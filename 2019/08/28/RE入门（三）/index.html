<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>RE入门（三） | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="re">
  
  
  
  
  <meta name="description" content="摘自《逆向工程核心原理》中关于 Windows 操作系统的 PE（Portable Executable）文件格式的部分，其中也有关于进程、内存、DLL 等的内容，它们是 Windows 操作系统中最核心的部分。">
<meta name="keywords" content="re">
<meta property="og:type" content="article">
<meta property="og:title" content="RE入门（三）">
<meta property="og:url" content="https://qianfei11.github.io/2019/08/28/RE入门（三）/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="摘自《逆向工程核心原理》中关于 Windows 操作系统的 PE（Portable Executable）文件格式的部分，其中也有关于进程、内存、DLL 等的内容，它们是 Windows 操作系统中最核心的部分。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/1.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/2.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/3.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/4.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/5.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/6.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/7.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/8.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/9.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/10.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/11.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/12.jpg">
<meta property="og:updated_time" content="2019-08-29T09:11:33.980Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RE入门（三）">
<meta name="twitter:description" content="摘自《逆向工程核心原理》中关于 Windows 操作系统的 PE（Portable Executable）文件格式的部分，其中也有关于进程、内存、DLL 等的内容，它们是 Windows 操作系统中最核心的部分。">
<meta name="twitter:image" content="https://qianfei11.github.io/pics/BIN集训/RE/三/1.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-RE入门（三）" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      RE入门（三）
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/08/28/RE入门（三）/" class="article-date">
	  <time datetime="2019-08-28T05:03:31.000Z" itemprop="datePublished">August 28, 2019</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>摘自<a href="https://reversecore.com/" target="_blank" rel="noopener">《逆向工程核心原理》</a>中关于 Windows 操作系统的 PE（Portable Executable）文件格式的部分，其中也有关于进程、内存、DLL 等的内容，它们是 Windows 操作系统中最核心的部分。</p>
<a id="more"></a>
<h1 id="PE-文件格式"><a href="#PE-文件格式" class="headerlink" title="PE 文件格式"></a>PE 文件格式</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>PE 文件是 Windows 操作系统下使用的可执行文件格式。它是微软在 UNIX 平台的 COFF（Common Object File Format，通用对象文件格式）基础上制作而成的。最初（正如 Portable 这个单词所代表的那样）设计用来提高程序在不同操作系统上的移植性，但实际上这种文件格式仅用在 Windows 系列的操作系统下。</p>
<p>PE 文件是指 32 位的可执行文件，也称为 PE32。64 位的可执行文件成为 PE+ 或 PE32+，是 PE（PE32）文件的一种扩展形式（请注意不是 PE64）。</p>
<h2 id="PE-文件格式-1"><a href="#PE-文件格式-1" class="headerlink" title="PE 文件格式"></a>PE 文件格式</h2><p>PE 文件种类如表所示。</p>
<table>
<thead>
<tr>
<th style="text-align:center">种类</th>
<th style="text-align:center">主扩展名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">可执行系列</td>
<td style="text-align:center">EXE、SCR</td>
</tr>
<tr>
<td style="text-align:center">库系列</td>
<td style="text-align:center">DLL、OCX、CPL、DRV</td>
</tr>
<tr>
<td style="text-align:center">驱动程序系列</td>
<td style="text-align:center">SYS、VXD</td>
</tr>
<tr>
<td style="text-align:center">对象文件系列</td>
<td style="text-align:center">OBJ</td>
</tr>
</tbody>
</table>
<p>严格地说，OBJ（对象）文件之外的所有文件都是可执行的。DLL、SYS 文件等虽然不能直接在 Shell（<code>Explorer.exe</code>）中运行，但可以使用其他方式（调试器、服务等）执行。</p>
<blockquote>
<p>根据 PE 正式规范，编译结果 OBJ 文件也视为 PE 文件。但是 OBJ 文件本身不能以任何形式执行，在代码逆向分析中几乎不需要关注它。</p>
</blockquote>
<p>接下来以记事本（Windows XP SP3 的 <code>notepad.exe</code>，与其他版本 Windows 下的 <code>notepad.exe</code> 文件结构类似，但是地址不同）程序进行简单说明。</p>
<p>下面是 <code>notepad.exe</code> 文件的起始部分，也是 PE 文件的头部分（PE header）。<code>notepad.exe</code> 文件运行需要的所有信息就存储在这个 PE 头中。如果加载到内存、从何处开始运行、运行中需要的 DLL 有哪些、需要多大的栈/堆内存等，大量信息以结构体形式存储在 PE 头中。换言之，学习 PE 文件格式就是学习 PE 头中的结构体。</p>
<p><img src="/pics/BIN集训/RE/三/1.png" alt="notepad.exe 文件"></p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p><code>notepad.exe</code> 具有普通 PE 文件的基本结构。从 DOS 头（DOS header）到节区头（Section header）是 PE 头部分，其下的节区合称 PE 体。文件中使用偏移（offset），内存中使用 VA（Virtual Address，虚拟地址）来表示位置。文件加载到内存时，情况就会发生变化（节区的大小、位置等）。文件的内容一般可分为代码（<code>.text</code>）、数据（<code>.data</code>）、资源（<code>.rsrc</code>）节，分别保存。</p>
<blockquote>
<p>根据所用的不同开发工具（VB/VC++/Delphi/etc）与编译选项，节区的名称、大小、个数、存储的内容等都是不同的。最重要的是它们按照不同的用途分类保存到不同的节中。</p>
</blockquote>
<p>各节区头定义了各节区在文件或内存中的大小、位置、属性等。</p>
<p>PE 头与各节区的尾部存在一个区域，称为 NULL 填充（Null padding）。计算机中，为了提高处理文件、内存、网络包的效率，使用“最小基本单位”这一概念，PE 文件中也类似。文件/内存中节区的起始位置应该在各文件/内存最小单位的倍数位置上，空白区域将用 NULL 填充（可以看到各节区起始地址的截断都遵循一定的规则）。</p>
<p><img src="/pics/BIN集训/RE/三/2.png" alt="PE文件（notepad.exe）加载到内存中的情形"></p>
<h3 id="VA-amp-RVA"><a href="#VA-amp-RVA" class="headerlink" title="VA&amp;RVA"></a>VA&amp;RVA</h3><p>VA 指的是进程虚拟内存的绝对地址，RVA（Relative Virtual Address，相对虚拟地址）指从某个基准位置（ImageBase）开始的相对地址。VA 和 RVA 满足下面的换算关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RVA+ImageBase=RA</span><br></pre></td></tr></table></figure>
<p>PE 头内部信息大多以 RVA 形式存在。原因在于，PE 文件（主要是 DLL）加载到进程虚拟内存的特定位置时，该位置可能已经加载了其他 PE 文件（DLL）。此时必须通过重定位（Relocation）将其加载到其他空白的位置，若 PE 头信息使用的是 VA，则无法正常访问。因此使用 RVA 来定位信息，即使发生了重定位，只要相对于基准位置的相对地址没有变化，就能正常访问到指定信息，不会出现任何问题。</p>
<blockquote>
<p>32 位 Windows OS 中，各进程分配有 4GB 的虚拟内存，因此进程中 VA 值的范围是 00000000~FFFFFFFF。</p>
</blockquote>
<h2 id="PE-头"><a href="#PE-头" class="headerlink" title="PE 头"></a>PE 头</h2><p>PE 头由许多结构体组成。</p>
<h3 id="DOS-头"><a href="#DOS-头" class="headerlink" title="DOS 头"></a>DOS 头</h3><p>微软创建 PE 文件格式时，人们正广泛使用 DOS 文件，所以微软充分考虑了 PE 文件对 DOS 文件的兼容性。其结果是在 PE 头的最前面添加了一个 <code>IMAGE_DOS_HEADER</code> 结构体，用来扩展已有的 DOS EXE 头。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span></span><br><span class="line">    WORD    e_magic;         <span class="comment">// DOS signature : 4D5A ("MZ")</span></span><br><span class="line">    WORD    e_cblp;</span><br><span class="line">    WORD    e_cp;</span><br><span class="line">    WORD    e_crlc;</span><br><span class="line">    WORD    e_cparhdr;</span><br><span class="line">    WORD    e_minalloc;</span><br><span class="line">    WORD    e_maxalloc;</span><br><span class="line">    WORD    e_ss;</span><br><span class="line">    WORD    e_sp;</span><br><span class="line">    WORD    e_csum;</span><br><span class="line">    WORD    e_ip;</span><br><span class="line">    WORD    e_cs;</span><br><span class="line">    WORD    e_lfarlc;</span><br><span class="line">    WORD    e_ovno;</span><br><span class="line">    WORD    e_res[<span class="number">4</span>];</span><br><span class="line">    WORD    e_oemid;</span><br><span class="line">    WORD    e_oeminfo;</span><br><span class="line">    WORD    e_res2[<span class="number">10</span>];</span><br><span class="line">    LONG    e_lfanew;        <span class="comment">// offset to NT header</span></span><br><span class="line">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure>
<p><code>IMAGE_DOS_HEADER</code> 结构体的大小为 40 个字节。在该结构中必须知道 2 个重要成员：<code>e_magic</code> 与 <code>e_lfanew</code>。</p>
<ul>
<li><code>e_magic</code>：DOS 签名（signature，4D5A=&gt;ASCII 值“MZ”）</li>
<li><code>e_lfanew</code>：指示 NT 头的偏移（根据不同文件拥有可变值）</li>
</ul>
<p>所有 PE 文件在你开始部分（<code>e_magic</code>）都有 DOS 签名（“MZ”）。<code>e_lfanew</code> 值指向 NT 头所在位置（NT 头的名称为 <code>IMAGE_NT_HEADERS</code>，后面将会介绍）。</p>
<blockquote>
<p>一个名叫 Mark Zbikowski 的开发人员在微软设计了 DOS 可执行文件，MZ 即取自其名字的首字母。</p>
</blockquote>
<p><img src="/pics/BIN集训/RE/三/3.png" alt="IMAGE_DOS_HEADERS"></p>
<p>根据 PE 规范，文件开始的 2 个字节为 4D5A，<code>e_lfanew</code> 的值为 000000E0（不是 E0000000）</p>
<blockquote>
<p>Intel 系列的 CPU 以逆序存储数据，称为小端序标识法。</p>
</blockquote>
<p>如果尝试修改这些值，会发现程序无法正常运行（因为根据 PE 规范，它已不再是 PE 文件了）。</p>
<h3 id="DOS-存根"><a href="#DOS-存根" class="headerlink" title="DOS 存根"></a>DOS 存根</h3><p>DOS 存根（stub）在 DOS 头下方，是个可选项，且大小不固定（即使没有 DOS 存根，文件也能正常运行）。DOS 存根由代码与数据混合而成。</p>
<p><img src="/pics/BIN集训/RE/三/4.png" alt="DOS 存根"></p>
<p>图中，文件偏移 40~4D 区域为 16 位的汇编指令。32 位的 Windos OS 中不会运行该命令（由于被识别为 PE 文件，所以完全忽视该代码）。在 DOS 环境中运行 <code>Notepad.exe</code> 文件，或者使用 DOS 调试器（<code>debug.exe</code>）运行它，可使其执行该代码（不认识 PE 文件格式，所以被识别为 DOS EXE 文件）。</p>
<p>在 Windows XP 下打开命令行窗口（<code>cmd.exe</code>），输入<code>debug C:\Windows\notepad.exe</code>。输入 “u” 指令（Unassemble），将会出现 16 位的汇编指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-u</span><br><span class="line">0B39:0000 0E            PUSH    CS</span><br><span class="line">0B39:0001 1F            POP     DS</span><br><span class="line">0B39:0002 BA0E00        MOV     DX,000E         ; DX = 0E : &quot;This program cannot be run in DOS mode&quot;</span><br><span class="line">0B39:0005 B409          MOV     AH,09</span><br><span class="line">0B39:0007 CD21          INT     21              ; AH = 09 : WriteString()</span><br><span class="line">0B39:0009 B8014C        MOV     AX,4C01</span><br><span class="line">0B39:000C CD21          INT     21              ; AX = 4C01 : Exit()</span><br><span class="line">0B39:000E 54            PUSH    SP</span><br><span class="line">0B39:000F 68            DB      68</span><br><span class="line">0B39:0010 69            DB      69</span><br><span class="line">0B39:0011 7320          JNB     0033</span><br><span class="line">0B39:0013 7072          JO      0087</span><br><span class="line">0B39:0015 6F            DB      6F</span><br><span class="line">0B39:0016 67            DB      67</span><br><span class="line">0B39:0017 7261          JB      007A</span><br><span class="line">0B39:0019 6D            DB      6D</span><br><span class="line">0B39:001A 206361        AND     [BP+DI+61],AH</span><br><span class="line">0B39:001D 6E            DB      6E</span><br><span class="line">0B39:001E 6E            DB      6E</span><br><span class="line">0B39:001F 6F            DB      6F</span><br></pre></td></tr></table></figure>
<p>代码非常简单，在画面中输出字符串 <code>&quot;This program cannot be run in DOS mode&quot;</code> 后就退出。换言之，<code>notepad.exe</code>文件虽然是 32 位的 PE 文件，但是带有 MS-DOS 兼容模式，可以在 DOS 环境中运行，执行 DOS EXE 代码，输出 <code>&quot;This program cannot be run in DOS mode&quot;</code> 后终止。灵活使用该特性可以在一个可执行文件（EXE）中创建出另一个文件，它在 DOS 与 Windows 中都能运行（在 DOS 环境中运行 16 位 DOS 代码，在 Windows 环境中运行 32 位 Windows 代码）。</p>
<p>如前所述，DOS 存根是可选项，开发工具应该支它（VB、VC++、Delphi 等默认支持 DOS 存根）。</p>
<h3 id="NT-头"><a href="#NT-头" class="headerlink" title="NT 头"></a>NT 头</h3><p>下面介绍 NT 头 <code>IMAGE_NT_HEADERS</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature;                   <span class="comment">// PE Signature : 50450000 ("PE"00)</span></span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>
<p><code>IMAGE_NT_HEADERS</code> 结构体由 3 个成员组成，第一个成员为签名（Signature）结构体，其值为 50450000h（”PE”00）。另外沥青个成员分别为文件头（File Header）与可选头（Optional Header）结构体。</p>
<p><img src="/pics/BIN集训/RE/三/5.png" alt="IMAGE_NT_HEADERS"></p>
<p><code>IMAGE_NT_HEADERS</code> 结构体的大小为 F8，相当大。</p>
<h3 id="NT-头：文件头"><a href="#NT-头：文件头" class="headerlink" title="NT 头：文件头"></a>NT 头：文件头</h3><p>文件头是表现文件大致属性的 <code>IMAGE_FILE_HEADER</code> 结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Machinie;</span><br><span class="line">    WORD    NumberOfSections;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    DWORD   PointerToSymbolTable;</span><br><span class="line">    DWORD   NumberOfSymbols;</span><br><span class="line">    WORD    SizeOfOptionalHeader;</span><br><span class="line">    WORD    Characteriistics;</span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure>
<p><code>IMAGE_FILE_HEADERS</code> 结构体中有如下 4 中重要成员（若它们设置不正确，将导致文件无法正常运行）。</p>
<h4 id="Machine"><a href="#Machine" class="headerlink" title="Machine"></a>Machine</h4><p>每个 CPU 都拥有唯一的 Machine 码，兼容 32 位 Intel x86 芯片的 Machine 码为 14C。以下是定义在 <code>winnt.h</code> 文件中的 Machine 码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_UNKNOWN      0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_I386         0x014c  <span class="comment">// Intel 386.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_R3000        0x0162  <span class="comment">// MIPS little-endian, 0x160 big-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_R4000        0x0166  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_R10000       0x0168  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_WCEMIPSV2    0x0169  <span class="comment">// MIPS little-endian WCE v2</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_ALPHA        0x0184  <span class="comment">// Alpha_AXP</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_POWERPC      0x01F0  <span class="comment">// IBM PowerPC Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_SH3          0x01a2  <span class="comment">// SH3 little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_SH3E         0x01a4  <span class="comment">// SH3E little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_SH4          0x01a6  <span class="comment">// SH4 little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_ARM          0x01c0  <span class="comment">// ARM Little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_THUMB        0x01c2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_IA64         0x0200  <span class="comment">// Intel 64</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_MIPS16       0x0266  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU      0x0366  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU16    0x0466  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_ALPHA64      0x0284  <span class="comment">// ALPHA64</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_MACHINE_AXP64        IMAGE_FILE_MACHINE_ALPHA64</span></span><br></pre></td></tr></table></figure>
<h4 id="NumberOfSections"><a href="#NumberOfSections" class="headerlink" title="NumberOfSections"></a>NumberOfSections</h4><p>前面提到过，PE 文件把代码、数据、资源等依据属性分类到各节区中存储。</p>
<p><code>NumberOfSections</code> 用来指出文件中存在的节区数量。该值一定要大于 0，且当定义的节区数量与实际节区不同时，将发生运行错误。</p>
<h4 id="SizeOfOptionalHeader"><a href="#SizeOfOptionalHeader" class="headerlink" title="SizeOfOptionalHeader"></a>SizeOfOptionalHeader</h4><p><code>IMAGE_NT_HEADER</code> 结构体的最后一个成员为 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体。<code>SizeOfOptionalHeader</code> 成员用来指出 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体的长度。<code>IMAGE_OPTIONAL_HEADER32</code> 结构体由 C 语言编写而成，故其大小已经确定。但是 Windows 的 PE 装载器需要查看 <code>IMAGE_FILE_HEADER</code> 的 <code>SizeOfOptionalHeader</code> 值，从而识别出 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体的大小。</p>
<p>PE32+ 格式的文件中使用的是 <code>IMAGE_OPTIONAL_HEADER64</code> 结构体，而不是 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体。2 个结构体的尺寸是不同的，所以需要在 <code>SizeOfOptionalHeader</code> 成员中明确指出结构体的大小。</p>
<blockquote>
<p>借助 <code>IMAGE_DOS_HEADER</code> 的 <code>e_lfanew</code> 成员与 <code>IMAGE_FILE_HEADER</code> 的 <code>SizeOfOptionalHeader</code> 成员，可以创建出一种脱离常规的 PE 文件（PE Patch）（也有人称之为 “麻花” PE 文件）</p>
</blockquote>
<h4 id="Characteristics"><a href="#Characteristics" class="headerlink" title="Characteristics"></a>Characteristics</h4><p>该字段用于标识文件的属性，文件是否可运行的形态、是否为 DLL 文件等信息，以 bit OR 形式组合起来。</p>
<p>以下是定义在 <code>winnt.h</code> 文件中的 <code>Characteristics</code> 值（请记住 0002h 与 2000h 这两个值）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_RELOCS_STRIPPED          0x0001  <span class="comment">// Relocation info stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_EXECUTABLE_IMAGE         0x0002  <span class="comment">// File is executable</span></span></span><br><span class="line">                                                    <span class="comment">// (i.e. no unresolved externel references).</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_LINE_NUMS_STRIPPED       0x0004  <span class="comment">// Line numbers stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_LOCAL_SYMS_STRIPPED      0x0008  <span class="comment">// Local symbols stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_AGGRESIVE_WS_TRIM        0x0010  <span class="comment">// Agressively trim working set</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_LARGE_ADDRESS_AWARE      0x0020  <span class="comment">// App can handle &gt;2gb addresses</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_BYTES_REVERSED_LO        0x0080  <span class="comment">// byte of machine word are reversed.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_32BIT_MACHINE            0x0100  <span class="comment">// 32 bit word machine.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_DEBUG_STRIPPED           0x0200  <span class="comment">// Debugging info stripped from</span></span></span><br><span class="line">                                                    <span class="comment">// file in .DBG file</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP  0x0400  <span class="comment">// If Image is on removable media,</span></span></span><br><span class="line">                                                    <span class="comment">// copy and run from the swap file.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_NET_RUN_FROM_SWAP        0x0800  <span class="comment">// If Image is on Net,</span></span></span><br><span class="line">                                                    <span class="comment">// copy and run from the swap file.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_SYSTEM                   0x1000  <span class="comment">// System File.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_DLL                      0x2000  <span class="comment">// File is a DLL.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_UP_SYSTEM_ONLY           0x4000  <span class="comment">// File should only be run on a UP machine</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_FILE_BYTES_REVERSED_HI        0x8000  <span class="comment">// byte of machine word are reversed.</span></span></span><br></pre></td></tr></table></figure>
<p>PE 中 <code>Characteristics</code> 的值有可能不是 0002h（不可执行），比如类似 <code>*.obj</code> 的 object 文件以及 resource DLL 文件等。</p>
<p>最后讲一下 <code>IMAGE_FILE_HEADER</code> 的 <code>TimeDateStamp</code> 成员。改成成员的值不影响文件运行，用来记录编译器创建此文件的时间。但是有些开发工具（VB、VC++）提供了设置该值的工具，而有些开发工具（Delphi）则未提供（且随所用选项的不同而不同）。</p>
<h4 id="IMAGE-FILE-HEADER"><a href="#IMAGE-FILE-HEADER" class="headerlink" title="IMAGE_FILE_HEADER"></a>IMAGE_FILE_HEADER</h4><p><code>IMAGE_FILE_HEADER</code> 的结构体。</p>
<p><img src="/pics/BIN集训/RE/三/6.png" alt="IMAGE_FILE_HEADER"></p>
<p>以结构体成员的形式表示如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ IMAGE_FILE_HEADER ] - notepad.exe</span><br><span class="line"></span><br><span class="line"> offset   value   description</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">000000E4     014C machine</span><br><span class="line">000000E6     0003 number of sections</span><br><span class="line">000000E8 48025287 time date stamp (Mon Apr 14 03:35:51 2008)</span><br><span class="line">000000EC 00000000 offset to symble table</span><br><span class="line">000000F0 00000000 number of symbols</span><br><span class="line">000000F4     00E0 size of optional header</span><br><span class="line">000000F6     010F characteristics</span><br><span class="line">                      IMAGE_FILE_RELOCS_STRIPPED</span><br><span class="line">                      IMAGE_FILE_EXECUTABLE_IMAGE</span><br><span class="line">                      IMAGE_FILE_LINE_NUMS_STRIPPED</span><br><span class="line">                      IMAGE_FILE_LOCAL_SYMS_STRIPPED</span><br><span class="line">                      IMAGE_FILE_32BIT_MACHINE</span><br></pre></td></tr></table></figure>
<h3 id="NT-头：可选头"><a href="#NT-头：可选头" class="headerlink" title="NT 头：可选头"></a>NT 头：可选头</h3><p><code>IMAGE_OPTIIONAL_HEADER32</code> 是 PE 头结构体中最大的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_NUMBEROF_DIRECTORY_ENTRIES    16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Magic;</span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode;</span><br><span class="line">    DWORD   SizeOfInitializedData;</span><br><span class="line">    DWORD   SizeOfUninitializedData;</span><br><span class="line">    DWORD   AddressOfEntryPoint;</span><br><span class="line">    DWORD   BaseOfCode;</span><br><span class="line">    DWORD   BaseOfData;</span><br><span class="line">    DWORD   ImageBase;</span><br><span class="line">    DWORD   SectionAlignment;</span><br><span class="line">    DWORD   FileAlignment;</span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;</span><br><span class="line">    DWORD   SizeOfHeaders;</span><br><span class="line">    DWORD   CheckSum;</span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;</span><br><span class="line">    DWORD   SizeOfStackCommit;</span><br><span class="line">    DWORD   SizeOfHeapReserve;</span><br><span class="line">    DWORD   SizeOfHeapCommit;</span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体中需要关注下列成员。这些值谁文件运行必需的，设置错误将导致文件无法正常运行。</p>
<h4 id="Magic"><a href="#Magic" class="headerlink" title="Magic"></a>Magic</h4><p>为 <code>IMAGE_OPTIONAL_HEADER32</code> 结构体时，Magic 码为 10B；为 <code>IMAGE_OPTIONAL_HEADER64</code> 结构体时，Magic 码为 20B。</p>
<h4 id="AddressOfEntryPoint"><a href="#AddressOfEntryPoint" class="headerlink" title="AddressOfEntryPoint"></a>AddressOfEntryPoint</h4><p><code>AddressOfEntryPoint</code> 持有 EP 的 RVA 值。该值指出程序最先执行的代码起始地址，相当重要。</p>
<h4 id="ImageBase"><a href="#ImageBase" class="headerlink" title="ImageBase"></a>ImageBase</h4><p>进程虚拟内存的范围时 0~FFFFFFFF（32 位系统）。PE 文件被加载到如此大的内存中时，<code>ImageBase</code> 指出文件的优先装入地址。</p>
<p>EXE、DLL 文件被装载到用户内存的 0~7FFFFFFF 中，SYS 文件被载入内核内存的 80000000~FFFFFFFF 中。一般而言，使用开发工具（VB/VC++/Delphi）创建好 EXE 文件后，其 <code>ImgaeBase</code> 的值为 00400000，DLL 文件的 <code>ImgaeBase</code> 值为 10000000（当然也可以指定为其他值）。执行 PE 文件时，PE 装载器先创建进程，再将文件载入内存，然后把 EIP 寄存器的值设置为 <code>ImageBase+AddressOfEntryPoint</code>。</p>
<h4 id="SectiionAlignment，FileAlignment"><a href="#SectiionAlignment，FileAlignment" class="headerlink" title="SectiionAlignment，FileAlignment"></a>SectiionAlignment，FileAlignment</h4><p>PE 文件的 Body 部分划分为若干节区，这些节存储着不同类别的数据。<code>FileAlignment</code> 指定了节区在磁盘文件中的最小单位，而 <code>SectionAlignment</code> 则指定了节区在内存中的最小单位（一个文件中，<code>FileAlignment</code> 与 <code>SectionAlignment</code> 的值可能相同，也可能不同）。磁盘文件或内存的节区大小必定为 <code>FileAlignment</code> 或 <code>SectionAlignment</code> 值的整数倍。</p>
<h4 id="SizeOfImage"><a href="#SizeOfImage" class="headerlink" title="SizeOfImage"></a>SizeOfImage</h4><p>加载 PE 文件到内存时，<code>SizeOfImage</code> 指定了 PE Image 在虚拟内存中所占的空间的大小。一般而言，文件的大小与加载到内存中的大小是不同的（节区头中定义了各节装载的位置与占有内存的大小）。</p>
<h4 id="SizeOfHeader"><a href="#SizeOfHeader" class="headerlink" title="SizeOfHeader"></a>SizeOfHeader</h4><p><code>SizeOfHeader</code> 用来指出整个 PE 头的大小。该值也必须是 <code>FileAlignment</code> 的整数倍。第一节区所在位置与 <code>SizeOfHeader</code> 距文件开始偏移的量相同。</p>
<h4 id="Subsystem"><a href="#Subsystem" class="headerlink" title="Subsystem"></a>Subsystem</h4><p>该 <code>Subsystem</code> 值用来区分系统驱动文件（<code>*.sys</code>）与普通的可执行文件（<code>*.exe</code>，<code>*.dll</code>）。<code>Subsystem</code> 成员可拥有的值如下。</p>
<table>
<thead>
<tr>
<th style="text-align:center">值</th>
<th style="text-align:center">含义</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">Driver 文件</td>
<td style="text-align:center">系统驱动（如：<code>ntfs.sys</code>）</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">GUI 文件</td>
<td style="text-align:center">窗口应用程序（如：<code>notepad.exe</code>）</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">CUI 文件</td>
<td style="text-align:center">控制台应用程序（如：<code>cmd.exe</code>）</td>
</tr>
</tbody>
</table>
<h4 id="NumberOfRvaAndSizes"><a href="#NumberOfRvaAndSizes" class="headerlink" title="NumberOfRvaAndSizes"></a>NumberOfRvaAndSizes</h4><p><code>NumberOfRvaAndSizes</code> 用来指定 <code>DataDirectory</code>（<code>IMAGE_OPTIONAL_HEADER32</code> 结构体的最后一个成员）数组的个数。虽然结构体定义中明确指出了数组个数为 <code>IMAGE_NUMBEROF_DIRECTORY_ENTRIES(16)</code>，但是 PE 装载器通过查看 <code>NumberOfRvaAndSizes</code> 值来识别数组大小，换言之，数组大小也可能不是 16。</p>
<h4 id="DataDirectory"><a href="#DataDirectory" class="headerlink" title="DataDirectory"></a>DataDirectory</h4><p><code>DataDirectory</code> 是由 <code>IMAGE_DATA_DIRECTORY</code> 结构体组成的数组，数组的每项都有被定义的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DataDirectory[<span class="number">0</span>] = EXPORT Directory</span><br><span class="line">DataDirectory[<span class="number">1</span>] = IMPORT Directory</span><br><span class="line">DataDirectory[<span class="number">2</span>] = RESOURCE Directory</span><br><span class="line">DataDirectory[<span class="number">3</span>] = EXCEPTION Directory</span><br><span class="line">DataDirectory[<span class="number">4</span>] = SECURITY Directory</span><br><span class="line">DataDirectory[<span class="number">5</span>] = BASERELOC Directory</span><br><span class="line">DataDirectory[<span class="number">6</span>] = DEBUG Directory</span><br><span class="line">DataDirectory[<span class="number">7</span>] = COPYRIGHT Directory</span><br><span class="line">DataDirectory[<span class="number">8</span>] = GLOBALPTR Directory</span><br><span class="line">DataDirectory[<span class="number">9</span>] = TLS Directory</span><br><span class="line">DataDirectory[A] = LOAD_CONFIG Directory</span><br><span class="line">DataDirectory[B] = BOUND_IMPORT Directory</span><br><span class="line">DataDirectory[C] = IAT Directory</span><br><span class="line">DataDirectory[D] = DELAY_IMPORT Directory</span><br><span class="line">DataDirectory[E] = COM_DESCRIPTOR Directory</span><br><span class="line">DataDirectory[F] = Reserved Directory</span><br></pre></td></tr></table></figure>
<p>将此处所说的 <code>Directory</code> 想成某个结构体数组即可。比较重要的是<code>EXPORT/IMPORT/RESOURCE</code>、<code>TLS Direction</code>。</p>
<h4 id="IMAGE-OPTIONAL-HEADER"><a href="#IMAGE-OPTIONAL-HEADER" class="headerlink" title="IMAGE_OPTIONAL_HEADER"></a>IMAGE_OPTIONAL_HEADER</h4><p><code>IMAGE_OPTIONAL_HEADER</code> 整个结构体。</p>
<p><img src="/pics/BIN集训/RE/三/7.png" alt="IMAGE_OPTIONAL_HEADER"></p>
<p>结构体各成员的值及其说明如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[ IMAGE_OPTIONAL_HEADER ] - notepad.exe</span><br><span class="line"></span><br><span class="line"> offset   value   description</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">000000F8     010B magic</span><br><span class="line">000000FA       07 major liinker version</span><br><span class="line">000000FB       0A minor liinker version</span><br><span class="line">000000FC 00007800 size of code</span><br><span class="line">00000100 00008C00 size of initialized data</span><br><span class="line">00000104 00000000 size of uninitialized data</span><br><span class="line">00000108 0000739D address of entry point</span><br><span class="line">0000010C 00001000 base of code</span><br><span class="line">00000110 00009000 base of data</span><br><span class="line">00000114 01000000 image base</span><br><span class="line">00000118 00001000 section alignment</span><br><span class="line">0000011C 00000200 file alignment</span><br><span class="line">00000120     0005 major OS version</span><br><span class="line">00000122     0001 minor OS version</span><br><span class="line">00000124     0005 major image version</span><br><span class="line">00000126     0001 minor image version</span><br><span class="line">00000128     0004 major subsystem version</span><br><span class="line">0000012A     0000 minor subsystem version</span><br><span class="line">0000012C 00000000 win32 version value</span><br><span class="line">00000130 00014000 size of image</span><br><span class="line">00000134 00000400 size of headers</span><br><span class="line">00000138 000126CE Checksum</span><br><span class="line">0000013C     0002 subsystem</span><br><span class="line">0000013E     8000 DLL characteristics</span><br><span class="line">00000140 00040000 size of stack reserve</span><br><span class="line">00000144 00011000 size of stack commit</span><br><span class="line">00000148 00100000 size of heap reserve</span><br><span class="line">0000014C 00001000 size of heap commit</span><br><span class="line">00000150 00000000 loader flags</span><br><span class="line">00000154 00000010 number of directories</span><br><span class="line">00000158 00000000 RVA  of EXPORT Directory</span><br><span class="line">0000015C 00000000 size of EXPORT Directory</span><br><span class="line">00000160 00007604 RVA  of IMPORT Directory</span><br><span class="line">00000164 000000C8 size of IMPORT Directory</span><br><span class="line">00000168 00000000 RVA  of RESOURCE Directory</span><br><span class="line">0000016C 00008304 size of RESOURCE Directory</span><br><span class="line">00000170 00000000 RVA  of EXCEPTION Directory</span><br><span class="line">00000174 00000000 size of EXCEPTION Directory</span><br><span class="line">00000178 00000000 RVA  of SECURITY Directory</span><br><span class="line">0000017C 00000000 size of SECURITY Directory</span><br><span class="line">00000180 00000000 RVA  of BASERELOC Directory</span><br><span class="line">00000184 00000000 size of BASERELOC Directory</span><br><span class="line">00000188 00001350 RVA  of DEBUG Directory</span><br><span class="line">0000018C 0000001C size of DEBUG Directory</span><br><span class="line">00000190 00000000 RVA  of COPYRIGHT Directory</span><br><span class="line">00000194 00000000 size of COPYRIGHT Directory</span><br><span class="line">00000198 00000000 RVA  of GLOBALPTR Directory</span><br><span class="line">0000019C 00000000 size of GLOBALPTR Directory</span><br><span class="line">000001A0 00000000 RVA  of TLS Directory</span><br><span class="line">000001A4 00000000 size of TLS Directory</span><br><span class="line">000001A8 000018A8 RVA  of LOAD_CONFIG Directory</span><br><span class="line">000001AC 00000040 size of LOAD_CONFIG Directory</span><br><span class="line">000001B0 00000250 RVA  of BOUND_IMPORT Directory</span><br><span class="line">000001B4 000000D0 size of BOUND_IMPORT Directory</span><br><span class="line">000001B8 00001000 RVA  of IAT Directory</span><br><span class="line">000001BC 00000348 size of IAT Directory</span><br><span class="line">000001C0 00000000 RVA  of DELAY_IMPORT Directory</span><br><span class="line">000001C4 00000000 size of DELAY_IMPORT Directory</span><br><span class="line">000001C8 00000000 RVA  of COM_DESCRIPTOR Directory</span><br><span class="line">000001CC 00000000 size of COM_DESCRIPTOR Directory</span><br><span class="line">000001D0 00000000 RVA  of Reserved Directory</span><br><span class="line">000001D4 00000000 size of Reserved Directory</span><br></pre></td></tr></table></figure>
<h3 id="节区头"><a href="#节区头" class="headerlink" title="节区头"></a>节区头</h3><p>节区头中定义了各节区属性。前面提到过，PE 文件中的 code（代码）、data（数据）、resource（资源）等按照属性分类存储在不同节区。</p>
<p>把 PE 文件创建成多个节区结构的好处是可以保证程序的安全性。若把 code 与 data 放在一个节区中相互纠缠很容易引发安全问题，即使忽略过程的烦琐。</p>
<p>假如向字符串 data 写数据时，由于某个原因导致溢出（输入超过缓冲区大小时），那么其下的 code（指令）就会被覆盖，应用程序就会崩溃。因此，PE 文件格式的设计者们决定把具有相似属性的数据统一保存在一个被称为 “节区” 的地方，然后需要把各节区属性记录在节区头中（节区属性中有文件/内存的起始位置、大小、访问权限等）。</p>
<p>换言之，需要为每个 code/data/resource 分别设置不同的特性、访问权限等，如下表。</p>
<table>
<thead>
<tr>
<th style="text-align:center">类别</th>
<th style="text-align:center">访问权限</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">code</td>
<td style="text-align:center">执行，读取权限</td>
</tr>
<tr>
<td style="text-align:center">data</td>
<td style="text-align:center">非执行，读写权限</td>
</tr>
<tr>
<td style="text-align:center">resource</td>
<td style="text-align:center">非执行，读取权限</td>
</tr>
</tbody>
</table>
<h4 id="IMAGE-SECTION-HEADER"><a href="#IMAGE-SECTION-HEADER" class="headerlink" title="IMAGE_SECTION_HEADER"></a>IMAGE_SECTION_HEADER</h4><p>节区头是由 <code>IMAGE_SECTION_HEADER</code> 结构体组成的数组，每个结构体对应一个节区。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IMAGE_SIZEOF_SHORT_NAME 8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   SizeOfRawData;</span><br><span class="line">    DWORD   PointerToRawData;</span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>
<p>下表中列出了 <code>IMAGE_SECTION_HEADER</code> 结构体中要了解的重要成员（不使用其他成员）。</p>
<table>
<thead>
<tr>
<th style="text-align:center">项目</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>VirtualSize</code></td>
<td style="text-align:center">内存中节区所占大小</td>
</tr>
<tr>
<td style="text-align:center"><code>VirtualAddress</code></td>
<td style="text-align:center">内存中节区起始地址（RVA）</td>
</tr>
<tr>
<td style="text-align:center"><code>SizeOfRawData</code></td>
<td style="text-align:center">磁盘文件中节区所占大小</td>
</tr>
<tr>
<td style="text-align:center"><code>PointerToRawData</code></td>
<td style="text-align:center">磁盘文件中节区起始位置</td>
</tr>
<tr>
<td style="text-align:center"><code>Characteristics</code></td>
<td style="text-align:center">节区属性（bit OR）</td>
</tr>
</tbody>
</table>
<p><code>VirtualAddress</code> 与 <code>PointerToRawData</code> 不带有任何值，分别由（定义在 <code>IMAGE_OPTIONAL_HEADER32</code> 中的）<code>SectionAlignment</code> 与 <code>FileAlignment</code> 确定。</p>
<p><code>VirutalSize</code> 与 <code>SizeOfRawData</code> 一般具有不同的值，即磁盘文件中节区的大小与加载到内存中的节区大小是不同的。</p>
<p><code>Characteristics</code> 由以下代码中现实的值组合（bit OR）而成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_CNT_CODE                0x00000020 <span class="comment">// Section contains code.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_CNT_INITIALIZED_DATA    0x00000040 <span class="comment">// Section contains initialized data.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_CNT_UNINITIALIZED_DATA  0x00000080 <span class="comment">// Section contains uninitialized data.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_MEM_EXECUTE             0x20000000 <span class="comment">// Section is executable.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_MEM_READ                0x40000000 <span class="comment">// Section is readable.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SCN_MEM_WRITE               0x80000000 <span class="comment">// Section is writable.</span></span></span><br></pre></td></tr></table></figure>
<p>最后讲一下 Name 字段。Name 成员不像 C 语言中的字符串一样以 NULL 结束，并且没有 “必须使用 ASCII 值” 的限制。PE 规范未明确规定节区的 Name，所以可以向其中仿佛任何值，甚至可以填充 NULL 值。所以节区的 Name 仅供参考，不能保证其百分之百地被用作某种信息（数据节区的名称也可叫做 <code>.code</code>）。</p>
<p><img src="/pics/BIN集训/RE/三/8.png" alt="notepad.exe 的 IMAGE_SECTION_HEADER 结构体数组"></p>
<p>各结构体成员如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[ IMAGE_SECTION_HEADER ]</span><br><span class="line"></span><br><span class="line"> offset   value   description</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">000001D8 2E746578 Name (.text)</span><br><span class="line">000001DC 74000000</span><br><span class="line">000001E0 00007748 virtual size</span><br><span class="line">000001E4 00001000 RVA</span><br><span class="line">000001E8 00007800 size of raw data</span><br><span class="line">000001EC 00000400 offset to raw data</span><br><span class="line">000001F0 00000000 offset to relocations</span><br><span class="line">000001F4 00000000 offset to line numbers</span><br><span class="line">000001F8     0000 number of relocations</span><br><span class="line">000001FA     0000 number of line numbers</span><br><span class="line">000001FC 60000020 characteristics</span><br><span class="line">                    IMAGE_SCN_CNT_CODE</span><br><span class="line">                    IMAGE_SCN_MEM_EXECUTE</span><br><span class="line">                    IMAGE_SCN_MEM_READ</span><br><span class="line"></span><br><span class="line">00000200 2E646174 Name (.data)</span><br><span class="line">00000204 61000000</span><br><span class="line">00000208 00001BA8 virtual size</span><br><span class="line">0000020C 00009000 RVA</span><br><span class="line">00000210 00000800 size of raw data</span><br><span class="line">00000214 00007C00 offset to raw data</span><br><span class="line">00000218 00000000 offset to relocations</span><br><span class="line">0000021C 00000000 offset to line numbers</span><br><span class="line">00000220     0000 number of relocations</span><br><span class="line">00000222     0000 number of line numbers</span><br><span class="line">00000224 C0000040 characteristics</span><br><span class="line">                    IMAGE_SCN_CNT_INITIALIZED_DATA</span><br><span class="line">                    IMAGE_SCN_MEM_READ</span><br><span class="line">                    IMAGE_SCN_MEM_WRITE</span><br><span class="line"></span><br><span class="line">00000228 2E727372 Name (.rsrc)</span><br><span class="line">0000022C 63000000</span><br><span class="line">00000230 00008304 virtual size</span><br><span class="line">00000234 0000B000 RVA</span><br><span class="line">00000238 00008400 size of raw data</span><br><span class="line">0000023C 00008400 offset to raw data</span><br><span class="line">00000240 00000000 offset to relocations</span><br><span class="line">00000244 00000000 offset to line numbers</span><br><span class="line">00000248     0000 number of relocations</span><br><span class="line">0000024A     0000 number of line numbers</span><br><span class="line">0000024C 40000040 characteristics</span><br><span class="line">                    IMAGE_SCN_CNT_INITIALIZED_DATA</span><br><span class="line">                    IMAGE_SCN_MEM_READ</span><br></pre></td></tr></table></figure>
<blockquote>
<p>讲解 PE 文件时经常出现 “映像” （Image）这一术语。PE 文件加载到内存时，文件不会原封不动地加载，而要根据节区头中定义的节区起始地址、节区大小等加载。因此，磁盘文件中的 PE 与内存中的 PE 具有不同形态。将装载到内存中的形态称为 “映像” 以示区别。</p>
</blockquote>
<h2 id="RVA-to-RAW"><a href="#RVA-to-RAW" class="headerlink" title="RVA to RAW"></a>RVA to RAW</h2><p>PE 文件加载到内存时，每个节区都要能准确完成内存骶椎与文件偏移间的映射。这种映射一般称为 RVA to RAW，方法如下。</p>
<ol>
<li>查找 RVA 所在节区。</li>
<li>使用简单的公式计算文件偏移（RAW）。</li>
</ol>
<p>根据 <code>IMAGE_SECTION_HEADER</code> 结构体，换算公式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RAW - PointerToRawData = RVA - VirtualAddress</span><br><span class="line">                   RAW = RVA - VirtualAddress + PointerToRawData</span><br></pre></td></tr></table></figure>
<h2 id="IAT"><a href="#IAT" class="headerlink" title="IAT"></a>IAT</h2><p>IAT（Import Address Table，导入地址表）保存的内容与 Windows 操作系统的核心进程、内存、DLL 结构等有关。换句话说，只要理解了 IAT，就掌握了 Windows 操作系统的根基。简言之 IAT 是一种表格，用来记录程序正在使用哪些库中的哪些函数。</p>
<blockquote>
<p>RVA 与 RAW（文件偏移）间的相互变换是 PE 头的最基本的内容。</p>
</blockquote>
<h3 id="DLL"><a href="#DLL" class="headerlink" title="DLL"></a>DLL</h3><p>DLL（Dynamic Linked Library）撑起了整座 Windows OS 大厦，它被翻译成 “动态链接库”。</p>
<p>16 位的 DOS 时代不存在 DLL 这一概念，只有 “库”（Library）一说。比如在 C 语言中使用 <code>printf()</code> 函数时，编译器会先从 C 库中读取相应函数的二进制代码，然后插入（包含到）应用程序。也就是说，可执行文件中包含着 <code>printf()</code> 函数的二进制代码。Windows OS 支持多任务，若仍采用这种包含库的方式，会非常没有效率。Windows 操作系统使用了数量庞大的库函数（进程、内存、窗口、消息等）来支持 32 位的 Windows 环境。同时运行多个程序时，若仍像以前一样每个程序运行时都包含相同的库，将造成严重的内存浪费（当然磁盘空间的浪费也不容小嘘）。因此，Windows OS 设计者们根据需要引入了 DLL 这一概念，描述如下。</p>
<ul>
<li>不要把库包含到程序中，单独组成 DLL 文件，需要时调用即可。</li>
<li>内存映射技术使加载后的 DLL 代码、资源在多个进程中实现共享。</li>
<li>更新库时只要替换相关 DLL 文件即可，简便易行。</li>
</ul>
<p>加载 DLL 的方式实际有两种：一种是 “显式链接”（Explicit Linking），程序使用 DLL 时加载，使用完毕后释放内存；另一种是 “隐式链接”（Implicit Linking），程序开始时即一同加载 DLL，程序终止时再释放占用的内存。IAT 提供的机制即与隐式链接有关。接下来用 OllyDbg 打开 <code>notepad.exe</code> 来查看 IAT，下图是 <code>CreateFileW()</code> 函数的代码，该函数位于 kernel32.dll 中。</p>
<p><img src="/pics/BIN集训/RE/三/9.png" alt="调用 CreateFileW() 函数的代码"></p>
<p>调用 <code>CreateFileW()</code> 函数时并非直接调用，而是通过获取 01001104 地址处的值来实现（所有 API 调用均采用这种方式）。</p>
<p>地址 01001104 是 <code>notepad.exe</code> 中 <code>.text</code> 节区的内存区域（更确切地说是 IAT 内存区域）。01001104 地址的值为 7C8107F0，而 7C8107F0 地址即是加载到 <code>notepad.exe</code> 进程内存中的 <code>CreateFileW()</code> 函数（位于 kernel32.dll 库中）的地址。</p>
<p>那么为什么不直接 <code>CALL 7C8107F0</code> 呢？事实上，<code>notepad.exe</code> 程序的制作者编译（生成）程序时，并不知道该 <code>notepad.exe</code> 程序运行在哪种 Windows（9X、2K、XP、Vista、7 等）、哪种语言（ENG、JPN、KOR 等）、哪种服务包（Service Pack）下。上面列举出的所有环境中，kernel32.dll 的版本各不相同，<code>CreateFileW()</code> 函数的位置（地址）也不相同。为了确保在所有环境中都能正常地调用 <code>CreateFileW()</code> 函数，编译器准备了要保存 <code>CreateFileW()</code> 函数实际地址的位置（01001104），并记下 <code>CALL DWORD PTR DS:[01001104]</code> 形式的指令。执行文件时，PE 装载器将 <code>CreateFileW()</code> 函数的地址写到 01001104 位置。</p>
<p>编译器不使用 <code>CALL 7C8107F0</code> 语句的另一个原因在于 DLL 重定位。DLL 文件的 ImageBase 值一般为 10000000。比如某个程序使用 a.dll 与 b.dll 时，PE 装载器先把 a.dll 装载到内存的 10000000（ImageBase）处，然后尝试把 b.dll 也装载到该处。但是由于该地址处已经装载了 a.dll，所以 PE 装载器查找其他空白的内存空间（ex：3E000000），然后将 b.dll 装载进去。</p>
<p>这就是所谓的 DLL 重定位，它使我们无法对实际地址硬编码。另一个原因在于，PE 头中表示地址时不使用 VA，而是 RVA。</p>
<blockquote>
<p>实际操作中无法保证 DLL 一定会被加载到 PE 头内指定的 ImageBase 处。但是 EXE 文件（生成进程的主体）却能准确加载到自身的 ImageBase 中，因为它拥有自己的虚拟空间。</p>
</blockquote>
<p>PE 头的 IAT 是代码逆向分析的核心内容。</p>
<h3 id="IMAGE-IMPORT-DESCRIPTOR"><a href="#IMAGE-IMPORT-DESCRIPTOR" class="headerlink" title="IMAGE_IMPORT_DESCRIPTOR"></a>IMAGE_IMPORT_DESCRIPTOR</h3><p><code>IMAGE_IMPORT_DESCRIPTOR</code> 结构体中记录着 PE 文件要导入哪些库文件。</p>
<blockquote>
<p>Import：导入，向库提供服务（函数）。<br>Export：导出，从库向其他 PE 文件提供服务（函数）。</p>
</blockquote>
<p><code>IMAGE_IMPORT_DESCRIPTOR</code> 结构体如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD   Characteristiics;</span><br><span class="line">        DWORD   OriginalFirstThunk;     <span class="comment">// INT(Import Name Table) address (RVA)</span></span><br><span class="line">    &#125;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    DWORD   ForwarderChain;</span><br><span class="line">    DWORD   Name;                       <span class="comment">// library name string address (RVA)</span></span><br><span class="line">    DWORD   FirstThunk;                 <span class="comment">// IAT(Import Address Table) address (RVA)</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORTBY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;                       <span class="comment">// ordinal</span></span><br><span class="line">    BYTE    Name[<span class="number">1</span>];                    <span class="comment">// function name string</span></span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure>
<p>执行一个普通程序时往往需要导入多个库，导入多少库就存在多少个 <code>IMAGE_IMPORT_DESCRIPTOR</code> 结构体，这些结构体形成了数组，且结构体数组最后以 NULL 结构体结束。<code>IMAGE_IMPORT_DESCRIPTOR</code> 中重要的成员如下表所示（拥有全部 RVA 值）。</p>
<table>
<thead>
<tr>
<th style="text-align:center">项目</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">OriginalFirstThunk</td>
<td style="text-align:center">INT 的地址（RVA）</td>
</tr>
<tr>
<td style="text-align:center">Name</td>
<td style="text-align:center">库名称字符串的地址（RVA）</td>
</tr>
<tr>
<td style="text-align:center">FirstThunk</td>
<td style="text-align:center">IAT 的地址（RVA）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>PE 头中提到的 “Table” 即指数组。<br>INT 与 IAT 是长整型（4 个字节数据类型）数组，以 NULL 结束（未另外明确指出大小）。<br>INT 中各元素的值为 IMAGE_IMPORT_BY_NAME 结构体指针（有时 IAT 也拥有相同的值）。<br>INT 与 IAT 的大小应相同。</p>
</blockquote>
<p>下图为 <code>notepad.exe</code> 之 kernel32.dll 的 <code>IMAGE_IMPORT_DESCRIPTOR</code> 结构。</p>
<p><img src="/pics/BIN集训/RE/三/10.png" alt="IAT"></p>
<p>INT 与 IAT 的各元素同时指向相同地址，但也有很多情况下它们是不一致的。</p>
<p>下面为 PE 装载器把导入函数输入之 IAT 的顺序。</p>
<ol>
<li>读取 IID 的 Name 成员，获取库名称字符串（“kernel32.dll”）。</li>
<li>装载相应库。-&gt; <code>LoadLibrary(&quot;kernel32.dll&quot;)</code></li>
<li>读取 IID 的 OriginialFirstThunk 成员，获取 INT 地址。</li>
<li>逐一读取 INT 中数组的值，获取相应 IMAGE_IMPORT_BY_NAME 地址（RVA）。</li>
<li>使用 IMAGE_IMPORT_BY_NAME 的 Hint（ordinal）或 Name 项，获取相应函数的起始地址。-&gt; <code>GetProcAddress(&quot;GetCurrentThreadld&quot;)</code></li>
<li>读取 IID 的 FirstThunk（IAT）成员，获得 IAT 地址。</li>
<li>将上面获得的函数地址输入相应 IAT 数组值。</li>
<li>重复以上步骤 4~7，直到 INT 结束（遇到 NULL 时）。</li>
</ol>
<h2 id="EAT"><a href="#EAT" class="headerlink" title="EAT"></a>EAT</h2><p>Windows 操作系统中，“库” 是为了方便其他程序调用而集中包含相关函数的文件（DLL/SYS）。Win32 API 是最具代表性的库，其中的 kernel32.dll 文件被称为最核心的库文件。</p>
<p>EAT 是一种核心机制，它使不同应用程序可以调用库文件中提供的函数。也就是说，只有通过 EAT 才能准确求得从相应库中导出函数的起始地址。与 IAT 一样，PE 文件内的特定结构体（<code>IMAGE_EXPORT_DIRECTORY</code>）保存着导出信息，且 PE 文件中仅有一个用来说明库 EAT 的 <code>IMAGE_EXPORT_DIRECTORY</code> 结构体。</p>
<blockquote>
<p>用来说明 IAT 的 IMAGE_IMPORT_DESCRIPTOR 结构体以数组形式存在，且拥有多个成员。这样是因为 PE 文件可以同时导入多个库。</p>
</blockquote>
<p>可以在 PE 文件的 PE 头查找到 <code>IMAGE_EXPORT_DIRECTORY</code> 结构体的位置。<code>IMAGE_OPTIONAL_HEADER32.DataDirectory[0].VirtualAddress</code> 值即是 <code>IMAGE_EXPORT_DIRECTORY</code> 的起始地址（也是 RVA 的值）。</p>
<p>下图显示的是 kernel32.dll 文件的 <code>IMAGE_OPTIONAL_HEADER32.DataDirectory[0]</code>（第一个 4 字节为 VirtualAddress，第二个 4 字节为 Size 成员）。</p>
<p><img src="/pics/BIN集训/RE/三/11.png" alt="IMAGE_OPTIONAL_HEADER32.DataDirectory[0]"></p>
<p><code>IMAGE_OPTIONAL_HEADER32.DataDirectory</code> 结构体数组信息整理如下表。</p>
<table>
<thead>
<tr>
<th style="text-align:center">偏移</th>
<th style="text-align:center">值</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00000160</td>
<td style="text-align:center">00000000</td>
<td style="text-align:center">loader flags</td>
</tr>
<tr>
<td style="text-align:center">00000164</td>
<td style="text-align:center">00000010</td>
<td style="text-align:center">number of directories</td>
</tr>
<tr>
<td style="text-align:center">00000168</td>
<td style="text-align:center">0000262C</td>
<td style="text-align:center">RVA of EXPORT Directory</td>
</tr>
<tr>
<td style="text-align:center">0000016C</td>
<td style="text-align:center">00006D19</td>
<td style="text-align:center">size of EXPORT Directory</td>
</tr>
<tr>
<td style="text-align:center">00000170</td>
<td style="text-align:center">00081898</td>
<td style="text-align:center">RVA of IMPORT Directory</td>
</tr>
<tr>
<td style="text-align:center">00000174</td>
<td style="text-align:center">00000028</td>
<td style="text-align:center">size of IMPORT Directory</td>
</tr>
</tbody>
</table>
<p>由于 RVA 值为 262C，所以文件偏移为 1A2C。</p>
<h3 id="IMAGE-EXPORT-DIRECTORY"><a href="#IMAGE-EXPORT-DIRECTORY" class="headerlink" title="IMAGE_EXPORT_DIRECTORY"></a>IMAGE_EXPORT_DIRECTORY</h3><p><code>IMAGE_EXPORT_DIRECTORY</code> 结构体如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">    DWROD   TimeDateStamp;          <span class="comment">// creation time date stamp</span></span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;                   <span class="comment">// address of library file name</span></span><br><span class="line">    DWORD   Base;                   <span class="comment">// ordinal base</span></span><br><span class="line">    DWORD   NumberOfFunctions;      <span class="comment">// number of functions</span></span><br><span class="line">    DWORD   NumberOfNames;          <span class="comment">// number of names</span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// address of function start address array</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// address of function name string array</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// address of ordinal array</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure>
<p>下表为其中的重要成员（全部地址均为 RVA）。</p>
<table>
<thead>
<tr>
<th style="text-align:center">项目</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">NumberOfFunctions</td>
<td style="text-align:center">实际 Export 函数的个数</td>
</tr>
<tr>
<td style="text-align:center">NumberOfNames</td>
<td style="text-align:center">Export 函数中具名的函数个数</td>
</tr>
<tr>
<td style="text-align:center">AddressOfFunctions</td>
<td style="text-align:center">Export 函数地址数组（数组元素个数=AddressOfFunctions）</td>
</tr>
<tr>
<td style="text-align:center">AddressOfNames</td>
<td style="text-align:center">函数名称地址数组（数组元素个数=AddressOfNames）</td>
</tr>
<tr>
<td style="text-align:center">AddressOfNameOrdinals</td>
<td style="text-align:center">Ordinal 地址数组（数组元素个数=AddressOfNames）</td>
</tr>
</tbody>
</table>
<p>下图是 kernel32.dll 文件的 <code>IMAGE_EXPORT_DIRECTORY</code> 结构体与整个 EAT 结构。</p>
<p><img src="/pics/BIN集训/RE/三/12.jpg" alt="EAT"></p>
<p>从库中获得函数地址的 API 为 <code>GetProcAddress()</code> 函数。该 API 引用 EAT 来获取指定 API 的地址。<code>GetProcAddress()</code> API 拥有函数名称，以下为它获取函数地址的过程。</p>
<ol>
<li>利用 AddressOfNames 成员转到 “函数名称数组”。</li>
<li>“函数名称数组” 中存储着字符串地址。通过比较（strcmp）字符串，查找指定的函数名称（此时数组的索引称为 name_index）。</li>
<li>利用 AddressOfNameOrdinals 成员，转到 ordinal 数组。</li>
<li>在 ordinal 数组中通过 name_index 查找相应的 ordinal 值。</li>
<li>利用 AddressOfFunctions 成员转到 “函数地址数组”（EAT）。</li>
<li>在 “函数地址数组” 中将刚刚求得的 ordinal 用作数组索引，获得指定函数的起始地址。</li>
</ol>
<p>kernel32.dll 中所有导出函数均有相应名称，AddressOfNameOrdinals 数组的值以 index=ordinal 的形式存在。但并不是所有的 DLL 文件都如此。导出函数中也有一些函数没有名称（仅通过 ordinal 导出），AddressOfNameOrdinals 数组的值为 index!=ordinal。所以只有按照上面的顺序才能获得准确的函数地址。</p>
<blockquote>
<p>对于没有函数名称的导出函数，可以通过 Ordinal 查找到它们的地址。从 Ordinal 值中减去 IMAGE_EXPORT_DIRECTORY.Base 成员后得到一个值，使用该值作为 “函数地址数组” 的索引，即可查找到相应函数的地址。</p>
</blockquote>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://reversecore.com/" target="_blank" rel="noopener">《逆向工程核心原理》</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/re/">re</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/29/攻防世界-MOBILE-新手练习区/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          攻防世界-MOBILE-新手练习区
        
      </div>
    </a>
  
  
    <a href="/2019/08/24/杭电CTF-题库-reverse/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">杭电CTF-题库-reverse</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PE-文件格式"><span class="nav-number">1.</span> <span class="nav-text">PE 文件格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PE-文件格式-1"><span class="nav-number">1.2.</span> <span class="nav-text">PE 文件格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本结构"><span class="nav-number">1.2.1.</span> <span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VA-amp-RVA"><span class="nav-number">1.2.2.</span> <span class="nav-text">VA&amp;RVA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PE-头"><span class="nav-number">1.3.</span> <span class="nav-text">PE 头</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DOS-头"><span class="nav-number">1.3.1.</span> <span class="nav-text">DOS 头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DOS-存根"><span class="nav-number">1.3.2.</span> <span class="nav-text">DOS 存根</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NT-头"><span class="nav-number">1.3.3.</span> <span class="nav-text">NT 头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NT-头：文件头"><span class="nav-number">1.3.4.</span> <span class="nav-text">NT 头：文件头</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Machine"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">Machine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NumberOfSections"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">NumberOfSections</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SizeOfOptionalHeader"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">SizeOfOptionalHeader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Characteristics"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">Characteristics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IMAGE-FILE-HEADER"><span class="nav-number">1.3.4.5.</span> <span class="nav-text">IMAGE_FILE_HEADER</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NT-头：可选头"><span class="nav-number">1.3.5.</span> <span class="nav-text">NT 头：可选头</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Magic"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">Magic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AddressOfEntryPoint"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">AddressOfEntryPoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageBase"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">ImageBase</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SectiionAlignment，FileAlignment"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">SectiionAlignment，FileAlignment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SizeOfImage"><span class="nav-number">1.3.5.5.</span> <span class="nav-text">SizeOfImage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SizeOfHeader"><span class="nav-number">1.3.5.6.</span> <span class="nav-text">SizeOfHeader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Subsystem"><span class="nav-number">1.3.5.7.</span> <span class="nav-text">Subsystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NumberOfRvaAndSizes"><span class="nav-number">1.3.5.8.</span> <span class="nav-text">NumberOfRvaAndSizes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DataDirectory"><span class="nav-number">1.3.5.9.</span> <span class="nav-text">DataDirectory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IMAGE-OPTIONAL-HEADER"><span class="nav-number">1.3.5.10.</span> <span class="nav-text">IMAGE_OPTIONAL_HEADER</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节区头"><span class="nav-number">1.3.6.</span> <span class="nav-text">节区头</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IMAGE-SECTION-HEADER"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">IMAGE_SECTION_HEADER</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RVA-to-RAW"><span class="nav-number">1.4.</span> <span class="nav-text">RVA to RAW</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IAT"><span class="nav-number">1.5.</span> <span class="nav-text">IAT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DLL"><span class="nav-number">1.5.1.</span> <span class="nav-text">DLL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-IMPORT-DESCRIPTOR"><span class="nav-number">1.5.2.</span> <span class="nav-text">IMAGE_IMPORT_DESCRIPTOR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EAT"><span class="nav-number">1.6.</span> <span class="nav-text">EAT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-EXPORT-DIRECTORY"><span class="nav-number">1.6.1.</span> <span class="nav-text">IMAGE_EXPORT_DIRECTORY</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">2.</span> <span class="nav-text">Reference</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
