<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>2019-CISCN-strange_int | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="rectf">
  
  
  
  
  <meta name="description" content="一道 MBR 虚拟机的题目，同时也熟悉了使用 bochs 对 MBR 的调试。">
<meta name="keywords" content="re,ctf">
<meta property="og:type" content="article">
<meta property="og:title" content="2019-CISCN-strange_int">
<meta property="og:url" content="qianfei11.coding.me/2020/01/24/2019-CISCN-strange-int/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="一道 MBR 虚拟机的题目，同时也熟悉了使用 bochs 对 MBR 的调试。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-01-27T03:42:36.631Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019-CISCN-strange_int">
<meta name="twitter:description" content="一道 MBR 虚拟机的题目，同时也熟悉了使用 bochs 对 MBR 的调试。">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2019-CISCN-strange-int" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      2019-CISCN-strange_int
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2020/01/24/2019-CISCN-strange-int/" class="article-date">
	  <time datetime="2020-01-24T08:46:38.000Z" itemprop="datePublished">January 24, 2020</time>
	</a>

       
      

	  |
	  6.6k words
	  |
	  37 minute(s) to read
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>一道 MBR 虚拟机的题目，同时也熟悉了使用 bochs 对 MBR 的调试。</p>
<a id="more"></a>
<h1 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file Image.bin</span><br><span class="line">Image.bin: DOS/MBR boot sector</span><br></pre></td></tr></table></figure>
<p>先在 IDA 中 16 位的模式打开。在 7C00~7C0E 的代码（MBR 的加载地址是 0x7C00 处）是对寄存器和栈指针进行初始化操作；在 7C0F~7C12 的代码是 x86 系统中的第 17 号调用，设置了显示模式；在 7C14~7C24 的代码是 x86 系统中的第 20 号调用，从软盘的第 0 个磁盘第 0 个柱面第 2 个扇区开始的共 28 个扇区读取数据到内存的 10000000 处；在 7C2B~7C3B 的代码将内存中 10000000~10002000 的数据赋值给内存 0~2000 处；在 7C3D~7C47 的代码初始化 IDT 和 GDT；在 7C4C~7C52 的代码处，启动保护模式，并跳转至 32 位代码段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">MBR16:0000 sub_0           proc near</span><br><span class="line">MBR16:0000                 jmp     far ptr 7C0h:5</span><br><span class="line">MBR16:0000 sub_0           endp</span><br><span class="line">MBR16:0000</span><br><span class="line">MBR16:0005</span><br><span class="line">MBR16:0005 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">MBR16:0005</span><br><span class="line">MBR16:0005</span><br><span class="line">MBR16:0005 sub_5           proc near</span><br><span class="line">MBR16:0005                 mov     ax, cs</span><br><span class="line">MBR16:0007                 mov     ds, ax</span><br><span class="line">MBR16:0009                 assume ds:MBR16</span><br><span class="line">MBR16:0009                 mov     ss, ax</span><br><span class="line">MBR16:000B                 assume ss:MBR16</span><br><span class="line">MBR16:000B                 mov     sp, 400h</span><br><span class="line">MBR16:000E                 cld</span><br><span class="line">MBR16:000F                 mov     ax, 3</span><br><span class="line">MBR16:0012                 int     10h             ; - VIDEO - SET VIDEO MODE</span><br><span class="line">MBR16:0012                                         ; AL = mode</span><br><span class="line">MBR16:0014                 mov     dx, 0</span><br><span class="line">MBR16:0017                 mov     cx, 2</span><br><span class="line">MBR16:001A                 mov     ax, 1000h</span><br><span class="line">MBR16:001D                 mov     es, ax</span><br><span class="line">MBR16:001F                 assume es:nothing</span><br><span class="line">MBR16:001F                 xor     bx, bx</span><br><span class="line">MBR16:0021                 mov     ax, 228h</span><br><span class="line">MBR16:0024                 int     13h             ; DISK - READ SECTORS INTO MEMORY</span><br><span class="line">MBR16:0024                                         ; AL = number of sectors to read, CH = track, CL = sector</span><br><span class="line">MBR16:0024                                         ; DH = head, DL = drive, ES:BX -&gt; buffer to fill</span><br><span class="line">MBR16:0024                                         ; Return: CF set on error, AH = status, AL = number of sectors read</span><br><span class="line">MBR16:0026                 jnb     short loc_2A</span><br><span class="line">MBR16:0028</span><br><span class="line">MBR16:0028 loc_28:                                 ; CODE XREF: sub_5:loc_28↓j</span><br><span class="line">MBR16:0028                 jmp     short loc_28</span><br><span class="line">MBR16:002A ; ---------------------------------------------------------------------------</span><br><span class="line">MBR16:002A</span><br><span class="line">MBR16:002A loc_2A:                                 ; CODE XREF: sub_5+21↑j</span><br><span class="line">MBR16:002A                 cli</span><br><span class="line">MBR16:002B                 mov     ax, 1000h</span><br><span class="line">MBR16:002E                 mov     ds, ax</span><br><span class="line">MBR16:0030                 assume ds:nothing</span><br><span class="line">MBR16:0030                 xor     ax, ax</span><br><span class="line">MBR16:0032                 mov     es, ax</span><br><span class="line">MBR16:0034                 assume es:MBR16</span><br><span class="line">MBR16:0034                 mov     cx, 2000h</span><br><span class="line">MBR16:0037                 sub     si, si</span><br><span class="line">MBR16:0039                 sub     di, di</span><br><span class="line">MBR16:003B                 rep movsb</span><br><span class="line">MBR16:003D                 mov     ax, 7C0h</span><br><span class="line">MBR16:0040</span><br><span class="line">MBR16:0040 loc_40:                                 ; DATA XREF: sub_5+D↑r</span><br><span class="line">MBR16:0040                 mov     ds, ax</span><br><span class="line">MBR16:0042                 assume ds:nothing</span><br><span class="line">MBR16:0042                 lidt    fword ptr ds:6Fh ; Init IDT</span><br><span class="line">MBR16:0047                 lgdt    fword ptr ds:75h ; Init GDT</span><br><span class="line">MBR16:004C</span><br><span class="line">MBR16:004C loc_4C:                                 ; DATA XREF: sub_5+1F↑r</span><br><span class="line">MBR16:004C                 mov     ax, 1            ; Start Protected Mode</span><br><span class="line">MBR16:004F                 lmsw    ax               ; Jump to 32-bit Code</span><br><span class="line">MBR16:004F sub_5           endp</span><br><span class="line">MBR16:004F</span><br><span class="line">MBR16:004F MBR16           ends</span><br></pre></td></tr></table></figure>
<blockquote>
<h2 id="何为-IDT-和-GDT？"><a href="#何为-IDT-和-GDT？" class="headerlink" title="何为 IDT 和 GDT？"></a>何为 IDT 和 GDT？</h2><h3 id="GDT"><a href="#GDT" class="headerlink" title="GDT"></a>GDT</h3><p>全局描述表（Global Descriptor Table）。在实时模式下，对一个内存地址的访问是通过段寄存器的方式来进行（一个段具备两个元素：[Base Address, Limit]），即段模式。而在保护模式下（保护模式运行在 32 位系统上），内存的管理模式分为两种，段模式和页模式，其中页模式也是基于段模式的（纯段模式和段页模式）。</p>
<p>在保护模式下，对一个段的描述则包括 3 方面因素：[Base Address, Limit, Access]，它们加在一起被放在一个 64-bit 长的数据结构中，被称为段描述符。而段寄存器仍然是 16-bit，无法通过 16-bit 长度的段寄存器来直接引用 64-bit 的段描述符。</p>
<p>解决方法就是把这些长度为 64-bit 的段描述符放入一个数组即 GDT 中。当程序员通过段寄存器来引用一个段描述符时，CPU 必须知道 GDT 的入口，也就是基地址放在哪里，所以 Intel 的设计者门提供了一个寄存器 GDTR 用来存放 GDT 的入口地址，程序员将 GDT 设定在内存中某个位置之后，可以通过 LGDT 指令将 GDT 的入口地址装入此寄存器，从此以后，CPU 就根据此寄存器中的内容作为 GDT 的入口来访问 GDT 了。</p>
<h3 id="IDT"><a href="#IDT" class="headerlink" title="IDT"></a>IDT</h3><p>中断描述符表（Interrupt Descriptor Table），和 GDT 类似，记录了 0~255 的中断号和调用函数之间的关系。</p>
<p>段描述符使用数组存储，使用 LIDT 指令将 IDT 的入口地址装入 IDTR 寄存器。</p>
</blockquote>
<p>接下来在 IDA 中用 32 位模式打开。一开始的一段代码对 IDT 和 GDT 进行了初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">seg001:00000205 sub_205         proc near</span><br><span class="line">seg001:00000205                 mov     ds, eax</span><br><span class="line">seg001:00000207                 lss     esp, fword ptr ds:dword_B34+28h</span><br><span class="line">seg001:0000020E                 call    IDT_Init</span><br><span class="line">seg001:00000213                 call    GDT_Init</span><br><span class="line">seg001:00000218                 mov     eax, 10h        ; DATA XREF: sub_28B+27↓r</span><br><span class="line">seg001:0000021D                 mov     ds, eax</span><br><span class="line">seg001:0000021F                 assume ds:nothing</span><br><span class="line">seg001:0000021F                 mov     es, eax</span><br><span class="line">seg001:00000221                 assume es:nothing</span><br><span class="line">seg001:00000221                 mov     fs, eax         ; DATA XREF: sub_283↓r</span><br><span class="line">seg001:00000223                 assume fs:nothing</span><br><span class="line">seg001:00000223                 mov     gs, eax</span><br><span class="line">seg001:00000225                 assume gs:nothing</span><br><span class="line">seg001:00000225                 lss     esp, large ds:0B5Ch</span><br><span class="line">seg001:00000225                                         ; DATA XREF: sub_28B+11↓o</span><br><span class="line">seg001:0000022C                 xor     ebx, ebx</span><br></pre></td></tr></table></figure>
<p>IDT_init 处，先将 000800FC 赋给了 EAX，将 8E00 赋给了 DX。然后进行了一个 256 次的循环，每次循环从 00080128 的地址开始，分别存入 EAX 和 EDX。最后加载 IDTR，地址为 11C。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">seg001:0000028B IDT_Init        proc near               ; CODE XREF: sub_205+9↑p</span><br><span class="line">seg001:0000028B                 mov     edx, 0FCh</span><br><span class="line">seg001:00000290                 mov     eax, 80000h</span><br><span class="line">seg001:00000295                 mov     ax, dx</span><br><span class="line">seg001:00000298                 mov     dx, 8E00h</span><br><span class="line">seg001:0000029C                 lea     edi, ds:128h</span><br><span class="line">seg001:000002A2                 mov     ecx, 100h</span><br><span class="line">seg001:000002A7</span><br><span class="line">seg001:000002A7 loc_2A7:                                ; CODE XREF: IDT_Init+25↓j</span><br><span class="line">seg001:000002A7                 mov     [edi], eax</span><br><span class="line">seg001:000002A9                 mov     [edi+4], edx</span><br><span class="line">seg001:000002AC                 add     edi, 8</span><br><span class="line">seg001:000002AF                 dec     ecx</span><br><span class="line">seg001:000002B0                 jnz     short loc_2A7</span><br><span class="line">seg001:000002B2                 lidt    large fword ptr ds:11Ch</span><br><span class="line">seg001:000002B9                 retn</span><br><span class="line">seg001:000002B9 IDT_Init        endp</span><br></pre></td></tr></table></figure>
<p>在 bogus 中调试得到 IDTR 中的值为 0x012807ff（可以使用 show mode 命令来判断实模式向保护模式的转换）。依据之前的知识，可以知道基址为 0x0128 以及长度为 0x07ff：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:40&gt; x 0x11c</span><br><span class="line">[bochs]:</span><br><span class="line">0x000000000000011c &lt;bogus+       0&gt;:	0x012807ff</span><br></pre></td></tr></table></figure>
<p>中断门描述符被初始化为 <code>0000 8e00 0008 00fc</code>（偏移：0xfc；段选择符：0x8；P：1，即段是否在内存；DPL：0），如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:79&gt; x/20 0x128</span><br><span class="line">[bochs]:</span><br><span class="line">0x0000000000000128 &lt;bogus+       0&gt;:	0x000800fc	0x00008e00	0x000800fc	0x00008e00</span><br><span class="line">0x0000000000000138 &lt;bogus+      16&gt;:	0x000800fc	0x00008e00	0x000800fc	0x00008e00</span><br><span class="line">0x0000000000000148 &lt;bogus+      32&gt;:	0x000800fc	0x00008e00	0x000800fc	0x00008e00</span><br><span class="line">0x0000000000000158 &lt;bogus+      48&gt;:	0x000800fc	0x00008e00	0x000800fc	0x00008e00</span><br><span class="line">0x0000000000000168 &lt;bogus+      64&gt;:	0x000800fc	0x00008e00	0x000800fc	0x00008e00</span><br></pre></td></tr></table></figure>
<p>GDT_init 处，加载 GDTR 的地址为 122：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seg001:00000283 GDT_Init        proc near               ; CODE XREF: sub_205+E↑p</span><br><span class="line">seg001:00000283                 lgdt    large fword ptr ds:122h</span><br><span class="line">seg001:0000028A                 retn</span><br><span class="line">seg001:0000028A GDT_Init        endp</span><br></pre></td></tr></table></figure>
<p>同理，可以知道 GDT 基址为 0x0928 以及长度为 0x001f。不过这里没有对 GDT 进行初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:74&gt; x 0x122</span><br><span class="line">[bochs]:</span><br><span class="line">0x0000000000000122 &lt;bogus+       0&gt;:	0x0928001f</span><br></pre></td></tr></table></figure>
<p>在 22E~25F 的代码执行了一个 16 次的循环，其中 0x21~0x30 的中断向量描述符在内存的原始位置在 D08 处，循环中将每个中断向量存储到 128 处；然后调用了 NextHandler 函数，最后调用 <code>INT 21H</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">seg001:0000022E loc_22E:                                ; CODE XREF: sub_205+58↓j</span><br><span class="line">seg001:0000022E                 nop</span><br><span class="line">seg001:0000022F                 cmp     ebx, 10h</span><br><span class="line">seg001:00000232                 jge     short loc_25F</span><br><span class="line">seg001:00000234                 mov     eax, 80000h</span><br><span class="line">seg001:00000239                 lea     edx, ds:0D08h[ebx*4]</span><br><span class="line">seg001:00000240                 mov     edx, [edx]</span><br><span class="line">seg001:00000242                 mov     ax, dx</span><br><span class="line">seg001:00000245                 mov     dx, 8E00h</span><br><span class="line">seg001:00000249                 mov     ecx, 21h ; &apos;!&apos;</span><br><span class="line">seg001:0000024E                 add     ecx, ebx</span><br><span class="line">seg001:00000250                 lea     esi, ds:128h[ecx*8]</span><br><span class="line">seg001:00000257                 mov     [esi], eax</span><br><span class="line">seg001:00000259                 mov     [esi+4], edx</span><br><span class="line">seg001:0000025C                 inc     ebx</span><br><span class="line">seg001:0000025D                 jmp     short loc_22E</span><br><span class="line">seg001:0000025F ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:0000025F</span><br><span class="line">seg001:0000025F loc_25F:                                ; CODE XREF: sub_205+2D↑j</span><br><span class="line">seg001:0000025F                                         ; sub_205+61↓j</span><br><span class="line">seg001:0000025F                 call    NextHandler</span><br><span class="line">seg001:00000264                 int     21h             ; DOS -</span><br><span class="line">seg001:00000266                 jmp     short loc_25F</span><br><span class="line">seg001:00000266 sub_205         endp</span><br></pre></td></tr></table></figure>
<p>获取得到所有中断向量的地址如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">IDT[0x21]=32-Bit Interrupt Gate target=0x0008:0x00000b7c, DPL=0</span><br><span class="line">IDT[0x22]=32-Bit Interrupt Gate target=0x0008:0x00000b8a, DPL=0</span><br><span class="line">IDT[0x23]=32-Bit Interrupt Gate target=0x0008:0x00000ba1, DPL=0</span><br><span class="line">IDT[0x24]=32-Bit Interrupt Gate target=0x0008:0x00000bc1, DPL=0</span><br><span class="line">IDT[0x25]=32-Bit Interrupt Gate target=0x0008:0x00000be1, DPL=0</span><br><span class="line">IDT[0x26]=32-Bit Interrupt Gate target=0x0008:0x00000bfc, DPL=0</span><br><span class="line">IDT[0x27]=32-Bit Interrupt Gate target=0x0008:0x00000c17, DPL=0</span><br><span class="line">IDT[0x28]=32-Bit Interrupt Gate target=0x0008:0x00000c32, DPL=0</span><br><span class="line">IDT[0x29]=32-Bit Interrupt Gate target=0x0008:0x00000c4f, DPL=0</span><br><span class="line">IDT[0x2a]=32-Bit Interrupt Gate target=0x0008:0x00000c6c, DPL=0</span><br><span class="line">IDT[0x2b]=32-Bit Interrupt Gate target=0x0008:0x00000c84, DPL=0</span><br><span class="line">IDT[0x2c]=32-Bit Interrupt Gate target=0x0008:0x00000c96, DPL=0</span><br><span class="line">IDT[0x2d]=32-Bit Interrupt Gate target=0x0008:0x00000cb5, DPL=0</span><br><span class="line">IDT[0x2e]=32-Bit Interrupt Gate target=0x0008:0x00000cf7, DPL=0</span><br><span class="line">IDT[0x2f]=32-Bit Interrupt Gate target=0x0008:0x00000ce0, DPL=0</span><br><span class="line">IDT[0x30]=32-Bit Interrupt Gate target=0x0008:0x00000cd4, DPL=0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>在 IDA 中定位到所有中断向量的地址，分别对应着不同的函数，这一段代码后面会用到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">seg001:00000D7C                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000D83                 mov     [ecx], eax</span><br><span class="line">seg001:00000D85                 jmp     loc_EF8</span><br><span class="line">seg001:00000D8A ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000D8A                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000D91                 mov     eax, [eax]</span><br><span class="line">seg001:00000D93                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000D9A                 mov     [ecx], eax</span><br><span class="line">seg001:00000D9C                 jmp     loc_EF8</span><br><span class="line">seg001:00000DA1 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000DA1                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000DA8                 mov     eax, [eax]</span><br><span class="line">seg001:00000DAA                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000DB1                 lea     eax, ds:0D48h[eax*4]</span><br><span class="line">seg001:00000DB8                 mov     eax, [eax]</span><br><span class="line">seg001:00000DBA                 mov     [ecx], eax</span><br><span class="line">seg001:00000DBC                 jmp     loc_EF8</span><br><span class="line">seg001:00000DC1 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000DC1                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000DC8                 mov     eax, [eax]</span><br><span class="line">seg001:00000DCA                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000DD1                 mov     ecx, [ecx]</span><br><span class="line">seg001:00000DD3                 lea     ecx, ds:0D48h[ecx*4]</span><br><span class="line">seg001:00000DDA                 mov     [ecx], eax</span><br><span class="line">seg001:00000DDC                 jmp     loc_EF8</span><br><span class="line">seg001:00000DE1 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000DE1                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000DE8                 mov     edx, [eax]</span><br><span class="line">seg001:00000DEA                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000DF1                 mov     eax, [ecx]</span><br><span class="line">seg001:00000DF3                 add     eax, edx</span><br><span class="line">seg001:00000DF5                 mov     [ecx], eax</span><br><span class="line">seg001:00000DF7                 jmp     loc_EF8</span><br><span class="line">seg001:00000DFC ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000DFC                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E03                 mov     edx, [eax]</span><br><span class="line">seg001:00000E05                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E0C                 mov     eax, [ecx]</span><br><span class="line">seg001:00000E0E                 sub     eax, edx</span><br><span class="line">seg001:00000E10                 mov     [ecx], eax</span><br><span class="line">seg001:00000E12                 jmp     loc_EF8</span><br><span class="line">seg001:00000E17 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E17                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E1E                 mov     edx, [eax]</span><br><span class="line">seg001:00000E20                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E27                 mov     eax, [ecx]</span><br><span class="line">seg001:00000E29                 xor     eax, edx</span><br><span class="line">seg001:00000E2B                 mov     [ecx], eax</span><br><span class="line">seg001:00000E2D                 jmp     loc_EF8</span><br><span class="line">seg001:00000E32 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E32                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E39                 mov     eax, [eax]</span><br><span class="line">seg001:00000E3B                 lea     edx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E42                 mov     cl, al</span><br><span class="line">seg001:00000E44                 mov     eax, [edx]</span><br><span class="line">seg001:00000E46                 shl     eax, cl</span><br><span class="line">seg001:00000E48                 mov     [edx], eax</span><br><span class="line">seg001:00000E4A                 jmp     loc_EF8</span><br><span class="line">seg001:00000E4F ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E4F                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E56                 mov     eax, [eax]</span><br><span class="line">seg001:00000E58                 lea     edx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E5F                 mov     cl, al</span><br><span class="line">seg001:00000E61                 mov     eax, [edx]</span><br><span class="line">seg001:00000E63                 shr     eax, cl</span><br><span class="line">seg001:00000E65                 mov     [edx], eax</span><br><span class="line">seg001:00000E67                 jmp     loc_EF8</span><br><span class="line">seg001:00000E6C ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E6C                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E73                 mov     eax, [eax]</span><br><span class="line">seg001:00000E75                 lea     ecx, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E7C                 mov     edx, [ecx]</span><br><span class="line">seg001:00000E7E                 and     eax, edx</span><br><span class="line">seg001:00000E80                 mov     [ecx], eax</span><br><span class="line">seg001:00000E82                 jmp     short loc_EF8</span><br><span class="line">seg001:00000E84 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E84                 lea     eax, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000E8B                 mov     eax, [eax]</span><br><span class="line">seg001:00000E8D                 lea     ecx, dword_B34+44h</span><br><span class="line">seg001:00000E93                 mov     [ecx], eax</span><br><span class="line">seg001:00000E95                 iret</span><br><span class="line">seg001:00000E96 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000E96                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000E9D                 mov     eax, [eax]</span><br><span class="line">seg001:00000E9F                 test    eax, eax</span><br><span class="line">seg001:00000EA1                 jnz     short loc_EF8</span><br><span class="line">seg001:00000EA3                 lea     eax, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000EAA                 mov     eax, [eax]</span><br><span class="line">seg001:00000EAC                 lea     ecx, dword_B34+44h</span><br><span class="line">seg001:00000EB2                 mov     [ecx], eax</span><br><span class="line">seg001:00000EB4                 iret</span><br><span class="line">seg001:00000EB5 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000EB5                 lea     eax, ds:0B64h[eax*4]</span><br><span class="line">seg001:00000EBC                 mov     eax, [eax]</span><br><span class="line">seg001:00000EBE                 test    eax, eax</span><br><span class="line">seg001:00000EC0                 jz      short loc_EF8</span><br><span class="line">seg001:00000EC2                 lea     eax, ds:0B64h[ecx*4]</span><br><span class="line">seg001:00000EC9                 mov     eax, [eax]</span><br><span class="line">seg001:00000ECB                 lea     ecx, dword_B34+44h</span><br><span class="line">seg001:00000ED1                 mov     [ecx], eax</span><br><span class="line">seg001:00000ED3                 iret</span><br><span class="line">seg001:00000ED4 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000ED4                 lea     eax, unk_F94</span><br><span class="line">seg001:00000EDA                 call    sub_2EA</span><br><span class="line">seg001:00000EDF                 hlt</span><br><span class="line">seg001:00000EE0 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00000EE0                 lea     eax, unk_FA0</span><br><span class="line">seg001:00000EE6                 call    sub_2EA</span><br><span class="line">seg001:00000EEB                 lea     eax, word_FAE</span><br><span class="line">seg001:00000EF1                 call    sub_2EA</span><br><span class="line">seg001:00000EF6                 hlt</span><br></pre></td></tr></table></figure>
<p>接下来在 NextHandler 处，包括 <code>INT 21H</code> 的三条指令，类似于一个 switch 语句，根据以前的做题经验，基本可以判断出是个虚拟机。在 NextHandler 函数中，首先从 B78 处获取值作为 D48 的偏移，将 D48 处的值分别赋值给 给 065（操作符）、ecx（操作数 1）、eax（操作数 2），而 065 地址处的值为 21H，即指令 <code>INT 21H</code> 的操作数，故这里中断的调用是和 edi 的取值有关系的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seg001:00000268 NextHandler     proc near               ; CODE XREF: sub_205:loc_25F↑p</span><br><span class="line">seg001:00000268                 mov     edi, large ds:0B78h</span><br><span class="line">seg001:0000026E                 lea     edi, ds:0D48h[edi*4]</span><br><span class="line">seg001:00000275                 mov     eax, [edi]</span><br><span class="line">seg001:00000277                 mov     large ds:65h, al</span><br><span class="line">seg001:0000027C                 mov     ecx, [edi+4]</span><br><span class="line">seg001:0000027F                 mov     eax, [edi+8]</span><br><span class="line">seg001:00000282                 retn</span><br><span class="line">seg001:00000282 NextHandler     endp</span><br></pre></td></tr></table></figure>
<p>回过去看上面中断代码的最后一部分是将上面 edi 中的值加 3，即取下一组指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">seg001:00000EF8 loc_EF8:                                ; CODE XREF: seg001:00000D85↑j</span><br><span class="line">seg001:00000EF8                                         ; seg001:00000D9C↑j ...</span><br><span class="line">seg001:00000EF8                 lea     ecx, dword_B34+44h</span><br><span class="line">seg001:00000EFE                 mov     eax, [ecx]</span><br><span class="line">seg001:00000F00                 add     eax, 3</span><br><span class="line">seg001:00000F03                 mov     [ecx], eax</span><br><span class="line">seg001:00000F05                 iret</span><br></pre></td></tr></table></figure>
<p>那么之前的那段代码就是不同的操作符时进行的中断调用。这里就先把每个中断的部分的代码进行翻译（buf 的地址为 B64，code 的地址为 D48，pc 的地址为 B78）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">中断编号</th>
<th style="text-align:center">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x21</td>
<td style="text-align:center"><code>buf[a] = b</code></td>
</tr>
<tr>
<td style="text-align:center">0x22</td>
<td style="text-align:center"><code>buf[a] = buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x23</td>
<td style="text-align:center"><code>buf[a] = code[buf[b]]</code></td>
</tr>
<tr>
<td style="text-align:center">0x24</td>
<td style="text-align:center"><code>code[buf[a]] = buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x25</td>
<td style="text-align:center"><code>buf[a] += buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x26</td>
<td style="text-align:center"><code>buf[a] -= buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x27</td>
<td style="text-align:center"><code>buf[a] ^= buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x28</td>
<td style="text-align:center"><code>buf[a] &lt;&lt;= buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x29</td>
<td style="text-align:center"><code>buf[a] &gt;&gt;= buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x2A</td>
<td style="text-align:center"><code>buf[a] &amp;= buf[b]</code></td>
</tr>
<tr>
<td style="text-align:center">0x2B</td>
<td style="text-align:center"><code>pc = a</code></td>
</tr>
<tr>
<td style="text-align:center">0x2C</td>
<td style="text-align:center"><code>if(buf[b] == 0) pc = buf[a]</code></td>
</tr>
<tr>
<td style="text-align:center">0x2D</td>
<td style="text-align:center"><code>if(buf[b] != 0) pc = buf[a]</code></td>
</tr>
<tr>
<td style="text-align:center">0x2E</td>
<td style="text-align:center">终止 CPU 运行，即 hlt 指令</td>
</tr>
<tr>
<td style="text-align:center">0x2F</td>
<td style="text-align:center">输出 flag 正确提示</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">输出 flag 错误提示</td>
</tr>
</tbody>
</table>
<p>根据上面的分析，用 IDAPython 把虚拟机指令 dump 下来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">code = []</span><br><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> range(<span class="number">0x0F48</span>, <span class="number">0x11E0</span>, <span class="number">12</span>):</span><br><span class="line">    ins = Dword(addr)</span><br><span class="line">    op1 = Dword(addr + <span class="number">4</span>)</span><br><span class="line">    op2 = Dword(addr + <span class="number">8</span>)</span><br><span class="line">    code.append(ins)</span><br><span class="line">    code.append(op1)</span><br><span class="line">    code.append(op2)</span><br><span class="line"><span class="keyword">print</span> code</span><br></pre></td></tr></table></figure>
<p>然后用脚本处理一下，得到伪代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line">buf[<span class="number">0</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] ^= buf[<span class="number">1</span>]</span><br><span class="line">code[buf[<span class="number">1</span>]] = buf[<span class="number">1</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '129')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '129')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '130')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '130')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '131')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '131')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '132')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '132')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '133')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '133')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '134')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '134')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '135')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '135')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '136')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '136')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">2</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '137')</span></span><br><span class="line">buf[<span class="number">3</span>] = buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">8</span></span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] &lt;&lt;= (buf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">3</span>] ^= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">3</span>]] <span class="comment"># 0</span></span><br><span class="line">code[buf[<span class="number">3</span>]] = buf[<span class="number">2</span>] <span class="comment"># 0</span></span><br><span class="line">buf[<span class="number">2</span>] ^= buf[<span class="number">4</span>]</span><br><span class="line">code[buf[<span class="number">0</span>]] = buf[<span class="number">2</span>] <span class="comment"># ('Write code, offset:', '137')</span></span><br><span class="line">buf[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">1</span>]</span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] -= buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">2</span>] <span class="comment"># jmp 9</span></span><br><span class="line">buf[<span class="number">0</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '129')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '138')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'wrong'</span></span><br></pre></td></tr></table></figure>
<p>上面是在 <code>buf[3] != 0</code> 的时候，输出 wrong 的情况，如果在这个条件判断中都正确的话，会产生以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">buf[<span class="number">0</span>] = <span class="number">129</span></span><br><span class="line">buf[<span class="number">1</span>] = buf[<span class="number">0</span>]</span><br><span class="line">buf[<span class="number">2</span>] = <span class="number">9</span></span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">2</span>]</span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '129')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '138')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '130')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '139')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '131')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '140')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '132')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '141')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '133')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '142')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '134')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '143')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '135')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '144')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '136')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '145')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line">buf[<span class="number">3</span>] = code[buf[<span class="number">0</span>]] <span class="comment"># ('Read code, offset:', '137')</span></span><br><span class="line">buf[<span class="number">4</span>] = code[buf[<span class="number">1</span>]] <span class="comment"># ('Read code, offset:', '146')</span></span><br><span class="line">buf[<span class="number">3</span>] -= buf[<span class="number">4</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">126</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">3</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 126</span></span><br><span class="line">buf[<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">buf[<span class="number">0</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">1</span>] += buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">2</span>] -= buf[<span class="number">3</span>]</span><br><span class="line">buf[<span class="number">4</span>] = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> buf[<span class="number">2</span>] != <span class="number">0</span>:</span><br><span class="line">	pc = buf[<span class="number">4</span>] <span class="comment"># jmp 90</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'right'</span></span><br></pre></td></tr></table></figure>
<p>人脑逆向机简化一波代码，就是一个 9 次的循环异或，并在最后进行比较：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">129</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    code[i] = code[i] ^ (code[i] &lt;&lt; <span class="number">8</span>) ^ (code[i] &lt;&lt; <span class="number">16</span>) ^ (code[i] &lt;&lt; <span class="number">24</span>) ^ code[i - <span class="number">1</span>] ^ (code[i - <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) ^ (code[i - <span class="number">1</span>] &lt;&lt; <span class="number">16</span>) ^ (code[i - <span class="number">1</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i - <span class="number">138</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">if</span> code[<span class="number">138</span> + i] - code[<span class="number">129</span> + i] != <span class="number">0</span>:</span><br><span class="line">	    <span class="keyword">print</span> <span class="string">'wrong'</span></span><br><span class="line">        exit()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'right'</span></span><br></pre></td></tr></table></figure>
<p>这里已知正确的数据在计算后的结果，可以通过爆破来得到（爆破范围比较大，Python 会消耗很多时间，这里用 C#）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line"></span><br><span class="line">namespace Solve &#123;</span><br><span class="line">	class Program &#123;</span><br><span class="line">		public static byte[] intToBytes(uint value) &#123;</span><br><span class="line">			byte[] res = new byte[4];</span><br><span class="line">			res[3] = (byte) ((value &gt;&gt; 24) &amp; 0xFF);</span><br><span class="line">			res[2] = (byte) ((value &gt;&gt; 16) &amp; 0xFF);</span><br><span class="line">			res[1] = (byte) ((value &gt;&gt; 8) &amp; 0xFF);</span><br><span class="line">			res[0] = (byte) (value &amp; 0xFF);</span><br><span class="line">			return res;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public static string asciiToString(byte[] array) &#123;</span><br><span class="line">			return Convert.ToString(System.Text.Encoding.ASCII.GetString(array));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		static void Main(string[] args) &#123;</span><br><span class="line">			var data = new uint[] &#123;</span><br><span class="line">				0x61646238, 0x36353465, 0x6361352d, 0x31312d38, 0x612d3965, 0x2d316331, 0x39653838, 0x30386566, 0x66616566, 0x57635565, 0x06530401, 0x1f494949, 0x5157071f, 0x575f4357, 0x57435e57, 0x4357020a, 0x575e035e, 0x0f590000, 0x6e6f7277, 0x20202067, 0x00202020, 0x72726f63, 0x20746365, 0x20202020, 0x6c660020, 0x69206761, 0x6c662073, 0x597b6761, 0x5072756f, 0x68637461, 0x2020207d, 0x20202020, 0x20202020, 0x20202020, 0x20202020, 0x20202020, 0x20202020, 0xffffff00, 0xffffffff</span><br><span class="line">			&#125;;</span><br><span class="line">			var ans = new uint[data.Length];</span><br><span class="line">			var patch = new byte[data.Length * 4];</span><br><span class="line">			for(uint i = 0; i &lt; 9; i++) &#123;</span><br><span class="line">				uint t = 0;</span><br><span class="line">				for(uint j = 0; j &lt;= 0x7FFFFFFF; j++) &#123;</span><br><span class="line">					t = j ^ (j &lt;&lt; 8) ^ (j &lt;&lt; 16) ^ (j &lt;&lt; 24);</span><br><span class="line">					if(i &gt; 0) &#123;</span><br><span class="line">						t ^= ans[i - 1] ^ (ans[i - 1] &lt;&lt; 8) ^ (ans[i - 1] &lt;&lt; 16) ^ (ans[i - 1] &lt;&lt; 24);</span><br><span class="line">					&#125;</span><br><span class="line">					if(t == data[i + 9]) &#123; // 0x57635565</span><br><span class="line">						ans[i] = j;</span><br><span class="line">						patch[4 * i] = intToBytes(j)[0];</span><br><span class="line">						patch[4 * i + 1] = intToBytes(j)[1];</span><br><span class="line">						patch[4 * i + 2] = intToBytes(j)[2];</span><br><span class="line">						patch[4 * i + 3] = intToBytes(j)[3];</span><br><span class="line">						Console.WriteLine(&quot;0x&#123;0:X8&#125;&quot;, j);</span><br><span class="line">						break;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			string flag = asciiToString(patch);</span><br><span class="line">			Console.WriteLine(flag);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然在已知数据的情况下也可以直接逆回来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">data = [<span class="number">0x57635565</span>, <span class="number">0x06530401</span>, <span class="number">0x1F494949</span>, <span class="number">0x5157071F</span>, <span class="number">0x575F4357</span>, <span class="number">0x57435E57</span>, <span class="number">0x4357020A</span>, <span class="number">0x575E035E</span>, <span class="number">0x0F590000</span>, <span class="number">0x00000000</span>]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    flag += libnum.n2s(data[i] ^ ((data[i] &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFF</span>))[::<span class="number">-1</span>]</span><br><span class="line">    data[i + <span class="number">1</span>] = data[i] ^ data[i + <span class="number">1</span>]</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="bochs-调试"><a href="#bochs-调试" class="headerlink" title="bochs 调试"></a>bochs 调试</h1><p>这道题其实主要通过 bochs 进行动态调试来分析，下面附上动态调试的一些过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:1&gt; b 0x7c00</span><br><span class="line">&lt;bochs:2&gt; c</span><br><span class="line">00000004662i[BIOS  ] $Revision: 13073 $ $Date: 2017-02-16 22:43:52 +0100 (Do, 16. Feb 2017) $</span><br><span class="line">00000318050i[KBD   ] reset-disable command received</span><br><span class="line">00000320819i[BIOS  ] Starting rombios32</span><br><span class="line">00000321257i[BIOS  ] Shutdown flag 0</span><br><span class="line">00000321840i[BIOS  ] ram_size=0x02000000</span><br><span class="line">00000322261i[BIOS  ] ram_end=32MB</span><br><span class="line">00000362829i[BIOS  ] Found 1 cpu(s)</span><br><span class="line">00000376413i[BIOS  ] bios_table_addr: 0x000f9cd8 end=0x000fcc00</span><br><span class="line">00000704208i[PCI   ] i440FX PMC write to PAM register 59 (TLB Flush)</span><br><span class="line">00001032137i[P2ISA ] PCI IRQ routing: PIRQA# set to 0x0b</span><br><span class="line">00001032156i[P2ISA ] PCI IRQ routing: PIRQB# set to 0x09</span><br><span class="line">00001032175i[P2ISA ] PCI IRQ routing: PIRQC# set to 0x0b</span><br><span class="line">00001032194i[P2ISA ] PCI IRQ routing: PIRQD# set to 0x09</span><br><span class="line">00001032204i[P2ISA ] write: ELCR2 = 0x0a</span><br><span class="line">00001032974i[BIOS  ] PIIX3/PIIX4 init: elcr=00 0a</span><br><span class="line">00001040697i[BIOS  ] PCI: bus=0 devfn=0x00: vendor_id=0x8086 device_id=0x1237 class=0x0600</span><br><span class="line">00001042976i[BIOS  ] PCI: bus=0 devfn=0x08: vendor_id=0x8086 device_id=0x7000 class=0x0601</span><br><span class="line">00001045094i[BIOS  ] PCI: bus=0 devfn=0x09: vendor_id=0x8086 device_id=0x7010 class=0x0101</span><br><span class="line">00001045323i[PIDE  ] new BM-DMA address: 0xc000</span><br><span class="line">00001045939i[BIOS  ] region 4: 0x0000c000</span><br><span class="line">00001047953i[BIOS  ] PCI: bus=0 devfn=0x0a: vendor_id=0x8086 device_id=0x7020 class=0x0c03</span><br><span class="line">00001048157i[UHCI  ] new base address: 0xc020</span><br><span class="line">00001048773i[BIOS  ] region 4: 0x0000c020</span><br><span class="line">00001048901i[UHCI  ] new irq line = 9</span><br><span class="line">00001050796i[BIOS  ] PCI: bus=0 devfn=0x0b: vendor_id=0x8086 device_id=0x7113 class=0x0680</span><br><span class="line">00001051028i[ACPI  ] new irq line = 11</span><br><span class="line">00001051040i[ACPI  ] new irq line = 9</span><br><span class="line">00001051065i[ACPI  ] new PM base address: 0xb000</span><br><span class="line">00001051079i[ACPI  ] new SM base address: 0xb100</span><br><span class="line">00001051107i[PCI   ] setting SMRAM control register to 0x4a</span><br><span class="line">00001215200i[CPU0  ] Enter to System Management Mode</span><br><span class="line">00001215200i[CPU0  ] enter_system_management_mode: temporary disable VMX while in SMM mode</span><br><span class="line">00001215210i[CPU0  ] RSM: Resuming from System Management Mode</span><br><span class="line">00001379231i[PCI   ] setting SMRAM control register to 0x0a</span><br><span class="line">00001394138i[BIOS  ] MP table addr=0x000f9db0 MPC table addr=0x000f9ce0 size=0xc8</span><br><span class="line">00001395960i[BIOS  ] SMBIOS table addr=0x000f9dc0</span><br><span class="line">00001398141i[BIOS  ] ACPI tables: RSDP addr=0x000f9ee0 ACPI DATA addr=0x01ff0000 size=0xf72</span><br><span class="line">00001401353i[BIOS  ] Firmware waking vector 0x1ff00cc</span><br><span class="line">00001403148i[PCI   ] i440FX PMC write to PAM register 59 (TLB Flush)</span><br><span class="line">00001403871i[BIOS  ] bios_table_cur_addr: 0x000f9f04</span><br><span class="line">00001531488i[VBIOS ] VGABios $Id: vgabios.c,v 1.76 2013/02/10 08:07:03 vruppert Exp $</span><br><span class="line">00001531559i[BXVGA ] VBE known Display Interface b0c0</span><br><span class="line">00001531591i[BXVGA ] VBE known Display Interface b0c5</span><br><span class="line">00001534516i[VBIOS ] VBE Bios $Id: vbe.c,v 1.65 2014/07/08 18:02:25 vruppert Exp $</span><br><span class="line">00014040189i[BIOS  ] Booting from 0000:7c00</span><br><span class="line">(0) Breakpoint 1, 0x0000000000007c00 in ?? ()</span><br><span class="line">Next at t=14040244</span><br><span class="line">(0) [0x000000007c00] 0000:7c00 (unk. ctxt): jmpf 0x07c0:0005          ; ea0500c007</span><br></pre></td></tr></table></figure>
<p>可以用 <code>show mode</code> 命令来显示实模式向保护模式的转换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:3&gt; show mode</span><br><span class="line">show mode switch: ON</span><br><span class="line">show mask is: mode</span><br></pre></td></tr></table></figure>
<p>利用 <code>u</code> 命令来查看汇编代码，这里是实模式的部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:7&gt; u/40 0x7c00</span><br><span class="line">00007c00: (                    ): jmpf 0x07c0:0005          ; ea0500c007</span><br><span class="line">00007c05: (                    ): mov ax, cs                ; 8cc8</span><br><span class="line">00007c07: (                    ): mov ds, ax                ; 8ed8</span><br><span class="line">00007c09: (                    ): mov ss, ax                ; 8ed0</span><br><span class="line">00007c0b: (                    ): mov sp, 0x0400            ; bc0004</span><br><span class="line">00007c0e: (                    ): cld                       ; fc</span><br><span class="line">00007c0f: (                    ): mov ax, 0x0003            ; b80300</span><br><span class="line">00007c12: (                    ): int 0x10                  ; cd10</span><br><span class="line">00007c14: (                    ): mov dx, 0x0000            ; ba0000</span><br><span class="line">00007c17: (                    ): mov cx, 0x0002            ; b90200</span><br><span class="line">00007c1a: (                    ): mov ax, 0x1000            ; b80010</span><br><span class="line">00007c1d: (                    ): mov es, ax                ; 8ec0</span><br><span class="line">00007c1f: (                    ): xor bx, bx                ; 31db</span><br><span class="line">00007c21: (                    ): mov ax, 0x0228            ; b82802</span><br><span class="line">00007c24: (                    ): int 0x13                  ; cd13</span><br><span class="line">00007c26: (                    ): jnb .+2                   ; 7302</span><br><span class="line">00007c28: (                    ): jmp .-2                   ; ebfe</span><br><span class="line">00007c2a: (                    ): cli                       ; fa</span><br><span class="line">00007c2b: (                    ): mov ax, 0x1000            ; b80010</span><br><span class="line">00007c2e: (                    ): mov ds, ax                ; 8ed8</span><br><span class="line">00007c30: (                    ): xor ax, ax                ; 31c0</span><br><span class="line">00007c32: (                    ): mov es, ax                ; 8ec0</span><br><span class="line">00007c34: (                    ): mov cx, 0x2000            ; b90020</span><br><span class="line">00007c37: (                    ): sub si, si                ; 29f6</span><br><span class="line">00007c39: (                    ): sub di, di                ; 29ff</span><br><span class="line">00007c3b: (                    ): rep movsb byte ptr es:[di], byte ptr ds:[si] ; f3a4</span><br><span class="line">00007c3d: (                    ): mov ax, 0x07c0            ; b8c007</span><br><span class="line">00007c40: (                    ): mov ds, ax                ; 8ed8</span><br><span class="line">00007c42: (                    ): lidt ds:0x006f            ; 0f011e6f00</span><br><span class="line">00007c47: (                    ): lgdt ds:0x0075            ; 0f01167500</span><br><span class="line">00007c4c: (                    ): mov ax, 0x0001            ; b80100</span><br><span class="line">00007c4f: (                    ): lmsw ax                   ; 0f01f0</span><br><span class="line">00007c52: (                    ): jmpf 0x0008:0000          ; ea00000800</span><br></pre></td></tr></table></figure>
<p>在指令 <code>lmsw ax</code> 处看到实模式向保护模式的转换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:39&gt; n</span><br><span class="line">Next at t=15885325</span><br><span class="line">(0) [0x000000007c4f] 07c0:004f (unk. ctxt): lmsw ax                   ; 0f01f0</span><br><span class="line">&lt;bochs:40&gt;</span><br><span class="line">00015885326: switched from &apos;real mode&apos; to &apos;protected mode&apos;</span><br><span class="line">Next at t=15885326</span><br><span class="line">(0) [0x000000007c52] 07c0:0000000000000052 (unk. ctxt): jmpf 0x0008:0000          ; ea00000800</span><br></pre></td></tr></table></figure>
<p>保护模式的前一段部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:42&gt; u/20 0x00</span><br><span class="line">00000000: (                    ): mov eax, 0x00000010       ; b810000000</span><br><span class="line">00000005: (                    ): mov ds, ax                ; 8ed8</span><br><span class="line">00000007: (                    ): lss esp, ds:0x00000b5c    ; 0fb2255c0b0000</span><br><span class="line">0000000e: (                    ): call .+120                ; e878000000</span><br><span class="line">00000013: (                    ): call .+107                ; e86b000000</span><br><span class="line">00000018: (                    ): mov eax, 0x00000010       ; b810000000</span><br><span class="line">0000001d: (                    ): mov ds, ax                ; 8ed8</span><br><span class="line">0000001f: (                    ): mov es, ax                ; 8ec0</span><br><span class="line">00000021: (                    ): mov fs, ax                ; 8ee0</span><br><span class="line">00000023: (                    ): mov gs, ax                ; 8ee8</span><br><span class="line">00000025: (                    ): lss esp, ds:0x00000b5c    ; 0fb2255c0b0000</span><br><span class="line">0000002c: (                    ): xor ebx, ebx              ; 31db</span><br></pre></td></tr></table></figure>
<p>IDTR 的初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:39&gt; u/20 0x8b</span><br><span class="line">0000008b: (                    ): mov edx, 0x000000fc       ; bafc000000</span><br><span class="line">00000090: (                    ): mov eax, 0x00080000       ; b800000800</span><br><span class="line">00000095: (                    ): mov ax, dx                ; 6689d0</span><br><span class="line">00000098: (                    ): mov dx, 0x8e00            ; 66ba008e</span><br><span class="line">0000009c: (                    ): lea edi, dword ptr ds:0x00000128 ; 8d3d28010000</span><br><span class="line">000000a2: (                    ): mov ecx, 0x00000100       ; b900010000</span><br><span class="line">000000a7: (                    ): mov dword ptr ds:[edi], eax ; 8907</span><br><span class="line">000000a9: (                    ): mov dword ptr ds:[edi+4], edx ; 895704</span><br><span class="line">000000ac: (                    ): add edi, 0x00000008       ; 83c708</span><br><span class="line">000000af: (                    ): dec ecx                   ; 49</span><br><span class="line">000000b0: (                    ): jnz .-11                  ; 75f5</span><br><span class="line">000000b2: (                    ): lidt ds:0x0000011c        ; 0f011d1c010000</span><br><span class="line">000000b9: (                    ): ret                       ; c3</span><br></pre></td></tr></table></figure>
<p>GDTR 的初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:68&gt; u/10 0x83</span><br><span class="line">00000083: (                    ): lgdt ds:0x00000122        ; 0f011522010000</span><br><span class="line">0000008a: (                    ): ret                       ; c3</span><br></pre></td></tr></table></figure>
<p>用 <code>sreg</code> 命令可以看到 GDTR 和 IDTR 寄存器被初始化了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:75&gt; sreg</span><br><span class="line">es:0x0000, dh=0x00009300, dl=0x0000ffff, valid=7</span><br><span class="line">	Data segment, base=0x00000000, limit=0x0000ffff, Read/Write, Accessed</span><br><span class="line">cs:0x0008, dh=0x00c09b00, dl=0x000007ff, valid=1</span><br><span class="line">	Code segment, base=0x00000000, limit=0x007fffff, Execute/Read, Non-Conforming, Accessed, 32-bit</span><br><span class="line">ss:0x0010, dh=0x00c09300, dl=0x000007ff, valid=7</span><br><span class="line">	Data segment, base=0x00000000, limit=0x007fffff, Read/Write, Accessed</span><br><span class="line">ds:0x0010, dh=0x00c09300, dl=0x000007ff, valid=7</span><br><span class="line">	Data segment, base=0x00000000, limit=0x007fffff, Read/Write, Accessed</span><br><span class="line">fs:0x0000, dh=0x00009300, dl=0x0000ffff, valid=1</span><br><span class="line">	Data segment, base=0x00000000, limit=0x0000ffff, Read/Write, Accessed</span><br><span class="line">gs:0x0000, dh=0x00009300, dl=0x0000ffff, valid=1</span><br><span class="line">	Data segment, base=0x00000000, limit=0x0000ffff, Read/Write, Accessed</span><br><span class="line">ldtr:0x0000, dh=0x00008200, dl=0x0000ffff, valid=1</span><br><span class="line">tr:0x0000, dh=0x00008b00, dl=0x0000ffff, valid=1</span><br><span class="line">gdtr:base=0x0000000000000928, limit=0x1f</span><br><span class="line">idtr:base=0x0000000000000128, limit=0x7ff</span><br></pre></td></tr></table></figure>
<p>最后是虚拟机指令部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:43&gt; u/110 0xb7c</span><br><span class="line">00000b7c: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000b83: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000b85: (                    ): jmp .+366                 ; e96e010000</span><br><span class="line">00000b8a: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000b91: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000b93: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000b9a: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000b9c: (                    ): jmp .+343                 ; e957010000</span><br><span class="line">00000ba1: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000ba8: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000baa: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000bb1: (                    ): lea eax, dword ptr ds:[eax*4+3400] ; 8d0485480d0000</span><br><span class="line">00000bb8: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000bba: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000bbc: (                    ): jmp .+311                 ; e937010000</span><br><span class="line">00000bc1: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000bc8: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000bca: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000bd1: (                    ): mov ecx, dword ptr ds:[ecx] ; 8b09</span><br><span class="line">00000bd3: (                    ): lea ecx, dword ptr ds:[ecx*4+3400] ; 8d0c8d480d0000</span><br><span class="line">00000bda: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000bdc: (                    ): jmp .+279                 ; e917010000</span><br><span class="line">00000be1: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000be8: (                    ): mov edx, dword ptr ds:[eax] ; 8b10</span><br><span class="line">00000bea: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000bf1: (                    ): mov eax, dword ptr ds:[ecx] ; 8b01</span><br><span class="line">00000bf3: (                    ): add eax, edx              ; 01d0</span><br><span class="line">00000bf5: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000bf7: (                    ): jmp .+252                 ; e9fc000000</span><br><span class="line">00000bfc: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c03: (                    ): mov edx, dword ptr ds:[eax] ; 8b10</span><br><span class="line">00000c05: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000c0c: (                    ): mov eax, dword ptr ds:[ecx] ; 8b01</span><br><span class="line">00000c0e: (                    ): sub eax, edx              ; 29d0</span><br><span class="line">00000c10: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000c12: (                    ): jmp .+225                 ; e9e1000000</span><br><span class="line">00000c17: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c1e: (                    ): mov edx, dword ptr ds:[eax] ; 8b10</span><br><span class="line">00000c20: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000c27: (                    ): mov eax, dword ptr ds:[ecx] ; 8b01</span><br><span class="line">00000c29: (                    ): xor eax, edx              ; 31d0</span><br><span class="line">00000c2b: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000c2d: (                    ): jmp .+198                 ; e9c6000000</span><br><span class="line">00000c32: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c39: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000c3b: (                    ): lea edx, dword ptr ds:[ecx*4+2916] ; 8d148d640b0000</span><br><span class="line">00000c42: (                    ): mov cl, al                ; 88c1</span><br><span class="line">00000c44: (                    ): mov eax, dword ptr ds:[edx] ; 8b02</span><br><span class="line">00000c46: (                    ): shl eax, cl               ; d3e0</span><br><span class="line">00000c48: (                    ): mov dword ptr ds:[edx], eax ; 8902</span><br><span class="line">00000c4a: (                    ): jmp .+169                 ; e9a9000000</span><br><span class="line">00000c4f: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c56: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000c58: (                    ): lea edx, dword ptr ds:[ecx*4+2916] ; 8d148d640b0000</span><br><span class="line">00000c5f: (                    ): mov cl, al                ; 88c1</span><br><span class="line">00000c61: (                    ): mov eax, dword ptr ds:[edx] ; 8b02</span><br><span class="line">00000c63: (                    ): shr eax, cl               ; d3e8</span><br><span class="line">00000c65: (                    ): mov dword ptr ds:[edx], eax ; 8902</span><br><span class="line">00000c67: (                    ): jmp .+140                 ; e98c000000</span><br><span class="line">00000c6c: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c73: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000c75: (                    ): lea ecx, dword ptr ds:[ecx*4+2916] ; 8d0c8d640b0000</span><br><span class="line">00000c7c: (                    ): mov edx, dword ptr ds:[ecx] ; 8b11</span><br><span class="line">00000c7e: (                    ): and eax, edx              ; 21d0</span><br><span class="line">00000c80: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000c82: (                    ): jmp .+116                 ; eb74</span><br><span class="line">00000c84: (                    ): lea eax, dword ptr ds:[ecx*4+2916] ; 8d048d640b0000</span><br><span class="line">00000c8b: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000c8d: (                    ): lea ecx, dword ptr ds:0x00000b78 ; 8d0d780b0000</span><br><span class="line">00000c93: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000c95: (                    ): iret                      ; cf</span><br><span class="line">00000c96: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000c9d: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000c9f: (                    ): test eax, eax             ; 85c0</span><br><span class="line">00000ca1: (                    ): jnz .+85                  ; 7555</span><br><span class="line">00000ca3: (                    ): lea eax, dword ptr ds:[ecx*4+2916] ; 8d048d640b0000</span><br><span class="line">00000caa: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000cac: (                    ): lea ecx, dword ptr ds:0x00000b78 ; 8d0d780b0000</span><br><span class="line">00000cb2: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000cb4: (                    ): iret                      ; cf</span><br><span class="line">00000cb5: (                    ): lea eax, dword ptr ds:[eax*4+2916] ; 8d0485640b0000</span><br><span class="line">00000cbc: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000cbe: (                    ): test eax, eax             ; 85c0</span><br><span class="line">00000cc0: (                    ): jz .+54                   ; 7436</span><br><span class="line">00000cc2: (                    ): lea eax, dword ptr ds:[ecx*4+2916] ; 8d048d640b0000</span><br><span class="line">00000cc9: (                    ): mov eax, dword ptr ds:[eax] ; 8b00</span><br><span class="line">00000ccb: (                    ): lea ecx, dword ptr ds:0x00000b78 ; 8d0d780b0000</span><br><span class="line">00000cd1: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000cd3: (                    ): iret                      ; cf</span><br><span class="line">00000cd4: (                    ): lea eax, dword ptr ds:0x00000f94 ; 8d05940f0000</span><br><span class="line">00000cda: (                    ): call .-3061               ; e80bf4ffff</span><br><span class="line">00000cdf: (                    ): hlt                       ; f4</span><br><span class="line">00000ce0: (                    ): lea eax, dword ptr ds:0x00000fa0 ; 8d05a00f0000</span><br><span class="line">00000ce6: (                    ): call .-3073               ; e8fff3ffff</span><br><span class="line">00000ceb: (                    ): lea eax, dword ptr ds:0x00000fae ; 8d05ae0f0000</span><br><span class="line">00000cf1: (                    ): call .-3084               ; e8f4f3ffff</span><br><span class="line">00000cf6: (                    ): hlt                       ; f4</span><br><span class="line">00000cf7: (                    ): hlt                       ; f4</span><br><span class="line">00000cf8: (                    ): lea ecx, dword ptr ds:0x00000b78 ; 8d0d780b0000</span><br><span class="line">00000cfe: (                    ): mov eax, dword ptr ds:[ecx] ; 8b01</span><br><span class="line">00000d00: (                    ): add eax, 0x00000003       ; 83c003</span><br><span class="line">00000d03: (                    ): mov dword ptr ds:[ecx], eax ; 8901</span><br><span class="line">00000d05: (                    ): iret                      ; cf</span><br></pre></td></tr></table></figure>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://www.52pojie.cn/thread-936377-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-936377-1-1.html</a><br><a href="https://blog.csdn.net/ice__snow/article/details/50654629" target="_blank" rel="noopener">https://blog.csdn.net/ice__snow/article/details/50654629</a><br><a href="https://blog.51cto.com/4201689/1420063" target="_blank" rel="noopener">https://blog.51cto.com/4201689/1420063</a><br><a href="https://www.cnblogs.com/playmak3r/p/12079833.html" target="_blank" rel="noopener">https://www.cnblogs.com/playmak3r/p/12079833.html</a><br><a href="https://blog.qrzbing.cn/2019/04/27/CISCN2019-strange-int/" target="_blank" rel="noopener">https://blog.qrzbing.cn/2019/04/27/CISCN2019-strange-int/</a><br><a href="http://imushan.com/2018/07/11/os/Bochs%E5%AD%A6%E4%B9%A0-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%AF%87/" target="_blank" rel="noopener">http://imushan.com/2018/07/11/os/Bochs%E5%AD%A6%E4%B9%A0-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%AF%87/</a><br><a href="https://www.cnblogs.com/mlzrq/p/10223079.html#%E4%BD%BF%E7%94%A8bochs%E8%B0%83%E8%AF%95" target="_blank" rel="noopener">https://www.cnblogs.com/mlzrq/p/10223079.html#%E4%BD%BF%E7%94%A8bochs%E8%B0%83%E8%AF%95</a><br><a href="https://mrh1s.top/posts/d2cf12e4/" target="_blank" rel="noopener">https://mrh1s.top/posts/d2cf12e4/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/re/">re</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/01/25/CTF-CheatSheet-by-AssassinQ/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          【TOP】CTF CheatSheet by AssassinQ
        
      </div>
    </a>
  
  
    <a href="/2020/01/21/[TODO]2019-CISCN-BabyBank/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2019-CISCN-BabyBank</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Analysis"><span class="nav-number">1.</span> <span class="nav-text">Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#何为-IDT-和-GDT？"><span class="nav-number">1.1.</span> <span class="nav-text">何为 IDT 和 GDT？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GDT"><span class="nav-number">1.1.1.</span> <span class="nav-text">GDT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDT"><span class="nav-number">1.1.2.</span> <span class="nav-text">IDT</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bochs-调试"><span class="nav-number">2.</span> <span class="nav-text">bochs 调试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">3.</span> <span class="nav-text">References</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2020 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
