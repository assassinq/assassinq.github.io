<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>2014-AliCTF-EvilAPK_3 | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="reandroid">
  
  
  
  
  <meta name="description" content="接触了一段时间的安卓后复现一下经典的题目，具体审计还有分析的步骤不做记录。">
<meta name="keywords" content="re,android">
<meta property="og:type" content="article">
<meta property="og:title" content="2014-AliCTF-EvilAPK_3">
<meta property="og:url" content="blog.b3ale.cn/2020/02/15/2014-AliCTF-EvilAPK_3/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="接触了一段时间的安卓后复现一下经典的题目，具体审计还有分析的步骤不做记录。">
<meta property="og:locale" content="default">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/1.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/2.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/3.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/4.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/5.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/6.png">
<meta property="og:image" content="/pics/2014-AliCTF-EvilAPK_3/7.png">
<meta property="og:updated_time" content="2020-02-19T02:44:54.523Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2014-AliCTF-EvilAPK_3">
<meta name="twitter:description" content="接触了一段时间的安卓后复现一下经典的题目，具体审计还有分析的步骤不做记录。">
<meta name="twitter:image" content="/pics/2014-AliCTF-EvilAPK_3/1.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2014-AliCTF-EvilAPK_3" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      2014-AliCTF-EvilAPK_3
    </h1>
  

      </header>
    
    <div class="article-meta">
      	<a href="/2020/02/15/2014-AliCTF-EvilAPK_3/" class="article-date">
	  <time datetime="2020-02-15T11:41:35.000Z" itemprop="datePublished">February 15, 2020</time>
	</a>

       
      

	  |
	  6.4k words
	  |
	  36 minute(s) to read
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>接触了一段时间的安卓后复现一下经典的题目，具体审计还有分析的步骤不做记录。</p>
<a id="more"></a>
<h1 id="Analysis（classes-dex）"><a href="#Analysis（classes-dex）" class="headerlink" title="Analysis（classes.dex）"></a>Analysis（classes.dex）</h1><p>这道题目是阿里 14 年出的，先导入 jadx 看看反编译后大概的内容。在 AndroidManifest.xml 中，可以看到先设置了入口点为 com.ali.mobisecenhance.StubApplication，猜测这里可能是阿里加固自己添加的一个入口，用来执行一些初始化的操作，比如解密 dex，反调试，检测模拟器等等之类的。调用完 StubApplication 后，才会调用 MainActivity：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span> <span class="attr">package</span>=<span class="string">"com.ali.tg.testapp"</span> <span class="attr">android:versionCode</span>=<span class="string">"1"</span> <span class="attr">android:versionName</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">"8"</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">"9"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span> <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span> <span class="attr">android:name</span>=<span class="string">"com.ali.mobisecenhance.StubApplication"</span> <span class="attr">android:debuggable</span>=<span class="string">"true"</span> <span class="attr">android:allowBackup</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".WebViewActivity"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在反编译出来的 Java 文件中，只能找到一个 StubApplication 类，其中的函数都是在 Native 层所实现，且加载了一个 mobisec 库。一般程序中是先执行 onCreate 函数，但 attachBaseContext 函数会早于 onCreate 函数执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ali.mobisecenhance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StubApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">(ClassLoader classLoader, Context context)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context context)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"mobisec"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在 lib 文件夹下看到 libmobisec.so 库，同时还可以看到在 assets 文件夹中有两个 jar 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── AndroidManifest.xml</span><br><span class="line">├── META-INF</span><br><span class="line">│   ├── MANIFEST.MF</span><br><span class="line">│   ├── TEST.RSA</span><br><span class="line">│   └── TEST.SF</span><br><span class="line">├── assets</span><br><span class="line">│   ├── cls.jar</span><br><span class="line">│   └── fak.jar</span><br><span class="line">├── classes.dex</span><br><span class="line">├── lib</span><br><span class="line">│   ├── armeabi</span><br><span class="line">│   │   ├── libhack.so</span><br><span class="line">│   │   ├── libmobisec.so</span><br><span class="line">│   │   └── libtranslate.so</span><br><span class="line">│   ├── armeabi-v7a</span><br><span class="line">│   │   ├── libhack.so</span><br><span class="line">│   │   ├── libmobisec.so</span><br><span class="line">│   │   └── libtranslate.so</span><br><span class="line">│   └── x86</span><br><span class="line">│       ├── libhack.so</span><br><span class="line">│       ├── libmobisec.so</span><br><span class="line">│       └── libtranslate.so</span><br><span class="line">├── res</span><br><span class="line">│   ├── drawable-hdpi</span><br><span class="line">│   │   ├── android.jpg</span><br><span class="line">│   │   └── android1.jpg</span><br><span class="line">│   ├── drawable-mdpi</span><br><span class="line">│   │   └── ic_launcher.png</span><br><span class="line">│   ├── drawable-xhdpi</span><br><span class="line">│   │   └── ic_launcher.png</span><br><span class="line">│   ├── drawable-xxhdpi</span><br><span class="line">│   │   └── ic_launcher.png</span><br><span class="line">│   └── layout</span><br><span class="line">│       ├── activity_main.xml</span><br><span class="line">│       └── webviewlayout.xml</span><br><span class="line">└── resources.arsc</span><br><span class="line"></span><br><span class="line">12 directories, 24 files</span><br></pre></td></tr></table></figure>
<p>file 一下，发现是 cls.jar 是一段不可识别的数据，fak.jar 判断出来是个 zip 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ file cls.jar</span><br><span class="line">cls.jar: data</span><br><span class="line"></span><br><span class="line">$ file fak.jar</span><br><span class="line">fak.jar: Zip archive data, at least v?[0x314] to extract</span><br></pre></td></tr></table></figure>
<p>经过以上粗略的审计，可以猜测可能是在 libmobisec.so 实现了 StubApplication 中的函数，并对 assets 文件夹下的两个文件进行操作来还原出 MainActivity 中的函数。</p>
<h1 id="Analysis（libmobisec-so）"><a href="#Analysis（libmobisec-so）" class="headerlink" title="Analysis（libmobisec.so）"></a>Analysis（libmobisec.so）</h1><p>打开 IDA，最先定位到 JNI_OnLoad 函数，查看一下注册了哪些函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">fastcall <span class="title">JNI_OnLoad</span><span class="params">(_JavaVM *vm, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v2; <span class="comment">// r2</span></span><br><span class="line">  jclass v3; <span class="comment">// r1</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// zf</span></span><br><span class="line">  _JNIEnv *env; <span class="comment">// [sp+4h] [bp-Ch]</span></span><br><span class="line"></span><br><span class="line">  env = (_JNIEnv *)a2;</span><br><span class="line">  <span class="keyword">if</span> ( vm-&gt;functions-&gt;GetEnv(&amp;vm-&gt;functions, (<span class="keyword">void</span> **)&amp;env, <span class="number">65542</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="string">"Failed to get the environment"</span>;</span><br><span class="line">LABEL_5:</span><br><span class="line">    _android_log_print(<span class="number">6</span>, <span class="string">"debug"</span>, v2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = env-&gt;functions-&gt;FindClass(&amp;env-&gt;functions, <span class="string">"com/ali/mobisecenhance/StubApplication"</span>);<span class="comment">// locate class</span></span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="string">"failed to get class reference"</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = env-&gt;functions-&gt;RegisterNatives(&amp;env-&gt;functions, v3, (<span class="keyword">const</span> JNINativeMethod *)gMethods, <span class="number">2</span>) == <span class="number">0</span>;<span class="comment">// register 2 methods</span></span><br><span class="line">  result = <span class="number">65542</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 RegisterNatives 函数的参数中可以看到注册了两个函数，分别为 attachBaseContext 和 onCreate。在内存中可以找到两个函数对应的指针：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.data:00054010 gMethods        DCD aAttachbasecont_0   ; DATA XREF: JNI_OnLoad+44↑o</span><br><span class="line">.data:00054010                                         ; .text:off_24784↑o</span><br><span class="line">.data:00054010                                         ; &quot;attachBaseContext&quot;</span><br><span class="line">.data:00054014                 DCD aLandroidConten_1   ; &quot;(Landroid/content/Context;)V&quot;</span><br><span class="line">.data:00054018                 DCD sub_24D3C+1</span><br><span class="line">.data:0005401C                 DCD aOncreate           ; &quot;onCreate&quot;</span><br><span class="line">.data:00054020                 DCD aV                  ; &quot;()V&quot;</span><br><span class="line">.data:00054024                 DCD sub_24498+1</span><br></pre></td></tr></table></figure>
<p>因为 attachBaseContext 先于 onCreate 函数执行，这里先看一下 attachBaseContext。跟着 log 可以对函数有一个大体的了解，在一处 log 里有“enter new application”的信息，猜测可能是完成了解码进入 MainActivity。在该处上下看看可以发现一个 parse_dex 函数，很有可能是解析出真正的 dex 文件的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">attachBaseContext</span><span class="params">(_JNIEnv *a1, jobject *a2, jobject *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  jobject *v3; <span class="comment">// r8</span></span><br><span class="line">  jobject *v4; <span class="comment">// r10</span></span><br><span class="line">  _JNIEnv *env; <span class="comment">// r4</span></span><br><span class="line">  _JNIEnv *v6; <span class="comment">// r1</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  ali *v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v19; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">void</span> *v22; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">void</span> *v23; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v24; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v25; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">size_t</span> v26; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v31; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> v32; <span class="comment">// r0</span></span><br><span class="line">  ali *v33; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v34; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v35; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> v36; <span class="comment">// [sp+8h] [bp-78h]</span></span><br><span class="line">  __int64 v37; <span class="comment">// [sp+18h] [bp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [sp+24h] [bp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v39; <span class="comment">// [sp+3Ch] [bp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> *v40; <span class="comment">// [sp+4Ch] [bp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> *v41; <span class="comment">// [sp+50h] [bp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = a2;</span><br><span class="line">  v4 = a3;</span><br><span class="line">  env = a1;</span><br><span class="line">  _android_log_print(<span class="number">6</span>, <span class="string">"debug"</span>, <span class="string">"in..."</span>);</span><br><span class="line">  result = ali::init_classes(env, v6, v7);      <span class="comment">// init classes</span></span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  v9 = (ali *)_JNIEnv::CallNonvirtualVoidMethod(env, v3, ali::ContextWrapper, dword_54128, v4);</span><br><span class="line">  v36 = ali::NanoTime(v9);</span><br><span class="line">  v10 = _JNIEnv::GetObjectClass(env, v3);</span><br><span class="line">  v11 = _JNIEnv::GetMethodID(env, v10, <span class="string">"getFilesDir"</span>, <span class="string">"()Ljava/io/File;"</span>);</span><br><span class="line">  v12 = _JNIEnv::CallObjectMethod(env, v3, v11);</span><br><span class="line">  v13 = v12;</span><br><span class="line">  v14 = _JNIEnv::GetObjectClass(env, v12);</span><br><span class="line">  v15 = _JNIEnv::GetMethodID(env, v14, <span class="string">"getAbsolutePath"</span>, <span class="string">"()Ljava/lang/String;"</span>);</span><br><span class="line">  v16 = _JNIEnv::CallObjectMethod(env, v13, v15);</span><br><span class="line">  sub_247D8(&amp;v39, env, v16);</span><br><span class="line">  <span class="keyword">if</span> ( &amp;v39 != (<span class="keyword">char</span> *)&amp;ali::g_filePath )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;ali::g_filePath, v41, v40);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v39);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"global files path is %s"</span>, dword_540E8);</span><br><span class="line">  v17 = _JNIEnv::CallObjectMethod(env, v3, dword_541A4);</span><br><span class="line">  <span class="keyword">if</span> ( ali::sdk_int &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = _JNIEnv::GetObjectField(env, v17, dword_5416C);</span><br><span class="line">    sub_247D8(&amp;v38, env, v20);</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v39, &amp;v38, <span class="string">"/lib"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( &amp;v39 != (<span class="keyword">char</span> *)&amp;ali::g_libPath )</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;ali::g_libPath, v41, v40);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v39);</span><br><span class="line">    v19 = &amp;v38;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v18 = _JNIEnv::GetObjectField(env, v17, dword_54170);</span><br><span class="line">    sub_247D8(&amp;v39, env, v18);</span><br><span class="line">    <span class="keyword">if</span> ( &amp;v39 != (<span class="keyword">char</span> *)&amp;ali::g_libPath )</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;ali::g_libPath, v41, v40);</span><br><span class="line">    v19 = &amp;v39;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(v19);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"global native path is %s"</span>, dword_540D0);</span><br><span class="line">  v21 = _JNIEnv::CallObjectMethod(env, v3, dword_541B0);</span><br><span class="line">  sub_247D8(&amp;v39, env, v21);</span><br><span class="line">  <span class="keyword">if</span> ( &amp;v39 != (<span class="keyword">char</span> *)&amp;ali::g_apkPath )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;ali::g_apkPath, v41, v40);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v39);</span><br><span class="line">  setenv(<span class="string">"APKPATH"</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)dword_540B8, <span class="number">1</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"global apk path is %s"</span>, dword_540B8);</span><br><span class="line">  sub_24A64(env, v3);</span><br><span class="line">  v22 = (<span class="keyword">void</span> *)_JNIEnv::CallObjectMethod(env, v4, dword_541A0);</span><br><span class="line">  v23 = v22;</span><br><span class="line">  <span class="keyword">if</span> ( v22 )</span><br><span class="line">  &#123;</span><br><span class="line">    v24 = env-&gt;functions-&gt;GetStringUTFChars(&amp;env-&gt;functions, v22, <span class="number">0</span>);</span><br><span class="line">    v25 = v24;</span><br><span class="line">    v26 = <span class="built_in">strlen</span>(v24);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;ali::g_pkgName, v25, &amp;v25[v26]);</span><br><span class="line">    env-&gt;functions-&gt;ReleaseStringUTFChars(&amp;env-&gt;functions, v23, v25);</span><br><span class="line">  &#125;</span><br><span class="line">  v37 = <span class="number">0L</span>L;</span><br><span class="line">  v27 = _JNIEnv::CallObjectMethod(env, v4, dword_541A8);</span><br><span class="line">  parse_dex(env, &amp;v37);                         <span class="comment">// parse dex?</span></span><br><span class="line">  replace_classloader_cookie(env, v27, v37, HIDWORD(v37));</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"enter new application"</span>);<span class="comment">// enter MainActivity?</span></span><br><span class="line">  v28 = dword_54120;</span><br><span class="line">  _JNIEnv::NewStringUTF(env, <span class="string">"android.app.Application"</span>);</span><br><span class="line">  v29 = _JNIEnv::CallObjectMethod(env, v27, v28);</span><br><span class="line">  v30 = v29;</span><br><span class="line">  <span class="keyword">if</span> ( v29 )</span><br><span class="line">  &#123;</span><br><span class="line">    v32 = _JNIEnv::GetMethodID(env, v29, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);</span><br><span class="line">    dword_540A0 = _JNIEnv::NewObject(env, v30, v32);</span><br><span class="line">    _JNIEnv::CallVoidMethod(env, dword_540A0, dword_54134, v4);</span><br><span class="line">    _JNIEnv::DeleteLocalRef(env, v30);</span><br><span class="line">    v31 = <span class="string">"exit new application"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v31 = <span class="string">"can't findClass realAppClass"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v33 = (ali *)_android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, v31);</span><br><span class="line">  <span class="keyword">if</span> ( dword_540A0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v33 = (ali *)env-&gt;functions-&gt;NewGlobalRef(&amp;env-&gt;functions, (jobject)dword_540A0);</span><br><span class="line">    dword_540A0 = (<span class="keyword">int</span>)v33;</span><br><span class="line">  &#125;</span><br><span class="line">  v34 = ali::NanoTime(v33);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"##### attachBaseContext spent:"</span>);</span><br><span class="line">  ali::PrettyDuration((ali *)(v34 - v36), v35);</span><br><span class="line">  result = _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"exit attachBaseContext"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来进入 parse_dex 进行分析。一开始判断了是采用了 Dalvik 模式还是 ART 模式。我的机器是 Android 4.4.4，用的是 Dalvik 模式，那就只分析一下 Dalvik 的部分。接下来对 SDK 的版本进行了判断，是否大于 SDK13。我用的机器是 SDK19，故下面应该是调用了 openWithHeader 函数。之后的部分看到是用 dlopen 打开 libdvm.so，并开始执行程序，所以就不做进一步分析。主要应该就是 openWithHeader 中的内容解析了出了 dex 文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">fastcall <span class="title">parse_dex</span><span class="params">(_JNIEnv *a1, __int64 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v3; <span class="comment">// r1</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v6; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// t1</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// ST14_4</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// r1</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> (__fastcall *v19)(<span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span>); <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v21; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v22; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">char</span> *v23; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v24; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v25; <span class="comment">// r6</span></span><br><span class="line">  ali::EncFile *v26; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> *v28; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v29; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// r10</span></span><br><span class="line">  <span class="keyword">void</span> *v31; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> (__fastcall *v32)(<span class="keyword">unsigned</span> __int8 *, <span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span> *); <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">int</span> (__fastcall *v33)(_DWORD); <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v34; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> v35; <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v36; <span class="comment">// r7</span></span><br><span class="line">  _DWORD *v37; <span class="comment">// r9</span></span><br><span class="line">  _BYTE *v38; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v39; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">void</span> *v40; <span class="comment">// r0</span></span><br><span class="line">  JNINativeMethod *v41; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v42; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v43; <span class="comment">// r3</span></span><br><span class="line">  _JNIEnv *v45; <span class="comment">// [sp+8h] [bp-2A0h]</span></span><br><span class="line">  __int64 *v46; <span class="comment">// [sp+10h] [bp-298h]</span></span><br><span class="line">  <span class="keyword">int</span> v47; <span class="comment">// [sp+24h] [bp-284h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v48; <span class="comment">// [sp+28h] [bp-280h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v49; <span class="comment">// [sp+2Ch] [bp-27Ch]</span></span><br><span class="line">  <span class="keyword">void</span> (__cdecl *v50)(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *, jvalue *); <span class="comment">// [sp+30h] [bp-278h]</span></span><br><span class="line">  <span class="keyword">char</span> v51; <span class="comment">// [sp+34h] [bp-274h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v52[<span class="number">2</span>]; <span class="comment">// [sp+38h] [bp-270h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [sp+40h] [bp-268h]</span></span><br><span class="line">  <span class="keyword">char</span> v54; <span class="comment">// [sp+54h] [bp-254h]</span></span><br><span class="line">  <span class="keyword">int</span> v55; <span class="comment">// [sp+64h] [bp-244h]</span></span><br><span class="line">  <span class="keyword">int</span> v56; <span class="comment">// [sp+68h] [bp-240h]</span></span><br><span class="line">  <span class="keyword">char</span> v57; <span class="comment">// [sp+6Ch] [bp-23Ch]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v58; <span class="comment">// [sp+80h] [bp-228h]</span></span><br><span class="line">  <span class="keyword">char</span> v59; <span class="comment">// [sp+84h] [bp-224h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v60; <span class="comment">// [sp+98h] [bp-210h]</span></span><br><span class="line">  <span class="keyword">char</span> v61; <span class="comment">// [sp+9Ch] [bp-20Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v62; <span class="comment">// [sp+B0h] [bp-1F8h]</span></span><br><span class="line">  <span class="keyword">char</span> v63; <span class="comment">// [sp+B4h] [bp-1F4h]</span></span><br><span class="line">  <span class="keyword">char</span> v64; <span class="comment">// [sp+CCh] [bp-1DCh]</span></span><br><span class="line">  <span class="keyword">int</span> v65; <span class="comment">// [sp+E0h] [bp-1C8h]</span></span><br><span class="line">  <span class="keyword">char</span> v66; <span class="comment">// [sp+E4h] [bp-1C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v67; <span class="comment">// [sp+FCh] [bp-1ACh]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v68; <span class="comment">// [sp+110h] [bp-198h]</span></span><br><span class="line">  <span class="keyword">char</span> v69; <span class="comment">// [sp+114h] [bp-194h]</span></span><br><span class="line">  <span class="keyword">char</span> v70; <span class="comment">// [sp+12Ch] [bp-17Ch]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v71; <span class="comment">// [sp+140h] [bp-168h]</span></span><br><span class="line">  <span class="keyword">char</span> v72; <span class="comment">// [sp+144h] [bp-164h]</span></span><br><span class="line">  <span class="keyword">char</span> *v73; <span class="comment">// [sp+154h] [bp-154h]</span></span><br><span class="line">  <span class="keyword">char</span> *v74; <span class="comment">// [sp+158h] [bp-150h]</span></span><br><span class="line">  <span class="keyword">char</span> v75; <span class="comment">// [sp+15Ch] [bp-14Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v76; <span class="comment">// [sp+174h] [bp-134h]</span></span><br><span class="line">  <span class="keyword">char</span> v77; <span class="comment">// [sp+18Ch] [bp-11Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v78; <span class="comment">// [sp+1A4h] [bp-104h]</span></span><br><span class="line">  <span class="keyword">char</span> v79; <span class="comment">// [sp+1BCh] [bp-ECh]</span></span><br><span class="line">  <span class="keyword">char</span> v80; <span class="comment">// [sp+1D4h] [bp-D4h]</span></span><br><span class="line">  <span class="keyword">char</span> v81; <span class="comment">// [sp+1ECh] [bp-BCh]</span></span><br><span class="line">  <span class="keyword">char</span> v82; <span class="comment">// [sp+204h] [bp-A4h]</span></span><br><span class="line">  <span class="keyword">char</span> v83; <span class="comment">// [sp+21Ch] [bp-8Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v84; <span class="comment">// [sp+234h] [bp-74h]</span></span><br><span class="line">  <span class="keyword">int</span> v85; <span class="comment">// [sp+244h] [bp-64h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v86; <span class="comment">// [sp+248h] [bp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> v87; <span class="comment">// [sp+24Ch] [bp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v88; <span class="comment">// [sp+264h] [bp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> *v89; <span class="comment">// [sp+274h] [bp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> *v90; <span class="comment">// [sp+278h] [bp-30h]</span></span><br><span class="line"></span><br><span class="line">  v45 = a1;</span><br><span class="line">  v46 = a2;</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"enter parse_dex"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ali::isDalvik )                          <span class="comment">// dalvik or art</span></span><br><span class="line">  &#123;</span><br><span class="line">    v47 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v88, &amp;ali::g_filePath, <span class="string">"/cls.jar"</span>);<span class="comment">// locate cls.jar</span></span><br><span class="line">    v25 = v90;</span><br><span class="line">    v26 = (ali::EncFile *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">0xC</span>u);</span><br><span class="line">    ali::EncFile::EncFile(v26, v25);</span><br><span class="line">    v48 = <span class="number">0</span>;</span><br><span class="line">    v49 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ali::sdk_int &gt; <span class="number">13</span> )                    <span class="comment">// sdk version &gt; 13</span></span><br><span class="line">    &#123;</span><br><span class="line">      v27 = ali::EncFile::openWithHeader(v26, &amp;v48, (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)&amp;v47, <span class="number">0x10</span>u);</span><br><span class="line">      v49 = v48 + <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// sdk version &lt;= 13 ( android 3.x )</span></span><br><span class="line">    &#123;</span><br><span class="line">      v27 = ali::EncFile::open(v26, &amp;v49, (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)&amp;v47);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v49 == (<span class="keyword">unsigned</span> __int8 *)<span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v28 = (<span class="keyword">int</span> *)_errno(v27);</span><br><span class="line">      v29 = strerror(*v28);</span><br><span class="line">      _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"mmap dex file :%s"</span>, v29);</span><br><span class="line">LABEL_45:</span><br><span class="line">      v24 = &amp;v88;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v30 = *((_DWORD *)v49 + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ( ali::sdk_int &gt; <span class="number">13</span> )                    <span class="comment">// sdk version &gt; 13</span></span><br><span class="line">    &#123;</span><br><span class="line">      v40 = dlopen(<span class="string">"libdvm.so"</span>, <span class="number">1</span>);             <span class="comment">// open libdvm.so and start execute program</span></span><br><span class="line">      v41 = (JNINativeMethod *)dlsym(v40, <span class="string">"dvm_dalvik_system_DexFile"</span>);</span><br><span class="line">      v50 = <span class="number">0</span>;</span><br><span class="line">      lookup(v41, <span class="string">"openDexFile"</span>, <span class="string">"([B)I"</span>, &amp;v50);</span><br><span class="line">      v42 = v48;</span><br><span class="line">      *((_DWORD *)v48 + <span class="number">2</span>) = v47;</span><br><span class="line">      *(_DWORD *)&amp;v51 = v42;</span><br><span class="line">      ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))v50)();</span><br><span class="line">      v43 = v52[<span class="number">0</span>];</span><br><span class="line">      *v46 = v52[<span class="number">0</span>];</span><br><span class="line">      *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(v43 + <span class="number">8</span>) + <span class="number">4</span>) + <span class="number">32</span>) = *(_DWORD *)(v43 + <span class="number">16</span>);</span><br><span class="line">      *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(v43 + <span class="number">8</span>) + <span class="number">4</span>) + <span class="number">36</span>) = v47;</span><br><span class="line">      ali::EncFile::~EncFile(v26);</span><br><span class="line">      operator delete((void *)v26);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// sdk version &lt;= 13 ( android 3.x )</span></span><br><span class="line">    &#123;</span><br><span class="line">      v31 = dlopen(<span class="string">"libdvm.so"</span>, <span class="number">1</span>);</span><br><span class="line">      v32 = (<span class="keyword">int</span> (__fastcall *)(<span class="keyword">unsigned</span> __int8 *, <span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span> *))dlsym(v31, <span class="string">"dvmDexFileOpenPartial"</span>);</span><br><span class="line">      v33 = (<span class="keyword">int</span> (__fastcall *)(_DWORD))dlsym(v31, <span class="string">"dexCreateClassLookup"</span>);</span><br><span class="line">      v52[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v32(v49, v30, v52) == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v34 = <span class="string">"dvmDexFileOpenPartial error"</span>;</span><br><span class="line">LABEL_40:</span><br><span class="line">        _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, v34);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">      &#125;</span><br><span class="line">      v35 = *(_DWORD *)v52[<span class="number">0</span>];</span><br><span class="line">      *(_DWORD *)(v35 + <span class="number">36</span>) = v33(*(_DWORD *)v52[<span class="number">0</span>]);</span><br><span class="line">      v36 = v52[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> ( !*(_DWORD *)(*(_DWORD *)v52[<span class="number">0</span>] + <span class="number">36</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v34 = <span class="string">"dexCreateClassLookup error"</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">      &#125;</span><br><span class="line">      v37 = <span class="built_in">malloc</span>(<span class="number">0x2C</span>u);</span><br><span class="line">      v38 = <span class="built_in">malloc</span>(<span class="number">0x14</span>u);</span><br><span class="line">      strdup((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;unk_4CEE9);</span><br><span class="line">      v38[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">      v38[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">      *((_DWORD *)v38 + <span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line">      v39 = v49;</span><br><span class="line">      *(_DWORD *)v38 = v38;</span><br><span class="line">      *((_DWORD *)v38 + <span class="number">3</span>) = v37;</span><br><span class="line">      v37[<span class="number">10</span>] = v36;</span><br><span class="line">      *(_DWORD *)(v36 + <span class="number">32</span>) = v39;</span><br><span class="line">      *(_DWORD *)(v36 + <span class="number">36</span>) = v47;</span><br><span class="line">      *v46 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v38;</span><br><span class="line">    &#125;</span><br><span class="line">    v23 = &amp;v88;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v54, &amp;ali::g_filePath, <span class="string">"/cls.jar"</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v57, &amp;ali::g_filePath, <span class="string">"/cls.dex"</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v59, &amp;ali::g_filePath, <span class="string">"/fak.jar"</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"before oat gen"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !access(v58, <span class="number">0</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">  v2 = android_getCpuFamily();</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v63, <span class="string">"arm"</span>, &amp;v51);</span><br><span class="line">  <span class="keyword">switch</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v3 = <span class="string">"arm"</span>;</span><br><span class="line">LABEL_5:</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=(&amp;v63, v3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      v3 = <span class="string">"x86"</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      v3 = <span class="string">"mips"</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      v3 = <span class="string">"arm64"</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      v3 = <span class="string">"x86_64"</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v64, &amp;ali::g_libPath, <span class="string">"/libhack.so"</span>);</span><br><span class="line">  v4 = getenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">  v5 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"the system already define LD_PRELOAD=%s"</span>, v4);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v84, v5, v52);</span><br><span class="line">    v6 = v86;</span><br><span class="line">    v7 = v85;</span><br><span class="line">    <span class="keyword">while</span> ( v6 != (<span class="keyword">unsigned</span> __int8 *)v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *v6++;</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">32</span> )</span><br><span class="line">        *(v6 - <span class="number">1</span>) = <span class="number">58</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v87, &amp;v84, <span class="string">":"</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v88, &amp;v87, &amp;v64);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v64, v90, v89);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v88);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v87);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v84);</span><br><span class="line">  &#125;</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"the new LD_PRELOAD is %s"</span>, v65);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v66, &amp;ali::g_filePath, <span class="string">"/juice.data"</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v67, &amp;ali::g_filePath, <span class="string">"/fak.jar"</span>);</span><br><span class="line">  fd = open(v68, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">"%d"</span>, fd);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v69, &amp;s, v52);</span><br><span class="line">  v73 = &amp;v72;</span><br><span class="line">  v74 = &amp;v72;</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_allocate_block(&amp;v72, v55 - v56 + <span class="number">10</span>);</span><br><span class="line">  *v73 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_appendT&lt;<span class="keyword">char</span> <span class="keyword">const</span>*&gt;(&amp;v72, <span class="string">"DEX_FILE="</span>, <span class="string">""</span>, v52);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::append((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v72, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v54);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v75, &amp;v72, <span class="string">"                     JUICE_FILE="</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v76, &amp;v75, &amp;v66);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v77, &amp;v76, <span class="string">"                     LD_PRELOAD="</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v78, &amp;v77, &amp;v64);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(</span><br><span class="line">    &amp;v79,</span><br><span class="line">    &amp;v78,</span><br><span class="line">    <span class="string">"                     /system/bin/dex2oat \t\t\t\t  \t --runtime-arg -Xms64m \t\t\t\t\t --runtime-arg -Xmx64m \t\t\t\t"</span></span><br><span class="line">    <span class="string">"\t --boot-image=/system/framework/boot.art                      --zip-fd="</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v80, &amp;v79, &amp;v69);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v81, &amp;v80, <span class="string">"\t\t\t\t\t --zip-location="</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v82, &amp;v81, &amp;v67);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v83, &amp;v82, <span class="string">"\t\t\t\t\t --oat-file="</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v84, &amp;v83, &amp;v57);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v70, &amp;v84, <span class="string">"                     "</span>);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v84);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v83);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v82);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v81);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v80);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v79);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v78);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v77);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v76);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v75);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v72);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"cmd is %s"</span>, v71);</span><br><span class="line">  system(v71);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v70);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v69);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v67);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v66);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v64);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v63);</span><br><span class="line">LABEL_24:</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"after oat gen"</span>);</span><br><span class="line">  v10 = ali::JDexFile;</span><br><span class="line">  v11 = dword_54140;</span><br><span class="line">  <span class="keyword">if</span> ( ali::sdk_int &lt;= <span class="number">19</span> )                     <span class="comment">// sdk version &lt;= 19</span></span><br><span class="line">  &#123;</span><br><span class="line">    v12 = _JNIEnv::NewStringUTF(v45, v60);</span><br><span class="line">    v13 = _JNIEnv::NewStringUTF(v45, v58);</span><br><span class="line">    v16 = _JNIEnv::CallStaticIntMethod(v45, v10, v11, v12, v13, <span class="number">0</span>);</span><br><span class="line">    v18 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>                                          <span class="comment">// sdk version &gt; 19</span></span><br><span class="line">  &#123;</span><br><span class="line">    v14 = _JNIEnv::NewStringUTF(v45, v60);</span><br><span class="line">    v15 = _JNIEnv::NewStringUTF(v45, v58);</span><br><span class="line">    v16 = _JNIEnv::CallStaticLongMethod(v45, v10, v11, v14, v15, <span class="number">0</span>);</span><br><span class="line">    v18 = v17;</span><br><span class="line">  &#125;</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"cookie is %llx"</span>);</span><br><span class="line">  *(_DWORD *)v46 = v16;</span><br><span class="line">  *((_DWORD *)v46 + <span class="number">1</span>) = v18;</span><br><span class="line">  v19 = (<span class="keyword">int</span> (__fastcall *)(<span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span>))dlsym((<span class="keyword">void</span> *)<span class="number">0xFFFFFFFF</span>, <span class="string">"_ZNK3art7DexFile12FindClassDefEt"</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"DexFile::FindClassDefFn is %p"</span>, v19);</span><br><span class="line">  v20 = v19(v16, <span class="number">1</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"call FindClassDefFn(%p,%d) =&gt; %p"</span>, v16, <span class="number">1</span>, v20);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"dex position is %p"</span>, v20 - <span class="number">572</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"dex head is %08x %08x"</span>, *(_DWORD *)(v20 - <span class="number">572</span>), *(_DWORD *)(v20 - <span class="number">568</span>));</span><br><span class="line">  v21 = *(<span class="keyword">unsigned</span> __int8 **)(v20 - <span class="number">540</span>);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"dex size is %d"</span>, v21);</span><br><span class="line">  MemEnableWrite((<span class="keyword">unsigned</span> __int8 *)(v20 - <span class="number">572</span>), &amp;v21[v20 - <span class="number">572</span>]);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v61, &amp;ali::g_filePath, <span class="string">"/juice.data"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !ali::dex_juicer_patch((ali *)(v20 - <span class="number">572</span>), v21, v62, v22) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v61);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v59);</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v57);</span><br><span class="line">    v23 = &amp;v54;</span><br><span class="line">LABEL_44:</span><br><span class="line">    <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(v23);</span><br><span class="line">    _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"exit parse_dex"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  _android_log_print(<span class="number">6</span>, <span class="string">"debug"</span>, <span class="string">"fail to patch dex"</span>);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v61);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v59);</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(&amp;v57);</span><br><span class="line">  v24 = &amp;v54;</span><br><span class="line">LABEL_46:</span><br><span class="line">  <span class="built_in">std</span>::priv::_String_base&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_deallocate_block(v24);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"exit parse_dex error"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 openWithHeader 中，log 了三次 dex 的 magic number，中间分别进行了 RC4 解密和 LZMA 解压缩。最后得到的结果应该就是最终的 dex 文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __fastcall ali::EncFile::openWithHeader(ali::EncFile *<span class="keyword">this</span>, <span class="keyword">unsigned</span> __int8 **a2, <span class="keyword">unsigned</span> <span class="keyword">int</span> *a3, <span class="keyword">unsigned</span> <span class="keyword">int</span> a4)</span><br><span class="line">&#123;</span><br><span class="line">  ali::EncFile *v4; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 **v5; <span class="comment">// r11</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v6; <span class="comment">// r6</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v8; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// r10</span></span><br><span class="line">  <span class="keyword">__blksize_t</span> v12; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v13; <span class="comment">// r4</span></span><br><span class="line">  ali *v14; <span class="comment">// r0</span></span><br><span class="line">  __int64 v15; <span class="comment">// r0</span></span><br><span class="line">  __int64 v16; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v17; <span class="comment">// r3</span></span><br><span class="line">  ali *v18; <span class="comment">// r0</span></span><br><span class="line">  __int64 v19; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">char</span> v22; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v23; <span class="comment">// r0</span></span><br><span class="line">  ali *v24; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v25; <span class="comment">// r9</span></span><br><span class="line">  ali *v26; <span class="comment">// ST24_4</span></span><br><span class="line">  __int64 v27; <span class="comment">// r0</span></span><br><span class="line">  __int64 v28; <span class="comment">// ST18_8</span></span><br><span class="line">  ali *v29; <span class="comment">// r0</span></span><br><span class="line">  __int64 v30; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">size_t</span> v31; <span class="comment">// [sp+2Ch] [bp-9Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v32; <span class="comment">// [sp+30h] [bp-98h]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [sp+34h] [bp-94h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span> <span class="comment">// [sp+38h] [bp-90h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="keyword">this</span>;</span><br><span class="line">  v5 = a2;</span><br><span class="line">  v6 = a3;</span><br><span class="line">  v7 = a4;</span><br><span class="line">  <span class="keyword">if</span> ( !*((_DWORD *)<span class="keyword">this</span> + <span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">"file path is null"</span>;</span><br><span class="line">LABEL_5:</span><br><span class="line">    _android_log_print(<span class="number">6</span>, <span class="string">"debug"</span>, v8);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fd = open(*((<span class="keyword">const</span> <span class="keyword">char</span> **)<span class="keyword">this</span> + <span class="number">2</span>), <span class="number">0</span>);</span><br><span class="line">  v10 = fstat(fd, &amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="string">"fstat failed"</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = buf.st_blksize;</span><br><span class="line">  *v6 = buf.st_blksize;</span><br><span class="line">  *(_DWORD *)v4 = v12;</span><br><span class="line">  v13 = (<span class="keyword">unsigned</span> __int8 *)mmap(<span class="number">0</span>, *v6, <span class="number">3</span>, <span class="number">2</span>, fd, <span class="number">0</span>);</span><br><span class="line">  *((_DWORD *)v4 + <span class="number">1</span>) = v13;</span><br><span class="line">  close(fd);</span><br><span class="line">  v14 = (ali *)_android_log_print(</span><br><span class="line">                 <span class="number">3</span>,</span><br><span class="line">                 <span class="string">"debug"</span>,</span><br><span class="line">                 <span class="string">"dex magic %c %c %c %c %c %c %c"</span>,<span class="comment">// original dex magic</span></span><br><span class="line">                 *v13,</span><br><span class="line">                 v13[<span class="number">1</span>],</span><br><span class="line">                 v13[<span class="number">2</span>],</span><br><span class="line">                 v13[<span class="number">3</span>],</span><br><span class="line">                 v13[<span class="number">4</span>],</span><br><span class="line">                 v13[<span class="number">5</span>],</span><br><span class="line">                 v13[<span class="number">6</span>]);</span><br><span class="line">  LODWORD(v15) = ali::NanoTime(v14);</span><br><span class="line">  v16 = v15;</span><br><span class="line">  v18 = (ali *)ali::decryptRc4((ali *)v13, v13, (<span class="keyword">unsigned</span> __int8 *)v6, v17);<span class="comment">// RC4 decrypt</span></span><br><span class="line">  LODWORD(v19) = ali::NanoTime(v18);</span><br><span class="line">  ali::PrettyDuration((ali *)(v19 - v16), v19 - v16);</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"decrypted len:%u"</span>, *v6);</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  _android_log_print(</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    <span class="string">"debug"</span>,</span><br><span class="line">    <span class="string">"after decrypt dex magic %c %c %c %c %c %c %c"</span>,<span class="comment">// dex magic after RC4</span></span><br><span class="line">    *v13,</span><br><span class="line">    v13[<span class="number">1</span>],</span><br><span class="line">    v13[<span class="number">2</span>],</span><br><span class="line">    v13[<span class="number">3</span>],</span><br><span class="line">    v13[<span class="number">4</span>],</span><br><span class="line">    v13[<span class="number">5</span>],</span><br><span class="line">    v13[<span class="number">6</span>]);</span><br><span class="line">  v21 = (<span class="keyword">int</span>)(v13 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v22 = <span class="number">8</span> * v10++;</span><br><span class="line">    v23 = (<span class="keyword">unsigned</span> __int64)*(<span class="keyword">unsigned</span> __int8 *)(v21++ + <span class="number">1</span>) &lt;&lt; v22;</span><br><span class="line">    v20 += v23;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v10 != <span class="number">8</span> );</span><br><span class="line">  _android_log_print(<span class="number">3</span>, <span class="string">"debug"</span>, <span class="string">"unpackSize: %u"</span>, v20);</span><br><span class="line">  *(_DWORD *)v4 = v7 + v20;</span><br><span class="line">  v24 = (ali *)mmap(<span class="number">0</span>, v7 + v20, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  *((_DWORD *)v4 + <span class="number">1</span>) = v24;</span><br><span class="line">  v25 = (<span class="keyword">unsigned</span> __int8 *)v24 + v7;</span><br><span class="line">  v26 = v24;</span><br><span class="line">  LODWORD(v27) = ali::NanoTime(v24);</span><br><span class="line">  v31 = *v6;</span><br><span class="line">  v28 = v27;</span><br><span class="line">  v32 = v20;</span><br><span class="line">  v29 = (ali *)LzmaDecode(v25, &amp;v32, v13 + <span class="number">13</span>, &amp;v31, v13, <span class="number">5</span>, <span class="number">1</span>, &amp;v33, &amp;off_54028);<span class="comment">// LZMA uncompress</span></span><br><span class="line">  LODWORD(v30) = ali::NanoTime(v29);</span><br><span class="line">  ali::PrettyDuration((ali *)(v30 - v28), v30 - v28);</span><br><span class="line">  munmap(v13, buf.st_blksize);</span><br><span class="line">  _android_log_print(</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    <span class="string">"debug"</span>,</span><br><span class="line">    <span class="string">"after uncompressed dex magic %c %c %c %c %c %c %c"</span>,<span class="comment">// dex magic after LZMA</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> __int8 *)v26 + v7),</span><br><span class="line">    v25[<span class="number">1</span>],</span><br><span class="line">    v25[<span class="number">2</span>],</span><br><span class="line">    v25[<span class="number">3</span>],</span><br><span class="line">    v25[<span class="number">4</span>],</span><br><span class="line">    v25[<span class="number">5</span>],</span><br><span class="line">    v25[<span class="number">6</span>]);</span><br><span class="line">  *v6 = v20;</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">    *v5 = (<span class="keyword">unsigned</span> __int8 *)*((_DWORD *)v4 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> *((_DWORD *)v4 + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Dump-Dex-File"><a href="#Dump-Dex-File" class="headerlink" title="Dump Dex File"></a>Dump Dex File</h1><p>知道了解析 dex 的流程，接下来就通过动态调试来吧 dex 文件 dump 下来。现在 BL 跳转到 openWithHeader 的语句处设下断点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:00026A7E loc_26A7E                               ; CODE XREF: parse_dex(_JNIEnv *,long long *)+622↑j</span><br><span class="line">.text:00026A7E                 MOV             R1, R9  ; unsigned __int8 **</span><br><span class="line">.text:00026A80                 MOV             R2, R4  ; unsigned int *</span><br><span class="line">.text:00026A82                 MOVS            R3, #0x10 ; unsigned int</span><br><span class="line">.text:00026A84                 BL              _ZN3ali7EncFile14openWithHeaderEPPhPjj ; ali::EncFile::openWithHeader(uchar **,uint *,uint)</span><br><span class="line">.text:00026A88                 LDR.W           R3, [R9]</span><br><span class="line">.text:00026A8C                 ADDS            R3, #0x10</span><br><span class="line">.text:00026A8E                 STR             R3, [R6]</span><br></pre></td></tr></table></figure>
<p>运行到断点处，单步步入 openWithHeader 函数，然后单步步过一直到 return，中间可以在 monitor 中用 tag:debug 过滤来查看 log。运行完后看到 log 输出的 magic number 已经是真实 dex 文件的样子了：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/1.png" alt="monitor中显示的log信息"></p>
<p>根据函数的返回值存放在 R0 中，可以看到 R0 所指向的部分是一个 dex 文件的数据了：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/2.png" alt="R0所指向的数据部分"></p>
<p>接下来我们可以把 dex 文件给 dump 下来。但文件的大小为多少？根据 dex 的数据结构，可以知道 dex 文件的大小位于偏移 0x20 处：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/3.png" alt="dex文件大小位置"></p>
<p>接下来使用 IDC 脚本来 dump 数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> fp, begin, end, len, b;</span><br><span class="line">    fp = fopen(<span class="string">"dump.dex"</span>, <span class="string">"wb"</span>);</span><br><span class="line">    begin = <span class="number">0x7584C010</span>; <span class="comment">// 解密后数据在内存中的位置</span></span><br><span class="line">    len = <span class="number">0x0941FC</span>; <span class="comment">// 文件大小</span></span><br><span class="line">    end = begin + len;</span><br><span class="line">    <span class="keyword">for</span> (b = begin; b &lt; end; b++) &#123;</span><br><span class="line">        fputc(Byte(b), fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后将 dump 下来的数据放进 JEB 中，反汇编可以得到真实的 MainActivity 代码：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/4.png" alt="反编译dex得到的Java代码"></p>
<h1 id="Fix-Application"><a href="#Fix-Application" class="headerlink" title="Fix Application"></a>Fix Application</h1><p>使用 AndroidKiller 反编译加固后的 apk，找到 AndroidManifest.xml，删除 Application 的 android:name 属性：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8" standalone="no"?&gt;<span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span> <span class="attr">package</span>=<span class="string">"com.ali.tg.testapp"</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">"23"</span> <span class="attr">platformBuildVersionName</span>=<span class="string">"6.0-2438415"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:allowBackup</span>=<span class="string">"true"</span> <span class="attr">android:debuggable</span>=<span class="string">"true"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span> <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".WebViewActivity"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>回编译后，找到生成的 apk，压缩软件打开，替换我们 dump 出来的 classes.dex，同时删除 assets 文件夹，其他 so 文件不用管。修改完后重新签名打包并安装运行，可以正常使用。</p>
<h1 id="Find-Flag"><a href="#Find-Flag" class="headerlink" title="Find Flag"></a>Find Flag</h1><p>定位到真实的程序后，开始分析具体的内容。先来看 MainActivity，主要是一个点击事件，其中获取了 EditText 中的字符串并作为参数传入并启动 WebViewActivity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ali.tg.testapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.ActionBarDrawerToggleJellybeanMR2n;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.widget.ListViewAutoScrollHelpern;</span><br><span class="line"><span class="keyword">import</span> android.view.View$OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">ali</span>.<span class="title">tg</span>.<span class="title">testapp</span>.<span class="title">MainActivity</span>$1 <span class="keyword">implements</span> <span class="title">View</span>$<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">        com.ali.tg.testapp.MainActivity$<span class="number">1</span>(MainActivity arg1) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span> = arg1;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg6)</span> </span>&#123;</span><br><span class="line">            ActionBarDrawerToggleJellybeanMR2n.b(ActionBarDrawerToggleJellybeanMR2n.a());</span><br><span class="line">            String v1 = MainActivity.<span class="keyword">this</span>.edit.getText().toString(); <span class="comment">// 获取EditText中的字符串</span></span><br><span class="line">            Intent v0 = <span class="keyword">new</span> Intent();</span><br><span class="line">            v0.putExtra(ListViewAutoScrollHelpern.decrypt_native(<span class="string">"dV."</span>, <span class="number">2</span>), v1); <span class="comment">// 将v1的值传给Intent，变量名为“dV.”解密后的值</span></span><br><span class="line">            v0.setClass(MainActivity.<span class="keyword">this</span>, WebViewActivity.class); <span class="comment">// 设置Intent要跳转的类为WebViewActivity</span></span><br><span class="line">            MainActivity.<span class="keyword">this</span>.startActivity(v0); <span class="comment">// 启动WebViewActivity</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Button btn_enter;</span><br><span class="line">    View$OnClickListener btn_listener;</span><br><span class="line">    EditText edit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.btn_enter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.edit = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.btn_listener = <span class="keyword">new</span> com.ali.tg.testapp.MainActivity$<span class="number">1</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg4)</span> </span>&#123;</span><br><span class="line">        ActionBarDrawerToggleJellybeanMR2n.b(ActionBarDrawerToggleJellybeanMR2n.a());</span><br><span class="line">        <span class="keyword">super</span>.onCreate(arg4);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">0x7F030000</span>);</span><br><span class="line">        <span class="keyword">this</span>.edit = <span class="keyword">this</span>.findViewById(<span class="number">0x7F060001</span>);</span><br><span class="line">        <span class="keyword">this</span>.btn_enter = <span class="keyword">this</span>.findViewById(<span class="number">0x7F060002</span>);</span><br><span class="line">        <span class="keyword">this</span>.btn_enter.setOnClickListener(<span class="keyword">this</span>.btn_listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来看看 WebViewActivity，主要就是新建了一个 JavaScriptInterface 对象，对象的名称同样被加密了。然后加载输入的 url，目标是最后能够成功调用对象 JavaScriptInterface 里的 showToast 方法。接下来需要根据密文解出对象名，并构造出相应的网页来弹出 Toast。不过这里好像 flag 就是“祥龙”，但还是继续往下尝试构造出能够弹 Toast 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ali.tg.testapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.ActionBarDrawerToggleJellybeanMR2n;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.widget.ListViewAutoScrollHelpern;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebSettings;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebViewActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptInterface</span> </span>&#123;</span><br><span class="line">        Context mContext;</span><br><span class="line"></span><br><span class="line">        JavaScriptInterface(WebViewActivity arg1, Context arg2) &#123;</span><br><span class="line">            WebViewActivity.<span class="keyword">this</span> = arg1;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.mContext = arg2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">()</span> </span>&#123; <span class="comment">// 构造出一个页面能够调用这个函数就成功了</span></span><br><span class="line">            ActionBarDrawerToggleJellybeanMR2n.b(ActionBarDrawerToggleJellybeanMR2n.a());</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>.mContext, <span class="string">"祥龙！"</span>, <span class="number">0</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WebView wView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebViewActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.wView = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg7)</span> </span>&#123;</span><br><span class="line">        ActionBarDrawerToggleJellybeanMR2n.b(ActionBarDrawerToggleJellybeanMR2n.a());</span><br><span class="line">        <span class="keyword">super</span>.onCreate(arg7);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">0x7F030001</span>);</span><br><span class="line">        <span class="keyword">this</span>.wView = <span class="keyword">this</span>.findViewById(<span class="number">0x7F060004</span>);</span><br><span class="line">        WebSettings v2 = <span class="keyword">this</span>.wView.getSettings();</span><br><span class="line">        v2.setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">        v2.setJavaScriptCanOpenWindowsAutomatically(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.wView.addJavascriptInterface(<span class="keyword">new</span> JavaScriptInterface(<span class="keyword">this</span>, ((Context)<span class="keyword">this</span>)), ListViewAutoScrollHelpern.decrypt_native(<span class="string">"BQ1$*[w6G_"</span>, <span class="number">2</span>)); <span class="comment">// 添加一个JavascriptInterface对象，对象的变量名为“BQ1$*[w6G_”解密后的值</span></span><br><span class="line">        <span class="keyword">this</span>.wView.loadUrl(<span class="keyword">this</span>.getIntent().getStringExtra(ListViewAutoScrollHelpern.decrypt_native(<span class="string">"dV."</span>, <span class="number">2</span>))); <span class="comment">// 把在MainActivity中获取的变量作为url来加载</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Crack"><a href="#Crack" class="headerlink" title="Crack"></a>Crack</h1><p>接下来再看看 ListViewAutoScrollHelpern 中的 decrypt_native 方法，发现是在 Native 层中的 translate 库实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.support.v4.widget;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListViewAutoScrollHelpern</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"translate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ListViewAutoScrollHelpern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">decrypt_native</span><span class="params">(String arg0, <span class="keyword">int</span> arg1)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLogv</span><span class="params">(String arg1)</span> </span>&#123;</span><br><span class="line">        Log.v(<span class="string">"cheatecore"</span>, arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLogw</span><span class="params">(String arg1)</span> </span>&#123;</span><br><span class="line">        Log.w(<span class="string">"cheatecore"</span>, arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将 libtranslat.so 载入 IDA。先看看 JNI_OnLoad，其中有两个函数 register_Algorithm 和 register_translate：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">JNI_OnLoad</span><span class="params">(_JavaVM *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// r1</span></span><br><span class="line">  jint v2; <span class="comment">// r2</span></span><br><span class="line">  _JNIEnv *v3; <span class="comment">// r4</span></span><br><span class="line">  jint v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// cf</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  _JNIEnv *env; <span class="comment">// [sp+4h] [bp-Ch]</span></span><br><span class="line"></span><br><span class="line">  env = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1-&gt;functions-&gt;GetEnv(&amp;a1-&gt;functions, (<span class="keyword">void</span> **)&amp;env, <span class="number">65540</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v3 = env;</span><br><span class="line">  register_Algorithm(env, v1, v2);</span><br><span class="line">  v4 = register_translate(v3);</span><br><span class="line">  v5 = v4 &lt; <span class="number">0</span>;</span><br><span class="line">  result = v4 &amp; (v4 &gt;&gt; <span class="number">32</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    result = <span class="number">65540</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 register_Algorithm 中发现了目标函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">register_Algorithm</span><span class="params">(_JNIEnv *a1, <span class="keyword">int</span> a2, jint a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _JNIEnv *v3; <span class="comment">// r4</span></span><br><span class="line">  jclass v4; <span class="comment">// r0</span></span><br><span class="line">  jclass v5; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v3 = a1;</span><br><span class="line">  v4 = a1-&gt;functions-&gt;FindClass(&amp;a1-&gt;functions, <span class="string">"android/support/v4/widget/ListViewAutoScrollHelpern"</span>);</span><br><span class="line">  v3-&gt;functions-&gt;RegisterNatives(&amp;v3-&gt;functions, v4, (<span class="keyword">const</span> JNINativeMethod *)off_607C, <span class="number">1</span>);</span><br><span class="line">  v5 = v3-&gt;functions-&gt;FindClass(&amp;v3-&gt;functions, <span class="string">"android/support/v4/view/PagerTitleStripIcsn"</span>);</span><br><span class="line">  v3-&gt;functions-&gt;RegisterNatives(&amp;v3-&gt;functions, v5, (<span class="keyword">const</span> JNINativeMethod *)off_607C, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定位到目标函数，发现其中调用了一个 vigenere_decrypt：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">jstring __<span class="function">fastcall <span class="title">decrypt_native</span><span class="params">(_JNIEnv *a1, jobject a2, jstring a3, jint a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  jstring data; <span class="comment">// r6</span></span><br><span class="line">  jint num; <span class="comment">// r9</span></span><br><span class="line">  _JNIEnv *env; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v7; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v8; <span class="comment">// r8</span></span><br><span class="line">  jstring v9; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [sp+4h] [bp+0h]</span></span><br><span class="line"></span><br><span class="line">  data = a3;</span><br><span class="line">  num = a4;</span><br><span class="line">  env = a1;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v11, <span class="number">0</span>, <span class="number">0x1000</span>u);</span><br><span class="line">  v7 = env-&gt;functions-&gt;GetStringUTFChars(&amp;env-&gt;functions, data, <span class="number">0</span>);</span><br><span class="line">  v8 = v7;</span><br><span class="line">  <span class="keyword">if</span> ( num == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    vigenere_decrypt(v7, (<span class="keyword">char</span> *)&amp;v11);</span><br><span class="line">    v9 = env-&gt;functions-&gt;NewStringUTF(&amp;env-&gt;functions, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v11);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = data;</span><br><span class="line">  &#125;</span><br><span class="line">  env-&gt;functions-&gt;ReleaseStringUTFChars(&amp;env-&gt;functions, data, v8);</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 vigenere_decrypt 函数中，对输入的数据进行了解密：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">fastcall <span class="title">vigenere_decrypt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *ciphertext, <span class="keyword">char</span> *plaintext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ciphertext_1; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">char</span> *plaintext_1; <span class="comment">// r6</span></span><br><span class="line">  <span class="keyword">size_t</span> len; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// r2</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *table; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v7; <span class="comment">// r7</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// r1</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// r10</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v16; <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">int</span> ch; <span class="comment">// r3</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [sp+4h] [bp-64h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [sp+48h] [bp-20h]</span></span><br><span class="line"></span><br><span class="line">  ciphertext_1 = ciphertext;</span><br><span class="line">  plaintext_1 = plaintext;</span><br><span class="line">  len = <span class="built_in">strlen</span>(ciphertext);</span><br><span class="line">  v5 = &amp;s;</span><br><span class="line">  table = <span class="string">"ncA8DaUPelq*S7Y9q#hLl0T##@XTuXHQpFA&amp;65eaUaY33WigYMXO9y7JtCQU"</span>;</span><br><span class="line">  v7 = len;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = *(_DWORD *)table;</span><br><span class="line">    table += <span class="number">8</span>;</span><br><span class="line">    v9 = *((_DWORD *)table - <span class="number">1</span>);</span><br><span class="line">    *(_DWORD *)v5 = v8;</span><br><span class="line">    *((_DWORD *)v5 + <span class="number">1</span>) = v9;</span><br><span class="line">    v10 = (<span class="keyword">int</span>)(v5 + <span class="number">8</span>);</span><br><span class="line">    v5 += <span class="number">8</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( table != <span class="string">"tCQU"</span> );</span><br><span class="line">  v11 = *(_DWORD *)table;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = table[<span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)v10 = v11;</span><br><span class="line">  *(_BYTE *)(v10 + <span class="number">4</span>) = v13;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  result = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  v16 = result;</span><br><span class="line">  <span class="keyword">while</span> ( i &lt; v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    ch = (<span class="keyword">unsigned</span> __int8)ciphertext_1[i];</span><br><span class="line">    <span class="keyword">if</span> ( ch - <span class="number">32</span> &lt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="string">'^'</span> )         <span class="comment">// chr(ch) &lt;= 127</span></span><br><span class="line">    &#123;</span><br><span class="line">      plaintext_1[i] = (ch - (<span class="keyword">unsigned</span> __int8)*(&amp;v19 + v12 - <span class="number">68</span>) + <span class="number">95</span>) % <span class="number">95</span> + <span class="number">32</span>;<span class="comment">// &amp;v19 - 68 = &amp;table</span></span><br><span class="line">      result = (v12 + <span class="number">1</span>) / v16;</span><br><span class="line">      v12 = (v12 + <span class="number">1</span>) % v16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// chr(ch) &gt; 127</span></span><br><span class="line">    &#123;</span><br><span class="line">      plaintext_1[i] = ch;</span><br><span class="line">    &#125;</span><br><span class="line">    ++i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我先是通过动态调试来获取到了两个字符串的解密结果：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/5.png" alt="`dV.`的解密结果"></p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/6.png" alt="第二个字符串的解密结果"></p>
<p>然后尝试自己实现一个解密函数进行验证：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *table = <span class="string">"ncA8DaUPelq*S7Y9q#hLl0T##@XTuXHQpFA&amp;65eaUaY33WigYMXO9y7JtCQU"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">vigenere_decrypt</span><span class="params">(<span class="keyword">char</span> *ciphertext)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(ciphertext);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, len);</span><br><span class="line">	<span class="keyword">char</span> plaintext[len];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">		<span class="keyword">char</span> ch = ciphertext[i];</span><br><span class="line">		<span class="keyword">if</span> ((ch - <span class="number">32</span>) &lt;= <span class="number">0x5E</span>) &#123;</span><br><span class="line">			plaintext[i] = (ch - table[j] + <span class="number">95</span>) % <span class="number">95</span> + <span class="number">32</span>;</span><br><span class="line">			j = (j + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			plaintext[i] = ch;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	plaintext[len] = '\x00';</span><br><span class="line">	<span class="keyword">return</span> plaintext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *ciphertext1 = <span class="string">"dV."</span>;</span><br><span class="line">	<span class="keyword">char</span> *plaintext1 = vigenere_decrypt(ciphertext1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s\n"</span>, plaintext1); <span class="comment">// url</span></span><br><span class="line">	<span class="keyword">char</span> *ciphertext2 = <span class="string">"BQ1$*[w6G_"</span>;</span><br><span class="line">	<span class="keyword">char</span> *plaintext2 = vigenere_decrypt(ciphertext2);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s\n"</span>, plaintext2); <span class="comment">// SmokeyBear</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然这里也可以 Hook 这个 so 文件，也可以直接编写代码调用 so 中的函数，条条大路通罗马。最后实现一个调用 Toast 的 html 页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      function alicrack() &#123;</span></span><br><span class="line"><span class="undefined">        SmokeyBear.showToast();</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Crack EvilAPK_3</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      alicrack();</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在软件中输入对应的地址，成功弹窗：</p>
<p><img src="/pics/2014-AliCTF-EvilAPK_3/7.png" alt="成功弹窗"></p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://xz.aliyun.com/t/383" target="_blank" rel="noopener">https://xz.aliyun.com/t/383</a><br><a href="https://blog.csdn.net/AliMobileSecurity/article/details/53259788" target="_blank" rel="noopener">https://blog.csdn.net/AliMobileSecurity/article/details/53259788</a><br><a href="https://yq.aliyun.com/articles/64691" target="_blank" rel="noopener">https://yq.aliyun.com/articles/64691</a><br><a href="http://pwn4.fun/2017/04/04/Android%E9%80%86%E5%90%91%E4%B9%8B%E8%84%B1%E5%A3%B3/" target="_blank" rel="noopener">http://pwn4.fun/2017/04/04/Android%E9%80%86%E5%90%91%E4%B9%8B%E8%84%B1%E5%A3%B3/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/re/">re</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/02/17/分组密码的工作模式/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          分组密码的工作模式
        
      </div>
    </a>
  
  
    <a href="/2020/02/14/[TODO]Android逆向入门（四）/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Android逆向入门（四）</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Analysis（classes-dex）"><span class="nav-number">1.</span> <span class="nav-text">Analysis（classes.dex）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Analysis（libmobisec-so）"><span class="nav-number">2.</span> <span class="nav-text">Analysis（libmobisec.so）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dump-Dex-File"><span class="nav-number">3.</span> <span class="nav-text">Dump Dex File</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fix-Application"><span class="nav-number">4.</span> <span class="nav-text">Fix Application</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Find-Flag"><span class="nav-number">5.</span> <span class="nav-text">Find Flag</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Crack"><span class="nav-number">6.</span> <span class="nav-text">Crack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">7.</span> <span class="nav-text">References</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2020 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
