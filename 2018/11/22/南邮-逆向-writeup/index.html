<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>南邮-逆向-writeup | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfwpre">
  
  
  
  
  <meta name="description" content="做了一下南邮的逆向题。">
<meta name="keywords" content="ctf,wp,re">
<meta property="og:type" content="article">
<meta property="og:title" content="南邮-逆向-writeup">
<meta property="og:url" content="https://qianfei11.github.io/2018/11/22/南邮-逆向-writeup/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="做了一下南邮的逆向题。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/007gQ38zly1fxjdzklizwj30s00crdjd.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/007gQ38zly1fxjeu32qp3j30i60g0q4y.jpg">
<meta property="og:updated_time" content="2019-03-26T06:14:30.230Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="南邮-逆向-writeup">
<meta name="twitter:description" content="做了一下南邮的逆向题。">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/007gQ38zly1fxjdzklizwj30s00crdjd.jpg">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-南邮-逆向-writeup" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      南邮-逆向-writeup
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/11/22/南邮-逆向-writeup/" class="article-date">
	  <time datetime="2018-11-22T08:12:02.000Z" itemprop="datePublished">November 22, 2018</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>做了一下南邮的逆向题。</p>
<a id="more"></a>
<h1 id="Hello-RE"><a href="#Hello-RE" class="headerlink" title="Hello,RE!"></a>Hello,RE!</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file 1.exe </span><br><span class="line">1.exe: PE32 executable (console) Intel 80386, for MS Windows</span><br></pre></td></tr></table></figure>
<p>32位PE文件，拖进ida在main函数中就有flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [esp+11h] [ebp-7Fh]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+75h] [ebp-1Bh]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+79h] [ebp-17h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+7Dh] [ebp-13h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [esp+81h] [ebp-Fh]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+85h] [ebp-Bh]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+89h] [ebp-7h]</span></span><br><span class="line">  __int16 v11; <span class="comment">// [esp+8Dh] [ebp-3h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [esp+8Fh] [ebp-1h]</span></span><br><span class="line"></span><br><span class="line">  __main();</span><br><span class="line">  <span class="built_in">printf</span>(fmt);</span><br><span class="line">  v5 = 'galf';</span><br><span class="line">  v6 = 'leW&#123;';</span><br><span class="line">  v7 = 'emoc';</span><br><span class="line">  v8 = '_oT_';</span><br><span class="line">  v9 = 'W_ER';</span><br><span class="line">  v10 = 'dlro';</span><br><span class="line">  v11 = '&#125;!';</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;v4) != <span class="number">-1</span> &amp;&amp; <span class="built_in">strcmp</span>(&amp;v4, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v5) )</span><br><span class="line">    <span class="built_in">printf</span>(aFlag);</span><br><span class="line">  <span class="built_in">printf</span>(aFlagoye);</span><br><span class="line">  <span class="built_in">printf</span>(aEc);</span><br><span class="line">  <span class="built_in">printf</span>(aEooaouctfNupts);</span><br><span class="line">  <span class="built_in">printf</span>(aOuU);</span><br><span class="line">  getchar();</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">v5 = <span class="string">'galf'</span></span><br><span class="line">v6 = <span class="string">'leW&#123;'</span></span><br><span class="line">v7 = <span class="string">'emoc'</span></span><br><span class="line">v8 = <span class="string">'_oT_'</span></span><br><span class="line">v9 = <span class="string">'W_ER'</span></span><br><span class="line">v10 = <span class="string">'dlro'</span></span><br><span class="line">v11 =<span class="string">'&#125;!'</span></span><br><span class="line">flag = v5[::<span class="number">-1</span>] + v6[::<span class="number">-1</span>] + v7[::<span class="number">-1</span>] + v8[::<span class="number">-1</span>] + v9[::<span class="number">-1</span>] + v10[::<span class="number">-1</span>] + v11[::<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="ReadAsm2"><a href="#ReadAsm2" class="headerlink" title="ReadAsm2"></a>ReadAsm2</h1><p>题目给了一个main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> input[] = &#123;<span class="number">0x0</span>,  <span class="number">0x67</span>, <span class="number">0x6e</span>, <span class="number">0x62</span>, <span class="number">0x63</span>, <span class="number">0x7e</span>, <span class="number">0x74</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6d</span>,</span><br><span class="line">                  <span class="number">0x55</span>, <span class="number">0x6a</span>, <span class="number">0x7f</span>, <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x66</span>, <span class="number">0x63</span>, <span class="number">0x4e</span>, <span class="number">0x66</span>, <span class="number">0x7b</span>,</span><br><span class="line">                  <span class="number">0x71</span>, <span class="number">0x4a</span>, <span class="number">0x74</span>, <span class="number">0x76</span>, <span class="number">0x6b</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x66</span> , <span class="number">0x1c</span>&#125;;</span><br><span class="line">  func(input, <span class="number">28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,input+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及一个汇编的func函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">00000000004004e6 &lt;func&gt;:</span><br><span class="line">  4004e6: 55                    push   rbp</span><br><span class="line">  4004e7: 48 89 e5              mov    rbp,rsp</span><br><span class="line">  4004ea: 48 89 7d e8           mov    QWORD PTR [rbp-0x18],rdi ; first arg =&gt; input</span><br><span class="line">  4004ee: 89 75 e4              mov    DWORD PTR [rbp-0x1c],esi ; second arg =&gt; length</span><br><span class="line">  4004f1: c7 45 fc 01 00 00 00  mov    DWORD PTR [rbp-0x4],0x1 ; i = 1</span><br><span class="line">  4004f8: eb 28                 jmp    400522 &lt;func+0x3c&gt;</span><br><span class="line">  4004fa: 8b 45 fc              mov    eax,DWORD PTR [rbp-0x4] ; &lt;func+0x14&gt;</span><br><span class="line">  4004fd: 48 63 d0              movsxd rdx,eax</span><br><span class="line">  400500: 48 8b 45 e8           mov    rax,QWORD PTR [rbp-0x18]</span><br><span class="line">  400504: 48 01 d0              add    rax,rdx</span><br><span class="line">  400507: 8b 55 fc              mov    edx,DWORD PTR [rbp-0x4]</span><br><span class="line">  40050a: 48 63 ca              movsxd rcx,edx</span><br><span class="line">  40050d: 48 8b 55 e8           mov    rdx,QWORD PTR [rbp-0x18] ; rdi</span><br><span class="line">  400511: 48 01 ca              add    rdx,rcx</span><br><span class="line">  400514: 0f b6 0a              movzx  ecx,BYTE PTR [rdx] ; input[rdx]</span><br><span class="line">  400517: 8b 55 fc              mov    edx,DWORD PTR [rbp-0x4] ; 1</span><br><span class="line">  40051a: 31 ca                 xor    edx,ecx ; xor(input[i] ^ i)</span><br><span class="line">  40051c: 88 10                 mov    BYTE PTR [rax],dl</span><br><span class="line">  40051e: 83 45 fc 01           add    DWORD PTR [rbp-0x4],0x1 ; i += 1</span><br><span class="line">  400522: 8b 45 fc              mov    eax,DWORD PTR [rbp-0x4] ; &lt;func+0x3c&gt;</span><br><span class="line">  400525: 3b 45 e4              cmp    eax,DWORD PTR [rbp-0x1c] ; length</span><br><span class="line">  400528: 7e d0                 jle    4004fa &lt;func+0x14&gt;</span><br><span class="line">  40052a: 90                    nop</span><br><span class="line">  40052b: 5d                    pop    rbp</span><br><span class="line">  40052c: c3                    ret</span><br></pre></td></tr></table></figure>
<p>分析func可以看到大概是对每个byte和递增的i异或，然后得到flag。脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">enc = [<span class="number">0x0</span>,  <span class="number">0x67</span>, <span class="number">0x6e</span>, <span class="number">0x62</span>, <span class="number">0x63</span>, <span class="number">0x7e</span>, <span class="number">0x74</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6d</span>, <span class="number">0x55</span>, <span class="number">0x6a</span>, <span class="number">0x7f</span>, <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x66</span>, <span class="number">0x63</span>, <span class="number">0x4e</span>, <span class="number">0x66</span>, <span class="number">0x7b</span>, <span class="number">0x71</span>, <span class="number">0x4a</span>, <span class="number">0x74</span>, <span class="number">0x76</span>, <span class="number">0x6b</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x66</span> , <span class="number">0x1c</span>]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc)):</span><br><span class="line">    flag += chr(enc[i] ^ i)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="Py交易"><a href="#Py交易" class="headerlink" title="Py交易"></a>Py交易</h1><p>给了一个pyc文件，在线反编译一下或者用<a href="https://github.com/rocky/python-uncompyle6.git" target="_blank" rel="noopener">工具python-uncompile6</a>反编译得到源代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ uncompyle6 Py.pyc        </span><br><span class="line"><span class="comment"># uncompyle6 version 3.2.4</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62211)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 2.7.16 (default, Mar  4 2019, 09:02:22) </span></span><br><span class="line"><span class="comment"># [GCC 4.2.1 Compatible Apple LLVM 10.0.0 (clang-1000.11.45.5)]</span></span><br><span class="line"><span class="comment"># Embedded file name: 1.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2017-06-03 10:20:43</span></span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def encode(message):</span><br><span class="line">    s = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> message:</span><br><span class="line">        x = ord(i) ^ 32</span><br><span class="line">        x = x + 16</span><br><span class="line">        s += chr(x)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> base64.b64encode(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">correct = <span class="string">'XlNkVmtUI1MgXWBZXCFeKY+AaXNt'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">'Input flag:'</span></span><br><span class="line">flag = raw_input()</span><br><span class="line"><span class="keyword">if</span> encode(flag) == correct:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'correct'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">'wrong'</span></span><br><span class="line"><span class="comment"># okay decompiling Py.pyc</span></span><br></pre></td></tr></table></figure>
<p>照着写个脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">enc = <span class="string">'XlNkVmtUI1MgXWBZXCFeKY+AaXNt'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">tmp = base64.b64decode(enc)</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> tmp:</span><br><span class="line">    flag += chr((ord(c) - <span class="number">16</span>) ^ <span class="number">32</span>)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="WxyVM1"><a href="#WxyVM1" class="headerlink" title="WxyVM1"></a>WxyVM1</h1><p>拿到文件先file一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssassinQ@MacBook-Air  ~/Downloads  file WxyVM1</span><br><span class="line">WxyVM1: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=0391bf87f6f7a11b4d23e29eb39330a762aff5b4, stripped</span><br></pre></td></tr></table></figure>
<p>然后拿到虚拟机下运行一下看看什么样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Desktop] ./WxyVM1                                                     3:25:21 </span><br><span class="line">[WxyVM 0.0.1]</span><br><span class="line">input your flag:</span><br><span class="line">nctf&#123;123456&#125;</span><br><span class="line">wrong</span><br></pre></td></tr></table></figure>
<p>没看出啥东西，基本判断就是程序应该是一个对flag的加密。然后拖进ida里分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Bh] [rbp-5h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[WxyVM 0.0.1]"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input your flag:"</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;input);</span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  vm_start();</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;input) != <span class="number">24</span> )</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;input + i) != enc[i] )</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"correct"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main函数中输入一个flag，然后一个vm加密函数，再将加密过后的flag与存放在data段中的enc比较，如果相等那么输出<code>correct</code>。所以基本思路应该是通过enc逆出flag。然后进到<code>vm_start</code>函数中看看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">vm_start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ST04_4</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14999</span>; i += <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = byte_6010C0[i];</span><br><span class="line">    v3 = byte_6010C0[i + <span class="number">2</span>];</span><br><span class="line">    result = v0;</span><br><span class="line">    <span class="keyword">switch</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;input + result) += v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;input + result) -= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;input + result) ^= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;input + result) *= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;input + result) ^= *(&amp;input + byte_6010C0[i + <span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里发现在data段中还有一个byte数组。总共有15000个数，每三个数一组。第一个数作为需要执行的指令，第二个数为输入flag的下标，第三个数为与其进行操作的数据。到这里基本已经清楚了，把数据都dump下来，写个脚本逆一下就ok了。然后还需要注意的是，这里的运算是以byte为单位，可能会产生溢出，所以应该每次操作之后模一下256。</p>
<p>看到网上大多数wp都是用idc脚本patch，因为数据确实太多了，连lazyida都dump不出来。我是选择手动复制出来所有的数据，然后再用python正则匹配一下，提取出来。</p>
<p><img src="https://ws1.sinaimg.cn/large/007gQ38zly1fxjdzklizwj30s00crdjd.jpg" alt></p>
<p>最后的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">f = open(<span class="string">'WxyVM1.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">enc = [<span class="number">0xFFFFFFC4</span>, <span class="number">0x00000034</span>, <span class="number">0x00000022</span>, <span class="number">0xFFFFFFB1</span>, <span class="number">0xFFFFFFD3</span>, <span class="number">0x00000011</span>, <span class="number">0xFFFFFF97</span>, <span class="number">0x00000007</span>, <span class="number">0xFFFFFFDB</span>, <span class="number">0x00000037</span>, <span class="number">0xFFFFFFC4</span>, <span class="number">0x00000006</span>, <span class="number">0x0000001D</span>, <span class="number">0xFFFFFFFC</span>, <span class="number">0x0000005B</span>, <span class="number">0xFFFFFFED</span>, <span class="number">0xFFFFFF98</span>, <span class="number">0xFFFFFFDF</span>, <span class="number">0xFFFFFF94</span>, <span class="number">0xFFFFFFD8</span>, <span class="number">0xFFFFFFB3</span>, <span class="number">0xFFFFFF84</span>, <span class="number">0xFFFFFFCC</span>, <span class="number">0x00000008</span>]</span><br><span class="line">text = f.read()</span><br><span class="line">f.close()</span><br><span class="line">pat = re.compile(<span class="string">r'db.&#123;5&#125;'</span>)</span><br><span class="line">find_pat = pat.findall(text)</span><br><span class="line">nums = []</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> find_pat:</span><br><span class="line">    n = n[<span class="number">2</span>:].strip()</span><br><span class="line">    <span class="keyword">if</span> n.endswith(<span class="string">'h'</span>):</span><br><span class="line">        n = int(n[:<span class="number">-1</span>], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        n = int(n)</span><br><span class="line">    nums.append(n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(v0, v3, index)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> v0 == <span class="number">1</span>:</span><br><span class="line">        enc[index] = (enc[index] - v3) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> v0 == <span class="number">2</span>:</span><br><span class="line">        enc[index] = (enc[index] + v3) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> v0 == <span class="number">3</span>:</span><br><span class="line">        enc[index] = (enc[index] ^ v3) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> v0 == <span class="number">4</span>:</span><br><span class="line">        enc[index] = (enc[index] / v3) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> v0 == <span class="number">5</span>:</span><br><span class="line">        enc[index] = (enc[index] ^ enc[v3]) % <span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5000</span>):</span><br><span class="line">    t = <span class="number">5000</span> - i</span><br><span class="line">    v0 = nums[<span class="number">3</span> * t - <span class="number">3</span>]</span><br><span class="line">    v3 = nums[<span class="number">3</span> * t - <span class="number">1</span>]</span><br><span class="line">    res = nums[<span class="number">3</span> * t - <span class="number">2</span>]</span><br><span class="line">    cal(v0, v3, res)</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc)):</span><br><span class="line">    flag += chr(enc[i])</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="maze"><a href="#maze" class="headerlink" title="maze"></a>maze</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file maze </span><br><span class="line">maze: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=eda1df76eec45447cd0e1ad208a7eff914e86758, stripped</span><br></pre></td></tr></table></figure>
<p>64位ELF文件，拖进ida：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 i; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> choice; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// bp</span></span><br><span class="line">  <span class="keyword">bool</span> v6; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v7; <span class="comment">// rdi</span></span><br><span class="line">  __int64 pos; <span class="comment">// [rsp+0h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  pos = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input flag:"</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;flag, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;flag) != <span class="number">24</span> || <span class="built_in">strncmp</span>(&amp;flag, <span class="string">"nctf&#123;"</span>, <span class="number">5u</span>LL) || *(&amp;byte_6010BF + <span class="number">24</span>) != <span class="string">'&#125;'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_22:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong flag!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  i = <span class="number">5L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;flag) - <span class="number">1</span> &gt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      choice = *(&amp;flag + i);</span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( choice &gt; <span class="number">78</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        choice = (<span class="keyword">unsigned</span> __int8)choice;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)choice == <span class="string">'O'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = left((_DWORD *)&amp;pos + <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( choice == <span class="string">'o'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = down((<span class="keyword">int</span> *)&amp;pos + <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        choice = (<span class="keyword">unsigned</span> __int8)choice;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)choice == <span class="string">'.'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = up(&amp;pos);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( choice == <span class="string">'0'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = right((<span class="keyword">int</span> *)&amp;pos);</span><br><span class="line">LABEL_14:</span><br><span class="line">          v5 = v6;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_15:</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)check((__int64)maze, SHIDWORD(pos), pos) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">      <span class="keyword">if</span> ( ++i &gt;= <span class="built_in">strlen</span>(&amp;flag) - <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v5 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">LABEL_20:</span><br><span class="line">        v7 = <span class="string">"Wrong flag!"</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( maze[<span class="number">8</span> * (<span class="keyword">signed</span> <span class="keyword">int</span>)pos + SHIDWORD(pos)] != <span class="string">'#'</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  v7 = <span class="string">"Congratulations!"</span>;</span><br><span class="line">LABEL_21:</span><br><span class="line">  <span class="built_in">puts</span>(v7);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>迷宫题，一波分析之后大概就能得到上下左右移动对应的字符，以及对应的一些check，在内存中可以找到8x8的迷宫。脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">  ******</span></span><br><span class="line"><span class="string">*   *  *</span></span><br><span class="line"><span class="string">*** * **</span></span><br><span class="line"><span class="string">**  * **</span></span><br><span class="line"><span class="string">*  *#  *</span></span><br><span class="line"><span class="string">** *** *</span></span><br><span class="line"><span class="string">**     *</span></span><br><span class="line"><span class="string">********</span></span><br><span class="line"><span class="string">left - O</span></span><br><span class="line"><span class="string">down - 0</span></span><br><span class="line"><span class="string">right - o</span></span><br><span class="line"><span class="string">up - .</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">flag = <span class="string">'nctf&#123;o0oo00O000oooo..OO&#125;'</span></span><br><span class="line"><span class="keyword">assert</span> len(flag) == <span class="number">24</span></span><br><span class="line">maze = [</span><br><span class="line">    [<span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">'#'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'*'</span>],</span><br><span class="line">    [<span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>, <span class="string">'*'</span>]</span><br><span class="line">]</span><br><span class="line">directions = flag[<span class="number">5</span>:<span class="number">-1</span>]</span><br><span class="line">i, j = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> directions:</span><br><span class="line">    <span class="keyword">if</span> d == <span class="string">'O'</span>:</span><br><span class="line">        j -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> d == <span class="string">'0'</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> d == <span class="string">'o'</span>:</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> d == <span class="string">'.'</span>:</span><br><span class="line">        i -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> maze[i][j] == <span class="string">'#'</span> <span class="keyword">and</span> d == len(directions) - <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'success'</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> maze[i][j] == <span class="string">'*'</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'failed'</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">False</span></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="WxyVM2"><a href="#WxyVM2" class="headerlink" title="WxyVM2"></a>WxyVM2</h1><p>file一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssassinQ@MacBook-Air  ~/Downloads  file WxyVM2</span><br><span class="line">WxyVM2: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=e57d1a1b70ac3d843afa30523dbbbc53c4ff341f, stripped</span><br></pre></td></tr></table></figure>
<p>运行一下，发现和上一题VM应该基本是同一个类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Desktop] ./WxyVM2                                                     3:25:36 </span><br><span class="line">[WxyVM 0.0.2]</span><br><span class="line">input your flag:</span><br><span class="line">nctf&#123;123456&#125;</span><br><span class="line">wrong</span><br></pre></td></tr></table></figure>
<p>然后拖进ida里，只有一个main函数。f5反编译发现提示说函数太大，无法反编译。这个时候需要先修改一下ida的配置文件<code>hexrays.cfg</code>，<a href="https://www.dllhook.com/post/217.html" target="_blank" rel="noopener">具体操作</a>。修改完后看一下main函数的情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Bh] [rbp-5h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[WxyVM 0.0.2]"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input your flag:"</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;input);</span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;input) != <span class="number">25</span> )</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">  [......]</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">24</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;input + i) != enc[i] )</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"correct"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>头和尾是基本一样的，主要是中间的部分，是一段又臭又长的对数据的加密：</p>
<p><img src="https://ws1.sinaimg.cn/large/007gQ38zly1fxjeu32qp3j30i60g0q4y.jpg" alt></p>
<p>我们输入的input应该都是byte，而这么多dword的操作其实都是对加密部分的混淆。然后这里的话我是把main函数提出来，然后筛选出byte开头的语句，并且通过一系列切片简化语句。然后把数据段里被加密的flag即enc数组dump出来，将提取出来的语句进行逆向的实现，就能输出flag。</p>
<p>其他的一些注意实现和前一题一样。最后的实现脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'WxyVM2.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">text = f.read()</span><br><span class="line">f.close()</span><br><span class="line">enc = [<span class="number">0xFFFFFFC0</span>, <span class="number">0xFFFFFF85</span>, <span class="number">0xFFFFFFF9</span>, <span class="number">0x0000006C</span>, <span class="number">0xFFFFFFE2</span>, <span class="number">0x00000014</span>, <span class="number">0xFFFFFFBB</span>, <span class="number">0xFFFFFFE4</span>, <span class="number">0x0000000D</span>, <span class="number">0x00000059</span>, <span class="number">0x0000001C</span>, <span class="number">0x00000023</span>, <span class="number">0xFFFFFF88</span>, <span class="number">0x0000006E</span>, <span class="number">0xFFFFFF9B</span>, <span class="number">0xFFFFFFCA</span>, <span class="number">0xFFFFFFBA</span>, <span class="number">0x0000005C</span>, <span class="number">0x00000037</span>, <span class="number">0xFFFFFFFF</span>, <span class="number">0x00000048</span>, <span class="number">0xFFFFFFD8</span>, <span class="number">0x0000001F</span>, <span class="number">0xFFFFFFAB</span>, <span class="number">0xFFFFFFA5</span>]</span><br><span class="line">ori = text.split(<span class="string">';\n'</span>)</span><br><span class="line">ops = []</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> ori:</span><br><span class="line">    <span class="keyword">if</span> s.startswith(<span class="string">'d'</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> s.startswith(<span class="string">'b'</span>):</span><br><span class="line">        t = s[:<span class="number">1</span>] + s[<span class="number">9</span>:<span class="number">11</span>] + s[<span class="number">12</span>:<span class="number">14</span>] + s[<span class="number">15</span>:]</span><br><span class="line">        ops.append(t)</span><br><span class="line">    <span class="keyword">elif</span> s.startswith(<span class="string">'--'</span>):</span><br><span class="line">        t = s[<span class="number">2</span>:<span class="number">3</span>] + s[<span class="number">-2</span>:] + <span class="string">'-=1'</span></span><br><span class="line">        ops.append(t)</span><br><span class="line">    <span class="keyword">elif</span> s.startswith(<span class="string">'++'</span>):</span><br><span class="line">        t = s[<span class="number">2</span>:<span class="number">3</span>] + s[<span class="number">-2</span>:] + <span class="string">'+=1'</span></span><br><span class="line">        ops.append(t)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">ops = ops[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPart</span><span class="params">(op)</span>:</span></span><br><span class="line">    index = int(op[<span class="number">1</span>:<span class="number">3</span>], <span class="number">16</span>)</span><br><span class="line">    symbol = op[<span class="number">3</span>:<span class="number">4</span>]</span><br><span class="line">    num = op[<span class="number">5</span>:]</span><br><span class="line">    <span class="keyword">if</span> num.endswith(<span class="string">'u'</span>):</span><br><span class="line">        num = num[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span> num.startswith(<span class="string">'0x'</span>):</span><br><span class="line">        num = int(num, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        num = int(num)</span><br><span class="line">    <span class="keyword">return</span> index, symbol, num</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(index, symbol, num)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> symbol == <span class="string">'+'</span>:</span><br><span class="line">        enc[index] = (enc[index] - num) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> symbol == <span class="string">'-'</span>:</span><br><span class="line">        enc[index] = (enc[index] + num) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">elif</span> symbol == <span class="string">'^'</span>:</span><br><span class="line">        enc[index] = (enc[index] ^ num) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'error'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> op <span class="keyword">in</span> ops:</span><br><span class="line">    index, symbol, num = getPart(op)</span><br><span class="line">    <span class="comment"># print 'enc[', index, ']', symbol, num</span></span><br><span class="line">    cal(index, symbol, num)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc)):</span><br><span class="line">    flag += chr(enc[i])</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/re/">re</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/11/29/【未完成】脱壳指南/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          脱壳指南
        
      </div>
    </a>
  
  
    <a href="/2018/10/16/2018-护网杯-review/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2018-护网杯-writeup</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Hello-RE"><span class="nav-number">1.</span> <span class="nav-text">Hello,RE!</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ReadAsm2"><span class="nav-number">2.</span> <span class="nav-text">ReadAsm2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Py交易"><span class="nav-number">3.</span> <span class="nav-text">Py交易</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WxyVM1"><span class="nav-number">4.</span> <span class="nav-text">WxyVM1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#maze"><span class="nav-number">5.</span> <span class="nav-text">maze</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WxyVM2"><span class="nav-number">6.</span> <span class="nav-text">WxyVM2</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
